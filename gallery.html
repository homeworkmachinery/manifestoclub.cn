<head><link href="/css/styles.fce4e685861cb3d4ae32.css" rel="stylesheet"></head><style data-page="gallery">* {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: Arial, sans-serif;
        min-height: 100vh;
    }

    .gallery-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .gallery-header {
        text-align: left;
        margin-top: -10px;
    }

    .gallery-header h1 {
        font-size: 36px;
        font-weight: bold;
    }

    .gallery-header p {
        color: black;
        font-size: 16px;
    }

    .gallery-filter {
        display: flex;
        justify-content: left;
        gap: 10px;
    }

    .filter-btn {
        margin-top: 10px;
        border: 2px solid black;
        background: white;
        cursor: pointer;
        font-size: 20px;
    }

    .filter-btn:hover {
        background: black;
        color: white;
    }

    .filter-btn.active {
        background: black;
        color: white;
    }

    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .gallery-item {
        background: white;
        border: 2px solid black;
        overflow: hidden;
        cursor: pointer;
        position: relative;
    }




    .gallery-item img {
        width: 100%;
        height: 250px;
        object-fit: contain;
        background: white;
    }

    .gallery-item-info {
        padding: 8px;
        border-top: 2px solid black;
        background: white;
    }

    .gallery-item-title {
        margin-bottom: 5px;
        font-size: 15px;
    }

    .gallery-item-author {
        color: #666;
        font-size: 12px;
        margin-bottom: 5px;
    }

    .gallery-item-date {
        color: #999;
        font-size: 11px;
    }

    .gallery-item-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .action-btn {
        flex: 1;
        border: 2px solid black;
        background: white;
        cursor: pointer;
        font-size: 15px;
    }

    .action-btn:hover {
        background: black;
        color: white;
    }

    .empty-gallery {
        text-align: center;
        padding: 100px 20px;
        color: #999;
    }

    .empty-gallery h2 {
        margin-bottom: 20px;
        color: #666;
    }

    .loading {
        text-align: center;
        padding: 50px;
        font-size: 18px;
        color: #666;
    }

    /* 模态框样式 */
    .gallery-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    .gallery-modal.show {
        display: flex;
    }

    .modal-content {
        background: white;
        padding: 30px;
        max-width: 80%;
        max-height: 80%;
        overflow: auto;
        border: 2px solid black;
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
        border: 2px solid black;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .modal-close:hover {
        background: black;
        color: white;
    }

    .modal-image {
        width: 100%;
        max-width: 600px;
        height: auto;
        margin: 0 auto;
        display: block;
    }

    .action-btn.liked {
        background: black !important;
        color: white !important;
    }
    
    
    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }


    @media(max-width:899px) {


.gallery-grid {
   
    grid-template-columns: repeat(2,  1fr);
    gap: 10px;

}
.gallery-header{
    margin-top: 0px;
}

.gallery-grid{
    margin-top:10px;
}

}</style><div class="gallery-container"><div class="gallery-header"><h1>DOODLE GALLERY</h1><p>Community SVG and remix-friendly artwork</p></div><div class="gallery-filter"><button class="filter-btn active" data-filter="all">ALL</button> <button class="filter-btn" data-filter="curated">CURATED</button> <button class="filter-btn" data-filter="popular">POPULAR</button> <button class="filter-btn" data-filter="mine">MY WORKS</button></div><div id="galleryGrid" class="gallery-grid"><div class="loading">Loading gallery...</div></div></div><div id="galleryModal" class="gallery-modal"><div class="modal-content"><span class="modal-close" onclick="closeGalleryModal()">&times;</span> <img id="modalImage" class="modal-image" src="" alt=""><div id="modalInfo" style="margin-top: 20px; text-align: center;"></div></div></div><script>// Gallery页面初始化
    (function () {
        console.log('Gallery页面脚本执行');

        // 使用setTimeout确保DOM已渲染
        setTimeout(() => {
            if (typeof supabase !== 'undefined') {
                initGallery();
            } else {
                console.error('Supabase未定义，等待加载...');
                // 等待supabase加载
                const checkSupabase = setInterval(() => {
                    if (typeof supabase !== 'undefined') {
                        clearInterval(checkSupabase);
                        initGallery();
                    }
                }, 100);
            }
        }, 100);
    })();

    async function initGallery() {
        console.log('开始初始化Gallery页面');

        // 检查必要元素是否存在
        const galleryGrid = document.getElementById('galleryGrid');
        if (!galleryGrid) {
            console.error('Gallery grid元素未找到');
            return;
        }

        // 设置过滤器事件
        const filterBtns = document.querySelectorAll('.filter-btn');
        console.log('找到过滤器按钮:', filterBtns.length);

        filterBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                filterBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                loadGalleryItems(this.dataset.filter);
            });
        });

        // 加载gallery项目
        await loadGalleryItems('all');
    }

    // 确保函数在全局作用域
    window.viewGalleryItem = viewGalleryItem;
    window.closeGalleryModal = closeGalleryModal;
    window.likeGalleryItem = likeGalleryItem;


    async function loadGalleryItems(filter = 'all') {
        console.log('加载Gallery项目, filter:', filter);
        const galleryGrid = document.getElementById('galleryGrid');

        if (!galleryGrid) {
            console.error('galleryGrid元素不存在');
            return;
        }

        galleryGrid.innerHTML = '<div class="loading">Loading gallery...</div>';

        try {
            // 获取当前用户
            let currentUserId = null;
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUserId = user.id;
            }

            // 获取gallery数据
            let query = supabase.from('gallery').select('*');

            // 根据过滤器修改查询
            if (filter === 'mine' && currentUserId) {
                query = query.eq('user_id', currentUserId);
            } else if (filter === 'popular') {
                query = query.order('likes', { ascending: false }).limit(20);
            } else if (filter === 'curated') {
                // 可以添加特殊的筛选逻辑，比如likes > 10
                query = query.gte('likes', 5).order('likes', { ascending: false });
            } else {
                query = query.order('created_at', { ascending: false });
            }

            const { data: galleryItems, error } = await query;

            if (error) {
                console.error('加载Gallery失败:', error);
                galleryGrid.innerHTML = '<div class="empty-gallery"><h2>加载失败</h2><p>请稍后重试</p></div>';
                return;
            }

            if (!galleryItems || galleryItems.length === 0) {
                galleryGrid.innerHTML = `
                <div class="empty-gallery">
                    <h2>No artworks yet</h2>
                    <p>Be the first to add your creation to the gallery!</p>
                </div>
            `;
                return;
            }

            // 获取用户信息
            const userIds = [...new Set(galleryItems.map(item => item.user_id))];
            const { data: profiles } = await supabase
                .from('profiles')
                .select('user_id, manifesto')
                .in('user_id', userIds);

            const profileMap = {};
            if (profiles) {
                profiles.forEach(profile => {
                    profileMap[profile.user_id] = profile.manifesto;
                });
            }

            // 如果用户已登录，获取其点赞记录
            let userLikes = new Set();
            let userRemixes = new Set();
            if (currentUserId) {
                const galleryIds = galleryItems.map(item => item.id);

                // 获取用户的点赞记录
                const { data: likes } = await supabase
                    .from('gallery_likes')
                    .select('gallery_id')
                    .eq('user_id', currentUserId)
                    .in('gallery_id', galleryIds);

                if (likes) {
                    likes.forEach(like => userLikes.add(like.gallery_id));
                }

                // 获取用户的remix记录
                const { data: remixes } = await supabase
                    .from('gallery_remixes')
                    .select('gallery_id')
                    .eq('user_id', currentUserId)
                    .in('gallery_id', galleryIds);

                if (remixes) {
                    remixes.forEach(remix => userRemixes.add(remix.gallery_id));
                }
            }

            // 渲染gallery项目
            galleryGrid.innerHTML = galleryItems.map(item => {
                const authorName = profileMap[item.user_id] || 'Anonymous';
                const createdDate = new Date(item.created_at).toLocaleDateString();
                const isOwner = currentUserId === item.user_id;
                const hasLiked = userLikes.has(item.id);
                const hasRemixed = userRemixes.has(item.id);

                return `
                <div class="gallery-item" data-id="${item.id}">
                    <img src="${item.preview_image}" alt="${item.title}" onclick="viewGalleryItem('${item.id}')">
                    <div class="gallery-item-info">
                        <div class="gallery-item-title">${item.title || 'Untitled'}</div>
                        <div class="gallery-item-author">by ${authorName}</div>
                        <div class="gallery-item-date">${createdDate}</div>
                        <div class="gallery-item-actions">
                            <button class="action-btn ${hasLiked ? 'liked' : ''}" 
                                    onclick="toggleLike('${item.id}')"
                                    ${!currentUserId ? 'disabled title="请先登录"' : ''}>
                                LIKE ${item.likes || 0}
                            </button>
                            <button class="action-btn ${hasRemixed ? 'remixed' : ''}" 
                                    onclick="remixGalleryItem('${item.id}')"
                                    ${!currentUserId ? 'disabled title="请先登录"' : ''}>
                                REMIX ${item.remix_count || 0}
                            </button>
                            ${isOwner ? `<button class="action-btn" onclick="deleteGalleryItem('${item.id}')">DELETE</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            console.log(`成功加载${galleryItems.length}个作品`);

        } catch (error) {
            console.error('Gallery加载错误:', error);
            galleryGrid.innerHTML = '<div class="empty-gallery"><h2>出错了</h2><p>请刷新页面重试</p></div>';
        }
    }

    async function toggleLike(itemId) {
    try {
        // 检查用户登录
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            alert('请先登录');
            return;
        }
  // 检查是否已点赞
  const { data: existingLike } = await supabase
            .from('gallery_likes')
            .select('id')
            .eq('user_id', user.id)
            .eq('gallery_id', itemId)
            .single();

        if (existingLike) {
            // 已点赞，取消点赞
            const { error: deleteError } = await supabase
                .from('gallery_likes')
                .delete()
                .eq('id', existingLike.id);

            if (!deleteError) {
                // 更新gallery表的点赞数
                const { data: item } = await supabase
                    .from('gallery')
                    .select('likes')
                    .eq('id', itemId)
                    .single();

                const newLikes = Math.max(0, (item?.likes || 0) - 1);
                
                await supabase
                    .from('gallery')
                    .update({ likes: newLikes })
                    .eq('id', itemId);
            }
        } else {
            // 未点赞，添加点赞
            const { error: insertError } = await supabase
                .from('gallery_likes')
                .insert([{
                    user_id: user.id,
                    gallery_id: itemId
                }]);

            if (!insertError) {
                // 更新gallery表的点赞数
                const { data: item } = await supabase
                    .from('gallery')
                    .select('likes')
                    .eq('id', itemId)
                    .single();

                const newLikes = (item?.likes || 0) + 1;
                
                await supabase
                    .from('gallery')
                    .update({ likes: newLikes })
                    .eq('id', itemId);
            }
        }

        // 刷新显示
        const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
        loadGalleryItems(activeFilter);

    } catch (error) {
        console.error('点赞操作失败:', error);
        alert('操作失败，请重试');
    }
}

async function remixGalleryItem(itemId) {
    try {
        // 检查用户登录
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            alert('请先登录');
            return;
        }

        // 获取作品信息
        const { data: item, error } = await supabase
            .from('gallery')
            .select('*')
            .eq('id', itemId)
            .single();

        if (error || !item) {
            console.error('获取作品信息失败:', error);
            alert('无法获取作品信息');
            return;
        }

        const { data: existingRemix } = await supabase
            .from('gallery_remixes')
            .select('id')
            .eq('user_id', user.id)
            .eq('gallery_id', itemId)
            .maybeSingle();

        let isFirstRemix = false;

        if (!existingRemix) {
            // 第一次remix，需要确认

            isFirstRemix = true;

            const { error: insertError } = await supabase
                .from('gallery_remixes')
                .insert([{
                    user_id: user.id,
                    gallery_id: itemId
                }]);

            if (!insertError) {
                // 更新remix计数（只在第一次时增加）
                const newRemixCount = (item.remix_count || 0) + 1;
                await supabase
                    .from('gallery')
                    .update({ remix_count: newRemixCount })
                    .eq('id', itemId);
                
                console.log('Remix计数已增加');
            } else if (insertError.code !== '23505') { // 23505是唯一约束冲突错误
                console.error('记录remix失败:', insertError);
            }
        } 

        if (!confirm('Do you really want to remix this artwork?')) {
                return;
            } 
        // 跳转到编辑器
        if (item.draft_id) {
            // 如果有draft_id，通过draft加载
            window.location.href = `/home?loadSvgDraft=${item.draft_id}&fromGallery=true`;
        } else if (item.svg_url) {
            // 如果有svg_url，通过URL加载
            window.location.href = `/home?loadSvgUrl=${encodeURIComponent(item.svg_url)}`;
        } else if (item.svg_data) {
            // 如果只有svg_data，存储到sessionStorage
            sessionStorage.setItem('remixSvgData', item.svg_data);
            window.location.href = `/home?loadRemixData=true`;
        } else {
            alert('该作品没有可用的源文件');
        }

    } catch (error) {
        console.error('Remix失败:', error);
        alert('Remix失败，请重试');
    }
}




// 5. 在SVG编辑器中添加加载remix的功能
async function checkAndLoadRemix() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // 从URL加载SVG
    const svgUrl = urlParams.get('loadSvgUrl');
    if (svgUrl) {
        try {
            const response = await fetch(decodeURIComponent(svgUrl));
            const svgContent = await response.text();
            loadSvgContent(svgContent);
            
            if (urlParams.get('isRemix') === 'true') {
                showNotification('Remix loaded! Start editing!', 'success');
            }
        } catch (error) {
            console.error('加载SVG失败:', error);
        }
    }
    
    // 从sessionStorage加载
    const loadRemixData = urlParams.get('loadRemixData');
    if (loadRemixData === 'true') {
        const svgData = sessionStorage.getItem('remixSvgData');
        if (svgData) {
            loadSvgContent(svgData);
            sessionStorage.removeItem('remixSvgData');
            showNotification('Remix loaded! Start editing!', 'success');
        }
    }
}

// 6. 加载SVG内容到编辑器
function loadSvgContent(svgContent) {
    if (!svg) {
        console.error('SVG编辑器未初始化');
        return;
    }
    
    // 清空当前内容
    svg.innerHTML = '';
    
    // 解析并加载新内容
    const parser = new DOMParser();
    const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
    const paths = svgDoc.querySelectorAll('path');
    
    paths.forEach(path => {
        const newPath = path.cloneNode(true);
        svg.appendChild(newPath);
    });
    
    // 保存到历史
    if (typeof saveState === 'function') {
        saveState();
    }
}

// 确保函数在全局作用域
window.viewGalleryItem = viewGalleryItem;
window.closeGalleryModal = closeGalleryModal;
window.likeGalleryItem = likeGalleryItem;
window.toggleLike = toggleLike;
window.remixGalleryItem = remixGalleryItem;
window.deleteGalleryItem = deleteGalleryItem; 




    async function viewGalleryItem(itemId) {
        try {
            const { data: item, error } = await supabase
                .from('gallery')
                .select('*')
                .eq('id', itemId)
                .single();

            if (!error && item) {
                const modal = document.getElementById('galleryModal');
                const modalImage = document.getElementById('modalImage');
                const modalInfo = document.getElementById('modalInfo');

                modalImage.src = item.svg_url || item.preview_image;
                modalInfo.innerHTML = `
                        <h3>${item.title || 'Untitled'}</h3>
                        <p>${item.description || ''}</p>
                        <p style="margin-top: 10px; color: #666;">Created: ${new Date(item.created_at).toLocaleString()}</p>
                    `;

                modal.classList.add('show');
            }
        } catch (error) {
            console.error('查看作品失败:', error);
        }
    }

    function closeGalleryModal() {
        const modal = document.getElementById('galleryModal');
        modal.classList.remove('show');
    }

    async function likeGalleryItem(itemId) {
        try {
            // 获取当前点赞数
            const { data: item } = await supabase
                .from('gallery')
                .select('likes')
                .eq('id', itemId)
                .single();

            const newLikes = (item?.likes || 0) + 1;

            // 更新点赞数
            const { error } = await supabase
                .from('gallery')
                .update({ likes: newLikes })
                .eq('id', itemId);

            if (!error) {
                // 刷新当前过滤器的内容
                const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
                loadGalleryItems(activeFilter);
            }
        } catch (error) {
            console.error('点赞失败:', error);
        }
    }

    async function deleteGalleryItem(itemId) {
    if (!confirm('确定要从Gallery中删除这个作品吗？')) {
        return;
    }

    try {
        // 先获取作品信息，以便删除相关文件
        const { data: item, error: fetchError } = await supabase
            .from('gallery')
            .select('*')
            .eq('id', itemId)
            .single();

        if (fetchError || !item) {
            console.error('获取作品信息失败:', fetchError);
            alert('删除失败');
            return;
        }

        console.log('准备删除Gallery作品:', item);
        const filesToDelete = [];
        
        // 从URL中提取文件路径的辅助函数
        const extractFileNameFromUrl = (url) => {
            if (!url || typeof url !== 'string') return null;
            
            // 检查是否是Supabase Storage URL
            const storageUrlPattern = /\/storage\/v1\/object\/public\/design-files\/(.+)/;
            const match = url.match(storageUrlPattern);
            return match ? match[1] : null;
        };

        // 1. 删除SVG文件
        if (item.svg_url) {
            const svgFileName = extractFileNameFromUrl(item.svg_url);
            if (svgFileName) {
                filesToDelete.push(svgFileName);
                console.log('添加SVG文件到删除列表:', svgFileName);
            }
        }

        // 2. 删除预览图（如果存储在Storage中）
        if (item.preview_image) {
            const previewFileName = extractFileNameFromUrl(item.preview_image);
            if (previewFileName) {
                filesToDelete.push(previewFileName);
                console.log('添加预览图到删除列表:', previewFileName);
            }
        }

        // 3. 如果有关联的draft，也获取draft相关文件
        if (item.draft_id) {
            const { data: draft } = await supabase
                .from('drafts')
                .select('*')
                .eq('id', item.draft_id)
                .single();

            if (draft && draft.data) {
                // 从draft的data中提取storage文件
                if (draft.data.storageUrl) {
                    const draftFileName = extractFileNameFromUrl(draft.data.storageUrl);
                    if (draftFileName && !filesToDelete.includes(draftFileName)) {
                        filesToDelete.push(draftFileName);
                        console.log('添加关联草稿文件:', draftFileName);
                    }
                }
                
                if (draft.data.fileName && !filesToDelete.includes(draft.data.fileName)) {
                    filesToDelete.push(draft.data.fileName);
                    console.log('添加关联草稿文件(fileName):', draft.data.fileName);
                }
            }
        }

        // 去重
        const uniqueFilesToDelete = [...new Set(filesToDelete)];
        console.log('准备删除的Storage文件:', uniqueFilesToDelete);

        // 批量删除Storage文件
        if (uniqueFilesToDelete.length > 0) {
            console.log('开始删除Storage文件...');
            
            const { data: deleteResult, error: storageError } = await supabase.storage
                .from('design-files')
                .remove(uniqueFilesToDelete);
            
            if (storageError) {
                console.error('删除Storage文件失败:', storageError);
                // 不中断流程，继续删除数据库记录
            } else {
                console.log('Storage文件删除成功:', deleteResult);
            }
        }

        // 删除相关的点赞记录
        const { error: likesError } = await supabase
            .from('gallery_likes')
            .delete()
            .eq('gallery_id', itemId);
        
        if (likesError) {
            console.error('删除点赞记录失败:', likesError);
        }

        // 删除相关的remix记录
        const { error: remixError } = await supabase
            .from('gallery_remixes')
            .delete()
            .eq('gallery_id', itemId);
        
        if (remixError) {
            console.error('删除remix记录失败:', remixError);
        }

        // 最后删除gallery记录
        const { error: deleteError } = await supabase
            .from('gallery')
            .delete()
            .eq('id', itemId);

        if (deleteError) {
            console.error('删除Gallery记录失败:', deleteError);
            alert('删除失败');
        } else {
            console.log('✅ Gallery作品删除成功');
            alert('作品已从Gallery中删除');
            
            // 刷新列表
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            loadGalleryItems(activeFilter);
        }
        
    } catch (error) {
        console.error('删除过程出错:', error);
        alert('删除失败');
    }
}</script><script defer="defer" src="/js/vendors.08ee64c9e60251b5d335.js"></script><script defer="defer" src="/js/styles.7aae21adbc8ce89b8327.js"></script><script defer="defer" src="/js/828.d126fe50deaa4b3f2d88.js"></script><script defer="defer" src="/js/33.545769f2acdaaebe9ae3.js"></script><script defer="defer" src="/js/798.b0cf1e47f6c8f7e444c1.js"></script><script defer="defer" src="/js/global.9e411c2b11604bb8b1b6.js"></script>