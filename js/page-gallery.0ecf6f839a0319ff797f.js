/*! For license information please see page-gallery.0ecf6f839a0319ff797f.js.LICENSE.txt */
(()=>{function e(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return r(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function t(){var e,r,a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",l=a.toStringTag||"@@toStringTag";function o(t,a,i,l){var o=a&&a.prototype instanceof c?a:c,u=Object.create(o.prototype);return n(u,"_invoke",function(t,n,a){var i,l,o,c=0,u=a||[],d=!1,f={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(r,t){return i=r,l=0,o=e,f.n=t,s}};function p(t,n){for(l=t,o=n,r=0;!d&&c&&!a&&r<u.length;r++){var a,i=u[r],p=f.p,y=i[2];t>3?(a=y===n)&&(o=i[(l=i[4])?5:(l=3,3)],i[4]=i[5]=e):i[0]<=p&&((a=t<2&&p<i[1])?(l=0,f.v=n,f.n=i[1]):p<y&&(a=t<3||i[0]>n||n>y)&&(i[4]=t,i[5]=n,f.n=y,l=0))}if(a||t>1)return s;throw d=!0,n}return function(a,u,y){if(c>1)throw TypeError("Generator is already running");for(d&&1===u&&p(u,y),l=u,o=y;(r=l<2?e:o)||!d;){i||(l?l<3?(l>1&&(f.n=-1),p(l,o)):f.n=o:f.v=o);try{if(c=2,i){if(l||(a="next"),r=i[a]){if(!(r=r.call(i,o)))throw TypeError("iterator result is not an object");if(!r.done)return r;o=r.value,l<2&&(l=0)}else 1===l&&(r=i.return)&&r.call(i),l<2&&(o=TypeError("The iterator does not provide a '"+a+"' method"),l=1);i=e}else if((r=(d=f.n<0)?o:t.call(n,f))!==s)break}catch(r){i=e,l=1,o=r}finally{c=1}}return{value:r,done:d}}}(t,i,l),!0),u}var s={};function c(){}function u(){}function d(){}r=Object.getPrototypeOf;var f=[][i]?r(r([][i]())):(n(r={},i,function(){return this}),r),p=d.prototype=c.prototype=Object.create(f);function y(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,n(e,l,"GeneratorFunction")),e.prototype=Object.create(p),e}return u.prototype=d,n(p,"constructor",d),n(d,"constructor",u),u.displayName="GeneratorFunction",n(d,l,"GeneratorFunction"),n(p),n(p,l,"Generator"),n(p,i,function(){return this}),n(p,"toString",function(){return"[object Generator]"}),(t=function(){return{w:o,m:y}})()}function n(e,r,t,a){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}n=function(e,r,t,a){if(r)i?i(e,r,{value:t,enumerable:!a,configurable:!a,writable:!a}):e[r]=t;else{var l=function(r,t){n(e,r,function(e){return this._invoke(r,t,e)})};l("next",0),l("throw",1),l("return",2)}},n(e,r,t,a)}function a(e,r,t,n,a,i,l){try{var o=e[i](l),s=o.value}catch(e){return void t(e)}o.done?r(s):Promise.resolve(s).then(n,a)}function i(e){return function(){var r=this,t=arguments;return new Promise(function(n,i){var l=e.apply(r,t);function o(e){a(l,n,i,o,s,"next",e)}function s(e){a(l,n,i,o,s,"throw",e)}o(void 0)})}}function l(){return o.apply(this,arguments)}function o(){return(o=i(t().m(function e(){var r;return t().w(function(e){for(;;)switch(e.n){case 0:if(document.getElementById("galleryGrid")){e.n=1;break}return e.a(2);case 1:return(r=document.querySelectorAll(".filter-btn")).forEach(function(e){e.addEventListener("click",function(){r.forEach(function(e){return e.classList.remove("active")}),this.classList.add("active"),s(this.dataset.filter)})}),e.n=2,s("all");case 2:return e.a(2)}},e)}))).apply(this,arguments)}function s(){return c.apply(this,arguments)}function c(){return c=i(t().m(function r(){var n,a,i,l,o,s,c,u,d,f,p,y,m,g,v,b,h,w,k,_=arguments;return t().w(function(r){for(;;)switch(r.p=r.n){case 0:if(n=_.length>0&&void 0!==_[0]?_[0]:"all",a=document.getElementById("galleryGrid")){r.n=1;break}return r.a(2);case 1:return a.innerHTML='<div class="loading">Loading gallery...</div>',r.p=2,i=null,r.n=3,supabase.auth.getUser();case 3:return l=r.v,(o=l.data.user)&&(i=o.id),s=supabase.from("gallery").select("*"),s="mine"===n&&i?s.eq("user_id",i):"popular"===n?s.order("likes",{ascending:!1}).limit(20):"curated"===n?s.gte("likes",5).order("likes",{ascending:!1}):s.order("created_at",{ascending:!1}),r.n=4,s;case 4:if(c=r.v,u=c.data,!c.error){r.n=5;break}return a.innerHTML='<div class="empty-gallery"><h2>加载失败</h2><p>请稍后重试</p></div>',r.a(2);case 5:if(u&&0!==u.length){r.n=6;break}return a.innerHTML='\n            <div class="empty-gallery">\n                <h2>No artworks yet</h2>\n                <p>Be the first to add your creation to the gallery!</p>\n            </div>\n        ',r.a(2);case 6:return d=e(new Set(u.map(function(e){return e.user_id}))),r.n=7,supabase.from("profiles").select("user_id, manifesto").in("user_id",d);case 7:if(f=r.v,p=f.data,y={},p&&p.forEach(function(e){y[e.user_id]=e.manifesto}),m=new Set,g=new Set,!i){r.n=10;break}return v=u.map(function(e){return e.id}),r.n=8,supabase.from("gallery_likes").select("gallery_id").eq("user_id",i).in("gallery_id",v);case 8:return b=r.v,(h=b.data)&&h.forEach(function(e){return m.add(e.gallery_id)}),r.n=9,supabase.from("gallery_remixes").select("gallery_id").eq("user_id",i).in("gallery_id",v);case 9:w=r.v,(k=w.data)&&k.forEach(function(e){return g.add(e.gallery_id)});case 10:a.innerHTML=u.map(function(e){var r=y[e.user_id]||"Anonymous",t=new Date(e.created_at).toLocaleDateString(),n=i===e.user_id,a=m.has(e.id),l=g.has(e.id);return'\n            <div class="gallery-item" data-id="'.concat(e.id,'">\n                <img src="').concat(e.preview_image,'" alt="').concat(e.title,'" onclick="viewGalleryItem(\'').concat(e.id,'\')">\n                <div class="gallery-item-info">\n                    <div class="gallery-item-title">').concat(e.title||"Untitled",'</div>\n                    <div class="gallery-item-author">by ').concat(r,'</div>\n                    <div class="gallery-item-date">').concat(t,'</div>\n                    <div class="gallery-item-actions">\n                        <button class="action-btn ').concat(a?"liked":"",'" \n                                onclick="toggleLike(\'').concat(e.id,"')\"\n                                ").concat(i?"":'disabled title="请先登录"',">\n                            LIKE ").concat(e.likes||0,'\n                        </button>\n                        <button class="action-btn ').concat(l?"remixed":"",'" \n                                onclick="remixGalleryItem(\'').concat(e.id,"')\"\n                                ").concat(i?"":'disabled title="请先登录"',">\n                            REMIX ").concat(e.remix_count||0,"\n                        </button>\n                        ").concat(n?'<button class="action-btn" onclick="deleteGalleryItem(\''.concat(e.id,"')\">DELETE</button>"):"","\n                    </div>\n                </div>\n            </div>\n        ")}).join(""),r.n=12;break;case 11:r.p=11,r.v,a.innerHTML='<div class="empty-gallery"><h2>出错了</h2><p>请刷新页面重试</p></div>';case 12:return r.a(2)}},r,null,[[2,11]])})),c.apply(this,arguments)}function u(){return(u=i(t().m(function e(r){var n,a,i,l,o,s,c,u,f,p,y,m,g,v,b,h;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.auth.getUser();case 1:if(n=e.v,a=n.data.user){e.n=2;break}return alert("请先登录"),e.a(2);case 2:if(i=document.querySelector("[onclick=\"toggleLike('".concat(r,"')\"]"))){e.n=3;break}return e.a(2);case 3:return i.disabled=!0,i.textContent,e.n=4,supabase.from("gallery_likes").select("id").eq("user_id",a.id).eq("gallery_id",r).single();case 4:if(l=e.v,!(o=l.data)){e.n=9;break}return e.n=5,supabase.from("gallery_likes").delete().eq("id",o.id);case 5:if(u=e.v,!(f=u.error)){e.n=6;break}throw f;case 6:return e.n=7,supabase.from("gallery").select("likes").eq("id",r).single();case 7:return p=e.v,y=p.data,s=Math.max(0,((null==y?void 0:y.likes)||0)-1),c=!1,e.n=8,supabase.from("gallery").update({likes:s}).eq("id",r);case 8:e.n=13;break;case 9:return e.n=10,supabase.from("gallery_likes").insert([{user_id:a.id,gallery_id:r}]);case 10:if(m=e.v,!(g=m.error)){e.n=11;break}throw g;case 11:return e.n=12,supabase.from("gallery").select("likes").eq("id",r).single();case 12:return v=e.v,b=v.data,s=((null==b?void 0:b.likes)||0)+1,c=!0,e.n=13,supabase.from("gallery").update({likes:s}).eq("id",r);case 13:d(i,s,c),e.n=15;break;case 14:e.p=14,e.v,alert("操作失败，请重试"),(h=document.querySelector("[onclick=\"toggleLike('".concat(r,"')\"]")))&&(h.disabled=!1);case 15:return e.a(2)}},e,null,[[0,14]])}))).apply(this,arguments)}function d(e,r,t){e.textContent="LIKE ".concat(r),t?e.classList.add("liked"):e.classList.remove("liked"),e.disabled=!1}function f(){return(f=i(t().m(function e(r){var n,a,i,l,o,s,c,u,d;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.auth.getUser();case 1:if(n=e.v,a=n.data.user){e.n=2;break}return alert("请先登录"),e.a(2);case 2:return e.n=3,supabase.from("gallery").select("*").eq("id",r).single();case 3:if(i=e.v,l=i.data,!i.error&&l){e.n=4;break}return alert("无法获取作品信息"),e.a(2);case 4:return e.n=5,supabase.from("gallery_remixes").select("id").eq("user_id",a.id).eq("gallery_id",r).maybeSingle();case 5:if(o=e.v,s=o.data,s){e.n=9;break}return e.n=6,supabase.from("gallery_remixes").insert([{user_id:a.id,gallery_id:r}]);case 6:if(c=e.v,u=c.error){e.n=8;break}return d=(l.remix_count||0)+1,e.n=7,supabase.from("gallery").update({remix_count:d}).eq("id",r);case 7:e.n=9;break;case 8:u.code;case 9:if(confirm("Do you really want to remix this artwork?")){e.n=10;break}return e.a(2);case 10:l.draft_id?window.location.href="/?loadSvgDraft=".concat(l.draft_id,"&fromGallery=true"):l.svg_url?window.location.href="/?loadSvgUrl=".concat(encodeURIComponent(l.svg_url)):l.svg_data?(sessionStorage.setItem("remixSvgData",l.svg_data),window.location.href="/?loadRemixData=true"):alert("该作品没有可用的源文件"),e.n=12;break;case 11:e.p=11,e.v,alert("Remix失败，请重试");case 12:return e.a(2)}},e,null,[[0,11]])}))).apply(this,arguments)}function p(e){return y.apply(this,arguments)}function y(){return(y=i(t().m(function e(r){var n,a,i,l,o;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("gallery").select("*").eq("id",r).single();case 1:n=e.v,a=n.data,!n.error&&a&&(i=document.getElementById("galleryModal"),l=document.getElementById("modalImage"),o=document.getElementById("modalInfo"),l.src=a.svg_url||a.preview_image,o.innerHTML="\n                    <h3>".concat(a.title||"Untitled","</h3>\n                    <p>").concat(a.description||"",'</p>\n                    <p style="margin-top: 10px; color: #666;">Created: ').concat(new Date(a.created_at).toLocaleString(),"</p>\n                "),i.classList.add("show")),e.n=3;break;case 2:e.p=2,e.v;case 3:return e.a(2)}},e,null,[[0,2]])}))).apply(this,arguments)}function m(){document.getElementById("galleryModal").classList.remove("show")}function g(e){return v.apply(this,arguments)}function v(){return(v=i(t().m(function e(r){var n,a,i,l;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("gallery").select("likes").eq("id",r).single();case 1:return n=e.v,a=n.data,i=((null==a?void 0:a.likes)||0)+1,e.n=2,supabase.from("gallery").update({likes:i}).eq("id",r);case 2:l=e.v,l.error||s(document.querySelector(".filter-btn.active").dataset.filter),e.n=4;break;case 3:e.p=3,e.v;case 4:return e.a(2)}},e,null,[[0,3]])}))).apply(this,arguments)}function b(){return(b=i(t().m(function r(n){var a,i,l,o,c,u,d,f,p,y,m,g,v,b;return t().w(function(r){for(;;)switch(r.p=r.n){case 0:if(confirm("确定要从Gallery中删除这个作品吗？")){r.n=1;break}return r.a(2);case 1:return r.p=1,r.n=2,supabase.from("gallery").select("*").eq("id",n).single();case 2:if(a=r.v,i=a.data,!a.error&&i){r.n=3;break}return alert("删除失败"),r.a(2);case 3:if(l=[],o=function(e){if(!e||"string"!=typeof e)return null;var r=e.match(/\/storage\/v1\/object\/public\/design-files\/(.+)/);return r?r[1]:null},i.svg_url&&(c=o(i.svg_url))&&l.push(c),i.preview_image&&(u=o(i.preview_image))&&l.push(u),!i.draft_id){r.n=5;break}return r.n=4,supabase.from("drafts").select("*").eq("id",i.draft_id).single();case 4:d=r.v,(f=d.data)&&f.data&&(f.data.storageUrl&&(p=o(f.data.storageUrl))&&!l.includes(p)&&l.push(p),f.data.fileName&&!l.includes(f.data.fileName)&&l.push(f.data.fileName));case 5:if(!((y=e(new Set(l))).length>0)){r.n=7;break}return r.n=6,supabase.storage.from("design-files").remove(y);case 6:m=r.v,m.data,m.error;case 7:return r.n=8,supabase.from("gallery_likes").delete().eq("gallery_id",n);case 8:return g=r.v,g.error,r.n=9,supabase.from("gallery_remixes").delete().eq("gallery_id",n);case 9:return v=r.v,v.error,r.n=10,supabase.from("gallery").delete().eq("id",n);case 10:b=r.v,b.error?alert("删除失败"):(alert("作品已从Gallery中删除"),s(document.querySelector(".filter-btn.active").dataset.filter)),r.n=12;break;case 11:r.p=11,r.v,alert("删除失败");case 12:return r.a(2)}},r,null,[[1,11]])}))).apply(this,arguments)}setTimeout(function(){if("undefined"!=typeof supabase)l();else var e=setInterval(function(){"undefined"!=typeof supabase&&(clearInterval(e),l())},100)},100),window.viewGalleryItem=p,window.closeGalleryModal=m,window.likeGalleryItem=g,window.viewGalleryItem=p,window.closeGalleryModal=m,window.likeGalleryItem=g,window.toggleLike=function(e){return u.apply(this,arguments)},window.remixGalleryItem=function(e){return f.apply(this,arguments)},window.deleteGalleryItem=function(e){return b.apply(this,arguments)}})();