"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[828],{45828:(e,t,n)=>{var r=n(18979),a=n.n(r),i=n(16781),c=n.n(i),o=n(39841),s=n.n(o),l=n(26100),u=n.n(l),d=n(78928),f=n.n(d),p=n(36751),v=n.n(p),h=n(25110),g=n.n(h),m=n(53930),b=n.n(m),y=n(5773),w=n(27842),x=n(49859),k=n(85073),E=n(34963),L=n(44828),I=n.n(L),S=n(49763),B=n.n(S),C=n(48079),A=n.n(C),M=n(11393),T=n.n(M),D=n(86226),R=n.n(D),q=n(29544),z=n.n(q),U=n(64007),P=n.n(U),_=n(385),H=n.n(_),N=n(36586),O=n.n(N),W=n(61240),X=n.n(W),G=n(8628),Y=n.n(G),j=n(56255),F=n.n(j),V=n(165),Q=n.n(V),$=n(43981),J=n.n($),K=n(66615),Z=n.n(K),ee=n(14166),te=n.n(ee),ne=n(11265),re=n.n(ne),ae=n(73363),ie=n.n(ae),ce=n(57119),oe=n.n(ce),se=n(50697),le=n.n(se),ue=n(14607),de=n.n(ue),fe=n(96984),pe=n.n(fe),ve=n(29550),he=n.n(ve),ge=n(31721),me=n.n(ge),be=n(96319),ye=n.n(be),we=n(66512),xe=n.n(we),ke=n(38573),Ee=n.n(ke),Le=n(20354),Ie=n.n(Le);function Se(e,t){var n=le()(e);if(u()){var r=u()(e);t&&(r=ye()(r).call(r,function(t){return f()(e,t).enumerable})),n.push.apply(n,r)}return n}function Be(e){for(var t=1;t<arguments.length;t++){var n,r,a=null!=arguments[t]?arguments[t]:{};t%2?R()(n=Se(Object(a),!0)).call(n,function(t){(0,x.A)(e,t,a[t])}):v()?g()(e,v()(a)):R()(r=Se(Object(a))).call(r,function(t){b()(e,t,f()(a,t))})}return e}function Ce(e,t){var n=void 0!==c()&&s()(e)||e["@@iterator"];if(!n){if(Z()(e)||(n=function(e,t){if(e){var n;if("string"==typeof e)return Ae(e,t);var r=a()(n={}.toString.call(e)).call(n,8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?B()(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ae(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,l=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return l=e.done,e},e:function(e){u=!0,o=e},f:function(){try{l||null==n.return||n.return()}finally{if(u)throw o}}}}function Ae(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}!function(e){if(!window.contentPageLoaded){window.contentPageLoaded=!0,window.cleanupContentPage=function(){window.contentPageLoaded=!1,void 0!==window.isTransferring&&(window.isTransferring=!1),void 0!==window.transferLock&&(window.transferLock=!1);var e=document.getElementById("mySVG");e&&e._contentEventHandlers;var t=document.querySelectorAll(".svg-drawing");if(t.length>1)for(var n=1;n<t.length;n++)t[n].remove()};var t="front",n="white",r=[],a=null,i=!1,c=!1,o=null,s=0,l=0,u=0,d=0,f=0,p=0,v=1,h=document.getElementById("tshirtContainer"),g=document.getElementById("tshirtBackground"),m=document.getElementById("resizeHandles"),b=(document.getElementById("tshirtImage"),document.getElementById("colorPicker"),{front:[],back:[]}),x={front:!1,back:!1},L={front:null,back:null};document.addEventListener("DOMContentLoaded",function(){at(),F()(function(){"function"==typeof window.displayUserProfile&&window.displayUserProfile().catch(function(e){})},1e3)}),"undefined"!=typeof supabase&&supabase.auth.onAuthStateChange(function(e,t){"SIGNED_IN"===e?F()(function(){"function"==typeof window.displayUserProfile&&window.displayUserProfile()},500):"SIGNED_OUT"===e&&x&&Se()}),window.addEventListener("resize",function(){F()(function(){a&&(dt(),lt())},100)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",it):it(),document.addEventListener("mousemove",function(e){if(i&&a){var t=e.clientX-s,n=e.clientY-l;a.style.left=t+"px",a.style.top=n+"px",lt()}else c&&function(e){if(c&&a){var t=e.clientX-s,n=e.clientY-l,r=u,i=d,h=f,g=p;switch(o){case"nw":h=f+t,g=p+(d-(i=(r=u-t)/v));break;case"n":h=f-((r=(i=d-n)*v)-u)/2,g=p+n;break;case"ne":g=p+(d-(i=(r=u+t)/v));break;case"e":g=p-((i=(r=u+t)/v)-d)/2;break;case"se":i=(r=u+t)/v;break;case"s":h=f-((r=(i=d+n)*v)-u)/2;break;case"sw":i=(r=u-t)/v,h=f+t;break;case"w":h=f+t,g=p-((i=(r=u-t)/v)-d)/2}r<20||i<20||(a.style.width=r+"px",a.style.height=i+"px",a.style.left=h+"px",a.style.top=g+"px",lt())}}(e)}),document.addEventListener("mouseup",function(){i=!1,c=!1,o=null,a&&a.classList.remove("dragging")}),h.addEventListener("click",function(e){e.target.classList.contains("uploaded-image")||ot()}),document.addEventListener("dragstart",function(e){e.preventDefault()}),document.addEventListener("dragover",function(e){e.preventDefault()}),document.addEventListener("keydown",function(e){"Delete"===e.key&&a?vt():"Escape"===e.key&&ot()}),window.addEventListener("resize",function(){a&&lt()}),document.addEventListener("click",function(e){e.target.closest(".color-option")&&Ke(e.target.closest(".color-option").dataset.color);if(!e.target.closest("#colorBtn")&&!e.target.closest(".color-menu")){var t=document.getElementById("colorMenu");t&&t.classList.contains("show")&&(t.classList.add("hidden"),t.classList.remove("show"))}});var S=document.getElementById("saveModal");if(S){S.addEventListener("click",function(e){e.target===S&&qe()});var C=document.getElementById("memberCodeBtn");C&&C.addEventListener("click",function(){return Ae.apply(this,arguments)})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",gt):gt(),R()(e=document.querySelectorAll(".quantity-control")).call(e,function(e){var t=e.querySelector(".quantity-input");t.addEventListener("change",function(){var e=O()(t.value);isNaN(e)||e<0?t.value=0:e>99&&(t.value=99)})}),document.addEventListener("DOMContentLoaded",(0,E.A)(I().mark(function e(){var t,n;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=1,Mt();case 1:if(!window.CartManager||"function"!=typeof window.CartManager.initCartIcon){e.next=2;break}return e.next=2,window.CartManager.initCartIcon();case 2:(n=document.getElementById("saveToDraftBtn"))&&n.addEventListener("click",(0,E.A)(I().mark(function e(){return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.textContent="SAVING...",this.disabled=!0,e.next=1,Oe();case 1:this.textContent="SAVE TO DRAFT",this.disabled=!1;case 2:case"end":return e.stop()}},e,this)}))),R()(t=document.querySelectorAll(".quantity-input")).call(t,function(e){e.addEventListener("change",function(){var e=O()(this.value)||0;e<0&&(this.value=0),e>99&&(this.value=99)}),e.addEventListener("input",function(){this.value=this.value.replace(/[^0-9]/g,"")})});case 3:case"end":return e.stop()}},e)})));var M,D,q,U,_,N=!1,W=null,G=[],j=-1,V="pencil",$=2,K=1,ee=3,ne=!1,ae=0,ce=0,se=null;window.__svgModalHandlerBound||(window.__svgModalHandlerBound=!0,document.addEventListener("mousedown",function(e){"saveSvgModal"===e.target.id&&(e.preventDefault(),tn())},!0),document.addEventListener("click",function(e){"saveSvgModal"===e.target.id&&(e.preventDefault(),e.stopPropagation(),tn())},!0)),window.isTransferring||(window.isTransferring=!1),window.transferLock||(window.transferLock=!1),window.transferToTShirt=cn,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",gn):gn(),window.addEventListener("resize",function(){q&&zt()})}function ue(){var e=B()(h.querySelectorAll(".uploaded-image"));b[t]=A()(e).call(e,function(e){return{src:e.src,className:e.className,style:{width:e.style.width,height:e.style.height,left:e.style.left,top:e.style.top},dataset:{aspectRatio:e.dataset.aspectRatio},isMemberCode:e.classList.contains("member-code-image")}})}function fe(){var e=document.getElementById("memberCodeBtn");if(e){var n=x[t];e.textContent=n?"REMOVE MEMBER CODE":"INSERT MEMBER CODE"}}function ve(){return ge.apply(this,arguments)}function ge(){return(ge=(0,E.A)(I().mark(function e(){var t;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=document.getElementById("member-barcode-complete"))||!t.src||"none"===t.style.display){e.next=1;break}return e.abrupt("return",t.src);case 1:return e.next=2,be();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)}))).apply(this,arguments)}function be(){return we.apply(this,arguments)}function we(){return(we=(0,E.A)(I().mark(function e(){var t,n,r,a,i,c;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"undefined"!=typeof supabase){e.next=1;break}return e.abrupt("return",null);case 1:return e.next=2,supabase.auth.getUser();case 2:if(t=e.sent,n=t.data.user){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=4,supabase.from("profiles").select("manifesto, barcode").eq("user_id",n.id).single();case 4:if(r=e.sent,a=r.data,!r.error&&a){e.next=5;break}return e.abrupt("return",null);case 5:if(void 0===window.barcodeGenerator){e.next=7;break}return(i=document.createElement("img")).style.display="none",document.body.appendChild(i),e.next=6,window.barcodeGenerator.generateBarcodeImage(a.manifesto||"No manifesto",a.barcode,i.id||"temp-barcode");case 6:return c=e.sent,document.body.removeChild(i),e.abrupt("return",c);case 7:return e.abrupt("return",null);case 8:return e.prev=8,e.catch(0),e.abrupt("return",null);case 9:case"end":return e.stop()}},e,null,[[0,8]])}))).apply(this,arguments)}function ke(){return Le.apply(this,arguments)}function Le(){return(Le=(0,E.A)(I().mark(function e(){var n;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!x[t]){e.next=1;break}return e.abrupt("return");case 1:return e.next=2,ve();case 2:if(n=e.sent){e.next=3;break}return alert("无法获取会员码，请确保已登录"),e.abrupt("return");case 3:return e.abrupt("return",new(X())(function(e,r){var a=new Image;a.onload=function(){var r=document.createElement("img");r.className="uploaded-image member-code-image",r.src=n,r.style.width="160px",r.style.height="auto";var a=h.offsetWidth||400;r.style.left=(a-160)/2+"px";var i=window.innerWidth<=899;r.style.top=i?"105px":"120px",r.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,h.appendChild(r),L[t]=r,x[t]=!0,rt(r),fe(),e(r)},a.onerror=function(){alert("会员码图片加载失败"),r(new Error("会员码图片加载失败"))},a.src=n}));case 4:throw e.prev=4,e.catch(0);case 5:case"end":return e.stop()}},e,null,[[0,4]])}))).apply(this,arguments)}function Se(){var e=L[t];if(e||(e=h.querySelector(".member-code-image")),e&&h.contains(e)){a===e&&ot(),h.removeChild(e);var n=P()(r).call(r,e);n>-1&&H()(r).call(r,n,1)}L[t]=null,x[t]=!1,fe();h.querySelector(".member-code-image")}function Ae(){return(Ae=(0,E.A)(I().mark(function e(){return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!x[t]){e.next=1;break}Se(),e.next=2;break;case 1:return e.next=2,ke();case 2:case"end":return e.stop()}},e)}))).apply(this,arguments)}function Me(){ue();var e=document.getElementById("saveModal"),t=document.getElementById("frontPreview"),n=document.getElementById("backPreview");e&&t&&n&&(Re("front",t),Re("back",n),e.classList.remove("hidden"))}function Te(e,t,n){return De.apply(this,arguments)}function De(){return De=(0,E.A)(I().mark(function e(t,n,r){var a,i,c,o,s,l,u,d,f,p,v,h,g,m,b=arguments;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=b.length>3&&void 0!==b[3]?b[3]:800,e.prev=1,t&&Q()(t).call(t,"data:image/")){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=3,supabase.auth.getUser();case 3:if(c=e.sent,o=c.data.user,!c.error&&o){e.next=4;break}return e.abrupt("return",null);case 4:return e.next=5,Ue(t,a,.8);case 5:if(s=e.sent){e.next=6;break}return e.abrupt("return",null);case 6:return l=ze(s),u=T()(i="".concat(n,"/images/")).call(i,r),e.next=7,supabase.storage.from("design-files").upload(u,l,{cacheControl:"3600",upsert:!0,contentType:l.type});case 7:if(d=e.sent,d.data,!(f=d.error)){e.next=13;break}if(!(null!==(p=f.message)&&void 0!==p&&Y()(p).call(p,"duplicate")||null!==(v=f.message)&&void 0!==v&&Y()(v).call(v,"already exists"))){e.next=12;break}return e.next=8,supabase.storage.from("design-files").remove([u]);case 8:return e.next=9,supabase.storage.from("design-files").upload(u,l,{cacheControl:"3600",upsert:!0,contentType:l.type});case 9:if(h=e.sent,h.data,!h.error){e.next=10;break}return e.abrupt("return",null);case 10:(0,k.A)("data");case 11:e.next=13;break;case 12:return e.abrupt("return",null);case 13:if(g=supabase.storage.from("design-files").getPublicUrl(u),m=g.data.publicUrl){e.next=14;break}return e.abrupt("return",null);case 14:return e.abrupt("return",{fileName:u,publicUrl:m,size:l.size,optimized:!0,uploadTime:(new Date).toISOString()});case 15:return e.prev=15,e.catch(1),e.abrupt("return",null);case 16:case"end":return e.stop()}},e,null,[[1,15]])})),De.apply(this,arguments)}function Re(e,t){t.innerHTML="";var r={front:{white:"./images/white-front.png",black:"./images/black-front.png"},back:{white:"./images/white-back.png",black:"./images/black-back.png"}},a=r[e]&&r[e][n]?r[e][n]:"./images/white-front.png",i=document.createElement("img");i.src=a,i.crossOrigin="anonymous",i.style.cssText="\n        position: absolute;\n        top: 50%;\n        margin-top: -50%;\n        left: 0;\n        width: 100%;\n        object-fit: contain;\n        z-index: 1;\n    ",t.appendChild(i),t.style.cssText="\n        position: relative;\n        background: white;\n        overflow: hidden;\n        border: 0 ; \n    ";var c,o,s,l,u,d,f=window.innerWidth<=899,p=h.offsetWidth||400,v=h.offsetHeight||500;if(f?(c=120,o=150):(c=200,o=250),f){var g=c/p,m=o/v;s=.9*Math.min(g,m),l=(c-p*s)/2,u=(o-v*s)/2+2}else{var y=c/p,w=o/v;s=1.4*Math.min(y,w),l=(c-p*s)/2,u=(o-v*s)/2+3}b[e]&&b[e].length>0&&R()(d=b[e]).call(d,function(e,n){var r=document.createElement("img");r.src=e.src,r.className="preview-image",r.crossOrigin="anonymous",r.style.cssText="\n                position: absolute;\n                z-index: 10;\n                pointer-events: none;\n            ";var a=O()(e.style.width)*s,i=O()(e.style.height)*s,c=O()(e.style.left)*s+l,o=O()(e.style.top)*s+u;r.style.width=a+"px",r.style.height=i+"px",r.style.left=c+"px",r.style.top=f?o-5+"px":o-12+"px",t.appendChild(r)})}function qe(){document.getElementById("saveModal").classList.add("hidden")}function ze(e){for(var t=e.split(","),n=t[0].match(/:(.*?);/)[1],r=atob(t[1]),a=r.length,i=new Uint8Array(a),c=0;c<a;c++)i[c]=r.charCodeAt(c);return new Blob([i],{type:n})}function Ue(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return new(X())(function(r){var a=document.createElement("canvas"),i=a.getContext("2d"),c=new Image;c.onload=function(){var c=this.width,o=this.height;if(c>t){var s=t/c;c=t,o*=s}a.width=c,a.height=o,i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.drawImage(this,0,0,c,o);var l="image/jpeg",u=n;if(Y()(e).call(e,"data:image/png")){for(var d=i.getImageData(0,0,c,o).data,f=!1,p=3;p<d.length;p+=4)if(d[p]<255){f=!0;break}f&&(l="image/png",u=void 0)}var v=a.toDataURL(l,u);r(v)},c.src=e})}function Pe(e){return _e.apply(this,arguments)}function _e(){return _e=(0,E.A)(I().mark(function e(t){var n,r,a=arguments;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:1200,r=a.length>2&&void 0!==a[2]?a[2]:"transparent",e.abrupt("return",new(X())(function(e,a){var i=document.createElement("canvas"),c=i.getContext("2d"),o=t.getBoundingClientRect(),s=o.width/o.height;if(i.width=n,i.height=n/s,"transparent"!==r&&(c.fillStyle=r,c.fillRect(0,0,i.width,i.height)),"svg"===t.tagName){var l=(new XMLSerializer).serializeToString(t),u=new Image;u.onload=function(){c.drawImage(this,0,0,i.width,i.height);var t=i.toDataURL("image/png");e(t)},u.onerror=a;var d=new Blob([l],{type:"image/svg+xml"}),f=pe().createObjectURL(d);u.src=f}else Ie()(t,{backgroundColor:"transparent"===r?null:r,useCORS:!0,scale:n/o.width,width:o.width,height:o.height}).then(function(t){var n=t.toDataURL("image/png");e(n)}).catch(a)}));case 1:case"end":return e.stop()}},e)})),_e.apply(this,arguments)}function He(e){return Ne.apply(this,arguments)}function Ne(){return(Ne=(0,E.A)(I().mark(function e(t){var n;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,Pe(t,1200,"transparent");case 1:return n=e.sent,e.abrupt("return",n);case 2:return e.prev=2,e.catch(0),e.abrupt("return",null);case 3:case"end":return e.stop()}},e,null,[[0,2]])}))).apply(this,arguments)}function Oe(){return We.apply(this,arguments)}function We(){return(We=(0,E.A)(I().mark(function e(){var r,a,i,c,o,s,l,u,d,f,p,v,h,g,m,y,x,k,E,L,S,B,C;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(i=e.sent,c=i.data.user,!i.error){e.next=2;break}return alert("认证失败，请重新登录"),e.abrupt("return");case 2:if(c){e.next=3;break}return alert("请先登录"),e.abrupt("return");case 3:if(bt()){e.next=4;break}return alert("请先添加设计元素再保存"),e.abrupt("return");case 4:if(ue(),o=document.getElementById("frontPreview"),s=document.getElementById("backPreview"),o&&s){e.next=5;break}return alert("预览容器未找到，请重试"),e.abrupt("return");case 5:return e.next=6,Xe(o);case 6:return e.next=7,Xe(s);case 7:return l={backgroundColor:"#ffffff",useCORS:!0,allowTaint:!1,removeContainer:!0,scale:1,logging:!1,foreignObjectRendering:!1,imageTimeout:15e3,width:o.offsetWidth,height:o.offsetHeight,onclone:function(e){var t=e.querySelectorAll("img");R()(t).call(t,function(e){e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.transform="none"})}},e.prev=8,e.next=9,Ie()(o,l);case 9:u=e.sent,e.next=12;break;case 10:return e.prev=10,e.catch(8),e.next=11,Fe(o);case 11:u=e.sent;case 12:return e.prev=12,e.next=13,Ie()(s,l);case 13:d=e.sent,e.next=16;break;case 14:return e.prev=14,e.catch(12),e.next=15,Fe(s);case 15:d=e.sent;case 16:return f=Ye(u),p=Ye(d),e.next=17,Qe(b.front,c.id,"front");case 17:return v=e.sent,e.next=18,Qe(b.back,c.id,"back");case 18:return h=e.sent,g=he()(),m=null,y=null,e.prev=19,e.next=20,Te(f,c.id,"".concat(g,"_preview_front.jpg"));case 20:m=e.sent,e.next=22;break;case 21:e.prev=21,e.catch(19);case 22:return e.prev=22,e.next=23,Te(p,c.id,"".concat(g,"_preview_back.jpg"));case 23:y=e.sent,e.next=25;break;case 24:e.prev=24,e.catch(22);case 25:return x=mt(),k={frontImages:A()(r=b.front).call(r,function(e,t){return Be(Be({},e),{},{storageFile:v[t]||null})}),backImages:A()(a=b.back).call(a,function(e,t){return Be(Be({},e),{},{storageFile:h[t]||null})}),color:n,currentView:t,timestamp:(new Date).toISOString(),sizeQuantities:x,frontPreviewFile:m||null,backPreviewFile:y||null},E={user_id:c.id,title:"Customized T-shirt ".concat((new Date).toLocaleString()),type:"tshirt",data:k,front_preview_image:m&&m.publicUrl?m.publicUrl:f,back_preview_image:y&&y.publicUrl?y.publicUrl:p,sizes:x},e.next=26,supabase.from("drafts").insert(E);case 26:L=e.sent,L.data,(S=L.error)?alert("保存失败: ".concat(S.message)):(ye()(B=T()(C=[]).call(C,(0,w.A)(v),(0,w.A)(h))).call(B,function(e){return null!==e}).length,v.length+h.length,alert("SAVED！"),qe()),e.next=28;break;case 27:e.prev=27,e.catch(0),alert("保存失败，请检查控制台了解详情");case 28:case"end":return e.stop()}},e,null,[[0,27],[8,10],[12,14],[19,21],[22,24]])}))).apply(this,arguments)}function Xe(e){return Ge.apply(this,arguments)}function Ge(){return Ge=(0,E.A)(I().mark(function e(t){var n,r,a;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.querySelectorAll("img"),a=A()(n=B()(r)).call(n,function(e){return new(X())(function(t){if(e.complete&&e.naturalWidth>0)t();else{var n=function(){e.removeEventListener("load",n),e.removeEventListener("error",n),t()};e.addEventListener("load",n),e.addEventListener("error",n),F()(t,5e3)}})}),e.next=1,X().all(a);case 1:return e.next=2,new(X())(function(e){return F()(e,500)});case 2:case"end":return e.stop()}},e)})),Ge.apply(this,arguments)}function Ye(e){if(!e||0===e.width||0===e.height)return je();for(var t=e.getContext("2d").getImageData(0,0,e.width,e.height).data,n=!1,r=0,a=0;a<t.length;a+=4){var i=t[a],c=t[a+1],o=t[a+2],s=t[a+3];r+=s,s>0&&(255!==i||255!==c||255!==o)&&(n=!0)}return!n||r<.1*t.length?je():e.toDataURL("image/jpeg",.9)}function je(){var e=document.createElement("canvas");e.width=200,e.height=250;var t=e.getContext("2d");return t.fillStyle="#ffffff",t.fillRect(0,0,e.width,e.height),t.fillStyle="#f0f0f0",t.fillRect(50,50,100,150),t.fillStyle="#666",t.font="14px Arial",t.textAlign="center",t.fillText("预览图",e.width/2,e.height/2),e.toDataURL("image/jpeg",.9)}function Fe(e){return Ve.apply(this,arguments)}function Ve(){return Ve=(0,E.A)(I().mark(function e(t){var n,r,a,i,c,o,s,l,u,d,f,p,v;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=document.createElement("canvas"),r=n.getContext("2d"),n.width=t.offsetWidth||200,n.height=t.offsetHeight||250,r.fillStyle="#ffffff",r.fillRect(0,0,n.width,n.height),(a=t.querySelector("img:first-child"))&&a.complete)try{r.drawImage(a,0,0,n.width,n.height)}catch(e){}i=t.querySelectorAll("img:not(:first-child)"),c=Ce(i);try{for(c.s();!(o=c.n()).done;)if((s=o.value).complete&&s.naturalWidth>0)try{l=s.getBoundingClientRect(),u=t.getBoundingClientRect(),d=l.left-u.left,f=l.top-u.top,p=l.width,v=l.height,r.drawImage(s,d,f,p,v)}catch(e){}}catch(e){c.e(e)}finally{c.f()}return e.abrupt("return",n);case 1:case"end":return e.stop()}},e)})),Ve.apply(this,arguments)}function Qe(e,t,n){return $e.apply(this,arguments)}function $e(){return($e=(0,E.A)(I().mark(function e(t,n,r){var a,i,c,o,s,l,u,d,f,p,v,h,g,m,b,y,w,x,k,E;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=[],i=he()(),c=0;case 1:if(!(c<t.length)){e.next=21;break}if(o=t[c],s=o.src,e.prev=2,p=void 0,v=void 0,h=void 0,!o.isMemberCode){e.next=7;break}if(!(g=L["front"===r?"front":"back"])){e.next=4;break}return e.next=3,He(g);case 3:p=e.sent,v="png",e.next=6;break;case 4:return e.next=5,Ue(s,1200,.9);case 5:p=e.sent,v="png";case 6:e.next=15;break;case 7:if(!Q()(s).call(s,"data:image/svg")){e.next=12;break}if(!(m=document.querySelector('img[src="'.concat(s,'"]')))){e.next=9;break}return e.next=8,Pe(m,1200);case 8:p=e.sent,e.next=11;break;case 9:return e.next=10,Ue(s,1200,.9);case 10:p=e.sent;case 11:v="png",e.next=15;break;case 12:if(!Q()(s).call(s,"data:image/")){e.next=14;break}return e.next=13,Ue(s,2e3,.85);case 13:p=e.sent,v=Y()(p).call(p,"data:image/png")?"png":"jpg",e.next=15;break;case 14:return a.push(null),e.abrupt("continue",20);case 15:if(p){e.next=16;break}return a.push(null),e.abrupt("continue",20);case 16:return b=ze(p),h=b.size,y=T()(l=T()(u=T()(d=T()(f="".concat(n,"/images/")).call(f,i,"_")).call(d,r,"_")).call(u,c,".")).call(l,v),e.next=17,supabase.storage.from("design-files").upload(y,b,{cacheControl:"3600",upsert:!0});case 17:if(w=e.sent,w.data,!w.error){e.next=18;break}return a.push(null),e.abrupt("continue",20);case 18:x=supabase.storage.from("design-files").getPublicUrl(y),k=x.data.publicUrl,E={fileName:y,publicUrl:k,side:r,originalSize:h,format:v,processedWidth:"png"===v&&(o.isMemberCode||Q()(s).call(s,"data:image/svg"))?1e3:"auto",uploadTime:(new Date).toISOString(),type:o.isMemberCode?"memberCode":Q()(s).call(s,"data:image/svg")?"svg":"regular"},a.push(E),e.next=20;break;case 19:e.prev=19,e.catch(2),a.push(null);case 20:c++,e.next=1;break;case 21:return ye()(a).call(a,function(e){return null!==e}).length,e.abrupt("return",a);case 22:case"end":return e.stop()}},e,null,[[2,19]])}))).apply(this,arguments)}function Je(e){var n;if(e!==t){var r;if(ue(),r=h.querySelectorAll(".uploaded-image"),R()(r).call(r,function(e){h.removeChild(e)}),ot(),function(e){var t;R()(t=b[e]).call(t,function(t){var n=document.createElement("img");n.src=t.src,n.className=t.className,z()(n.style,t.style),t.dataset.aspectRatio&&(n.dataset.aspectRatio=t.dataset.aspectRatio),h.appendChild(n),rt(n),t.isMemberCode&&(L[e]=n,x[e]=!0)}),fe()}(t=e),R()(n=document.querySelectorAll(".t-shirt-column button")).call(n,function(e){e.classList.remove("active")}),"color"!==e){var a=document.getElementById(e+"Btn");a&&a.classList.add("active")}var i=document.getElementById("colorMenu");i&&(i.classList.remove("show"),i.classList.add("hidden")),Ze(),fe()}}function Ke(e){var t;n=e,R()(t=document.querySelectorAll(".color-option")).call(t,function(e){e.classList.remove("active")});var r=document.querySelector('[data-color="'.concat(e,'"]'));r&&r.classList.add("active");var a=document.getElementById("colorMenu");a&&(a.classList.add("hidden"),a.classList.remove("show")),Ze()}function Ze(){var e={front:{white:"./images/white-front.png",black:"./images/black-front.png"},back:{white:"./images/white-back.png",black:"./images/black-back.png"}},r=g.querySelector("img");e[t]&&e[t][n]&&r&&(r.src=e[t][n])}function et(){document.getElementById("fileInput").click()}function tt(e){var t=e.target.files;if(t&&0!==t.length){for(var n=0;n<t.length;n++){var r,a=t[n];if(Q()(r=a.type).call(r,"image/")){var i=new FileReader;i.onload=function(e){nt(e.target.result)},i.readAsDataURL(a)}else alert("请选择图片文件！")}e.target.value=""}}function nt(e){var t=document.createElement("img");t.className="uploaded-image",t.src=e,t.onload=function(){var e=.6*h.offsetWidth,n=.6*h.offsetHeight,a=Math.min(e/this.naturalWidth,n/this.naturalHeight),i=this.naturalWidth*a,c=this.naturalHeight*a;t.style.width=i+"px",t.style.height=c+"px",t.style.left=(h.offsetWidth-i)/2+"px",t.style.top=(h.offsetHeight-c)/2+"px",t.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,h.appendChild(t),r.push(t),rt(t)}}function rt(e){e.draggable=!1,e.style.touchAction="none",e.addEventListener("click",function(t){t.stopPropagation(),ct(e)}),st()?e.addEventListener("touchstart",function(t){t.preventDefault(),t.stopPropagation(),ct(e)},{passive:!1}):(e.addEventListener("touchstart",function(t){if(t.preventDefault(),t.stopPropagation(),ct(e),1===t.touches.length){var n=t.touches[0],r=e.getBoundingClientRect(),a=h.getBoundingClientRect();i=!0,s=n.clientX-(r.left-a.left),l=n.clientY-(r.top-a.top),e.classList.add("dragging")}},{passive:!1}),e.addEventListener("mousedown",function(t){t.target.classList.contains("resize-handle")||(i=!0,s=t.clientX-e.offsetLeft,l=t.clientY-e.offsetTop,e.classList.add("dragging"),t.preventDefault())}))}function at(){st()?(document.addEventListener("touchmove",function(e){e.target.classList.contains("resize-handle")&&e.preventDefault()},{passive:!1}),document.addEventListener("touchend",function(e){(i||c)&&(e.preventDefault(),i=!1,c=!1,o=null,a&&a.classList.remove("dragging"))},{passive:!1})):(document.addEventListener("touchmove",function(e){if(i&&a&&1===e.touches.length){e.preventDefault();var t=e.touches[0],n=h.getBoundingClientRect(),r=t.clientX-n.left-s,g=t.clientY-n.top-l,m=n.width-a.offsetWidth,b=n.height-a.offsetHeight;a.style.left=Math.max(0,Math.min(r,m))+"px",a.style.top=Math.max(0,Math.min(g,b))+"px",lt()}else c&&a&&1===e.touches.length&&(e.preventDefault(),function(e){if(!c||!a)return;var t=e.clientX-s,n=(e.clientY,u),r=d,i=f,l=p;switch(o){case"se":r=(n=Math.max(30,u+t))/v;break;case"sw":r=(n=Math.max(30,u-t))/v,i=f+(u-n);break;case"ne":n=Math.max(30,u+t),l=p+(d-(r=n/v));break;case"nw":n=Math.max(30,u-t),i=f+(u-n),l=p+(d-(r=n/v))}a.style.width=n+"px",a.style.height=r+"px",a.style.left=i+"px",a.style.top=l+"px",lt()}(e.touches[0]))},{passive:!1}),document.addEventListener("touchend",function(e){(i||c)&&(e.preventDefault(),i=!1,c=!1,o=null,a&&a.classList.remove("dragging"))},{passive:!1}))}function it(){var e;(e=document.createElement("style")).textContent='\n            .uploaded-image {\n                touch-action: none;\n                -webkit-user-select: none;\n                user-select: none;\n                -webkit-touch-callout: none;\n            }\n            \n            .resize-handle {\n                touch-action: none;\n                -webkit-user-select: none;\n                user-select: none;\n            }\n            \n            /* Mobile-specific handle styles */\n            @media (max-width: 899px) {\n                .resize-handle {\n                    width: 30px !important;\n                    height: 30px !important;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    font-size: 23px;\n                    \n                    color: black;\n                    transform-origin: center center !important;\n                }\n                \n                /* Corner handles - resize controls */\n                .resize-handle[data-direction="nw"],\n                .resize-handle[data-direction="ne"] {\n                   \n                    border: 2px solid black;\n                }\n                \n                .resize-handle[data-direction="sw"],\n                .resize-handle[data-direction="se"] {\n                  \n                    border: 2px solid black;\n                }\n                \n                /* Side handles - movement controls */\n                .resize-handle[data-direction="n"],\n                .resize-handle[data-direction="s"],\n                .resize-handle[data-direction="e"],\n                .resize-handle[data-direction="w"] {\n\n                    border: 2px solid black;\n                }\n                \n              \n            }\n            \n           \n        ',document.head.appendChild(e),at()}function ct(e){a&&a.classList.remove("selected"),(a=e).classList.add("selected"),m.classList.remove("hidden"),lt(),dt()}function ot(){a&&a.classList.remove("selected"),a=null,m.classList.add("hidden")}function st(){return window.innerWidth<=899||"ontouchstart"in window}function lt(){var e;if(a){a.offsetHeight;var t=a.getBoundingClientRect(),n=h.getBoundingClientRect(),r=t.left-n.left,i=t.top-n.top,c=t.width,o=t.height;m.style.transform=T()(e="translate(".concat(r,"px, ")).call(e,i,"px)"),m.style.width=c+"px",m.style.height=o+"px",m.style.position||(m.style.position="absolute",m.style.left="0",m.style.top="0"),st()&&requestAnimationFrame(function(){ut()})}}function ut(){var e=m.querySelectorAll(".resize-handle");R()(e).call(e,function(e){switch(e.dataset.direction){case"nw":case"ne":e.innerHTML="+",e.title="Tap to enlarge";break;case"sw":case"se":e.innerHTML="−",e.title="Tap to shrink";break;case"n":e.innerHTML="↑",e.title="Move up";break;case"s":e.innerHTML="↓",e.title="Move down";break;case"e":e.innerHTML="→",e.title="Move right";break;case"w":e.innerHTML="←",e.title="Move left"}})}function dt(){var e=m.querySelectorAll(".resize-handle");R()(e).call(e,function(e){e.replaceWith(e.cloneNode(!0))});var t=m.querySelectorAll(".resize-handle");R()(t).call(t,function(e){st()?(e.addEventListener("touchstart",ft,{passive:!1}),e.addEventListener("touchend",pt,{passive:!1}),e.addEventListener("touchmove",function(e){return e.preventDefault()},{passive:!1})):e.addEventListener("mousedown",function(e){e.stopPropagation(),a&&(c=!0,o=this.dataset.direction,s=e.clientX,l=e.clientY,u=a.offsetWidth,d=a.offsetHeight,f=a.offsetLeft,p=a.offsetTop,v=J()(a.dataset.aspectRatio)||1,e.preventDefault())})}),st()&&ut()}function ft(e){(e.preventDefault(),e.stopPropagation(),a)&&(e.currentTarget.style.transformOrigin="center center")}function pt(e){(e.preventDefault(),e.stopPropagation(),a)&&function(e){if(!a)return;var t=a.offsetWidth,n=a.offsetHeight,r=a.offsetLeft,i=a.offsetTop,c=J()(a.dataset.aspectRatio)||1,o=h.offsetWidth,s=h.offsetHeight;switch(e){case"nw":case"ne":var l=Math.min(1.1*t,.9*o),u=l/c;if(u<=.9*s){a.style.width=l+"px",a.style.height=u+"px";var d=Math.max(0,Math.min(r+(t-l)/2,o-l)),f=Math.max(0,Math.min(i+(n-u)/2,s-u));a.style.left=d+"px",a.style.top=f+"px"}break;case"sw":case"se":var p=Math.max(.9*t,30),v=p/c;a.style.width=p+"px",a.style.height=v+"px";var g=Math.max(0,Math.min(r+(t-p)/2,o-p)),m=Math.max(0,Math.min(i+(n-v)/2,s-v));a.style.left=g+"px",a.style.top=m+"px";break;case"n":var b=Math.max(0,i-10);a.style.top=b+"px";break;case"s":var y=Math.min(s-n,i+10);a.style.top=y+"px";break;case"w":var w=Math.max(0,r-10);a.style.left=w+"px";break;case"e":var x=Math.min(o-t,r+10);a.style.left=x+"px"}requestAnimationFrame(function(){lt()})}(e.currentTarget.dataset.direction)}function vt(){if(a){if(a.parentNode&&a.parentNode.removeChild(a),void 0!==r&&Z()(r)){var e=P()(r).call(r,a);e>-1&&H()(r).call(r,e,1)}ot()}}function ht(){var e=document.getElementById("frontBtn");e&&e.addEventListener("click",function(e){e.preventDefault(),Je("front")});var t=document.getElementById("backBtn");t&&t.addEventListener("click",function(e){e.preventDefault(),Je("back")});var n=document.getElementById("colorBtn");n&&n.addEventListener("click",function(e){var t;e.preventDefault(),(t=document.getElementById("colorMenu"))&&(t.classList.contains("hidden")?(t.classList.remove("hidden"),t.classList.add("show")):(t.classList.add("hidden"),t.classList.remove("show")))})}function gt(){var e=["tshirtContainer","tshirtBackground","resizeHandles","frontBtn","backBtn","colorBtn"];te()(e).call(e,function(e){return document.getElementById(e)})?F()(function(){!function(){void 0===r&&(window.uploadedImages=[]),void 0===a&&(window.selectedImage=null);var e=document.getElementById("tshirtContainer");e&&void 0===h&&(window.container=e),document.getElementById("tshirtBackground"),document.getElementById("resizeHandles")}(),ht(),h?(Je("front"),Ke("white"),fe(),function(){var e=document.getElementById("fileBtn");e&&e.addEventListener("click",et);var t=document.getElementById("deleteBtn");t&&t.addEventListener("click",vt);var n=document.getElementById("saveDesignBtn");n&&n.addEventListener("click",Me);var r=document.getElementById("saveToDraftBtn");r&&r.addEventListener("click",Oe);var a=document.getElementById("addToCartBtn");a&&(a.replaceWith(a.cloneNode(!0)),document.getElementById("addToCartBtn").addEventListener("click",Ct));var i=document.getElementById("saveSvgBtn");i&&i.addEventListener("click",Jt);var c=document.getElementById("backToEditBtn");c&&c.addEventListener("click",qe);var o=document.getElementById("fileInput");o&&o.addEventListener("change",tt)}(),function(){yt.apply(this,arguments)}(),F()(function(){var e=document.querySelector('[data-color="white"]');e&&e.classList.add("active")},100)):F()(gt,1e3)},500):F()(gt,500)}function mt(){var e=document.querySelectorAll(".size-option"),t={};return R()(e).call(e,function(e){var n=e.querySelector("label"),r=e.querySelector(".quantity-input");if(n&&r){var a,i=re()(a=n.textContent).call(a),c=O()(r.value)||0;c>0&&(t[i]=c)}}),t}function bt(){var e=b.front&&b.front.length>0,t=b.back&&b.back.length>0;return e||t}function yt(){return(yt=(0,E.A)(I().mark(function e(){var t,n,r;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=new(xe())(window.location.search),!(n=t.get("loadTshirtDraft"))){e.next=3;break}return e.next=1,wt();case 1:return e.next=2,xt(n);case 2:r=window.location.pathname,window.history.replaceState({},document.title,r);case 3:case"end":return e.stop()}},e)}))).apply(this,arguments)}function wt(){return new(X())(function(e){var t=function(){var n=document.getElementById("tshirtContainer"),r=document.getElementById("frontBtn"),a=document.getElementById("backBtn");n&&r&&a?e():F()(t,100)};t()})}function xt(e){return kt.apply(this,arguments)}function kt(){return(kt=(0,E.A)(I().mark(function e(t){var n,r,a;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,document.getElementById("tshirtContainer")){e.next=1;break}return e.next=1,new(X())(function(e){return F()(e,1e3)});case 1:return e.next=2,supabase.from("drafts").select("*").eq("id",t).single();case 2:if(n=e.sent,r=n.data,!n.error&&r&&"tshirt"===r.type){e.next=3;break}return alert("无法加载T恤设计"),e.abrupt("return");case 3:if(a=r.data){e.next=4;break}return alert("草稿数据损坏"),e.abrupt("return");case 4:return a.color&&Ke(a.color),Et(),Je("front"),e.next=5,Lt("front",a.frontImages);case 5:return Je("back"),e.next=6,Lt("back",a.backImages);case 6:a.sizeQuantities&&Bt(a.sizeQuantities),a.currentView?Je(a.currentView):Je("front"),hn("The design has been loaded!","success"),e.next=8;break;case 7:e.prev=7,e.catch(0),alert("恢复失败，请重试");case 8:case"end":return e.stop()}},e,null,[[0,7]])}))).apply(this,arguments)}function Et(){b.front=[],b.back=[];var e=document.getElementById("tshirtContainer");if(e){var t=e.querySelectorAll(".uploaded-image");R()(t).call(t,function(e){return e.remove()})}x.front=!1,x.back=!1,L.front=null,L.back=null,r=[],ot()}function Lt(e,t){return It.apply(this,arguments)}function It(){return(It=(0,E.A)(I().mark(function e(t,n){var r,a,i,c,o;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n&&Z()(n)){e.next=1;break}return e.abrupt("return");case 1:if(document.getElementById("tshirtContainer")){e.next=2;break}return e.abrupt("return");case 2:r=Ce(n),e.prev=3,r.s();case 4:if((a=r.n()).done){e.next=10;break}if(i=a.value,e.prev=5,c=null,i.storageFile&&i.storageFile.publicUrl?c=i.storageFile.publicUrl:i.src&&(c=i.src),c){e.next=6;break}return e.abrupt("continue",9);case 6:return e.next=7,St(c,i,t);case 7:e.next=9;break;case 8:e.prev=8,e.catch(5);case 9:e.next=4;break;case 10:e.next=12;break;case 11:e.prev=11,o=e.catch(3),r.e(o);case 12:return e.prev=12,r.f(),e.finish(12);case 13:ue();case 14:case"end":return e.stop()}},e,null,[[3,11,12,13],[5,8]])}))).apply(this,arguments)}function St(e,t,n){return new(X())(function(a,i){var c=new Image;c.onload=function(){var i=document.createElement("img");i.src=e,i.className=t.className||"uploaded-image",t.style&&(i.style.width=t.style.width,i.style.height=t.style.height,i.style.left=t.style.left,i.style.top=t.style.top),t.dataset&&t.dataset.aspectRatio?i.dataset.aspectRatio=t.dataset.aspectRatio:i.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,document.getElementById("tshirtContainer").appendChild(i),rt(i),r.push(i),(t.isMemberCode||i.classList.contains("member-code-image"))&&(L[n]=i,x[n]=!0,fe()),a(i)},c.onerror=function(){i(new Error("图片加载失败"))},c.src=e})}function Bt(e){var t;e&&R()(t=le()(e)).call(t,function(t){var n=document.querySelector('.quantity-input[data-size="'.concat(t,'"]'));if(!n){var r,a=Ce(document.querySelectorAll(".size-option"));try{for(a.s();!(r=a.n()).done;){var i,c=r.value,o=c.querySelector("label");if(o&&re()(i=o.textContent).call(i)===t){n=c.querySelector(".quantity-input");break}}}catch(e){a.e(e)}finally{a.f()}}n&&(n.value=e[t]||0)})}function Ct(){return At.apply(this,arguments)}function At(){return(At=(0,E.A)(I().mark(function e(){var t,r,a,i,c,o,s,l,u,d,f,p,v,h,g,m,w,x,k;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(r=e.sent,a=r.data.user){e.next=2;break}return alert("请先登录"),e.abrupt("return");case 2:if(i=mt(),0!==(c=ie()(t=oe()(i)).call(t,function(e,t){return e+t},0))){e.next=3;break}return alert("请至少选择一个尺码"),e.abrupt("return");case 3:if(!(o=document.getElementById("addToCartBtn"))){e.next=10;break}if(s=o.textContent,o.textContent="PROCESSING...",o.disabled=!0,e.prev=4,ue(),l=b.front&&b.front.length>0,u=b.back&&b.back.length>0,d="",f="",p=0,v="",h=null,l||u?l&&u?(d="double-sided",f="double-sided-".concat(n),v="Double-sided Custom T-shirt",p=TSHIRT_PRICING["double-sided"][n]||TSHIRT_PRICING["double-sided"].white):(d="single-sided",f="single-sided-".concat(n),v="Single-sided Custom T-shirt",p=TSHIRT_PRICING["single-sided"][n]||TSHIRT_PRICING["single-sided"].white):(d="blank",f="blank-tshirt-".concat(n),v="Blank T-shirt (".concat(n,")"),p=TSHIRT_PRICING.blank[n]||TSHIRT_PRICING.blank.white),!l&&!u){e.next=6;break}return e.next=5,Tt(!0);case 5:if(h=e.sent){e.next=6;break}throw new Error("保存设计失败");case 6:return e.next=7,window.CartManager.addOrUpdateCartItem({draftId:h,itemData:{type:f,designType:d,color:n,title:v,unitPrice:p},sizes:i,userId:a.id});case 7:if(!(g=e.sent).success){e.next=8;break}qe(),w=p*c,x=A()(m=Ee()(i)).call(m,function(e){var t,n=(0,y.A)(e,2),r=n[0],a=n[1];return T()(t="".concat(r,": ")).call(t,a)}).join(", "),confirm("Successfully added to cart!\n\n"+"Item: ".concat(v,"\n")+"Type: ".concat(d,"\n")+"Color: ".concat(n,"\n")+"Sizes: ".concat(x,"\n")+"Unit Price: $".concat(p.toFixed(2),"\n")+"Total Quantity: ".concat(c,"\n")+"Total Price: $".concat(w.toFixed(2),"\n\n")),e.next=9;break;case 8:throw new Error(g.error||"添加到购物车失败");case 9:return e.prev=9,o.textContent=s,o.disabled=!1,e.finish(9);case 10:e.next=12;break;case 11:e.prev=11,k=e.catch(0),alert("添加失败: "+k.message);case 12:case"end":return e.stop()}},e,null,[[0,11],[4,,9,10]])}))).apply(this,arguments)}function Mt(){return new(X())(function(e){var t=de()(function(){window.CartManager&&"function"==typeof window.CartManager.addOrUpdateCartItem&&(clearInterval(t),e())},100);F()(function(){clearInterval(t),e()},5e3)})}function Tt(){return Dt.apply(this,arguments)}function Dt(){return Dt=(0,E.A)(I().mark(function e(){var r,a,i,c,o,s,l,u,d,f,p,v,h,g,m,y,w,x,k,E,L,S,B=arguments;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=B.length>0&&void 0!==B[0]&&B[0],e.prev=1,e.next=2,supabase.auth.getUser();case 2:if(c=e.sent,o=c.data.user){e.next=3;break}return r||alert("请先登录"),e.abrupt("return",null);case 3:if(bt()){e.next=4;break}return e.abrupt("return",null);case 4:if(ue(),s=document.getElementById("frontPreview"),l=document.getElementById("backPreview"),s&&l){e.next=5;break}return e.abrupt("return",null);case 5:return e.next=6,Xe(s);case 6:return e.next=7,Xe(l);case 7:return u={backgroundColor:"#ffffff",useCORS:!0,allowTaint:!1,removeContainer:!0,scale:1,logging:!1,foreignObjectRendering:!1,imageTimeout:15e3,width:s.offsetWidth,height:s.offsetHeight,onclone:function(e){var t=e.querySelectorAll("img");R()(t).call(t,function(e){e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.transform="none"})}},e.prev=8,e.next=9,Ie()(s,u);case 9:d=e.sent,e.next=12;break;case 10:return e.prev=10,e.catch(8),e.next=11,Fe(s);case 11:d=e.sent;case 12:return e.prev=12,e.next=13,Ie()(l,u);case 13:f=e.sent,e.next=16;break;case 14:return e.prev=14,e.catch(12),e.next=15,Fe(l);case 15:f=e.sent;case 16:return p=Ye(d),v=Ye(f),e.next=17,Qe(b.front,o.id,"front");case 17:return h=e.sent,e.next=18,Qe(b.back,o.id,"back");case 18:return g=e.sent,m=he()(),y=null,w=null,e.prev=19,e.next=20,Te(p,o.id,"".concat(m,"_cart_preview_front.jpg"));case 20:y=e.sent,e.next=22;break;case 21:e.prev=21,e.catch(19);case 22:return e.prev=22,e.next=23,Te(v,o.id,"".concat(m,"_cart_preview_back.jpg"));case 23:w=e.sent,e.next=25;break;case 24:e.prev=24,e.catch(22);case 25:return x=mt(),k={frontImages:A()(a=b.front).call(a,function(e,t){return Be(Be({},e),{},{storageFile:h[t]||null})}),backImages:A()(i=b.back).call(i,function(e,t){return Be(Be({},e),{},{storageFile:g[t]||null})}),color:n,currentView:t,timestamp:(new Date).toISOString(),sizeQuantities:x,frontPreviewFile:y||null,backPreviewFile:w||null},E={user_id:o.id,title:"T恤设计 ".concat((new Date).toLocaleString()),type:"tshirt",data:k,front_preview_image:y&&y.publicUrl?y.publicUrl:p,back_preview_image:w&&w.publicUrl?w.publicUrl:v,sizes:x},e.next=26,supabase.from("drafts").insert(E).select().single();case 26:if(L=e.sent,S=L.data,!L.error){e.next=27;break}return e.abrupt("return",null);case 27:return e.abrupt("return",S.id);case 28:return e.prev=28,e.catch(1),e.abrupt("return",null);case 29:case"end":return e.stop()}},e,null,[[1,28],[8,10],[12,14],[19,21],[22,24]])})),Dt.apply(this,arguments)}function Rt(){var e=document.querySelector(".pencil-menu");e&&e.classList.remove("show")}function qt(){(q=document.getElementById("mySVG"))&&(zt(),function(){var e=document.getElementById("pencil");e&&e.addEventListener("click",function(){Ot("pencil"),Wt(ee),Nt(ee),Rt()});var t=document.querySelector(".pencil-menu-trigger");t&&t.addEventListener("click",function(e){var t;e.stopPropagation(),(t=document.querySelector(".pencil-menu"))&&t.classList.toggle("show")});document.addEventListener("click",function(e){var t=document.getElementById("pencil");t&&!t.contains(e.target)&&Rt()});var n=document.getElementById("eraser");n&&n.addEventListener("click",function(){Ot("eraser")});var r=document.getElementById("zoom-in");r&&r.addEventListener("click",function(){K<3&&(K=Math.min(1.25*K,3),Ut())});var a=document.getElementById("zoom-out");a&&a.addEventListener("click",function(){K>.5&&((K=Math.max(K/1.25,.5))<=1&&(K=1,ae=0,ce=0),Ut())});var i=document.getElementById("drag");i&&i.addEventListener("click",function(){Ot("drag")});var c=document.querySelectorAll(".pencil-menu [data-width]");R()(c).call(c,function(e){e.addEventListener("click",function(){var e=O()(this.getAttribute("data-width"));Wt(e),ee=e,Nt(e),Rt()})}),Wt(2),Nt(2)}(),function(){if(!q)return;function e(e){var t,n;if(e.preventDefault(),"touchstart"===e.type){var r=e.touches[0];t=r.clientX,n=r.clientY}else t=e.clientX,n=e.clientY;var a=Xt(t,n);"drag"===V?(ne=!0,U=t,_=n,q.style.cursor="grabbing"):(N=!0,M=a.x,D=a.y,Gt(a.x,a.y))}function t(e){var t,n;if(e.preventDefault(),"touchmove"===e.type){var r=e.touches[0];t=r.clientX,n=r.clientY}else t=e.clientX,n=e.clientY;var a=Xt(t,n);if(ne){var i=t-U,c=n-_;U=t,_=n,ae+=i,ce+=c,Ut()}else N&&(Yt(M,D,a.x,a.y),M=a.x,D=a.y)}function n(e){e.preventDefault(),ne?(ne=!1,q.style.cursor="drag"===V?"grab":"default"):N&&(N=!1,jt(),Vt())}q.addEventListener("mousedown",function(e){e.preventDefault();var t=Xt(e.clientX,e.clientY);"drag"===V?(ne=!0,U=e.clientX,_=e.clientY,q.style.cursor="grabbing"):(N=!0,M=t.x,D=t.y,Gt(t.x,t.y))}),q.addEventListener("mousemove",function(e){e.preventDefault();var t=Xt(e.clientX,e.clientY);if(ne){var n=e.clientX-U,r=e.clientY-_;U=e.clientX,_=e.clientY,ae+=n,ce+=r,Ut()}else N&&(Yt(M,D,t.x,t.y),M=t.x,D=t.y)}),q.addEventListener("mouseup",function(e){ne?(ne=!1,q.style.cursor="grab"):N&&(N=!1,jt(),Vt())}),q.addEventListener("mousedown",e),q.addEventListener("mousemove",t),q.addEventListener("mouseup",n),q.addEventListener("touchstart",Pt),q.addEventListener("touchmove",_t),q.addEventListener("touchend",Ht),q.addEventListener("touchcancel",n,{passive:!1}),q.addEventListener("touchstart",function(e){e.touches.length>1&&e.preventDefault()},{passive:!1})}(),Ot("pencil"),Vt())}function zt(){var e;if(q){var t=q.parentElement;if(t){var n=t.getBoundingClientRect(),r=Math.max(n.width,100),a=Math.max(n.height-60,100);q.setAttribute("width",r),q.setAttribute("height",a),q.setAttribute("viewBox",T()(e="0 0 ".concat(r," ")).call(e,a))}}}function Ut(){var e,t,n;if(q){var r=T()(e=T()(t=T()(n="".concat(-ae/K," ")).call(n,-ce/K," ")).call(t,q.clientWidth/K," ")).call(e,q.clientHeight/K);q.setAttribute("viewBox",r)}}function Pt(e){e.preventDefault();var t=e.touches[0],n=Xt(t.clientX,t.clientY);"drag"===V?(ne=!0,U=t.clientX,_=t.clientY):(N=!0,M=n.x,D=n.y,Gt(n.x,n.y))}function _t(e){e.preventDefault();var t=e.touches[0],n=Xt(t.clientX,t.clientY);if(ne){var r=t.clientX-U,a=t.clientY-_;U=t.clientX,_=t.clientY,ae+=r,ce+=a,Ut()}else N&&(Yt(M,D,n.x,n.y),M=n.x,D=n.y)}function Ht(e){e.preventDefault(),ne?ne=!1:N&&(N=!1,jt(),Vt())}function Nt(e){var t=document.querySelectorAll(".pencil-menu [data-width]");R()(t).call(t,function(t){t.classList.remove("active"),O()(t.getAttribute("data-width"))===e&&t.classList.add("active")})}function Ot(e){var t;V=e,R()(t=document.querySelectorAll(".tools > div")).call(t,function(e){e.classList.remove("active")});var n=document.getElementById(e);n&&n.classList.add("active"),q&&("pencil"===e?q.classList.add("pencil-cursor"):(q.classList.remove("pencil-cursor"),q.style.cursor="eraser"===e?"crosshair":"drag"===e?"grab":"default"))}function Wt(e){$=e}function Xt(e,t){if(!q)return{x:0,y:0};var n=q.getBoundingClientRect(),r=window.pageXOffset||document.documentElement.scrollLeft||0,a=window.pageYOffset||document.documentElement.scrollTop||0,i=e-n.left-r,c=t-n.top-a;return{x:(i-ae)/K,y:(c-ce)/K}}function Gt(e,t){if("pencil"===V){var n;W=document.createElementNS("http://www.w3.org/2000/svg","path");var r=Math.round(100*e)/100,a=Math.round(100*t)/100;W.setAttribute("d",T()(n="M ".concat(r," ")).call(n,a)),W.setAttribute("stroke","black"),W.setAttribute("stroke-width",$),W.setAttribute("fill","none"),W.setAttribute("stroke-linecap","square"),W.setAttribute("stroke-linejoin","square"),q.appendChild(W)}else"eraser"===V&&Ft(e,t)}function Yt(e,t,n,r){if("pencil"===V&&W){var a,i=Math.round(100*n)/100,c=Math.round(100*r)/100,o=W.getAttribute("d");W.setAttribute("d",o+T()(a=" L ".concat(i," ")).call(a,c))}else"eraser"===V&&Ft(n,r)}function jt(){W=null}function Ft(e,t){if(q){var n=q.querySelectorAll("path"),r=2*$;R()(n).call(n,function(n){try{var a=n.getBBox();e>=a.x-r&&e<=a.x+a.width+r&&t>=a.y-r&&t<=a.y+a.height+r&&q.removeChild(n)}catch(e){}})}}function Vt(){if(q){++j<G.length&&(G.length=j),G.push(q.innerHTML);G.length>20&&(G.shift(),j--)}}function Qt(){!q||j<=0||(j--,q.innerHTML=G[j])}function $t(){q&&(q.innerHTML="",Vt())}function Jt(){return Kt.apply(this,arguments)}function Kt(){return(Kt=(0,E.A)(I().mark(function e(){return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:Zt();case 1:case"end":return e.stop()}},e)}))).apply(this,arguments)}function Zt(){var e=(new XMLSerializer).serializeToString(q),t=new Blob([e],{type:"image/svg+xml"}),n=pe().createObjectURL(t),r='\n        <div id="saveSvgModal" class="modal">\n            <div class="modal-content-svg">\n                <div class="preview-container-svg">\n                    <div class="preview-item-svg">\n                        <span>PREVIEW</span>\n                        <div class="preview-svg" style="background-image: url(\''.concat(n,'\')"></div>\n                    </div>\n                </div>\n                <div class="modal-buttons">\n                    <button id="confirmSaveSvgBtn">SAVE TO DRAFT</button>\n                    <button id="addToGalleryBtn">ADD TO GALLERY</button>\n                </div>\n            </div>\n        </div>\n    ');document.body.insertAdjacentHTML("beforeend",r),se=document.getElementById("saveSvgModal");var a=document.getElementById("confirmSaveSvgBtn"),i=document.getElementById("addToGalleryBtn");a&&a.addEventListener("click",function(e){e.stopPropagation(),function(){en.apply(this,arguments)}()}),i&&i.addEventListener("click",function(e){e.stopPropagation(),function(){an.apply(this,arguments)}()});var c=se.querySelector(".modal-content-svg");c&&c.addEventListener("click",function(e){e.stopPropagation()})}function en(){return(en=(0,E.A)(I().mark(function e(){var t,n,r,a,i,c,o,s,l,u,d,f;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(n=e.sent,r=n.data.user){e.next=2;break}return alert("请先登录"),tn(),e.abrupt("return");case 2:return a=(new XMLSerializer).serializeToString(q),i=new Blob([a],{type:"image/svg+xml"}),c=he()(),o=T()(t="".concat(r.id,"/svg/")).call(t,c,"_drawing.svg"),e.next=3,supabase.storage.from("design-files").upload(o,i,{contentType:"image/svg+xml",cacheControl:"3600",upsert:!0});case 3:if(s=e.sent,s.data,!s.error){e.next=4;break}return alert("上传失败，请重试"),e.abrupt("return");case 4:return l=supabase.storage.from("design-files").getPublicUrl(o),u=l.data.publicUrl,e.next=5,nn(a);case 5:return d=e.sent,e.next=6,supabase.from("drafts").insert({user_id:r.id,title:"SVG绘图 ".concat((new Date).toLocaleString()),type:"svg",data:{storageUrl:u,fileName:o,fileSize:i.size,uploadTime:(new Date).toISOString()},front_preview_image:d});case 6:f=e.sent,f.data,f.error?alert("保存失败，请重试"):(tn(),alert("SAVED!")),e.next=8;break;case 7:e.prev=7,e.catch(0),alert("保存失败，请重试");case 8:case"end":return e.stop()}},e,null,[[0,7]])}))).apply(this,arguments)}function tn(){var e=document.querySelectorAll("#saveSvgModal");R()(e).call(e,function(e){var t;null===(t=e.parentNode)||void 0===t||t.removeChild(e)}),se=null}function nn(e){return rn.apply(this,arguments)}function rn(){return rn=(0,E.A)(I().mark(function e(t){var n,r,a=arguments;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:400,r=a.length>2&&void 0!==a[2]?a[2]:400,e.abrupt("return",new(X())(function(e){var a=document.createElement("canvas"),i=a.getContext("2d"),c=new Image;a.width=n,a.height=r,i.fillStyle="#ffffff",i.fillRect(0,0,n,r),c.onload=function(){var t=.9*Math.min(n/this.width,r/this.height),o=this.width*t,s=this.height*t,l=(n-o)/2,u=(r-s)/2;i.drawImage(c,l,u,o,s),e(a.toDataURL("image/png",.9))},c.onerror=function(){i.fillStyle="#f0f0f0",i.fillRect(50,50,n-100,r-100),i.fillStyle="#666",i.font="20px Arial",i.textAlign="center",i.fillText("SVG预览",n/2,r/2),e(a.toDataURL("image/png",.9))};var o=new Blob([t],{type:"image/svg+xml"});c.src=pe().createObjectURL(o)}));case 1:case"end":return e.stop()}},e)})),rn.apply(this,arguments)}function an(){return(an=(0,E.A)(I().mark(function e(){var t,n,r,a,i,c,o,s,l,u,d,f,p,v,h;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(t=e.sent,n=t.data.user){e.next=2;break}return alert("请先登录"),e.abrupt("return");case 2:if(q&&0!==q.children.length){e.next=3;break}return alert("请先绘制一些内容！"),e.abrupt("return");case 3:return r=(new XMLSerializer).serializeToString(q),e.next=4,nn(r);case 4:return a=e.sent,i=null,e.prev=5,o=new Blob([r],{type:"image/svg+xml"}),s=he()(),l=T()(c="".concat(n.id,"/gallery/")).call(c,s,"_artwork.svg"),e.next=6,supabase.storage.from("design-files").upload(l,o,{contentType:"image/svg+xml",cacheControl:"3600",upsert:!0});case 6:u=e.sent,u.data,u.error||(d=supabase.storage.from("design-files").getPublicUrl(l),f=d.data.publicUrl,i=f),e.next=8;break;case 7:e.prev=7,e.catch(5);case 8:return p={user_id:n.id,title:prompt("Give your artwork a title:","My Doodle")||"Untitled",description:prompt("Add a description (optional):","")||"",preview_image:a,svg_url:i,svg_data:r},e.next=9,supabase.from("gallery").insert(p).select();case 9:v=e.sent,v.data,(h=v.error)?alert("添加失败："+h.message):(alert("Successfully added to gallery!"),tn(),confirm("View in gallery now?")&&("function"==typeof loadPage?loadPage("gallery"):window.location.href="/gallery")),e.next=11;break;case 10:e.prev=10,e.catch(0),alert("添加失败，请重试");case 11:case"end":return e.stop()}},e,null,[[0,10],[5,7]])}))).apply(this,arguments)}function cn(){if(!window.isTransferring&&!window.transferLock)if(q&&0!==q.children.length){window.isTransferring=!0,window.transferLock=!0;try{var e,t,n,a,i=q.cloneNode(!0),c=i.querySelectorAll("path");if(0===c.length)return void hn("没有找到绘图内容！","error");var o=document.querySelectorAll(".svg-drawing"),s=he()();R()(o).call(o,function(e){var t=e.dataset.createdTime;t&&s-O()(t)<1e3&&e.remove()});var l=1/0,u=1/0,d=-1/0,f=-1/0,p=!1;if(R()(c).call(c,function(e){var t=e.getAttribute("d");if(t&&""!==re()(t).call(t)){var n=function(e){var t=[],n=/-?\d+(?:\.\d+)?/g,r=e.match(n);if(r&&r.length>=2)for(var a=0;a<r.length-1;a+=2){var i=J()(r[a]),c=J()(r[a+1]);isNaN(i)||isNaN(c)||t.push({x:i,y:c})}return t}(t);n.length>0&&(R()(n).call(n,function(e){l=Math.min(l,e.x),u=Math.min(u,e.y),d=Math.max(d,e.x),f=Math.max(f,e.y)}),p=!0)}}),!p||l===1/0)return void hn("没有找到有效的绘图内容！","error");var v=d-l,g=f-u,m=Math.max(.1*Math.max(v,g),20);i.setAttribute("viewBox",T()(e=T()(t=T()(n="".concat(l-m," ")).call(n,u-m," ")).call(t,v+2*m," ")).call(e,g+2*m)),i.setAttribute("width","300"),i.setAttribute("height","300"),i.setAttribute("xmlns","http://www.w3.org/2000/svg"),R()(a=i.querySelectorAll("path")).call(a,function(e){e.getAttribute("stroke")||e.setAttribute("stroke","black"),e.getAttribute("stroke-width")||e.setAttribute("stroke-width","2"),e.getAttribute("fill")||e.setAttribute("fill","none")});var b=(new XMLSerializer).serializeToString(i);!function(e,t){var n,a=Ce(document.querySelectorAll(".svg-drawing"));try{for(a.s();!(n=a.n()).done;){var i=n.value;if(i.src===e||i.dataset.uniqueId===t)return}}catch(e){a.e(e)}finally{a.f()}var c=document.getElementById("tshirtContainer");c||(c=document.getElementById("uploadedImagesContainer"));c||void 0===h||(c=h);if(!c)return void alert("T恤设计区域未找到，请确保右侧面板已加载");var o=document.createElement("img");o.className="uploaded-image svg-drawing",o.src=e,o.dataset.uniqueId=t,o.dataset.createdTime=he()().toString(),o.onload=function(){var e=this;if("true"!==this.dataset.loaded){this.dataset.loaded="true";var t=.4*c.offsetWidth;c.offsetHeight;if(this.style.width=t+"px",this.style.height="auto",this.style.left=(c.offsetWidth-t)/2+"px",this.style.top="80px",this.style.position="absolute",this.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,void 0!==r&&Z()(r)){var n=me()(r).call(r,function(t){return t.dataset.uniqueId===e.dataset.uniqueId});n||r.push(this)}else window.uploadedImages=window.uploadedImages||[],window.uploadedImages.push(this);rt(this),F()(function(){ct(e)},100),hn("Image transferred successfully!","success")}},o.onerror=function(){hn("图片加载失败，请重试","error"),this.remove()},c.appendChild(o)}("data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(b))),"svg-"+he()()+"-"+Math.random().toString(36).substr(2,9))}catch(e){hn("传输失败："+e.message,"error")}finally{F()(function(){window.isTransferring=!1},1e3),F()(function(){window.transferLock=!1},2e3)}}else hn("Draw something first！","error")}function on(){return(on=(0,E.A)(I().mark(function e(){var t,n,r;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=new(xe())(window.location.search),!(n=t.get("loadSvgDraft"))){e.next=3;break}return e.next=1,sn();case 1:return e.next=2,ln(n);case 2:r=window.location.pathname,window.history.replaceState({},document.title,r);case 3:case"end":return e.stop()}},e)}))).apply(this,arguments)}function sn(){return new(X())(function(e){var t=function(){void 0!==q&&q?e():F()(t,100)};t()})}function ln(e){return un.apply(this,arguments)}function un(){return(un=(0,E.A)(I().mark(function e(t){var n,r,a,i,c,o,s,l;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.from("drafts").select("*").eq("id",t).single();case 1:if(a=e.sent,i=a.data,!a.error&&i){e.next=2;break}return alert("获取草稿失败"),e.abrupt("return");case 2:if(c=null,null===(n=i.data)||void 0===n||!n.storageUrl){e.next=4;break}return e.next=3,dn(i.data.storageUrl);case 3:c=e.sent,e.next=5;break;case 4:null!==(r=i.data)&&void 0!==r&&r.svgContent&&(c=i.data.svgContent);case 5:if(c){e.next=6;break}return alert("无法恢复SVG文件"),e.abrupt("return");case 6:q&&(q.innerHTML="",o=new DOMParser,s=o.parseFromString(c,"image/svg+xml"),l=s.querySelectorAll("path"),R()(l).call(l,function(e){var t=e.cloneNode(!0);q.appendChild(t)}),Vt(),hn("The draft has been loaded!","success")),e.next=8;break;case 7:e.prev=7,e.catch(0),alert("恢复失败，请重试");case 8:case"end":return e.stop()}},e,null,[[0,7]])}))).apply(this,arguments)}function dn(e){return fn.apply(this,arguments)}function fn(){return(fn=(0,E.A)(I().mark(function e(t){var n,r;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,fetch(t);case 1:if((n=e.sent).ok){e.next=2;break}throw new Error("获取SVG失败");case 2:return e.next=3,n.text();case 3:return r=e.sent,e.abrupt("return",r);case 4:return e.prev=4,e.catch(0),e.abrupt("return",null);case 5:case"end":return e.stop()}},e,null,[[0,4]])}))).apply(this,arguments)}function pn(){return(pn=(0,E.A)(I().mark(function e(){var t,n,r,a,i,c,o,s;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=new(xe())(window.location.search),n=t.get("loadSvgDraft"),r="true"===t.get("fromGallery"),!n||!r){e.next=1;break}return e.abrupt("return");case 1:if(!(a=t.get("loadSvgUrl"))){e.next=8;break}return e.prev=2,e.next=3,sn();case 3:return e.next=4,fetch(decodeURIComponent(a));case 4:if((i=e.sent).ok){e.next=5;break}throw new Error("无法获取SVG文件");case 5:return e.next=6,i.text();case 6:vn(e.sent),hn("Remix loaded! Start editing!","success"),c=window.location.pathname,window.history.replaceState({},document.title,c),e.next=8;break;case 7:e.prev=7,e.catch(2),alert("无法加载Remix内容");case 8:if("true"!==t.get("loadRemixData")){e.next=10;break}if(!(o=sessionStorage.getItem("remixSvgData"))){e.next=10;break}return e.next=9,sn();case 9:vn(o),sessionStorage.removeItem("remixSvgData"),hn("Remix loaded! Start editing!","success"),s=window.location.pathname,window.history.replaceState({},document.title,s);case 10:case"end":return e.stop()}},e,null,[[2,7]])}))).apply(this,arguments)}function vn(e){if(q){q.innerHTML="";try{var t=(new DOMParser).parseFromString(e,"image/svg+xml");if(t.querySelector("parsererror"))return void alert("SVG文件格式错误");var n=t.querySelectorAll("path");if(0===n.length){var r=t.querySelectorAll("circle, rect, line, polyline, polygon, ellipse, path, text, g");R()(r).call(r,function(e){var t=e.cloneNode(!0);q.appendChild(t)})}else R()(n).call(n,function(e){var t=e.cloneNode(!0);q.appendChild(t)});Vt()}catch(e){alert("加载失败："+e.message)}}}function hn(e){var t=document.createElement("div");t.textContent=e;t.style.cssText="\n        position: fixed;\n        top: 0px;\n        right: 0px;\n        background: black;\n        color: white;\n        z-index: 9999;\n        font-size: 20px;\n        animation: slideIn 0.3s ease-out;\n    ";var n=document.createElement("style");n.textContent="\n        @keyframes slideIn {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n        }\n    ",document.head.querySelector("style[data-notification]")||(n.setAttribute("data-notification","true"),document.head.appendChild(n)),document.body.appendChild(t),F()(function(){document.body.contains(t)&&(t.style.animation="slideIn 0.3s ease-out reverse",F()(function(){document.body.contains(t)&&document.body.removeChild(t)},300))},3e3)}function gn(){window.canvasSectionInitialized||(window.canvasSectionInitialized=!0,F()(function(){qt(),function(){var e=document.getElementById("undoBtn");e&&e.addEventListener("click",Qt);var t=document.getElementById("saveBtn");t&&t.addEventListener("click",Jt);var n=document.getElementById("clearBtn");n&&n.addEventListener("click",$t);var r=document.getElementById("nextBtn");r&&r.addEventListener("click",cn)}(),function(){on.apply(this,arguments)}(),function(){pn.apply(this,arguments)}();var e=de()(function(){document.getElementById("tshirtContainer")&&clearInterval(e)},500);F()(function(){return clearInterval(e)},1e4)},100))}}()}}]);