(()=>{"use strict";var e,r={62425:(e,r,t)=>{var a=t(27842),n=t(34963),l=t(44828),s=t.n(l),i=t(56255),c=t.n(i),u=t(14607),o=t.n(u),d=t(86226),p=t.n(d),f=t(96319),g=t.n(f),m=t(59261),y=t.n(m),v=t(48079),b=t.n(v),x=t(11393),h=t.n(x),k=(t(66512),t(8628)),w=t.n(k);function _(){return q.apply(this,arguments)}function q(){return(q=(0,n.A)(s().mark(function e(){var r;return s().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(document.getElementById("galleryGrid")){e.next=1;break}return e.abrupt("return");case 1:return r=document.querySelectorAll(".filter-btn"),p()(r).call(r,function(e){e.addEventListener("click",function(){p()(r).call(r,function(e){return e.classList.remove("active")}),this.classList.add("active"),I(g()(this.dataset))})}),e.next=2,I("all");case 2:case"end":return e.stop()}},e)}))).apply(this,arguments)}function I(){return L.apply(this,arguments)}function L(){return L=(0,n.A)(s().mark(function e(){var r,t,n,l,i,c,u,o,d,f,g,m,v,x,k,w,_,q,I,L=arguments;return s().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=L.length>0&&void 0!==L[0]?L[0]:"all",t=document.getElementById("galleryGrid")){e.next=1;break}return e.abrupt("return");case 1:return t.innerHTML='<div class="loading">Loading gallery...</div>',e.prev=2,n=null,e.next=3,supabase.auth.getUser();case 3:return l=e.sent,(i=l.data.user)&&(n=i.id),c=supabase.from("gallery").select("*"),c="mine"===r&&n?c.eq("user_id",n):"popular"===r?c.order("likes",{ascending:!1}).limit(20):"curated"===r?c.gte("likes",5).order("likes",{ascending:!1}):c.order("created_at",{ascending:!1}),e.next=4,c;case 4:if(u=e.sent,o=u.data,!u.error){e.next=5;break}return t.innerHTML='<div class="empty-gallery"><h2>加载失败</h2><p>请稍后重试</p></div>',e.abrupt("return");case 5:if(o&&0!==o.length){e.next=6;break}return t.innerHTML='\n            <div class="empty-gallery">\n                <h2>No artworks yet</h2>\n                <p>Be the first to add your creation to the gallery!</p>\n            </div>\n        ',e.abrupt("return");case 6:return d=(0,a.A)(new(y())(b()(o).call(o,function(e){return e.user_id}))),e.next=7,supabase.from("profiles").select("user_id, manifesto").in("user_id",d);case 7:if(f=e.sent,g=f.data,m={},g&&p()(g).call(g,function(e){m[e.user_id]=e.manifesto}),v=new(y()),x=new(y()),!n){e.next=10;break}return k=b()(o).call(o,function(e){return e.id}),e.next=8,supabase.from("gallery_likes").select("gallery_id").eq("user_id",n).in("gallery_id",k);case 8:return w=e.sent,(_=w.data)&&p()(_).call(_,function(e){return v.add(e.gallery_id)}),e.next=9,supabase.from("gallery_remixes").select("gallery_id").eq("user_id",n).in("gallery_id",k);case 9:q=e.sent,(I=q.data)&&p()(I).call(I,function(e){return x.add(e.gallery_id)});case 10:t.innerHTML=b()(o).call(o,function(e){var r,t,a,l,s,i,c,u,o,d,p,f,g,y,b,k=m[e.user_id]||"Anonymous",w=new Date(e.created_at).toLocaleDateString(),_=n===e.user_id,q=v.has(e.id),I=x.has(e.id);return h()(r=h()(t=h()(a=h()(l=h()(s=h()(i=h()(c=h()(u=h()(o=h()(d=h()(p=h()(f=h()(g=h()(y=h()(b='\n            <div class="gallery-item" data-id="'.concat(e.id,'">\n                <img src="')).call(b,e.preview_image,'" alt="')).call(y,e.title,'" onclick="viewGalleryItem(\'')).call(g,e.id,'\')">\n                <div class="gallery-item-info">\n                    <div class="gallery-item-title">')).call(f,e.title||"Untitled",'</div>\n                    <div class="gallery-item-author">by ')).call(p,k,'</div>\n                    <div class="gallery-item-date">')).call(d,w,'</div>\n                    <div class="gallery-item-actions">\n                        <button class="action-btn ')).call(o,q?"liked":"",'" \n                                onclick="toggleLike(\'')).call(u,e.id,"')\"\n                                ")).call(c,n?"":'disabled title="请先登录"',">\n                            LIKE ")).call(i,e.likes||0,'\n                        </button>\n                        <button class="action-btn ')).call(s,I?"remixed":"",'" \n                                onclick="remixGalleryItem(\'')).call(l,e.id,"')\"\n                                ")).call(a,n?"":'disabled title="请先登录"',">\n                            REMIX ")).call(t,e.remix_count||0,"\n                        </button>\n                        ")).call(r,_?'<button class="action-btn" onclick="deleteGalleryItem(\''.concat(e.id,"')\">DELETE</button>"):"","\n                    </div>\n                </div>\n            </div>\n        ")}).join(""),e.next=12;break;case 11:e.prev=11,e.catch(2),t.innerHTML='<div class="empty-gallery"><h2>出错了</h2><p>请刷新页面重试</p></div>';case 12:case"end":return e.stop()}},e,null,[[2,11]])})),L.apply(this,arguments)}function G(){return(G=(0,n.A)(s().mark(function e(r){var t,a,n,l,i,c,u,o,d,p,f,m;return s().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(t=e.sent,a=t.data.user){e.next=2;break}return alert("请先登录"),e.abrupt("return");case 2:return e.next=3,supabase.from("gallery_likes").select("id").eq("user_id",a.id).eq("gallery_id",r).single();case 3:if(n=e.sent,!(l=n.data)){e.next=7;break}return e.next=4,supabase.from("gallery_likes").delete().eq("id",l.id);case 4:if(i=e.sent,i.error){e.next=6;break}return e.next=5,supabase.from("gallery").select("likes").eq("id",r).single();case 5:return c=e.sent,u=c.data,o=Math.max(0,((null==u?void 0:u.likes)||0)-1),e.next=6,supabase.from("gallery").update({likes:o}).eq("id",r);case 6:e.next=10;break;case 7:return e.next=8,supabase.from("gallery_likes").insert([{user_id:a.id,gallery_id:r}]);case 8:if(d=e.sent,d.error){e.next=10;break}return e.next=9,supabase.from("gallery").select("likes").eq("id",r).single();case 9:return p=e.sent,f=p.data,m=((null==f?void 0:f.likes)||0)+1,e.next=10,supabase.from("gallery").update({likes:m}).eq("id",r);case 10:I(g()(document.querySelector(".filter-btn.active").dataset)),e.next=12;break;case 11:e.prev=11,e.catch(0),alert("操作失败，请重试");case 12:case"end":return e.stop()}},e,null,[[0,11]])}))).apply(this,arguments)}function E(){return(E=(0,n.A)(s().mark(function e(r){var t,a,n,l,i,c,u,o,d;return s().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(t=e.sent,a=t.data.user){e.next=2;break}return alert("请先登录"),e.abrupt("return");case 2:return e.next=3,supabase.from("gallery").select("*").eq("id",r).single();case 3:if(n=e.sent,l=n.data,!n.error&&l){e.next=4;break}return alert("无法获取作品信息"),e.abrupt("return");case 4:return e.next=5,supabase.from("gallery_remixes").select("id").eq("user_id",a.id).eq("gallery_id",r).maybeSingle();case 5:if(i=e.sent,c=i.data,c){e.next=9;break}return e.next=6,supabase.from("gallery_remixes").insert([{user_id:a.id,gallery_id:r}]);case 6:if(u=e.sent,o=u.error){e.next=8;break}return d=(l.remix_count||0)+1,e.next=7,supabase.from("gallery").update({remix_count:d}).eq("id",r);case 7:e.next=9;break;case 8:o.code;case 9:if(confirm("Do you really want to remix this artwork?")){e.next=10;break}return e.abrupt("return");case 10:l.draft_id?window.location.href="/home?loadSvgDraft=".concat(l.draft_id,"&fromGallery=true"):l.svg_url?window.location.href="/home?loadSvgUrl=".concat(encodeURIComponent(l.svg_url)):l.svg_data?(sessionStorage.setItem("remixSvgData",l.svg_data),window.location.href="/home?loadRemixData=true"):alert("该作品没有可用的源文件"),e.next=12;break;case 11:e.prev=11,e.catch(0),alert("Remix失败，请重试");case 12:case"end":return e.stop()}},e,null,[[0,11]])}))).apply(this,arguments)}function M(e){return A.apply(this,arguments)}function A(){return(A=(0,n.A)(s().mark(function e(r){var t,a,n,l,i,c,u;return s().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.from("gallery").select("*").eq("id",r).single();case 1:t=e.sent,a=t.data,!t.error&&a&&(i=document.getElementById("galleryModal"),c=document.getElementById("modalImage"),u=document.getElementById("modalInfo"),c.src=a.svg_url||a.preview_image,u.innerHTML=h()(n=h()(l="\n                    <h3>".concat(a.title||"Untitled","</h3>\n                    <p>")).call(l,a.description||"",'</p>\n                    <p style="margin-top: 10px; color: #666;">Created: ')).call(n,new Date(a.created_at).toLocaleString(),"</p>\n                "),i.classList.add("show")),e.next=3;break;case 2:e.prev=2,e.catch(0);case 3:case"end":return e.stop()}},e,null,[[0,2]])}))).apply(this,arguments)}function O(){document.getElementById("galleryModal").classList.remove("show")}function S(e){return j.apply(this,arguments)}function j(){return(j=(0,n.A)(s().mark(function e(r){var t,a,n,l;return s().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.from("gallery").select("likes").eq("id",r).single();case 1:return t=e.sent,a=t.data,n=((null==a?void 0:a.likes)||0)+1,e.next=2,supabase.from("gallery").update({likes:n}).eq("id",r);case 2:l=e.sent,l.error||I(g()(document.querySelector(".filter-btn.active").dataset)),e.next=4;break;case 3:e.prev=3,e.catch(0);case 4:case"end":return e.stop()}},e,null,[[0,3]])}))).apply(this,arguments)}function T(){return(T=(0,n.A)(s().mark(function e(r){var t,n,l,i,c,u,o,d,p,f,m,v,b,x;return s().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(confirm("确定要从Gallery中删除这个作品吗？")){e.next=1;break}return e.abrupt("return");case 1:return e.prev=1,e.next=2,supabase.from("gallery").select("*").eq("id",r).single();case 2:if(t=e.sent,n=t.data,!t.error&&n){e.next=3;break}return alert("删除失败"),e.abrupt("return");case 3:if(l=[],i=function(e){if(!e||"string"!=typeof e)return null;var r=e.match(/\/storage\/v1\/object\/public\/design-files\/(.+)/);return r?r[1]:null},n.svg_url&&(c=i(n.svg_url))&&l.push(c),n.preview_image&&(u=i(n.preview_image))&&l.push(u),!n.draft_id){e.next=5;break}return e.next=4,supabase.from("drafts").select("*").eq("id",n.draft_id).single();case 4:o=e.sent,(d=o.data)&&d.data&&(d.data.storageUrl&&(p=i(d.data.storageUrl))&&!w()(l).call(l,p)&&l.push(p),d.data.fileName&&!w()(l).call(l,d.data.fileName)&&l.push(d.data.fileName));case 5:if(!((f=(0,a.A)(new(y())(l))).length>0)){e.next=7;break}return e.next=6,supabase.storage.from("design-files").remove(f);case 6:m=e.sent,m.data,m.error;case 7:return e.next=8,supabase.from("gallery_likes").delete().eq("gallery_id",r);case 8:return v=e.sent,v.error,e.next=9,supabase.from("gallery_remixes").delete().eq("gallery_id",r);case 9:return b=e.sent,b.error,e.next=10,supabase.from("gallery").delete().eq("id",r);case 10:x=e.sent,x.error?alert("删除失败"):(alert("作品已从Gallery中删除"),I(g()(document.querySelector(".filter-btn.active").dataset))),e.next=12;break;case 11:e.prev=11,e.catch(1),alert("删除失败");case 12:case"end":return e.stop()}},e,null,[[1,11]])}))).apply(this,arguments)}c()(function(){if("undefined"!=typeof supabase)_();else var e=o()(function(){"undefined"!=typeof supabase&&(clearInterval(e),_())},100)},100),window.viewGalleryItem=M,window.closeGalleryModal=O,window.likeGalleryItem=S,window.viewGalleryItem=M,window.closeGalleryModal=O,window.likeGalleryItem=S,window.toggleLike=function(e){return G.apply(this,arguments)},window.remixGalleryItem=function(e){return E.apply(this,arguments)},window.deleteGalleryItem=function(e){return T.apply(this,arguments)}}},t={};function a(e){var n=t[e];if(void 0!==n)return n.exports;var l=t[e]={exports:{}};return r[e].call(l.exports,l,l.exports,a),l.exports}a.m=r,e=[],a.O=(r,t,n,l)=>{if(!t){var s=1/0;for(o=0;o<e.length;o++){for(var[t,n,l]=e[o],i=!0,c=0;c<t.length;c++)(!1&l||s>=l)&&Object.keys(a.O).every(e=>a.O[e](t[c]))?t.splice(c--,1):(i=!1,l<s&&(s=l));if(i){e.splice(o--,1);var u=n();void 0!==u&&(r=u)}}return r}l=l||0;for(var o=e.length;o>0&&e[o-1][2]>l;o--)e[o]=e[o-1];e[o]=[t,n,l]},a.n=e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return a.d(r,{a:r}),r},a.d=(e,r)=>{for(var t in r)a.o(r,t)&&!a.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),a.j=411,(()=>{var e={411:0};a.O.j=r=>0===e[r];var r=(r,t)=>{var n,l,[s,i,c]=t,u=0;if(s.some(r=>0!==e[r])){for(n in i)a.o(i,n)&&(a.m[n]=i[n]);if(c)var o=c(a)}for(r&&r(t);u<s.length;u++)l=s[u],a.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return a.O(o)},t=self.webpackChunk=self.webpackChunk||[];t.forEach(r.bind(null,0)),t.push=r.bind(null,t.push.bind(t))})();var n=a.O(void 0,[96],()=>a(62425));n=a.O(n)})();