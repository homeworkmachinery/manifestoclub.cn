(()=>{"use strict";var e,t,r,a={62425:(e,t,r)=>{var a=r(27842),n=r(34963),l=r(44828),i=r.n(l),s=r(56255),c=r.n(s),o=r(14607),u=r.n(o),d=r(86226),f=r.n(d),p=r(96319),g=r.n(p),y=r(59261),m=r.n(y),b=r(48079),v=r.n(b),x=r(11393),h=r.n(x),k=(r(66512),r(8628)),w=r.n(k);function _(){return q.apply(this,arguments)}function q(){return(q=(0,n.A)(i().mark(function e(){var t;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(document.getElementById("galleryGrid")){e.next=1;break}return e.abrupt("return");case 1:return t=document.querySelectorAll(".filter-btn"),f()(t).call(t,function(e){e.addEventListener("click",function(){f()(t).call(t,function(e){return e.classList.remove("active")}),this.classList.add("active"),I(g()(this.dataset))})}),e.next=2,I("all");case 2:case"end":return e.stop()}},e)}))).apply(this,arguments)}function I(){return L.apply(this,arguments)}function L(){return L=(0,n.A)(i().mark(function e(){var t,r,n,l,s,c,o,u,d,p,g,y,b,x,k,w,_,q,I,L=arguments;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=L.length>0&&void 0!==L[0]?L[0]:"all",r=document.getElementById("galleryGrid")){e.next=1;break}return e.abrupt("return");case 1:return r.innerHTML='<div class="loading">Loading gallery...</div>',e.prev=2,n=null,e.next=3,supabase.auth.getUser();case 3:return l=e.sent,(s=l.data.user)&&(n=s.id),c=supabase.from("gallery").select("*"),c="mine"===t&&n?c.eq("user_id",n):"popular"===t?c.order("likes",{ascending:!1}).limit(20):"curated"===t?c.gte("likes",5).order("likes",{ascending:!1}):c.order("created_at",{ascending:!1}),e.next=4,c;case 4:if(o=e.sent,u=o.data,!o.error){e.next=5;break}return r.innerHTML='<div class="empty-gallery"><h2>加载失败</h2><p>请稍后重试</p></div>',e.abrupt("return");case 5:if(u&&0!==u.length){e.next=6;break}return r.innerHTML='\n            <div class="empty-gallery">\n                <h2>No artworks yet</h2>\n                <p>Be the first to add your creation to the gallery!</p>\n            </div>\n        ',e.abrupt("return");case 6:return d=(0,a.A)(new(m())(v()(u).call(u,function(e){return e.user_id}))),e.next=7,supabase.from("profiles").select("user_id, manifesto").in("user_id",d);case 7:if(p=e.sent,g=p.data,y={},g&&f()(g).call(g,function(e){y[e.user_id]=e.manifesto}),b=new(m()),x=new(m()),!n){e.next=10;break}return k=v()(u).call(u,function(e){return e.id}),e.next=8,supabase.from("gallery_likes").select("gallery_id").eq("user_id",n).in("gallery_id",k);case 8:return w=e.sent,(_=w.data)&&f()(_).call(_,function(e){return b.add(e.gallery_id)}),e.next=9,supabase.from("gallery_remixes").select("gallery_id").eq("user_id",n).in("gallery_id",k);case 9:q=e.sent,(I=q.data)&&f()(I).call(I,function(e){return x.add(e.gallery_id)});case 10:r.innerHTML=v()(u).call(u,function(e){var t,r,a,l,i,s,c,o,u,d,f,p,g,m,v,k=y[e.user_id]||"Anonymous",w=new Date(e.created_at).toLocaleDateString(),_=n===e.user_id,q=b.has(e.id),I=x.has(e.id);return h()(t=h()(r=h()(a=h()(l=h()(i=h()(s=h()(c=h()(o=h()(u=h()(d=h()(f=h()(p=h()(g=h()(m=h()(v='\n            <div class="gallery-item" data-id="'.concat(e.id,'">\n                <img src="')).call(v,e.preview_image,'" alt="')).call(m,e.title,'" onclick="viewGalleryItem(\'')).call(g,e.id,'\')">\n                <div class="gallery-item-info">\n                    <div class="gallery-item-title">')).call(p,e.title||"Untitled",'</div>\n                    <div class="gallery-item-author">by ')).call(f,k,'</div>\n                    <div class="gallery-item-date">')).call(d,w,'</div>\n                    <div class="gallery-item-actions">\n                        <button class="action-btn ')).call(u,q?"liked":"",'" \n                                onclick="toggleLike(\'')).call(o,e.id,"')\"\n                                ")).call(c,n?"":'disabled title="请先登录"',">\n                            LIKE ")).call(s,e.likes||0,'\n                        </button>\n                        <button class="action-btn ')).call(i,I?"remixed":"",'" \n                                onclick="remixGalleryItem(\'')).call(l,e.id,"')\"\n                                ")).call(a,n?"":'disabled title="请先登录"',">\n                            REMIX ")).call(r,e.remix_count||0,"\n                        </button>\n                        ")).call(t,_?'<button class="action-btn" onclick="deleteGalleryItem(\''.concat(e.id,"')\">DELETE</button>"):"","\n                    </div>\n                </div>\n            </div>\n        ")}).join(""),e.next=12;break;case 11:e.prev=11,e.catch(2),r.innerHTML='<div class="empty-gallery"><h2>出错了</h2><p>请刷新页面重试</p></div>';case 12:case"end":return e.stop()}},e,null,[[2,11]])})),L.apply(this,arguments)}function O(){return(O=(0,n.A)(i().mark(function e(t){var r,a,n,l,s,c,o,u,d,f,p,g,y,m,b,v;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(r=e.sent,a=r.data.user){e.next=2;break}return alert("请先登录"),e.abrupt("return");case 2:if(n=document.querySelector("[onclick=\"toggleLike('".concat(t,"')\"]"))){e.next=3;break}return e.abrupt("return");case 3:return n.disabled=!0,n.textContent,e.next=4,supabase.from("gallery_likes").select("id").eq("user_id",a.id).eq("gallery_id",t).single();case 4:if(l=e.sent,!(s=l.data)){e.next=9;break}return e.next=5,supabase.from("gallery_likes").delete().eq("id",s.id);case 5:if(u=e.sent,!(d=u.error)){e.next=6;break}throw d;case 6:return e.next=7,supabase.from("gallery").select("likes").eq("id",t).single();case 7:return f=e.sent,p=f.data,c=Math.max(0,((null==p?void 0:p.likes)||0)-1),o=!1,e.next=8,supabase.from("gallery").update({likes:c}).eq("id",t);case 8:e.next=13;break;case 9:return e.next=10,supabase.from("gallery_likes").insert([{user_id:a.id,gallery_id:t}]);case 10:if(g=e.sent,!(y=g.error)){e.next=11;break}throw y;case 11:return e.next=12,supabase.from("gallery").select("likes").eq("id",t).single();case 12:return m=e.sent,b=m.data,c=((null==b?void 0:b.likes)||0)+1,o=!0,e.next=13,supabase.from("gallery").update({likes:c}).eq("id",t);case 13:j(n,c,o),e.next=15;break;case 14:e.prev=14,e.catch(0),alert("操作失败，请重试"),(v=document.querySelector("[onclick=\"toggleLike('".concat(t,"')\"]")))&&(v.disabled=!1);case 15:case"end":return e.stop()}},e,null,[[0,14]])}))).apply(this,arguments)}function j(e,t,r){e.textContent="LIKE ".concat(t),r?e.classList.add("liked"):e.classList.remove("liked"),e.disabled=!1}function S(){return(S=(0,n.A)(i().mark(function e(t){var r,a,n,l,s,c,o,u,d;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(r=e.sent,a=r.data.user){e.next=2;break}return alert("请先登录"),e.abrupt("return");case 2:return e.next=3,supabase.from("gallery").select("*").eq("id",t).single();case 3:if(n=e.sent,l=n.data,!n.error&&l){e.next=4;break}return alert("无法获取作品信息"),e.abrupt("return");case 4:return e.next=5,supabase.from("gallery_remixes").select("id").eq("user_id",a.id).eq("gallery_id",t).maybeSingle();case 5:if(s=e.sent,c=s.data,c){e.next=9;break}return e.next=6,supabase.from("gallery_remixes").insert([{user_id:a.id,gallery_id:t}]);case 6:if(o=e.sent,u=o.error){e.next=8;break}return d=(l.remix_count||0)+1,e.next=7,supabase.from("gallery").update({remix_count:d}).eq("id",t);case 7:e.next=9;break;case 8:u.code;case 9:if(confirm("Do you really want to remix this artwork?")){e.next=10;break}return e.abrupt("return");case 10:l.draft_id?window.location.href="/?loadSvgDraft=".concat(l.draft_id,"&fromGallery=true"):l.svg_url?window.location.href="/?loadSvgUrl=".concat(encodeURIComponent(l.svg_url)):l.svg_data?(sessionStorage.setItem("remixSvgData",l.svg_data),window.location.href="/?loadRemixData=true"):alert("该作品没有可用的源文件"),e.next=12;break;case 11:e.prev=11,e.catch(0),alert("Remix失败，请重试");case 12:case"end":return e.stop()}},e,null,[[0,11]])}))).apply(this,arguments)}function G(e){return M.apply(this,arguments)}function M(){return(M=(0,n.A)(i().mark(function e(t){var r,a,n,l,s,c,o;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.from("gallery").select("*").eq("id",t).single();case 1:r=e.sent,a=r.data,!r.error&&a&&(s=document.getElementById("galleryModal"),c=document.getElementById("modalImage"),o=document.getElementById("modalInfo"),c.src=a.svg_url||a.preview_image,o.innerHTML=h()(n=h()(l="\n                    <h3>".concat(a.title||"Untitled","</h3>\n                    <p>")).call(l,a.description||"",'</p>\n                    <p style="margin-top: 10px; color: #666;">Created: ')).call(n,new Date(a.created_at).toLocaleString(),"</p>\n                "),s.classList.add("show")),e.next=3;break;case 2:e.prev=2,e.catch(0);case 3:case"end":return e.stop()}},e,null,[[0,2]])}))).apply(this,arguments)}function E(){document.getElementById("galleryModal").classList.remove("show")}function A(e){return T.apply(this,arguments)}function T(){return(T=(0,n.A)(i().mark(function e(t){var r,a,n,l;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.from("gallery").select("likes").eq("id",t).single();case 1:return r=e.sent,a=r.data,n=((null==a?void 0:a.likes)||0)+1,e.next=2,supabase.from("gallery").update({likes:n}).eq("id",t);case 2:l=e.sent,l.error||I(g()(document.querySelector(".filter-btn.active").dataset)),e.next=4;break;case 3:e.prev=3,e.catch(0);case 4:case"end":return e.stop()}},e,null,[[0,3]])}))).apply(this,arguments)}function U(){return(U=(0,n.A)(i().mark(function e(t){var r,n,l,s,c,o,u,d,f,p,y,b,v,x;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(confirm("确定要从Gallery中删除这个作品吗？")){e.next=1;break}return e.abrupt("return");case 1:return e.prev=1,e.next=2,supabase.from("gallery").select("*").eq("id",t).single();case 2:if(r=e.sent,n=r.data,!r.error&&n){e.next=3;break}return alert("删除失败"),e.abrupt("return");case 3:if(l=[],s=function(e){if(!e||"string"!=typeof e)return null;var t=e.match(/\/storage\/v1\/object\/public\/design-files\/(.+)/);return t?t[1]:null},n.svg_url&&(c=s(n.svg_url))&&l.push(c),n.preview_image&&(o=s(n.preview_image))&&l.push(o),!n.draft_id){e.next=5;break}return e.next=4,supabase.from("drafts").select("*").eq("id",n.draft_id).single();case 4:u=e.sent,(d=u.data)&&d.data&&(d.data.storageUrl&&(f=s(d.data.storageUrl))&&!w()(l).call(l,f)&&l.push(f),d.data.fileName&&!w()(l).call(l,d.data.fileName)&&l.push(d.data.fileName));case 5:if(!((p=(0,a.A)(new(m())(l))).length>0)){e.next=7;break}return e.next=6,supabase.storage.from("design-files").remove(p);case 6:y=e.sent,y.data,y.error;case 7:return e.next=8,supabase.from("gallery_likes").delete().eq("gallery_id",t);case 8:return b=e.sent,b.error,e.next=9,supabase.from("gallery_remixes").delete().eq("gallery_id",t);case 9:return v=e.sent,v.error,e.next=10,supabase.from("gallery").delete().eq("id",t);case 10:x=e.sent,x.error?alert("删除失败"):(alert("作品已从Gallery中删除"),I(g()(document.querySelector(".filter-btn.active").dataset))),e.next=12;break;case 11:e.prev=11,e.catch(1),alert("删除失败");case 12:case"end":return e.stop()}},e,null,[[1,11]])}))).apply(this,arguments)}c()(function(){if("undefined"!=typeof supabase)_();else var e=u()(function(){"undefined"!=typeof supabase&&(clearInterval(e),_())},100)},100),window.viewGalleryItem=G,window.closeGalleryModal=E,window.likeGalleryItem=A,window.viewGalleryItem=G,window.closeGalleryModal=E,window.likeGalleryItem=A,window.toggleLike=function(e){return O.apply(this,arguments)},window.remixGalleryItem=function(e){return S.apply(this,arguments)},window.deleteGalleryItem=function(e){return U.apply(this,arguments)}}},n={};function l(e){var t=n[e];if(void 0!==t)return t.exports;var r=n[e]={exports:{}};return a[e].call(r.exports,r,r.exports,l),r.exports}l.m=a,e=[],l.O=(t,r,a,n)=>{if(!r){var i=1/0;for(u=0;u<e.length;u++){for(var[r,a,n]=e[u],s=!0,c=0;c<r.length;c++)(!1&n||i>=n)&&Object.keys(l.O).every(e=>l.O[e](r[c]))?r.splice(c--,1):(s=!1,n<i&&(i=n));if(s){e.splice(u--,1);var o=a();void 0!==o&&(t=o)}}return t}n=n||0;for(var u=e.length;u>0&&e[u-1][2]>n;u--)e[u]=e[u-1];e[u]=[r,a,n]},l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},r=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,l.t=function(e,a){if(1&a&&(e=this(e)),8&a)return e;if("object"==typeof e&&e){if(4&a&&e.__esModule)return e;if(16&a&&"function"==typeof e.then)return e}var n=Object.create(null);l.r(n);var i={};t=t||[null,r({}),r([]),r(r)];for(var s=2&a&&e;("object"==typeof s||"function"==typeof s)&&!~t.indexOf(s);s=r(s))Object.getOwnPropertyNames(s).forEach(t=>i[t]=()=>e[t]);return i.default=()=>e,l.d(n,i),n},l.d=(e,t)=>{for(var r in t)l.o(t,r)&&!l.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},l.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.j=411,(()=>{var e={411:0};l.O.j=t=>0===e[t];var t=(t,r)=>{var a,n,[i,s,c]=r,o=0;if(i.some(t=>0!==e[t])){for(a in s)l.o(s,a)&&(l.m[a]=s[a]);if(c)var u=c(l)}for(t&&t(r);o<i.length;o++)n=i[o],l.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return l.O(u)},r=self.webpackChunk=self.webpackChunk||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var i=l.O(void 0,[96],()=>l(62425));i=l.O(i)})();