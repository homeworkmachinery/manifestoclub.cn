/*! For license information please see page-profile.2fbc1c8a00c273431b9f.js.LICENSE.txt */
(()=>{function e(n){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(n)}function n(e){throw new TypeError('"'+e+'" is read-only')}function t(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,a)}return t}function a(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?t(Object(a),!0).forEach(function(n){r(e,n,a[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):t(Object(a)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))})}return e}function r(n,t,a){return(t=function(n){var t=function(n,t){if("object"!=e(n)||!n)return n;var a=n[Symbol.toPrimitive];if(void 0!==a){var r=a.call(n,t||"default");if("object"!=e(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(n)}(n,"string");return"symbol"==e(t)?t:t+""}(t))in n?Object.defineProperty(n,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[t]=a,n}function i(e){return function(e){if(Array.isArray(e))return o(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,n){if(e){if("string"==typeof e)return o(e,n);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?o(e,n):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,a=Array(n);t<n;t++)a[t]=e[t];return a}function s(){var e,n,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",r=t.toStringTag||"@@toStringTag";function i(t,a,r,i){var s=a&&a.prototype instanceof c?a:c,l=Object.create(s.prototype);return d(l,"_invoke",function(t,a,r){var i,s,d,c=0,l=r||[],u=!1,p={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(n,t){return i=n,s=0,d=e,p.n=t,o}};function f(t,a){for(s=t,d=a,n=0;!u&&c&&!r&&n<l.length;n++){var r,i=l[n],f=p.p,m=i[2];t>3?(r=m===a)&&(d=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=f&&((r=t<2&&f<i[1])?(s=0,p.v=a,p.n=i[1]):f<m&&(r=t<3||i[0]>a||a>m)&&(i[4]=t,i[5]=a,p.n=m,s=0))}if(r||t>1)return o;throw u=!0,a}return function(r,l,m){if(c>1)throw TypeError("Generator is already running");for(u&&1===l&&f(l,m),s=l,d=m;(n=s<2?e:d)||!u;){i||(s?s<3?(s>1&&(p.n=-1),f(s,d)):p.n=d:p.v=d);try{if(c=2,i){if(s||(r="next"),n=i[r]){if(!(n=n.call(i,d)))throw TypeError("iterator result is not an object");if(!n.done)return n;d=n.value,s<2&&(s=0)}else 1===s&&(n=i.return)&&n.call(i),s<2&&(d=TypeError("The iterator does not provide a '"+r+"' method"),s=1);i=e}else if((n=(u=p.n<0)?d:t.call(a,p))!==o)break}catch(n){i=e,s=1,d=n}finally{c=1}}return{value:n,done:u}}}(t,r,i),!0),l}var o={};function c(){}function l(){}function u(){}n=Object.getPrototypeOf;var p=[][a]?n(n([][a]())):(d(n={},a,function(){return this}),n),f=u.prototype=c.prototype=Object.create(p);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,d(e,r,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=u,d(f,"constructor",u),d(u,"constructor",l),l.displayName="GeneratorFunction",d(u,r,"GeneratorFunction"),d(f),d(f,r,"Generator"),d(f,a,function(){return this}),d(f,"toString",function(){return"[object Generator]"}),(s=function(){return{w:i,m}})()}function d(e,n,t,a){var r=Object.defineProperty;try{r({},"",{})}catch(e){r=0}d=function(e,n,t,a){if(n)r?r(e,n,{value:t,enumerable:!a,configurable:!a,writable:!a}):e[n]=t;else{var i=function(n,t){d(e,n,function(e){return this._invoke(n,t,e)})};i("next",0),i("throw",1),i("return",2)}},d(e,n,t,a)}function c(e,n,t,a,r,i,o){try{var s=e[i](o),d=s.value}catch(e){return void t(e)}s.done?n(d):Promise.resolve(d).then(a,r)}function l(e){return function(){var n=this,t=arguments;return new Promise(function(a,r){var i=e.apply(n,t);function o(e){c(i,a,r,o,s,"next",e)}function s(e){c(i,a,r,o,s,"throw",e)}o(void 0)})}}function u(){return p.apply(this,arguments)}function p(){return(p=l(s().m(function e(){var n,t;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!window.authManager||!window.authManager.isAuthenticated()){e.n=1;break}return e.a(2,window.authManager.getCurrentUser());case 1:if(e.p=1,!window.supabase){e.n=3;break}return e.n=2,window.supabase.auth.getUser();case 2:return n=e.v,t=n.data.user,e.a(2,t);case 3:e.n=5;break;case 4:e.p=4,e.v;case 5:return e.a(2,null)}},e,null,[[1,4]])}))).apply(this,arguments)}function f(){return m.apply(this,arguments)}function m(){return(m=l(s().m(function e(){var n,t;return s().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,u();case 1:if(n=e.v){e.n=2;break}return alert("请先登录"),t=new CustomEvent("showAuthModal",{detail:{message:"请登录后操作",redirect:window.location.href}}),window.dispatchEvent(t),e.a(2,null);case 2:return e.a(2,n)}},e)}))).apply(this,arguments)}var g=!1,b=!1;document.querySelectorAll(".menu-item"),document.querySelectorAll(".content-section");function v(){g||(g=!0,document.addEventListener("click",handleGlobalClick),document.addEventListener("keydown",function(e){"Escape"===e.key&&C()}))}function y(e){return h.apply(this,arguments)}function h(){return(h=l(s().m(function e(n){var t,a,r;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("note_annotations").select("*").eq("note_id",n).order("display_order",{ascending:!0});case 1:if(t=e.v,a=t.data,!(r=t.error)){e.n=2;break}throw r;case 2:return e.a(2,a||[]);case 3:return e.p=3,e.v,e.a(2,[])}},e,null,[[0,3]])}))).apply(this,arguments)}function w(e){return x.apply(this,arguments)}function x(){return(x=l(s().m(function e(n){var t;return s().w(function(e){for(;;)switch(e.n){case 0:if(n&&0!==n.length){e.n=1;break}return e.a(2,"");case 1:return t=i(n).sort(function(e,n){return e.display_order-n.display_order}),e.a(2,'\n        <div class="note-annotations" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">\n            <div style="font-weight: bold; margin-bottom: 8px; font-size: 13px;">注解:</div>\n            '.concat(t.map(function(e){return'\n                <div style="margin-bottom: 6px; line-height: 1.4; font-size: 12px;">\n                    <span style="color: #0066cc; font-weight: bold; margin-right: 4px;">'.concat(k(e.display_order),"</span>\n                    <span>").concat(e.annotation_text||"（无注解内容）","</span>\n                </div>\n            ")}).join(""),"\n        </div>\n    "))}},e)}))).apply(this,arguments)}function k(e){return e<=20?["⓪","①","②","③","④","⑤","⑥","⑦","⑧","⑨","⑩","⑪","⑫","⑬","⑭","⑮","⑯","⑰","⑱","⑲","⑳"][e]:"(".concat(e,")")}function E(e){var n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,function(e){return n[e]})}function _(){return(_=l(s().m(function e(n,t){var r,i,o,d,c,l,u,p,m,g,b;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("drafts").select("*").eq("id",n).single();case 1:if(r=e.v,i=r.data,!r.error&&i){e.n=2;break}return alert("Unable to add to cart"),e.a(2);case 2:return o=29.99,i.data&&(d=i.data,c=d.color||"white",l=d.backImages&&d.backImages.length>0,u=l?"double-sided":"single-sided",window.TSHIRT_PRICING&&window.TSHIRT_PRICING[u]&&(o="white"===c?window.TSHIRT_PRICING[u].white:"black"===c?window.TSHIRT_PRICING[u].black:window.TSHIRT_PRICING[u].colored)),e.n=3,f();case 3:if(p=e.v){e.n=4;break}return e.a(2);case 4:return m=a(a({},i.data),{},{sizeQuantities:t}),e.n=5,supabase.from("drafts").update({data:m,sizes:t,updated_at:(new Date).toISOString()}).eq("id",n);case 5:if(g=e.v,g.error,!window.CartManager||!window.CartManager.addOrUpdateCartItem){e.n=7;break}return e.n=6,window.CartManager.addOrUpdateCartItem({draftId:n,itemData:{type:"custom-design",designType:"custom",color:(null===(b=i.data)||void 0===b?void 0:b.color)||"white",title:i.title||"Custom T-shirt Design",unitPrice:o},sizes:t,userId:p.id});case 6:e.v;case 7:e.n=9;break;case 8:e.p=8,e.v,alert("Operation failed, please try again.");case 9:return e.a(2)}},e,null,[[0,8]])}))).apply(this,arguments)}function I(){return S.apply(this,arguments)}function S(){return(S=l(s().m(function e(){var n,t,a;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,u();case 1:if(n=e.v){e.n=2;break}return e.a(2);case 2:return e.n=3,supabase.from("drafts").select("*").eq("user_id",n.id).order("created_at",{ascending:!1});case 3:if(t=e.v,a=t.data,!t.error){e.n=4;break}return e.a(2);case 4:P(a),e.n=6;break;case 5:e.p=5,e.v;case 6:return e.a(2)}},e,null,[[0,5]])}))).apply(this,arguments)}function P(e){var n=document.getElementById("draft");if(n){var t=e.map(function(e){var n="";return("svg"===e.type||"tshirt"===e.type)&&(n=e.front_preview_image),'\n        <div class="draft-item" data-id="'.concat(e.id,'">\n            <div style="display: flex; align-items: center; gap: 10px;">\n                <img src="').concat(n,'" alt="预览" \n                     style="width: 80px; height: 80px; object-fit: cover;  border: 2px solid black; aspect-ratio: 1 / 1; ">\n                <div style="flex: 1;">\n                    <p>').concat("svg"===e.type?"DOODLE":"T-SHIRT","</p>\n                    <p>CREATED: ").concat(new Date(e.created_at).toLocaleString(),'</p>\n                </div>\n                <div class="button-containe">\n                    <button class="load-draft-btn" data-draft-id="').concat(e.id,'" style="margin-right: 10px; border: 2px solid black; background:white; width:100px;font-size: 15px">LOAD</button>\n                    <button class="delete-draft-btn" data-draft-id="').concat(e.id,'" style="color: black;border: 2px solid black; background:white; width:100px; font-size: 15px">DELETE</button>\n                </div>\n            </div>\n        </div>\n\n        ')}).join("");n.innerHTML=t}}function A(){return(A=l(s().m(function e(n){return s().w(function(e){for(;;)switch(e.n){case 0:if(!b){e.n=1;break}return e.a(2);case 1:b=!0,setTimeout(l(s().m(function e(){var t,a,r,o,d,c,l,u,p,f,m,g;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("确定要删除这个草稿吗？")){e.n=1;break}return b=!1,e.a(2);case 1:return e.p=1,e.n=2,supabase.from("drafts").select("*").eq("id",n).single();case 2:if(t=e.v,a=t.data,!t.error){e.n=3;break}return alert("删除失败"),b=!1,e.a(2);case 3:if(r=[],o=function(e){if(!e||"string"!=typeof e)return null;var n=e.match(/\/storage\/v1\/object\/public\/design-files\/(.+)/);return n?n[1]:null},"svg"===a.type?(a.data&&(a.data.storageUrl&&(d=o(a.data.storageUrl))&&r.push(d),a.data.fileName&&(r.includes(a.data.fileName)||r.push(a.data.fileName))),a.front_preview_image&&(c=o(a.front_preview_image))&&!r.includes(c)&&r.push(c)):"tshirt"===a.type&&((l=a.data)&&(l.frontImages&&Array.isArray(l.frontImages)&&l.frontImages.forEach(function(e,n){if(e.storageFile)if(e.storageFile.fileName)r.push(e.storageFile.fileName);else if(e.storageFile.publicUrl){var t=o(e.storageFile.publicUrl);t&&!r.includes(t)&&r.push(t)}}),l.backImages&&Array.isArray(l.backImages)&&l.backImages.forEach(function(e,n){if(e.storageFile)if(e.storageFile.fileName)r.push(e.storageFile.fileName);else if(e.storageFile.publicUrl){var t=o(e.storageFile.publicUrl);t&&!r.includes(t)&&r.push(t)}}),l.frontPreviewFile&&l.frontPreviewFile.fileName&&r.push(l.frontPreviewFile.fileName),l.backPreviewFile&&l.backPreviewFile.fileName&&r.push(l.backPreviewFile.fileName)),a.front_preview_image&&(u=o(a.front_preview_image))&&!r.includes(u)&&r.push(u),a.back_preview_image&&(p=o(a.back_preview_image))&&!r.includes(p)&&r.push(p)),!((f=i(new Set(r))).length>0)){e.n=5;break}return e.n=4,supabase.storage.from("design-files").remove(f);case 4:m=e.v,m.data,m.error;case 5:return e.n=6,supabase.from("drafts").delete().eq("id",n);case 6:if(g=e.v,!g.error){e.n=7;break}alert("删除失败"),e.n=8;break;case 7:return alert("草稿已删除"),e.n=8,I();case 8:e.n=10;break;case 9:e.p=9,e.v,alert("删除失败");case 10:return e.p=10,setTimeout(function(){b=!1},500),e.f(10);case 11:return e.a(2)}},e,null,[[1,9,10,11]])})),0);case 2:return e.a(2)}},e)}))).apply(this,arguments)}function T(){return(T=l(s().m(function e(n){var t,a;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("drafts").select("*").eq("id",n).single();case 1:if(t=e.v,a=t.data,!t.error){e.n=2;break}return e.a(2);case 2:"svg"===a.type?L(a):"tshirt"===a.type&&D(a),e.n=4;break;case 3:e.p=3,e.v;case 4:return e.a(2)}},e,null,[[0,3]])}))).apply(this,arguments)}function L(e){var n='\n    \n        <div id="draftPreviewModal" class="modal-overlay-svg" style="position: fixed; top: 0; left: 5px; width: calc(100% - 10px); height: 100%; z-index: 10000;  display: flex; justify-content: center; align-items: center; ">\n            <div class="modal-content-svg" style="background: white; padding: 20px;  max-width: 100vw; max-height: 100vh;  border: 2px solid black;">\n                <div class="preview-container" style="display: flex; gap: 30px; justify-content: center; margin-bottom: 20px;">\n                    <div class="preview-item" style="text-align: center;">\n                        <span style="font-size: 18px; margin-bottom: 10px; display: block;">PREVIEW</span>\n                        <div class="preview-tshirt" style="width: 200px; height: 250px; background-image: url(\''.concat(e.front_preview_image,'\'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto; outline: none; box-shadow: none;border: 2px solid black;"></div>\n                    </div>\n                </div>\n              \n                <div class="modal-buttons" style="display: flex; gap: 20px; justify-content: space-between;">\n                    <button class="edit-draft" data-draft-id="').concat(e.id,'" style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 150px;">BACK TO EDIT</button>\n                    <button class="add-in-gallery" data-draft-id="').concat(e.id,'" style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 150px;">ADD TO GALLERY</button>\n                </div>\n            </div>\n        </div>\n    ');document.body.insertAdjacentHTML("beforeend",n)}function D(e){var n,t=(null===(n=e.data)||void 0===n?void 0:n.sizeQuantities)||e.sizes||{XS:0,S:0,M:0,L:0,XL:0,"2XL":0,"3XL":0},a='\n    <div id="draftPreviewModal" class="modal-overlay" style="position: fixed; top: 0; left: 5px; width: calc(100% - 10px); height: 100%; z-index: 10000; display: flex; justify-content: center; align-items: center;">\n      <div class="modal-content" style="background: white; padding: 25px; max-width: 70vh; max-height: 80vh; overflow-y: auto; border: 2px solid black; position: relative;">\n        <div class="preview-container" style="display: flex; gap: 30px; justify-content: center; margin-bottom: 20px;">\n          <div class="preview-item" style="text-align: center;">\n            <span style="font-size: 18px; margin-bottom: 10px; display: block;">FRONT</span>\n            <div style="border: 2px black solid;">\n              <div class="preview-tshirt" style="width: 200px; height: 250px; min-width: 120px; background-image: url(\''.concat(e.front_preview_image,'\'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto;"></div>\n            </div>\n          </div>\n          <div class="preview-item" style="text-align: center;">\n            <span style="font-size: 18px; margin-bottom: 10px; display: block;">BACK</span>\n            <div style="border: 2px black solid;">\n              <div class="preview-tshirt" style="width: 200px; height: 250px; min-width: 100px; background-image: url(\'').concat(e.back_preview_image,'\'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto;"></div>\n            </div>\n          </div>\n        </div>\n        \n        <div class="size-selection-horizontal" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 20px;">\n          ').concat(["XS","S","M","L","XL","2XL","3XL"].map(function(e){return'\n            <div class="size-option">\n              <label>'.concat(e,'</label>\n              <div class="quantity-control" style="display: flex; align-items: center; overflow: hidden;">\n                <input type="number" class="quantity-input" data-size="').concat(e,'" value="').concat(t[e]||0,'" min="0" max="99" style="width: 45px; height: 30px; text-align: center; border: 2px solid black;">\n              </div>\n            </div>\n          ')}).join(""),'\n        </div>\n        \n        <div class="modal-buttons" style="display: flex; gap: 20px; justify-content: space-between;">\n          <button class="edit-draft" data-draft-id="').concat(e.id,'" style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 120px;">BACK TO EDIT</button>\n          <button class="add-to-cart-tshirt" data-draft-id="').concat(e.id,'" style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 120px;">UPDATE CART</button>\n        </div>\n      </div>\n    </div>\n    ');document.body.insertAdjacentHTML("beforeend",a)}function C(){var e=document.getElementById("draftPreviewModal");e&&e.remove()}function N(){return(N=l(s().m(function e(n){var t,a;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("drafts").select("*").eq("id",n).single();case 1:if(t=e.v,a=t.data,!t.error&&a){e.n=2;break}return alert("无法加载草稿"),e.a(2);case 2:"svg"===a.type?window.location.href="/?loadSvgDraft=".concat(n):"tshirt"===a.type&&(window.location.href="/?loadTshirtDraft=".concat(n)),e.n=4;break;case 3:e.p=3,e.v,alert("加载失败，请重试");case 4:return e.a(2)}},e,null,[[0,3]])}))).apply(this,arguments)}function O(){return(O=l(s().m(function e(n){var t,a,r,i,o,d,c,l,u,p,m,g;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,f();case 1:if(i=e.v){e.n=2;break}return e.a(2);case 2:return e.n=3,supabase.from("drafts").select("*").eq("id",n).single();case 3:if(o=e.v,d=o.data,!o.error&&d){e.n=4;break}return alert("无法获取草稿信息"),e.a(2);case 4:if("svg"===d.type){e.n=5;break}return alert("只能将SVG草稿添加到Gallery"),e.a(2);case 5:return e.n=6,supabase.from("gallery").select("id").eq("draft_id",n).maybeSingle();case 6:if(c=e.v,!c.data){e.n=7;break}return alert("This artwork is already in the gallery!"),e.a(2);case 7:return l=prompt("Give your artwork a title:","My Doodle")||"Untitled",u=prompt("Add a description (optional):","")||"",p={user_id:i.id,draft_id:n,title:l,description:u,preview_image:d.front_preview_image,svg_url:(null===(t=d.data)||void 0===t?void 0:t.storageUrl)||null,svg_data:(null===(a=d.data)||void 0===a?void 0:a.svgContent)||(null===(r=d.data)||void 0===r?void 0:r.svgData)||null},e.n=8,supabase.from("gallery").insert([p]).select().single();case 8:if(m=e.v,m.data,!(g=m.error)){e.n=9;break}return alert("添加失败："+g.message),e.a(2);case 9:if(!confirm("Successfully added to gallery! Do you want to delete this draft?")){e.n=11;break}return e.n=10,z(n);case 10:e.n=13;break;case 11:if(C(),!confirm("View in gallery now?")){e.n=12;break}"function"==typeof loadPage?loadPage("gallery"):window.location.href="/gallery",e.n=13;break;case 12:return e.n=13,I();case 13:e.n=15;break;case 14:e.p=14,e.v,alert("添加失败，请重试");case 15:return e.a(2)}},e,null,[[0,14]])}))).apply(this,arguments)}function z(e){return q.apply(this,arguments)}function q(){return(q=l(s().m(function e(n){var t,a,r,o,d,c,l,u,p,f;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("drafts").select("*").eq("id",n).single();case 1:if(t=e.v,a=t.data,!t.error){e.n=2;break}return e.a(2);case 2:if(r=[],o=function(e){if(!e||"string"!=typeof e)return null;var n=e.match(/\/storage\/v1\/object\/public\/design-files\/(.+)/);return n?n[1]:null},"svg"===a.type&&(null!==(d=a.data)&&void 0!==d&&d.storageUrl&&(l=o(a.data.storageUrl))&&r.push(l),null!==(c=a.data)&&void 0!==c&&c.fileName&&r.push(a.data.fileName)),!((u=i(new Set(r))).length>0)){e.n=4;break}return e.n=3,supabase.storage.from("design-files").remove(u);case 3:p=e.v,p.error;case 4:return e.n=5,supabase.from("drafts").delete().eq("id",n);case 5:if(f=e.v,!f.error){e.n=6;break}alert("草稿删除失败"),e.n=8;break;case 6:if(C(),!confirm("Draft deleted. View in gallery now?")){e.n=7;break}"function"==typeof loadPage?loadPage("gallery"):window.location.href="/gallery",e.n=8;break;case 7:return e.n=8,I();case 8:e.n=10;break;case 9:e.p=9,e.v;case 10:return e.a(2)}},e,null,[[0,9]])}))).apply(this,arguments)}function M(){return B.apply(this,arguments)}function B(){return(B=l(s().m(function e(){var n,t,a,r;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,u();case 1:if(n=e.v){e.n=2;break}return(t=document.getElementById("order"))&&(t.innerHTML='<p style="text-align: center; padding: 20px;">Please login to view your orders</p>'),e.a(2);case 2:return e.n=3,supabase.from("orders").select("*").eq("user_id",n.id).order("created_at",{ascending:!1});case 3:if(a=e.v,r=a.data,!a.error){e.n=4;break}return e.a(2);case 4:F(r.map(function(e){try{"string"==typeof e.items&&(e.items=JSON.parse(e.items)),Array.isArray(e.items)||(e.items=[])}catch(n){e.items=[]}return e})),e.n=6;break;case 5:e.p=5,e.v;case 6:return e.a(2)}},e,null,[[0,5]])}))).apply(this,arguments)}function F(e){var n=document.getElementById("order");if(n)if(e&&0!==e.length){var t="";e.forEach(function(e){var n=new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),a=e.paid_at?new Date(e.paid_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Not paid",r="",i="#666";switch(e.status){case"awaiting_verification":r="AWAITING VERIFICATION (等待审核)",i="#FFA500";break;case"verified":r="PAYMENT VERIFIED (付款已确认)",i="#28a745";break;case"shipped":r="SHIPPED (已发货)",i="#17a2b8";break;case"delivered":r="DELIVERED (已送达)",i="#28a745";break;case"cancelled":r="CANCELLED (已取消)",i="#dc3545";break;default:r=e.status.toUpperCase()}var o=parseFloat(e.amount)||0,s=parseFloat(e.shipping_cost)||0,d=parseFloat(e.tax_amount)||0,c=o+s+d,l="";"awaiting_verification"===e.status||"verified"===e.status?l+='\n         <button class="cancel-order-btn" data-order-id="'.concat(e.order_id,'"  style="\n             padding: 5px 20px;\n             font-size:15px;\n             background: white;\n             color: black;\n             cursor: pointer;\n             border: 2px black solid;\n         ">CANCEL ORDER</button>\n     '):"shipped"!==e.status&&"delivered"!==e.status||(l+='\n         <button class="track-order-btn" data-order-id="'.concat(e.order_id,'" data-tracking-number="').concat(e.tracking_number||"",'"  style="\n         padding: 5px 20px;\n         font-size:15px;\n         background: white;\n         color: black;\n         cursor: pointer;\n         border: 2px black solid;\n         ">ORDER TRACKING</button>\n     ')),t+='\n            <div class="order-item" style="\n                background: white;\n                border: 2px solid black;\n                padding: 20px;\n                margin-bottom: 20px;\n                position: relative;\n            ">\n                <div class="order-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;  ">\n                    <div >\n                        <h3 style="margin: 0; font-size: 20px;">ORDER #'.concat(e.order_id,'</h3>\n                        <p style="color: #666; margin: 5px 0; font-size: 14px;">Placed on ').concat(n,'</p>\n                    </div>\n                    <div class="status" style="text-align: right;">\n                        <span class="status-badge" style="\n                            background: ').concat(i,';\n                        ">').concat(r,'</span>\n                    </div>\n                </div>\n\n                <div style="  margin-bottom: 15px; font-size: 15px;">\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">\n                        <span>Manifesto#:</span>\n                        <span>').concat(e.manifesto||"Anonymous",'</span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">\n                        <span>Payment Method:</span>\n                        <span>').concat("alipay"===e.payment_method?"Alipay (支付宝)":"wechat"===e.payment_method?"WeChat Pay (微信支付)":e.payment_method,"</span>\n                    </div>\n                    ").concat(e.paid_at?'\n                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">\n                            <span>Paid At:</span>\n                            <span>'.concat(a,"</span>\n                        </div>\n                    "):"",'\n                </div>\n\n                <div style="border-top: 2px solid black; padding-top: 15px; margin-bottom: 15px;">\n                    <h4 style="margin-bottom: 10px;">Items (').concat(e.items?e.items.length:0,")</h4>\n                    ").concat(e.items&&e.items.length>0?'\n                        <div style="max-height: 200px; overflow-y: auto;">\n                            '.concat(e.items.map(function(e){return'\n                                <div style="\n                                    display: flex;\n                                    justify-content: space-between;\n                                   \n                                    margin-bottom: 5px;\n                                ">\n                                    <div>\n                                        <strong>'.concat(function(e){if(!e)return"Unknown Item";if(e.title)return e.title;if(e.productName)return e.productName;if(e.name)return e.name;if(e.item_data)if("string"==typeof e.item_data)try{var n=JSON.parse(e.item_data);if(n.productName)return n.productName;if(n.name)return n.name}catch(e){}else if(e.item_data.productName)return e.item_data.productName;if(e.type){if(e.type.startsWith("console-")){var t=e.type.replace("console-","");return"RETRO CONSOLE #".concat(t)}if(e.type.includes("blank-tshirt"))return"BLANK T-SHIRT";if(e.type.includes("custom-design")||e.draft_id)return"CUSTOMIZED T-SHIRT"}return"PRODUCT"}(e),"</strong>\n                                        ").concat(e.size?'<span style="color: #666; ">Size: '.concat(e.size,"</span>"):"","\n                                        ").concat(e.quantity>1?'<span style="color: #666; margin-left: 10px;">× '.concat(e.quantity,"</span>"):"","\n                                    </div>\n                                    <div>\n                                        ¥").concat((parseFloat(e.price)*(e.quantity||1)).toFixed(2),"\n                                    </div>\n                                </div>\n                            ")}).join(""),"\n                        </div>\n                    "):'<p style="color: #999;">No item details available</p>','\n                </div>\n\n                <div style="border-top: black 2px solid ; padding-top: 15px; margin-bottom: 15px;">\n                    <h4 style="margin-bottom: 10px;">Shipping Address</h4>\n                    ').concat(e.shipping_address?'\n                        <div style="  font-size: 14px;">\n                       '.concat(e.shipping_address.fullName||e.shipping_address.name||"","<br>\n                        ").concat(e.shipping_address.email?"Email: ".concat(e.shipping_address.email,"<br>"):"","\n                        ").concat(e.shipping_address.phone?"Phone: ".concat(e.shipping_address.phone,"<br>"):"","\n                        ").concat(e.shipping_address.address1||e.shipping_address.street||"","<br>\n                        ").concat(e.shipping_address.address2?"".concat(e.shipping_address.address2,"<br>"):"","\n                        ").concat(e.shipping_address.city||""," ").concat(e.shipping_address.state||""," ").concat(e.shipping_address.zipCode||"","<br>\n                        ").concat(e.shipping_address.country||"","\n                        </div>\n                    "):'<p style="color: #999;">No shipping address provided</p>','\n                </div>\n\n                <div style="border-top: 2px solid black; padding-top: 15px;">\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size:15px;">\n                        <span>Subtotal:</span>\n                        <span>¥').concat(o.toFixed(2),'</span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size:15px;">\n                        <span>Shipping:</span>\n                        <span>¥').concat(s.toFixed(2),'</span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size:15px;">\n                        <span>Tax:</span>\n                        <span>¥').concat(d.toFixed(2),'</span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">\n                        <span>Total:</span>\n                        <span>¥').concat(c.toFixed(2),"</span>\n                    </div>\n                </div>\n\n               \n                ").concat(e.tracking_number?'\n                    <div style="margin-top: 15px; padding: 10px;  border: 2px solid black;">\n                        <strong>Tracking Number:</strong> '.concat(e.tracking_number,"<br>\n                        <strong>Courier:</strong> ").concat(e.courier,"\n                    </div>\n                "):"",'\n\n                <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">\n                    ').concat(l,"\n                </div>\n          \n               \n        </div>\n        ")}),n.innerHTML=t}else n.innerHTML='\n            <div style="text-align: center; padding: 40px;">\n                <h2 style="color: black; margin-bottom: 20px;">NO ORDERS YET</h2>\n                <p style="color: #999;">Your orders will appear here after purchase</p>\n            </div>\n        '}function j(){return(j=l(s().m(function e(n,t,a){var r;return s().w(function(e){for(;;)switch(e.n){case 0:if(t){e.n=1;break}return alert("Tracking number not available yet.\n追踪号码尚未生成。\n\nPlease check back later.\n请稍后再查看。"),e.a(2);case 1:r="https://www.17track.net/en#nums=".concat(t,"&auto=1"),window.open(r,"_blank");case 2:return e.a(2)}},e)}))).apply(this,arguments)}document.addEventListener("DOMContentLoaded",function(){var e=setInterval(function(){window.authManager&&(clearInterval(e),window.authManager.isAuthenticated()&&(setTimeout(l(s().m(function e(){return s().w(function(e){for(;;)switch(e.n){case 0:if("function"!=typeof window.displayUserProfile){e.n=1;break}return e.n=1,window.displayUserProfile();case 1:return e.a(2)}},e)})),200),v()))},100)}),window.handleGlobalClick=function(e){if(e.target.classList.contains("menu-item")){var n=e.target.getAttribute("data-target");if(!n)return;if(!window.authManager||!window.authManager.isAuthenticated()){alert("请先登录");var t=new CustomEvent("showAuthModal",{detail:{message:"请登录后操作",redirect:window.location.href}});return void window.dispatchEvent(t)}document.querySelectorAll(".menu-item").forEach(function(e){return e.classList.remove("active")}),e.target.classList.add("active"),document.querySelectorAll(".content-section").forEach(function(e){return e.classList.remove("active")});var a=document.getElementById(n);return a&&a.classList.add("active"),"library"===n&&loadLibrary(),"draft"===n&&I(),"order"===n&&M(),void("setting"===n&&H())}if(e.target.classList.contains("load-draft-btn")){e.preventDefault(),e.stopPropagation();var r=e.target.getAttribute("data-draft-id");r&&function(e){T.apply(this,arguments)}(r)}else if(e.target.classList.contains("delete-draft-btn")){e.preventDefault(),e.stopPropagation();var i=e.target.getAttribute("data-draft-id");i&&!b&&function(e){A.apply(this,arguments)}(i)}else if(e.target.classList.contains("edit-draft")){e.preventDefault(),e.stopPropagation();var o=e.target.getAttribute("data-draft-id");o&&function(e){N.apply(this,arguments)}(o)}else if(e.target.classList.contains("add-to-cart-tshirt")){e.preventDefault(),e.stopPropagation();var s=e.target.getAttribute("data-draft-id");if(s){var d=document.querySelectorAll("#draftPreviewModal .quantity-input"),c={},l=!1;if(d.forEach(function(e){var n=e.getAttribute("data-size"),t=parseInt(e.value)||0;t>0&&(c[n]=t,l=!0)}),!l)return void alert("Please select at least one size");!function(e,n){_.apply(this,arguments)}(s,c)}}else if(e.target.classList.contains("add-in-gallery")){e.preventDefault(),e.stopPropagation();var u=e.target.getAttribute("data-draft-id");u&&function(e){O.apply(this,arguments)}(u)}else if(e.target.classList.contains("modal-overlay")||e.target.classList.contains("modal-overlay-svg"))"draftPreviewModal"===e.target.id&&C();else if(e.target.classList.contains("view-order-details-btn")){e.preventDefault(),e.stopPropagation();var p=e.target.getAttribute("data-order-id");p&&viewOrderDetails(p)}else if(e.target.classList.contains("cancel-order-btn")){e.preventDefault(),e.stopPropagation();var f=e.target.getAttribute("data-order-id");f&&function(e){R.apply(this,arguments)}(f)}else if(e.target.classList.contains("track-order-btn")){e.preventDefault(),e.stopPropagation();var m=e.target.getAttribute("data-order-id"),g=e.target.getAttribute("data-tracking-number");m&&function(e,n,t){j.apply(this,arguments)}(m,g)}else if(e.target.classList.contains("reorder-items-btn")){e.preventDefault(),e.stopPropagation();var v=e.target.getAttribute("data-order-id");v&&reorderItems(v)}else{if(e.target.classList.contains("close-tracking-modal-x-btn"))return e.preventDefault(),e.stopPropagation(),void closeTrackingModal();if(e.target.classList.contains("close-tracking-modal-btn"))return e.preventDefault(),e.stopPropagation(),void closeTrackingModal();if(e.target.classList.contains("open-courier-website-btn")){e.preventDefault(),e.stopPropagation();var y=e.target.getAttribute("data-tracking-number");y&&window.open("https://www.example-courier.com/track/".concat(y),"_blank")}else e.target.classList.contains("modal-overlay")?"draftPreviewModal"===e.target.id&&C():"trackingModal"!==e.target.id||closeTrackingModal()}},"undefined"!=typeof window&&"undefined"!=typeof displayUserProfile&&(window.displayUserProfile=displayUserProfile),window.reloadProfileBarcode=l(s().m(function e(){return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,displayUserProfile();case 1:e.n=3;break;case 2:e.p=2,e.v;case 3:return e.a(2)}},e,null,[[0,2]])})),window.addEventListener("profilePageLoaded",l(s().m(function e(){return s().w(function(e){for(;;)switch(e.n){case 0:if("function"!=typeof displayUserProfile){e.n=1;break}return e.n=1,displayUserProfile();case 1:return e.a(2)}},e)}))),function e(){try{if("undefined"!=typeof supabase&&document.getElementById("library")){var n=document.querySelector('.menu-item[data-target="library"]');n&&!n.classList.contains("active")&&(document.querySelectorAll(".menu-item").forEach(function(e){return e.classList.remove("active")}),n.classList.add("active"));var t=document.getElementById("library");t&&!t.classList.contains("active")&&(document.querySelectorAll(".content-section").forEach(function(e){return e.classList.remove("active")}),t.classList.add("active")),loadLibrary()}else setTimeout(e,200)}catch(n){setTimeout(e,200)}}(),window.loadLibrary=l(s().m(function e(){var n,t,a,r,i,o,d,c,l,p,f,m,g,b,v,h,x,k,_,I,S,P,A,T,L,D;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=document.getElementById("library")){e.n=1;break}return e.a(2);case 1:return n.innerHTML='\n        <div style="padding: 20px; text-align: center;">\n            <div class="loading">Loading your library...</div>\n        </div>\n    ',e.p=2,e.n=3,u();case 3:if(t=e.v){e.n=4;break}return n.innerHTML='\n                <div style="padding: 40px; text-align: center;">\n                    <p style="font-size: 18px; margin-bottom: 20px;">请先登录查看你的书库</p>\n                </div>\n            ',e.a(2);case 4:return e.n=5,supabase.from("book_wants").select("book_id, created_at").eq("user_id",t.id).order("created_at",{ascending:!1});case 5:if(a=e.v,r=a.data,!(i=a.error)){e.n=6;break}throw i;case 6:return e.n=7,supabase.from("book_readings").select("book_id, created_at").eq("user_id",t.id).order("created_at",{ascending:!1});case 7:if(o=e.v,d=o.data,!(c=o.error)){e.n=8;break}throw c;case 8:return e.n=9,supabase.from("book_notes").select("*").eq("user_id",t.id).order("created_at",{ascending:!1});case 9:if(l=e.v,p=l.data,!(f=l.error)){e.n=10;break}throw f;case 10:if(m={},p&&p.forEach(function(e){m[e.book_id]||(m[e.book_id]=[]),m[e.book_id].push(e)}),g=window.BOOKS_DATA||{},b="<div>",d&&d.length>0&&(b+='<div class="library-section" style="margin-bottom: 10px;">',b+='<div style="font-size: 22px;  border: 2px black solid; ">READ ('+d.length+")</div>",b+='<div style="margin-bottom: 10px;"></div>',b+='<div class="library-books-grid" style=" display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">',d.forEach(function(e){var n=g[e.book_id];if(n){var t=m[e.book_id]?m[e.book_id].length:0;b+='\n                        <div class="library-book-card" style="border: 2px solid black; padding: 10px; cursor: pointer;" \n                             onclick="scrollToBook(\''.concat(n.id,"', '").concat(n.category,'\')"\n                             >\n                             <div style="display: flex; justify-content: center; width: 100%; margin-bottom: 10px;">\n                            <img src="').concat(n.imgSrc,'" alt="').concat(n.title,'" style="width: 100px; height: auto; object-fit: cover;">\n                            </div>\n                            <span style="font-size: 16px;">').concat(n.title,'</span><br>\n                            <span style="font-size: 12px; color: #666;">').concat(t," NOTES</span>\n                        </div>\n                    ")}}),b+="</div></div>"),r&&r.length>0&&(b+='<div class="library-section" style="margin-bottom: 10px;">',b+='<div style="font-size: 22px; border: 2px black solid;">WANT ('+r.length+")</div>",b+='<div style="margin-bottom: 10px;"></div>',b+='<div class="library-books-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">',r.forEach(function(e){var n=g[e.book_id];if(n){var t=m[e.book_id]?m[e.book_id].length:0;b+='\n                        <div class="library-book-card" style="border: 2px solid black; padding: 10px; cursor: pointer; " \n                             onclick="scrollToBook(\''.concat(n.id,"', '").concat(n.category,'\')"\n                             >\n                             <div style="display: flex; justify-content: center; width: 100%; margin-bottom: 10px;">\n                            <img src="').concat(n.imgSrc,'" alt="').concat(n.title,'" style="width: 100px; height: auto; object-fit: cover; "></div>\n                            <span style="font-size: 16px; margin-bottom: 5px;">').concat(n.title,'</span><br>\n                            <span style="font-size: 12px; color: #666;">').concat(t," NOTES</span>\n                        </div>\n                    ")}}),b+="</div></div>"),!(p&&p.length>0)){e.n=19;break}b+='<div class="library-section" style="margin-bottom: 10px;">',b+='<div style="font-size: 22px; border: 2px black solid;">MY NOTES ('+p.length+")</div>",b+='<div style="margin-bottom: 10px;"></div>',v=0,h=Object.keys(m);case 11:if(!(v<h.length)){e.n=18;break}if(x=h[v],k=g[x],_=m[x],!(k&&_&&_.length>0)){e.n=17;break}b+='\n                        <div class="book-notes-section" style="margin-bottom: 10px; padding: 10px; border: 2px solid black;">\n                            <span style="font-size: 18px; cursor: pointer; font-weight: bold;" onclick="scrollToBook(\''.concat(x,"', '").concat(k.category,"')\">\n                                ").concat(k.title," (").concat(_.length,')\n                            </span>\n                            <div class="notes-list" id="library-notes-list-').concat(x,'">\n                    '),I=0;case 12:if(!(I<_.length)){e.n=16;break}return S=_[I],P=new Date(S.created_at).toLocaleDateString("zh-CN"),A="",S.page_start&&S.page_end?A="P".concat(S.page_start,"-").concat(S.page_end):S.page_start&&(A="P".concat(S.page_start)),e.n=13,y(S.id);case 13:return T=e.v,e.n=14,w(T);case 14:L=e.v,D=E(S.content),b+='\n                            <div class="library-note-item" id="library-note-'.concat(S.id,'" style="margin-bottom: 10px; padding: 10px; border: 2px solid black; background-color: white;">\n                                <div class="note-content-display" style="margin-bottom: 10px; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-break: break-word;">').concat(D,"</div>\n                                ").concat(L,'\n                                <div class="note-meta" style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #666; margin-top: 10px;">\n                                    <span>').concat(A?A+" · ":"").concat(P,'</span>\n                                    <div style="display: flex; gap: 10px;">\n                                        <span class="note-edit-btn" onclick="editLibraryNote(\'').concat(S.id,"', '").concat(x,"', ").concat(S.page_start||"null",", ").concat(S.page_end||"null",')" style="cursor: pointer; color: #666; ">编辑</span>\n                                        <span class="note-delete-btn" onclick="deleteLibraryNote(\'').concat(S.id,"', '").concat(x,'\')" style="cursor: pointer; color: #666; ">删除</span>\n                            \n                                    </div>\n                                </div>\n                            </div>\n                        ');case 15:I++,e.n=12;break;case 16:b+="</div></div>";case 17:v++,e.n=11;break;case 18:b+="</div>";case 19:d&&0!==d.length||r&&0!==r.length||p&&0!==p.length||(b='\n                <div style="padding: 40px; text-align: center;">\n                    <p style="font-size: 18px; margin-bottom: 20px;">你的书库还是空的</p>\n                    <p style="font-size: 14px; color: #666;">去标记一些书籍或添加笔记叭</p>\n                </div>\n            '),b+="</div>",n.innerHTML=b,e.n=21;break;case 20:e.p=20,e.v,n.innerHTML='\n            <div style="padding: 40px; text-align: center;">\n                <p style="color: red;">加载失败，请刷新重试</p>\n            </div>\n        ';case 21:return e.a(2)}},e,null,[[2,20]])})),window.scrollToBook=function(e,n){var t={law:"/law",game:"/game",design:"/design",culture:"/culture"}[n]||"/law";sessionStorage.setItem("scrollToBookId",e),sessionStorage.setItem("openNotesArea","true"),window.location.href=t},window.editLibraryNote=function(){var e=l(s().m(function e(n,t,a,r){var i,o,d,c,l;return s().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,supabase.auth.getUser();case 1:if(i=e.v,i.data.user){e.n=2;break}return alert("请先登录"),e.a(2);case 2:return o=document.getElementById("library-note-".concat(n)),e.n=3,supabase.from("book_notes").select("*").eq("id",n).single();case 3:if(d=e.v,c=d.data){e.n=4;break}return alert("笔记未找到"),e.a(2);case 4:return l=(l=c.content.replace(/[①-⑳⓪]/g,"")).split("\n").map(function(e){var n=e.trim();return n?n.replace(/^　+/g,""):""}).join("\n"),e.n=5,y(n);case 5:e.v,o.innerHTML='\n        <div style="margin-bottom: 10px;">\n            <div style="display: flex; gap: 10px; margin-bottom: 10px;">\n                <input type="number" id="lib-edit-pageStart-'.concat(n,'" value="').concat(a||"",'" placeholder="起始页" \n                    style="width: 100px; padding: 5px; border: 2px solid black;">\n                <span style="line-height: 30px;">-</span>\n                <input type="number" id="lib-edit-pageEnd-').concat(n,'" value="').concat(r||"",'" placeholder="结束页" \n                    style="width: 100px; padding: 5px; border: 2px solid black;">\n            </div>\n            <div id="lib-edit-content-').concat(n,'" contenteditable="true" style="width: 100%; min-height: 120px; padding: 10px; border: 2px solid black; font-family: inherit; font-size: 14px; white-space: pre-wrap; line-height: 1.6;">').concat(E(l),'</div>\n        </div>\n        <div style="display: flex; gap: 10px; margin-top: 10px;">\n            <button onclick="saveLibraryNoteEdit(\'').concat(n,"', '").concat(t,'\')" style="padding: 5px 15px; border: 2px solid black; background-color: white; cursor: pointer;">保存</button>\n            <button onclick="cancelLibraryNoteEdit(\'').concat(n,"', '").concat(t,'\')" style="padding: 5px 15px; border: 2px solid black; background-color: white; cursor: pointer;">取消</button>\n        </div>\n    ');case 6:return e.a(2)}},e)}));return function(n,t,a,r){return e.apply(this,arguments)}}(),window.saveLibraryNoteEdit=function(){var e=l(s().m(function e(n,t){var a,r,i,o,d,c;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,a=document.getElementById("lib-edit-content-".concat(n)),r=document.getElementById("lib-edit-pageStart-".concat(n)).value,i=document.getElementById("lib-edit-pageEnd-".concat(n)).value,o=(o=a.textContent.trim()).split("\n").map(function(e){var n=e.trim();return n?"　　"+n:""}).join("\n")){e.n=1;break}return alert("请输入笔记内容"),e.a(2);case 1:if(r){e.n=2;break}return alert("请填写页码"),e.a(2);case 2:return e.n=3,supabase.from("book_notes").update({content:o,page_start:parseInt(r),page_end:i?parseInt(i):null,updated_at:(new Date).toISOString()}).eq("id",n);case 3:if(d=e.v,!(c=d.error)){e.n=4;break}throw c;case 4:return e.n=5,loadLibrary();case 5:e.n=7;break;case 6:e.p=6,e.v,alert("保存失败，请重试");case 7:return e.a(2)}},e,null,[[0,6]])}));return function(n,t){return e.apply(this,arguments)}}(),window.cancelLibraryNoteEdit=function(){var e=l(s().m(function e(n,t){return s().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,loadLibrary();case 1:return e.a(2)}},e)}));return function(n,t){return e.apply(this,arguments)}}(),window.deleteLibraryNote=function(){var e=l(s().m(function e(n,t){var a,r;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("确定要删除这条笔记吗？")){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,supabase.from("book_notes").delete().eq("id",n);case 2:if(a=e.v,!(r=a.error)){e.n=3;break}throw r;case 3:return e.n=4,loadLibrary();case 4:e.n=6;break;case 5:e.p=5,e.v,alert("删除失败，请重试");case 6:return e.a(2)}},e,null,[[1,5]])}));return function(n,t){return e.apply(this,arguments)}}(),document.addEventListener("DOMContentLoaded",function(){v();var e=window.handleGlobalClick;window.handleGlobalClick=function(n){if(n.target.classList.contains("menu-item")){var t=n.target.getAttribute("data-target");if("order"===t){document.querySelectorAll(".menu-item").forEach(function(e){return e.classList.remove("active")}),n.target.classList.add("active"),document.querySelectorAll(".content-section").forEach(function(e){return e.classList.remove("active")});var a=document.getElementById(t);return a&&a.classList.add("active"),void M()}}e&&e.call(this,n)}}),window.addEventListener("orderSubmitted",function(e){var n=document.getElementById("order");n&&n.classList.contains("active")&&M()});var U=window.confirmPayment;function R(){return(R=l(s().m(function e(t){var a,r,i,o,d;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("Are you sure you want to cancel order #".concat(t,"?\n您确定要取消订单 #").concat(t," 吗？\n\nThis action cannot be undone.\n此操作无法撤销。"))){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,supabase.auth.getUser();case 2:if(a=e.v,r=a.data.user,!a.error&&r){e.n=3;break}return alert("Please login to cancel order"),e.a(2);case 3:return e.n=4,supabase.from("orders").update({status:"cancelled",cancelled_at:(new Date).toISOString()}).eq("order_id",t).eq("user_id",r.id).select().single();case 4:if(i=e.v,i.data,!(o=i.error)){e.n=8;break}if("PGRST204"!==o.code&&!o.message.includes("column")){e.n=7;break}return e.n=5,supabase.from("orders").update({status:"cancelled"}).eq("order_id",t).eq("user_id",r.id).select().single();case 5:if(d=e.v,d.data,!d.error){e.n=6;break}return alert("Failed to cancel order. Please try again.\n取消订单失败，请重试。"),e.a(2);case 6:n("data"),e.n=8;break;case 7:return alert("Failed to cancel order. Please try again.\n取消订单失败，请重试。"),e.a(2);case 8:return alert("Order #".concat(t," has been cancelled successfully.\n订单 #").concat(t," 已成功取消。\n\nRefund will be processed within 3-5 business days.\n退款将在3-5个工作日内处理。")),e.n=9,M();case 9:e.n=11;break;case 10:e.p=10,e.v,alert("An unexpected error occurred. Please try again.\n发生意外错误，请重试。");case 11:return e.a(2)}},e,null,[[1,10]])}))).apply(this,arguments)}function H(){return G.apply(this,arguments)}function G(){return(G=l(s().m(function e(){var n,t,a,r;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=document.getElementById("setting")){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,u();case 2:if(t=e.v){e.n=3;break}return n.innerHTML='<p style="text-align: center; padding: 20px;">Please login to access settings</p>',e.a(2);case 3:return e.n=4,supabase.from("profiles").select("manifesto, shipping_addresses").eq("user_id",t.id).single();case 4:a=e.v,r=a.data,a.error,window.currentAddresses=(null==r?void 0:r.shipping_addresses)||[],n.innerHTML='\n            <style>\n                .settings-section {\n                    border: 2px solid black;\n                    padding: 20px;\n                    margin-bottom: 20px;\n                    background: white;\n                }\n                \n                .settings-section h3 {\n                    margin-top: 0;\n                    margin-bottom: 20px;\n                    font-size: 20px;\n                    border-bottom: 2px solid black;\n                    padding-bottom: 10px;\n                }\n                \n                .form-group {\n                    margin-bottom: 15px;\n                }\n                \n                .form-group label {\n                    display: block;\n                    margin-bottom: 5px;\n                    font-weight: bold;\n                    font-size: 14px;\n                }\n                \n                .form-group input, .form-group select {\n                    width: 100%;\n                    padding: 10px;\n                    border: 2px solid black;\n                    font-size: 14px;\n                    box-sizing: border-box;\n                    background: white;\n                }\n                \n                .form-group input[type="checkbox"] {\n                    width: auto;\n                    margin-right: 10px;\n                    transform: scale(1.2);\n                }\n                \n                .form-group label input[type="checkbox"] {\n                    display: inline;\n                    margin-right: 8px;\n                }\n                \n                .settings-btn {\n                    padding: 8px 20px;\n                    background: black;\n                    color: white;\n                    border: none;\n                    cursor: pointer;\n                    font-size: 16px;\n                    margin-right: 10px;\n                    margin-bottom: 5px;\n                }\n                \n                .settings-btn:hover {\n                    background: #333;\n                }\n                \n                .settings-btn:disabled {\n                    background: #999;\n                    cursor: not-allowed;\n                }\n                \n                .settings-btn.secondary {\n                    background: #666;\n                }\n                \n                .settings-btn.secondary:hover {\n                    background: #555;\n                }\n                \n                .success-message, .error-message {\n                    background: black;\n                    color: white;\n                    padding: 5px;\n                    margin-bottom: 10px;\n                    display: none;\n                    border-radius:0;\n                    position: relative;\n                    font-size:16px;\n                }\n                \n                \n                .two-columns {\n                    display: grid;\n                    grid-template-columns: 1fr 1fr;\n                    gap: 15px;\n                }\n                \n                .address-card {\n                    border: 2px solid black;\n                    padding: 15px;\n                    margin-bottom: 15px;\n                    position: relative;\n                }\n                \n                .address-card .address-header {\n                    display: flex;\n                    align-items: center;\n                    margin-bottom: 10px;\n                }\n                \n                .address-card .default-badge {\n                    background: black;\n                    color: white;\n                    padding: 2px 8px;\n                    font-size: 12px;\n                    margin-left: 15px;\n                    font-weight: bold;\n                }\n                \n                .address-card .address-info {\n                    font-size: 14px;\n                    color: #555;\n                    line-height: 1.4;\n                }\n                \n                .address-card .address-actions {\n                    margin-top: 15px;\n                    display: flex;\n                    gap: 10px;\n                    flex-wrap: wrap;\n                }\n                \n                .address-card .settings-btn {\n                    padding: 5px 12px;\n                    font-size: 12px;\n                    margin: 0;\n                }\n                \n                @media (max-width: 768px) {\n                    .two-columns {\n                        grid-template-columns: 1fr;\n                    }\n                    \n                    .address-card .address-actions {\n                        flex-direction: column;\n                    }\n                    \n                    .address-card .settings-btn {\n                        width: 100%;\n                        margin-bottom: 5px;\n                    }\n                }\n            </style>\n            \n            \x3c!-- Manifesto Section --\x3e\n            <div class="settings-section">\n                <h3>MANIFESTO USERNAME</h3>\n                <div id="manifestoMessage" class="success-message">Manifesto updated successfully!</div>\n                <div id="manifestoError" class="error-message"></div>\n                \n                <form id="manifestoForm">\n                    <div class="form-group">\n                        <label for="manifesto">Your Manifesto:</label>\n                        <input type="text" \n                               id="manifesto" \n                               name="manifesto" \n                               value="'.concat((null==r?void 0:r.manifesto)||"",'" \n                               placeholder="Enter your manifesto"\n                               maxlength="50">\n                    </div>\n                    <button type="submit" class="settings-btn save-manifesto-btn">SAVE MANIFESTO</button>\n                </form>\n            </div>\n            \n            \x3c!-- Shipping Information Section --\x3e\n            <div class="settings-section">\n                <h3>SHIPPING INFORMATION</h3>\n                <div id="shippingMessage" class="success-message">Shipping information updated successfully!</div>\n                <div id="shippingError" class="error-message"></div>\n                \n                \x3c!-- 已保存的地址列表 --\x3e\n                ').concat(null!=r&&r.shipping_addresses&&r.shipping_addresses.length>0?'\n                    <div style="margin-bottom: 25px;">\n                        <h4 style="margin-bottom: 15px; font-size: 16px;">Saved Addresses:</h4>\n                        '.concat(r.shipping_addresses.map(function(e,n){return'\n                            <div class="address-card">\n                                <div class="address-header">\n                                    <strong style="font-size: 16px;">'.concat(e.fullName,"</strong>\n                                    ").concat(e.isDefault?'<span class="default-badge">DEFAULT</span>':"",'\n                                </div>\n                                <div class="address-info">\n                                    ').concat(e.phone,"<br>\n                                    ").concat(e.address1," ").concat(e.address2||"","<br>\n                                    ").concat(e.city,", ").concat(e.state," ").concat(e.zipCode,"<br>\n                                    ").concat(e.country,'\n                                </div>\n                                <div class="address-actions">\n                                    <button class="settings-btn edit-address-btn" \n                                            data-address-index="').concat(n,'" style="background:white; border:black 2px solid;color:black; padding:0 10px; ">\n                                        EDIT\n                                    </button>\n                                    <button class="settings-btn delete-address-btn" \n                                            data-address-index="').concat(n,'"\n                                            style="background:white; border:black 2px solid; color:black; padding:0 10px;">\n                                        DELETE\n                                    </button>\n                                    ').concat(e.isDefault?"":'\n                                        <button class="settings-btn set-default-btn" \n                                                data-address-index="'.concat(n,'"\n                                                style="background:white; border:black 2px solid;color:black; padding:0 10px;">\n                                            SET AS DEFAULT\n                                        </button>\n                                    '),"\n                                </div>\n                            </div>\n                        ")}).join(""),"\n                    </div>\n                "):"",'\n                \n                \x3c!-- 添加/编辑地址表单 --\x3e\n                <div id="addressFormContainer">\n                    <h4 style="margin-bottom: 15px; font-size: 16px;">\n                        <span id="addressFormTitle">Add New Address</span>\n                    </h4>\n                    <form id="shippingForm">\n                        <input type="hidden" id="addressIndex" value="">\n                        \n                        <div class="two-columns">\n                            <div class="form-group">\n                                <label for="fullName">Full Name:</label>\n                                <input type="text" \n                                       id="fullName" \n                                       name="fullName" \n                                       value=""\n                                       required>\n                            </div>\n                            \n                            <div class="form-group">\n                                <label for="phone">Phone Number:</label>\n                                <input type="tel" \n                                       id="phone" \n                                       name="phone" \n                                       value=""\n                                       required>\n                            </div>\n                        </div>\n                        \n                        <div class="form-group">\n                            <label for="email">Email:</label>\n                            <input type="email" \n                                   id="email" \n                                   name="email" \n                                   value="').concat(t.email||"",'"\n                                   required>\n                        </div>\n                        \n                        <div class="form-group">\n                            <label for="address1">Address Line 1:</label>\n                            <input type="text" \n                                   id="address1" \n                                   name="address1" \n                                   value=""\n                                   required>\n                        </div>\n                        \n                        <div class="form-group">\n                            <label for="address2">Address Line 2 (Optional):</label>\n                            <input type="text" \n                                   id="address2" \n                                   name="address2" \n                                   value="">\n                        </div>\n                        \n                        <div class="two-columns">\n                            <div class="form-group">\n                                <label for="city">City:</label>\n                                <input type="text" \n                                       id="city" \n                                       name="city" \n                                       value=""\n                                       required>\n                            </div>\n                            \n                            <div class="form-group">\n                                <label for="state">State/Province:</label>\n                                <input type="text" \n                                       id="state" \n                                       name="state" \n                                       value=""\n                                       required>\n                            </div>\n                        </div>\n                        \n                        <div class="two-columns">\n                            <div class="form-group">\n                                <label for="zipCode">ZIP/Postal Code:</label>\n                                <input type="text" \n                                       id="zipCode" \n                                       name="zipCode" \n                                       value=""\n                                       required>\n                            </div>\n                            \n                            <div class="form-group">\n                                <label for="country">Country:</label>\n                                <select id="country" name="country" required>\n                                    <option value="">Select Country</option>\n                                    <option value="CN">中国</option>\n                                    <option value="HK">Hong Kong</option>\n                                    <option value="TW">臺灣</option>\n                                    <option value="JP">Japan</option>\n                                    <option value="UK">United Kingdom</option>\n                                <option value="US">United States</option>\n                                <option value="OTHER">Other</option>\n                                </select>\n                            </div>\n                        </div>\n                        \n                        <div class="form-group">\n                            <label>\n                                <input type="checkbox" id="setAsDefault" name="setAsDefault">\n                                Set as default address\n                            </label>\n                        </div>\n                        \n                        <button type="submit" class="settings-btn save-shipping-btn">SAVE ADDRESS</button>\n                        <button type="button" class="settings-btn secondary cancel-edit-btn" style="display: none;">CANCEL</button>\n                    </form>\n                </div>\n            </div>\n            \n            \x3c!-- Change Password Section --\x3e\n            <div class="settings-section">\n                <h3>CHANGE PASSWORD</h3>\n                <div id="passwordMessage" class="success-message">Password updated successfully!</div>\n                <div id="passwordError" class="error-message"></div>\n                \n                <form id="passwordForm">\n                    <div class="form-group">\n                        <label for="currentPassword">Current Password:</label>\n                        <input type="password" \n                               id="currentPassword" \n                               name="currentPassword" \n                               placeholder="Enter current password"\n                               required>\n                    </div>\n                    \n                    <div class="form-group">\n                        <label for="newPassword">New Password:</label>\n                        <input type="password" \n                               id="newPassword" \n                               name="newPassword" \n                               placeholder="Enter new password"\n                               minlength="6"\n                               required>\n                    </div>\n                    \n                    <div class="form-group">\n                        <label for="confirmPassword">Confirm New Password:</label>\n                        <input type="password" \n                               id="confirmPassword" \n                               name="confirmPassword" \n                               placeholder="Confirm new password"\n                               minlength="6"\n                               required>\n                    </div>\n                    \n                    <button type="submit" class="settings-btn change-password-btn">CHANGE PASSWORD</button>\n                </form>\n            </div>\n            \n            \x3c!-- Account Info Section --\x3e\n            <div class="settings-section">\n                <h3>ACCOUNT INFORMATION</h3>\n                <div style="line-height: 1.6;">\n                    <p><strong>Email:</strong> ').concat(t.email,"</p>\n                    <p><strong>User ID:</strong> ").concat(t.id,"</p>\n                    <p><strong>Account Created:</strong> ").concat(new Date(t.created_at).toLocaleDateString(),"</p>\n                </div>\n            </div>\n        "),V(),e.n=6;break;case 5:e.p=5,e.v,n.innerHTML='<p style="text-align: center; padding: 20px; color: red;">Error loading settings. Please try again.</p>';case 6:return e.a(2)}},e,null,[[1,5]])}))).apply(this,arguments)}function V(){var e=document.getElementById("manifestoForm");e&&e.addEventListener("submit",function(){var e=l(s().m(function e(n){return s().w(function(e){for(;;)switch(e.n){case 0:return n.preventDefault(),e.n=1,K();case 1:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}());var n=document.getElementById("shippingForm");n&&n.addEventListener("submit",function(){var e=l(s().m(function e(n){return s().w(function(e){for(;;)switch(e.n){case 0:return n.preventDefault(),e.n=1,X();case 1:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}());var t=document.getElementById("passwordForm");t&&t.addEventListener("submit",function(){var e=l(s().m(function e(n){return s().w(function(e){for(;;)switch(e.n){case 0:return n.preventDefault(),e.n=1,Z();case 1:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}()),document.querySelectorAll(".edit-address-btn").forEach(function(e){e.addEventListener("click",function(e){!function(e){var n=(window.currentAddresses||[])[e];if(!n)return;document.getElementById("addressIndex").value=e,document.getElementById("fullName").value=n.fullName||"",document.getElementById("phone").value=n.phone||"",document.getElementById("email").value=n.email||"",document.getElementById("address1").value=n.address1||"",document.getElementById("address2").value=n.address2||"",document.getElementById("city").value=n.city||"",document.getElementById("state").value=n.state||"",document.getElementById("zipCode").value=n.zipCode||"",document.getElementById("country").value=n.country||"",document.getElementById("setAsDefault").checked=n.isDefault||!1,document.getElementById("addressFormTitle").textContent="Edit Address",document.querySelector(".save-shipping-btn").textContent="UPDATE ADDRESS",document.querySelector(".cancel-edit-btn").style.display="inline-block",document.getElementById("addressFormContainer").scrollIntoView({behavior:"smooth",block:"start"})}(parseInt(e.target.dataset.addressIndex))})}),document.querySelectorAll(".delete-address-btn").forEach(function(e){e.addEventListener("click",function(e){!function(e){J.apply(this,arguments)}(parseInt(e.target.dataset.addressIndex))})}),document.querySelectorAll(".set-default-btn").forEach(function(e){e.addEventListener("click",function(e){!function(e){Q.apply(this,arguments)}(parseInt(e.target.dataset.addressIndex))})});var a=document.querySelector(".cancel-edit-btn");a&&a.addEventListener("click",function(){!function(){document.getElementById("shippingForm").reset(),document.getElementById("addressIndex").value="",document.getElementById("addressFormTitle").textContent="Add New Address",document.querySelector(".cancel-edit-btn").style.display="none";var e=supabase.auth.getUser().data.user;e&&(document.getElementById("email").value=e.email||"")}()})}function K(){return W.apply(this,arguments)}function W(){return(W=l(s().m(function e(){var n,t,a,r,i,o,d;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=document.getElementById("manifesto").value.trim(),t=document.getElementById("manifestoMessage"),a=document.getElementById("manifestoError"),r=document.querySelector(".save-manifesto-btn"),t.style.display="none",a.style.display="none",n){e.n=1;break}return a.textContent="Manifesto name cannot be empty",a.style.display="block",e.a(2);case 1:return r.disabled=!0,r.textContent="SAVING...",e.p=2,e.n=3,u();case 3:if(i=e.v){e.n=4;break}return a.textContent="请先登录",a.style.display="block",e.a(2);case 4:return e.n=5,supabase.from("profiles").update({manifesto:n}).eq("user_id",i.id);case 5:if(o=e.v,!(d=o.error)){e.n=6;break}throw d;case 6:if(t.style.display="block","function"!=typeof displayUserProfile){e.n=7;break}return e.n=7,displayUserProfile();case 7:setTimeout(function(){t.style.display="none"},3e3),e.n=9;break;case 8:e.p=8,e.v,a.textContent="Failed to update manifesto. Please try again.",a.style.display="block";case 9:return e.p=9,r.disabled=!1,r.textContent="SAVE MANIFESTO",e.f(9);case 10:return e.a(2)}},e,null,[[2,8,9,10]])}))).apply(this,arguments)}function X(){return Y.apply(this,arguments)}function Y(){return(Y=l(s().m(function e(){var n,t,r,i,o,d,c,l,p,f,m,g,b;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=document.getElementById("shippingForm"),t=new FormData(n),r=document.getElementById("shippingMessage"),i=document.getElementById("shippingError"),o=document.querySelector(".save-shipping-btn"),d=document.getElementById("addressIndex").value,r.style.display="none",i.style.display="none",c={fullName:t.get("fullName"),phone:t.get("phone"),email:t.get("email"),address1:t.get("address1"),address2:t.get("address2")||"",city:t.get("city"),state:t.get("state"),zipCode:t.get("zipCode"),country:t.get("country"),isDefault:"on"===t.get("setAsDefault")},o.disabled=!0,o.textContent="SAVING...",e.p=1,e.n=2,u();case 2:if(l=e.v){e.n=3;break}return i.textContent="请先登录",i.style.display="block",e.a(2);case 3:return e.n=4,supabase.from("profiles").select("shipping_addresses").eq("user_id",l.id).single();case 4:return p=e.v,f=p.data,m=(null==f?void 0:f.shipping_addresses)||[],c.isDefault&&(m=m.map(function(e){return a(a({},e),{},{isDefault:!1})})),""!==d?m[parseInt(d)]=c:(0===m.length&&(c.isDefault=!0),m.push(c)),e.n=5,supabase.from("profiles").update({shipping_addresses:m}).eq("user_id",l.id);case 5:if(g=e.v,!(b=g.error)){e.n=6;break}throw b;case 6:r.style.display="block",setTimeout(function(){r.style.display="none",H()},2e3),e.n=8;break;case 7:e.p=7,e.v,i.textContent="Failed to update shipping information. Please try again.",i.style.display="block";case 8:return e.p=8,o.disabled=!1,o.textContent="SAVE ADDRESS",e.f(8);case 9:return e.a(2)}},e,null,[[1,7,8,9]])}))).apply(this,arguments)}function J(){return(J=l(s().m(function e(n){var t,a,r,i,o,d,c,l,u,p;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("Are you sure you want to delete this address?")){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,supabase.auth.getUser();case 2:return t=e.v,a=t.data.user,e.n=3,supabase.from("profiles").select("shipping_addresses").eq("user_id",a.id).single();case 3:return r=e.v,i=r.data,o=(null==i?void 0:i.shipping_addresses)||[],d=o[n],o.splice(n,1),null!=d&&d.isDefault&&o.length>0&&(o[0].isDefault=!0),e.n=4,supabase.from("profiles").update({shipping_addresses:o}).eq("user_id",a.id);case 4:if(c=e.v,!(l=c.error)){e.n=5;break}throw l;case 5:(u=document.getElementById("shippingMessage")).textContent="Address deleted successfully!",u.style.display="block",setTimeout(function(){u.style.display="none",H()},2e3),e.n=7;break;case 6:e.p=6,e.v,(p=document.getElementById("shippingError")).textContent="Failed to delete address. Please try again.",p.style.display="block",setTimeout(function(){p.style.display="none"},5e3);case 7:return e.a(2)}},e,null,[[1,6]])}))).apply(this,arguments)}function Q(){return(Q=l(s().m(function e(n){var t,r,i,o,d,c,l,u,p;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.auth.getUser();case 1:return t=e.v,r=t.data.user,e.n=2,supabase.from("profiles").select("shipping_addresses").eq("user_id",r.id).single();case 2:if(i=e.v,o=i.data,(d=(null==o?void 0:o.shipping_addresses)||[])[n]){e.n=3;break}throw new Error("Address not found");case 3:return d=d.map(function(e,t){return a(a({},e),{},{isDefault:t===n})}),e.n=4,supabase.from("profiles").update({shipping_addresses:d}).eq("user_id",r.id);case 4:if(c=e.v,!(l=c.error)){e.n=5;break}throw l;case 5:(u=document.getElementById("shippingMessage")).textContent="Default address updated successfully!",u.style.display="block",setTimeout(function(){u.style.display="none",H()},2e3),e.n=7;break;case 6:e.p=6,e.v,(p=document.getElementById("shippingError")).textContent="Failed to set default address. Please try again.",p.style.display="block",setTimeout(function(){p.style.display="none"},5e3);case 7:return e.a(2)}},e,null,[[0,6]])}))).apply(this,arguments)}function Z(){return $.apply(this,arguments)}function $(){return($=l(s().m(function e(){var n,t,a,r,i,o,d,c,l,u,p;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=document.getElementById("currentPassword").value,t=document.getElementById("newPassword").value,a=document.getElementById("confirmPassword").value,r=document.getElementById("passwordMessage"),i=document.getElementById("passwordError"),o=document.querySelector(".change-password-btn"),r.style.display="none",i.style.display="none",t===a){e.n=1;break}return i.textContent="New passwords do not match",i.style.display="block",e.a(2);case 1:if(!(t.length<6)){e.n=2;break}return i.textContent="Password must be at least 6 characters",i.style.display="block",e.a(2);case 2:if(n!==t){e.n=3;break}return i.textContent="New password must be different from current password",i.style.display="block",e.a(2);case 3:return o.disabled=!0,o.textContent="UPDATING...",e.p=4,d=supabase.auth.updateUser({password:t}),c=new Promise(function(e,n){return setTimeout(function(){return n(new Error("Request timeout"))},1e4)}),e.n=5,Promise.race([d,c]);case 5:if(l=e.v,!(u=l.error)){e.n=6;break}throw u;case 6:r.style.display="block",document.getElementById("currentPassword").value="",document.getElementById("newPassword").value="",document.getElementById("confirmPassword").value="",setTimeout(function(){r.style.display="none"},5e3),e.n=8;break;case 7:e.p=7,p=e.v,i.textContent="Request timeout"===p.message?"Request timed out. Please check your connection and try again.":p.message||"Failed to update password. Please try again.",i.style.display="block";case 8:return e.p=8,o.disabled=!1,o.textContent="CHANGE PASSWORD",e.f(8);case 9:return e.a(2)}},e,null,[[4,7,8,9]])}))).apply(this,arguments)}window.confirmPayment=l(s().m(function e(){var n,t,a,r,i,o,d,c,l,u,p,f,m,g;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.n=1,U.call(this);case 1:return window.dispatchEvent(new CustomEvent("orderSubmitted",{detail:{orderId:null===(n=window.currentOrder)||void 0===n?void 0:n.orderId}})),e.p=2,e.n=3,supabase.auth.getUser();case 3:if(t=e.v,a=t.data.user,!t.error&&a){e.n=4;break}return alert("Please login to complete payment"),e.a(2);case 4:return e.n=5,getCartItems();case 5:return r=e.v,i=generateOrderId(),o=calculateSubtotal(r),d=calculateShipping(),c=calculateTax(o),l=r.map(function(e){return{draft_id:e.draft_id,size:e.size,quantity:e.quantity,price:e.price,title:e.title||"Custom Design"}}),u={order_id:i,user_id:a.id,items:l,status:"awaiting_verification",amount:o,shipping_cost:d,tax_amount:c,payment_method:window.selectedPaymentMethod||"pending",shipping_address:window.shippingAddress||{},manifesto:window.currentManifesto||null,created_at:(new Date).toISOString(),paid_at:(new Date).toISOString()},e.n=6,supabase.from("orders").insert([u]).select().single();case 6:if(p=e.v,f=p.data,!p.error){e.n=7;break}return alert("Failed to create order"),e.a(2);case 7:return e.n=8,saveDraftImagesToOrderStorage(f.order_id,l);case 8:if(!((m=e.v)&&m.length>0)){e.n=10;break}return e.n=9,supabase.from("orders").update({saved_images:m}).eq("order_id",f.order_id);case 9:g=e.v,g.error;case 10:return e.n=11,clearCart();case 11:return showPaymentSuccessModal(f.order_id),window.dispatchEvent(new CustomEvent("orderSubmitted",{detail:{orderId:f.order_id}})),window.currentOrder={orderId:f.order_id},e.a(2,f);case 12:return e.p=12,e.v,alert("Payment processing failed. Please try again."),e.a(2,null)}},e,this,[[2,12]])})),document.addEventListener("authStateChanged",l(s().m(function e(){var n,t,a;return s().w(function(e){for(;;)switch(e.n){case 0:if(!window.authManager||!window.authManager.isAuthenticated()){e.n=10;break}if(!(n=document.querySelector(".content-section.active"))){e.n=9;break}t=n.id,a=t,e.n="library"===a?1:"draft"===a?3:"order"===a?5:"setting"===a?7:9;break;case 1:return e.n=2,window.loadLibrary();case 2:return e.a(3,9);case 3:return e.n=4,I();case 4:return e.a(3,9);case 5:return e.n=6,M();case 6:return e.a(3,9);case 7:return e.n=8,H();case 8:return e.a(3,9);case 9:e.n=11;break;case 10:["library","draft","order","setting"].forEach(function(e){var n=document.getElementById(e);n&&(n.innerHTML='\n                    <div style="padding: 40px; text-align: center;">\n                        <p>请登录查看内容</p>\n                    </div>\n                ')});case 11:return e.a(2)}},e)})))})();