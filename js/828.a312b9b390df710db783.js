"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[828],{45828:(e,t,n)=>{var a,r=n(50697),i=n.n(r),c=n(26100),o=n.n(c),s=n(96319),l=n.n(s),d=n(78928),u=n.n(d),f=n(36751),m=n.n(f),v=n(25110),p=n.n(v),g=n(53930),h=n.n(g),y=n(49859),b=n(34963),w=n(44828),E=n.n(w),k=n(49763),x=n.n(k),L=n(48079),B=n.n(L),I=n(11393),A=n.n(I),S=n(86226),C=n.n(S),M=n(29544),q=n.n(M),D=n(64007),R=n.n(D),N=n(385),T=n.n(N),U=n(36586),z=n.n(U),H=n(61240),X=n.n(H),P=n(56255),O=n.n(P),Y=n(165),W=n.n(Y),_=n(43981),G=n.n(_),j=n(66615),F=n.n(j),V=n(14166),Q=n.n(V),J=n(96984),K=n.n(J),Z=n(11265),$=n.n(Z),ee=n(14607),te=n.n(ee),ne=n(29550),ae=n.n(ne),re=n(8628),ie=n.n(re),ce=n(20354),oe=n.n(ce);function se(e,t){var n=i()(e);if(o()){var a=o()(e);t&&(a=l()(a).call(a,function(t){return u()(e,t).enumerable})),n.push.apply(n,a)}return n}function le(e){for(var t=1;t<arguments.length;t++){var n,a,r=null!=arguments[t]?arguments[t]:{};t%2?C()(n=se(Object(r),!0)).call(n,function(t){(0,y.A)(e,t,r[t])}):m()?p()(e,m()(r)):C()(a=se(Object(r))).call(a,function(t){h()(e,t,u()(r,t))})}return e}var de="front",ue="white",fe=[],me=null,ve=!1,pe=!1,ge=null,he=0,ye=0,be=0,we=0,Ee=0,ke=0,xe=1,Le=document.getElementById("tshirtContainer"),Be=document.getElementById("tshirtBackground"),Ie=document.getElementById("resizeHandles"),Ae=(document.getElementById("tshirtImage"),document.getElementById("colorPicker"),{front:[],back:[]}),Se={front:!1,back:!1},Ce={front:null,back:null};function Me(){var e=x()(Le.querySelectorAll(".uploaded-image"));Ae[de]=B()(e).call(e,function(e){return{src:e.src,className:e.className,style:{width:e.style.width,height:e.style.height,left:e.style.left,top:e.style.top},dataset:{aspectRatio:e.dataset.aspectRatio},isMemberCode:e.classList.contains("member-code-image")}})}function qe(){var e=document.getElementById("memberCodeBtn");if(e){var t=Se[de];e.textContent=t?"REMOVE MEMBER CODE":"INSERT MEMBER CODE"}}function De(){return Re.apply(this,arguments)}function Re(){return(Re=(0,b.A)(E().mark(function e(){var t;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=document.getElementById("member-barcode-complete"))||!t.src||"none"===t.style.display){e.next=1;break}return e.abrupt("return",t.src);case 1:if(!t){e.next=4;break}if("function"!=typeof window.displayUserProfile){e.next=4;break}return e.next=2,window.displayUserProfile();case 2:return e.next=3,new(X())(function(e){return O()(e,500)});case 3:if(!t.src||"none"===t.style.display){e.next=4;break}return e.abrupt("return",t.src);case 4:return e.next=5,Ne();case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}},e)}))).apply(this,arguments)}function Ne(){return Te.apply(this,arguments)}function Te(){return(Te=(0,b.A)(E().mark(function e(){var t,n,a,r,i,c;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"undefined"!=typeof supabase){e.next=1;break}return e.abrupt("return",null);case 1:return e.next=2,supabase.auth.getUser();case 2:if(t=e.sent,n=t.data.user){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=4,supabase.from("profiles").select("manifesto, barcode").eq("user_id",n.id).single();case 4:if(a=e.sent,r=a.data,!a.error&&r){e.next=5;break}return e.abrupt("return",null);case 5:if(void 0===window.barcodeGenerator){e.next=7;break}return(i=document.createElement("img")).style.display="none",document.body.appendChild(i),e.next=6,window.barcodeGenerator.generateBarcodeImage(r.manifesto||"No manifesto",r.barcode,i.id||"temp-barcode");case 6:return c=e.sent,document.body.removeChild(i),e.abrupt("return",c);case 7:return e.abrupt("return",null);case 8:return e.prev=8,e.catch(0),e.abrupt("return",null);case 9:case"end":return e.stop()}},e,null,[[0,8]])}))).apply(this,arguments)}function Ue(){return ze.apply(this,arguments)}function ze(){return(ze=(0,b.A)(E().mark(function e(){var t;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!Se[de]){e.next=1;break}return e.abrupt("return");case 1:return e.next=2,De();case 2:if(t=e.sent){e.next=3;break}return alert("无法获取会员码，请确保已登录"),e.abrupt("return");case 3:return e.abrupt("return",new(X())(function(e,n){var a=new Image;a.onload=function(){var n=document.createElement("img");n.className="uploaded-image member-code-image",n.src=t,n.style.width="160px",n.style.height="auto";var a=Le.offsetWidth||400;n.style.left=(a-160)/2+"px",n.style.top="120px",n.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,Le.appendChild(n),Ce[de]=n,Se[de]=!0,et(n),qe(),e(n)},a.onerror=function(){alert("会员码图片加载失败"),n(new Error("会员码图片加载失败"))},a.src=t}));case 4:throw e.prev=4,e.catch(0);case 5:case"end":return e.stop()}},e,null,[[0,4]])}))).apply(this,arguments)}function He(){var e=Ce[de];if(e||(e=Le.querySelector(".member-code-image")),e&&Le.contains(e)){me===e&&nt(),Le.removeChild(e);var t=R()(fe).call(fe,e);t>-1&&T()(fe).call(fe,t,1)}Ce[de]=null,Se[de]=!1,qe();Le.querySelector(".member-code-image")}function Xe(){return(Xe=(0,b.A)(E().mark(function e(){return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!Se[de]){e.next=1;break}He(),e.next=2;break;case 1:return e.next=2,Ue();case 2:case"end":return e.stop()}},e)}))).apply(this,arguments)}function Pe(){Me();var e=document.getElementById("saveModal"),t=document.getElementById("frontPreview"),n=document.getElementById("backPreview");Oe("front",t),Oe("back",n),e.classList.remove("hidden")}function Oe(e,t){var n;t.innerHTML="";var a={front:{white:"./images/white-front.png",black:"./images/black-front.png"},back:{white:"./images/white-back.png",black:"./images/black-back.png"}},r=a[e]&&a[e][ue]?a[e][ue]:"./images/white-front.png";t.style.backgroundImage="url(".concat(r,")");var i=Le.offsetWidth||400,c=Le.offsetHeight||500,o=250/c,s=.8*Math.min(o),l=(200-i*s)/2,d=(250-c*s)/2;C()(n=Ae[e]).call(n,function(e,n){var a=document.createElement("img");a.src=e.src,a.className="preview-image";var r=z()(e.style.width)*s,i=z()(e.style.height)*s,c=z()(e.style.left)*s+l,o=z()(e.style.top)*s+d;a.style.width=r+"px",a.style.height=i+"px",a.style.left=c+"px",a.style.top=o-12+"px",t.appendChild(a)})}function Ye(){document.getElementById("saveModal").classList.add("hidden")}function We(){return _e.apply(this,arguments)}function _e(){return(_e=(0,b.A)(E().mark(function e(){var t,n,a,r,i,c,o,s,l,d,u,f,m,v,p,g,h;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(a=e.sent,r=a.data.user,!a.error){e.next=2;break}return alert("认证失败，请重新登录"),e.abrupt("return");case 2:if(r){e.next=3;break}return alert("请先登录"),e.abrupt("return");case 3:return Me(),e.next=4,je(Ae.front,r.id,"front");case 4:return i=e.sent,e.next=5,je(Ae.back,r.id,"back");case 5:return c=e.sent,o=document.getElementById("frontPreview"),e.next=6,oe()(o,{backgroundColor:null,useCORS:!0});case 6:return s=e.sent,l=document.getElementById("backPreview"),e.next=7,oe()(l,{backgroundColor:null,useCORS:!0});case 7:return d=e.sent,u=s.toDataURL("image/jpeg"),f=d.toDataURL("image/jpeg"),m=nn(),v={frontImages:B()(t=Ae.front).call(t,function(e,t){return le(le({},e),{},{storageFile:i[t]||null})}),backImages:B()(n=Ae.back).call(n,function(e,t){return le(le({},e),{},{storageFile:c[t]||null})}),color:ue,currentView:de,timestamp:(new Date).toISOString(),sizeQuantities:m},p={user_id:r.id,title:"T恤设计草稿 ".concat((new Date).toLocaleString()),type:"tshirt",data:v,front_preview_image:u,back_preview_image:f,sizes:m},e.next=8,supabase.from("drafts").insert(p);case 8:g=e.sent,g.data,(h=g.error)?alert("保存失败: ".concat(h.message)):(alert("设计已保存到草稿！"),Ye()),e.next=10;break;case 9:e.prev=9,e.catch(0),alert("保存失败，请检查控制台了解详情");case 10:case"end":return e.stop()}},e,null,[[0,9]])}))).apply(this,arguments)}function Ge(e){for(var t=e.split(","),n=t[0].match(/:(.*?);/)[1],a=atob(t[1]),r=a.length,i=new Uint8Array(r),c=0;c<r;c++)i[c]=a.charCodeAt(c);return new Blob([i],{type:n})}function je(e,t,n){return Fe.apply(this,arguments)}function Fe(){return(Fe=(0,b.A)(E().mark(function e(t,n,a){var r,i,c,o,s,l,d,u,f,m,v,p,g,h,y,b;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=[],i=ae()(),c=0;case 1:if(!(c<t.length)){e.next=12;break}if(o=t[c],s=o.src,!o.isMemberCode){e.next=2;break}return e.abrupt("continue",11);case 2:if(!W()(s).call(s,"data:image/")){e.next=11;break}return e.prev=3,e.next=4,Ge(s);case 4:return f=e.sent,m=A()(l=A()(d=A()(u="".concat(n,"/")).call(u,i,"_")).call(d,c,"_")).call(l,a,".jpg"),e.next=5,supabase.storage.from("design-files").list(n);case 5:return v=e.sent,v.error,e.next=6,supabase.storage.from("design-files").upload(m,f,{cacheControl:"3600",upsert:!0});case 6:if(p=e.sent,p.data,!(g=p.error)){e.next=9;break}if(!ie()(h=g.message).call(h,"already exists")){e.next=8;break}return e.next=7,supabase.storage.from("design-files").remove([m]);case 7:return e.next=8,supabase.storage.from("design-files").upload(m,f);case 8:return e.abrupt("continue",11);case 9:y=supabase.storage.from("design-files").getPublicUrl(m),b=y.data.publicUrl,r.push({fileName:m,publicUrl:b,side:a}),e.next=11;break;case 10:e.prev=10,e.catch(3);case 11:c++,e.next=1;break;case 12:return e.abrupt("return",r);case 13:case"end":return e.stop()}},e,null,[[3,10]])}))).apply(this,arguments)}function Ve(e){var t;if(e!==de){var n;if(Me(),n=Le.querySelectorAll(".uploaded-image"),C()(n).call(n,function(e){Le.removeChild(e)}),nt(),function(e){var t;C()(t=Ae[e]).call(t,function(t){var n=document.createElement("img");n.src=t.src,n.className=t.className,q()(n.style,t.style),t.dataset.aspectRatio&&(n.dataset.aspectRatio=t.dataset.aspectRatio),Le.appendChild(n),et(n),t.isMemberCode&&(Ce[e]=n,Se[e]=!0)}),qe()}(de=e),C()(t=document.querySelectorAll(".t-shirt-column button")).call(t,function(e){e.classList.remove("active")}),"color"!==e){var a=document.getElementById(e+"Btn");a&&a.classList.add("active")}var r=document.getElementById("colorMenu");r&&(r.classList.remove("show"),r.classList.add("hidden")),Je(),qe()}}function Qe(e){var t;ue=e,C()(t=document.querySelectorAll(".color-option")).call(t,function(e){e.classList.remove("active")});var n=document.querySelector('[data-color="'.concat(e,'"]'));n&&n.classList.add("active");var a=document.getElementById("colorMenu");a&&(a.classList.add("hidden"),a.classList.remove("show")),Je()}function Je(){var e={front:{white:"./images/white-front.png",black:"./images/black-front.png"},back:{white:"./images/white-back.png",black:"./images/black-back.png"}},t=Be.querySelector("img");e[de]&&e[de][ue]&&t&&(t.src=e[de][ue])}function Ke(){document.getElementById("fileInput").click()}function Ze(e){var t=e.target.files;if(t&&0!==t.length){for(var n=0;n<t.length;n++){var a,r=t[n];if(W()(a=r.type).call(a,"image/")){var i=new FileReader;i.onload=function(e){$e(e.target.result)},i.readAsDataURL(r)}else alert("请选择图片文件！")}e.target.value=""}}function $e(e){var t=document.createElement("img");t.className="uploaded-image",t.src=e,t.onload=function(){var e=.6*Le.offsetWidth,n=.6*Le.offsetHeight,a=Math.min(e/this.naturalWidth,n/this.naturalHeight),r=this.naturalWidth*a,i=this.naturalHeight*a;t.style.width=r+"px",t.style.height=i+"px",t.style.left=(Le.offsetWidth-r)/2+"px",t.style.top=(Le.offsetHeight-i)/2+"px",t.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,Le.appendChild(t),fe.push(t),et(t)}}function et(e){e.addEventListener("click",function(t){t.stopPropagation(),tt(e)}),e.addEventListener("mousedown",function(t){t.target.classList.contains("resize-handle")||(ve=!0,he=t.clientX-e.offsetLeft,ye=t.clientY-e.offsetTop,e.classList.add("dragging"),t.preventDefault())})}function tt(e){var t;me&&me.classList.remove("selected"),(me=e).classList.add("selected"),Ie.classList.remove("hidden"),at(),t=Ie.querySelectorAll(".resize-handle"),C()(t).call(t,function(e){e.addEventListener("mousedown",function(e){e.stopPropagation(),pe=!0,ge=this.dataset.direction,he=e.clientX,ye=e.clientY,be=me.offsetWidth,we=me.offsetHeight,Ee=me.offsetLeft,ke=me.offsetTop,xe=G()(me.dataset.aspectRatio),e.preventDefault()})})}function nt(){me&&me.classList.remove("selected"),me=null,Ie.classList.add("hidden")}function at(){if(me){var e=me.getBoundingClientRect(),t=Le.getBoundingClientRect();Ie.style.left=e.left-t.left+"px",Ie.style.top=e.top-t.top+"px",Ie.style.width=e.width+"px",Ie.style.height=e.height+"px"}}function rt(){if(me){if(me.parentNode&&me.parentNode.removeChild(me),void 0!==fe&&F()(fe)){var e=R()(fe).call(fe,me);e>-1&&T()(fe).call(fe,e,1)}nt()}}function it(){var e=document.getElementById("frontBtn");e&&e.addEventListener("click",function(e){e.preventDefault(),Ve("front")});var t=document.getElementById("backBtn");t&&t.addEventListener("click",function(e){e.preventDefault(),Ve("back")});var n=document.getElementById("colorBtn");n&&n.addEventListener("click",function(e){var t;e.preventDefault(),(t=document.getElementById("colorMenu"))&&(t.classList.contains("hidden")?(t.classList.remove("hidden"),t.classList.add("show")):(t.classList.add("hidden"),t.classList.remove("show")))})}document.addEventListener("DOMContentLoaded",function(){O()(function(){"function"==typeof window.displayUserProfile&&window.displayUserProfile().catch(function(e){})},1e3)}),"undefined"!=typeof supabase&&supabase.auth.onAuthStateChange(function(e,t){"SIGNED_IN"===e?O()(function(){"function"==typeof window.displayUserProfile&&window.displayUserProfile()},500):"SIGNED_OUT"===e&&Se&&He()}),document.addEventListener("mousemove",function(e){if(ve&&me){var t=e.clientX-he,n=e.clientY-ye;me.style.left=t+"px",me.style.top=n+"px",at()}else pe&&function(e){if(pe&&me){var t=e.clientX-he,n=e.clientY-ye,a=be,r=we,i=Ee,c=ke;switch(ge){case"nw":i=Ee+t,c=ke+(we-(r=(a=be-t)/xe));break;case"n":i=Ee-((a=(r=we-n)*xe)-be)/2,c=ke+n;break;case"ne":c=ke+(we-(r=(a=be+t)/xe));break;case"e":c=ke-((r=(a=be+t)/xe)-we)/2;break;case"se":r=(a=be+t)/xe;break;case"s":i=Ee-((a=(r=we+n)*xe)-be)/2;break;case"sw":r=(a=be-t)/xe,i=Ee+t;break;case"w":i=Ee+t,c=ke-((r=(a=be-t)/xe)-we)/2}a<20||r<20||(me.style.width=a+"px",me.style.height=r+"px",me.style.left=i+"px",me.style.top=c+"px",at())}}(e)}),document.addEventListener("mouseup",function(){ve=!1,pe=!1,ge=null,me&&me.classList.remove("dragging")}),Le.addEventListener("click",function(e){e.target.classList.contains("uploaded-image")||nt()}),document.addEventListener("dragstart",function(e){e.preventDefault()}),document.addEventListener("dragover",function(e){e.preventDefault()}),document.addEventListener("keydown",function(e){"Delete"===e.key&&me?rt():"Escape"===e.key&&nt()}),window.addEventListener("resize",function(){me&&at()}),document.addEventListener("click",function(e){e.target.closest(".color-option")&&Qe(e.target.closest(".color-option").dataset.color);if(!e.target.closest("#colorBtn")&&!e.target.closest(".color-menu")){var t=document.getElementById("colorMenu");t&&t.classList.contains("show")&&(t.classList.add("hidden"),t.classList.remove("show"))}});var ct=document.getElementById("saveModal");if(ct){ct.addEventListener("click",function(e){e.target===ct&&Ye()});var ot=document.getElementById("memberCodeBtn");ot&&ot.addEventListener("click",function(){return Xe.apply(this,arguments)});var st=document.getElementById("plusBtn");st&&st.addEventListener("click",function(){alert("添加功能待开发")})}function lt(){var e=["tshirtContainer","tshirtBackground","resizeHandles","frontBtn","backBtn","colorBtn"];Q()(e).call(e,function(e){return document.getElementById(e)})?O()(function(){!function(){void 0===fe&&(window.uploadedImages=[]),void 0===me&&(window.selectedImage=null);var e=document.getElementById("tshirtContainer");e&&void 0===Le&&(window.container=e),document.getElementById("tshirtBackground"),document.getElementById("resizeHandles")}(),it(),Le?(Ve("front"),Qe("white"),qe(),function(){var e=document.getElementById("fileBtn");e&&e.addEventListener("click",Ke);var t=document.getElementById("deleteBtn");t&&t.addEventListener("click",rt);var n=document.getElementById("saveDesignBtn");n&&n.addEventListener("click",Pe);var a=document.getElementById("saveToDraftBtn");a&&a.addEventListener("click",We);var r=document.getElementById("saveSvgBtn");r&&r.addEventListener("click",_t);var i=document.getElementById("backToEditBtn");i&&i.addEventListener("click",Ye);var c=document.getElementById("fileInput");c&&c.addEventListener("change",Ze)}(),O()(function(){var e=document.querySelector('[data-color="white"]');e&&e.classList.add("active")},100)):O()(lt,1e3)},500):O()(lt,500)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",lt):lt();var dt,ut,ft,mt,vt,pt=!1,gt=null,ht=[],yt=-1,bt="pencil",wt=2,Et=1,kt=3,xt=!1,Lt=0,Bt=0;function It(){var e=document.querySelector(".pencil-menu");e&&e.classList.remove("show")}function At(){(ft=document.getElementById("mySVG"))&&(St(),function(){var e=document.getElementById("pencil");e&&e.addEventListener("click",function(){Nt("pencil"),Tt(kt),Rt(kt),It()});var t=document.querySelector(".pencil-menu-trigger");t&&t.addEventListener("click",function(e){var t;e.stopPropagation(),(t=document.querySelector(".pencil-menu"))&&t.classList.toggle("show")});document.addEventListener("click",function(e){var t=document.getElementById("pencil");t&&!t.contains(e.target)&&It()});var n=document.getElementById("eraser");n&&n.addEventListener("click",function(){Nt("eraser")});var a=document.getElementById("zoom-in");a&&a.addEventListener("click",function(){Et<3&&(Et=Math.min(1.25*Et,3),Ct())});var r=document.getElementById("zoom-out");r&&r.addEventListener("click",function(){Et>.5&&((Et=Math.max(Et/1.25,.5))<=1&&(Et=1,Lt=0,Bt=0),Ct())});var i=document.getElementById("drag");i&&i.addEventListener("click",function(){Nt("drag")});var c=document.querySelectorAll(".pencil-menu [data-width]");C()(c).call(c,function(e){e.addEventListener("click",function(){var e=z()(this.getAttribute("data-width"));Tt(e),kt=e,Rt(e),It()})}),Tt(2),Rt(2)}(),function(){if(!ft)return;ft.addEventListener("mousedown",function(e){e.preventDefault();var t=Ut(e.clientX,e.clientY);"drag"===bt?(xt=!0,mt=e.clientX,vt=e.clientY,ft.style.cursor="grabbing"):(pt=!0,dt=t.x,ut=t.y,zt(t.x,t.y))}),ft.addEventListener("mousemove",function(e){e.preventDefault();var t=Ut(e.clientX,e.clientY);if(xt){var n=e.clientX-mt,a=e.clientY-vt;mt=e.clientX,vt=e.clientY,Lt+=n,Bt+=a,Ct()}else pt&&(Ht(dt,ut,t.x,t.y),dt=t.x,ut=t.y)}),ft.addEventListener("mouseup",function(e){xt?(xt=!1,ft.style.cursor="grab"):pt&&(pt=!1,Xt(),Ot())}),ft.addEventListener("touchstart",Mt),ft.addEventListener("touchmove",qt),ft.addEventListener("touchend",Dt)}(),Nt("pencil"),Ot())}function St(){var e;if(ft){var t=ft.parentElement;if(t){var n=t.getBoundingClientRect(),a=Math.max(n.width,100),r=Math.max(n.height-60,100);ft.setAttribute("width",a),ft.setAttribute("height",r),ft.setAttribute("viewBox",A()(e="0 0 ".concat(a," ")).call(e,r))}}}function Ct(){var e,t,n;if(ft){var a=A()(e=A()(t=A()(n="".concat(-Lt/Et," ")).call(n,-Bt/Et," ")).call(t,ft.clientWidth/Et," ")).call(e,ft.clientHeight/Et);ft.setAttribute("viewBox",a)}}function Mt(e){e.preventDefault();var t=e.touches[0],n=Ut(t.clientX,t.clientY);"drag"===bt?(xt=!0,mt=t.clientX,vt=t.clientY):(pt=!0,dt=n.x,ut=n.y,zt(n.x,n.y))}function qt(e){e.preventDefault();var t=e.touches[0],n=Ut(t.clientX,t.clientY);if(xt){var a=t.clientX-mt,r=t.clientY-vt;mt=t.clientX,vt=t.clientY,Lt+=a,Bt+=r,Ct()}else pt&&(Ht(dt,ut,n.x,n.y),dt=n.x,ut=n.y)}function Dt(e){e.preventDefault(),xt?xt=!1:pt&&(pt=!1,Xt(),Ot())}function Rt(e){var t=document.querySelectorAll(".pencil-menu [data-width]");C()(t).call(t,function(t){t.classList.remove("active"),z()(t.getAttribute("data-width"))===e&&t.classList.add("active")})}function Nt(e){var t;bt=e,C()(t=document.querySelectorAll(".tools > div")).call(t,function(e){e.classList.remove("active")});var n=document.getElementById(e);n&&n.classList.add("active"),ft&&("pencil"===e?ft.classList.add("pencil-cursor"):(ft.classList.remove("pencil-cursor"),ft.style.cursor="eraser"===e?"crosshair":"drag"===e?"grab":"default"))}function Tt(e){wt=e}function Ut(e,t){if(!ft)return{x:0,y:0};var n=ft.getBoundingClientRect(),a=e-n.left,r=t-n.top;return{x:(a-Lt)/Et,y:(r-Bt)/Et}}function zt(e,t){if("pencil"===bt){var n;gt=document.createElementNS("http://www.w3.org/2000/svg","path");var a=Math.round(100*e)/100,r=Math.round(100*t)/100;gt.setAttribute("d",A()(n="M ".concat(a," ")).call(n,r)),gt.setAttribute("stroke","black"),gt.setAttribute("stroke-width",wt),gt.setAttribute("fill","none"),gt.setAttribute("stroke-linecap","square"),gt.setAttribute("stroke-linejoin","square"),ft.appendChild(gt)}else"eraser"===bt&&Pt(e,t)}function Ht(e,t,n,a){if("pencil"===bt&&gt){var r,i=Math.round(100*n)/100,c=Math.round(100*a)/100,o=gt.getAttribute("d");gt.setAttribute("d",o+A()(r=" L ".concat(i," ")).call(r,c))}else"eraser"===bt&&Pt(n,a)}function Xt(){gt=null}function Pt(e,t){if(ft){var n=ft.querySelectorAll("path"),a=2*wt;C()(n).call(n,function(n){try{var r=n.getBBox();e>=r.x-a&&e<=r.x+r.width+a&&t>=r.y-a&&t<=r.y+r.height+a&&ft.removeChild(n)}catch(e){}})}}function Ot(){if(ft){++yt<ht.length&&(ht.length=yt),ht.push(ft.innerHTML);ht.length>20&&(ht.shift(),yt--)}}function Yt(){!ft||yt<=0||(yt--,ft.innerHTML=ht[yt])}function Wt(){ft&&(ft.innerHTML="",Ot())}function _t(){return Gt.apply(this,arguments)}function Gt(){return(Gt=(0,b.A)(E().mark(function e(){return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:Ft();case 1:case"end":return e.stop()}},e)}))).apply(this,arguments)}var jt=null;function Ft(){var e=(new XMLSerializer).serializeToString(ft),t=new Blob([e],{type:"image/svg+xml"}),n=K().createObjectURL(t),a='\n        <div id="saveSvgModal" class="modal">\n            <div class="modal-content-svg">\n                <div class="preview-container-svg">\n                    <div class="preview-item-svg">\n                        <span>PREVIEW</span>\n                        <div class="preview-svg" style="background-image: url(\''.concat(n,'\')"></div>\n                    </div>\n                </div>\n                <div class="modal-buttons">\n                    <button id="confirmSaveSvgBtn">SAVE TO DRAFT</button>\n                    <button id="addToGalleryBtn">ADD IN GALLERY</button>\n                </div>\n            </div>\n        </div>\n    ');document.body.insertAdjacentHTML("beforeend",a),jt=document.getElementById("saveSvgModal"),document.getElementById("confirmSaveSvgBtn").addEventListener("click",Jt),document.getElementById("addToGalleryBtn").addEventListener("click",Zt),document.addEventListener("click",Vt)}function Vt(e){if(jt){var t=e.target.closest("#saveSvgModal"),n=e.target.closest(".modal-content-svg"),a=e.target.closest(".modal-btn");!t||n||a||Qt()}}function Qt(){if(jt){document.removeEventListener("click",Vt);var e=document.getElementById("confirmSaveSvgBtn"),t=document.getElementById("addToGalleryBtn");e&&e.removeEventListener("click",Jt),t&&t.removeEventListener("click",Zt),jt.remove(),jt=null}}function Jt(){return Kt.apply(this,arguments)}function Kt(){return(Kt=(0,b.A)(E().mark(function e(){var t,n,a,r,i,c,o;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(t=e.sent,n=t.data.user){e.next=2;break}return alert("请先登录"),Qt(),e.abrupt("return");case 2:a=(new XMLSerializer).serializeToString(ft),r=document.createElement("canvas"),i=r.getContext("2d"),(c=new Image).onload=(0,b.A)(E().mark(function e(){var t,o;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r.width=200,r.height=200,i.drawImage(c,0,0,200,200),t=r.toDataURL(),e.next=1,supabase.from("drafts").insert({user_id:n.id,title:"SVG草稿 ".concat((new Date).toLocaleString()),type:"svg",data:{svgContent:a},front_preview_image:t});case 1:o=e.sent,o.data,o.error?alert("保存失败，请重试"):(alert("已保存到草稿"),Qt());case 2:case"end":return e.stop()}},e)})),o=new Blob([a],{type:"image/svg+xml"}),c.src=K().createObjectURL(o),e.next=4;break;case 3:e.prev=3,e.catch(0),alert("保存失败，请重试");case 4:case"end":return e.stop()}},e,null,[[0,3]])}))).apply(this,arguments)}function Zt(){alert("Gallery feature coming soon!"),Qt()}function $t(){if(ft&&0!==ft.children.length)if(document.querySelector(".panels-right"))try{var e,t,n,a,r=ft.cloneNode(!0),i=r.querySelectorAll("path");if(0===i.length)return void en("没有找到绘图内容！","error");var c=1/0,o=1/0,s=-1/0,l=-1/0,d=!1;if(C()(i).call(i,function(e){var t=e.getAttribute("d");if(t&&""!==$()(t).call(t)){var n=function(e){var t=[],n=/-?\d+(?:\.\d+)?/g,a=e.match(n);if(a&&a.length>=2)for(var r=0;r<a.length-1;r+=2){var i=G()(a[r]),c=G()(a[r+1]);isNaN(i)||isNaN(c)||t.push({x:i,y:c})}return t}(t);n.length>0&&(C()(n).call(n,function(e){c=Math.min(c,e.x),o=Math.min(o,e.y),s=Math.max(s,e.x),l=Math.max(l,e.y)}),d=!0)}}),!d||c===1/0)return void en("没有找到有效的绘图内容！请确保已完成绘制。","error");var u=s-c,f=l-o,m=Math.max(.1*Math.max(u,f),20);r.setAttribute("viewBox",A()(e=A()(t=A()(n="".concat(c-m," ")).call(n,o-m," ")).call(t,u+2*m," ")).call(e,f+2*m)),r.setAttribute("width","300"),r.setAttribute("height","300"),r.setAttribute("xmlns","http://www.w3.org/2000/svg"),C()(a=r.querySelectorAll("path")).call(a,function(e){e.getAttribute("stroke")||e.setAttribute("stroke","black"),e.getAttribute("stroke-width")||e.setAttribute("stroke-width","2"),e.getAttribute("fill")||e.setAttribute("fill","none")});var v=(new XMLSerializer).serializeToString(r);!function(e){var t=null;(t=document.getElementById("tshirtContainer"))||(t=document.getElementById("uploadedImagesContainer"));t||void 0===Le||(t=Le);if(!t)return void alert("T恤设计区域未找到，请确保右侧面板已加载");var n=document.createElement("img");n.className="uploaded-image svg-drawing",n.src=e,n.onload=function(){var e=.4*t.offsetWidth;t.offsetHeight;n.style.width=e+"px",n.style.height="auto",n.style.left=(t.offsetWidth-e)/2+"px",n.style.top="80px",n.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,t.appendChild(n),void 0!==fe&&F()(fe)?fe.push(n):"undefined"!=typeof window&&(window.uploadedImages=window.uploadedImages||[],window.uploadedImages.push(n)),et(n),O()(function(){tt(n)},100)},n.onerror=function(){alert("图片加载失败，请重试")}}("data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(v))))}catch(e){en("传输失败："+e.message,"error")}else en("右侧T恤设计面板未找到，请确保页面完全加载","error");else en("请先绘制一些内容！","error")}function en(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=document.createElement("div");n.textContent=e;var a="success"===t?"#4CAF50":"error"===t?"#f44336":"#2196F3";n.style.cssText="\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        background: ".concat(a,";\n        color: white;\n        padding: 12px 16px;\n        border-radius: 6px;\n        z-index: 9999;\n        font-size: 14px;\n        box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n        animation: slideIn 0.3s ease-out;\n    ");var r=document.createElement("style");r.textContent="\n        @keyframes slideIn {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n        }\n    ",document.head.querySelector("style[data-notification]")||(r.setAttribute("data-notification","true"),document.head.appendChild(r)),document.body.appendChild(n),O()(function(){document.body.contains(n)&&(n.style.animation="slideIn 0.3s ease-out reverse",O()(function(){document.body.contains(n)&&document.body.removeChild(n)},300))},3e3)}function tn(){O()(function(){At(),function(){var e=document.getElementById("undoBtn");e&&e.addEventListener("click",Yt);var t=document.getElementById("saveBtn");t&&t.addEventListener("click",_t);var n=document.getElementById("galleryBtn");n&&n.addEventListener("click",function(){alert("画廊功能待开发")});var a=document.getElementById("clearBtn");a&&a.addEventListener("click",Wt);var r=document.getElementById("nextBtn");r&&r.addEventListener("click",$t)}();var e=te()(function(){document.getElementById("tshirtContainer")&&clearInterval(e)},500);O()(function(){return clearInterval(e)},1e4)},100)}function nn(){var e=document.querySelectorAll(".size-option"),t={};return C()(e).call(e,function(e){var n=e.querySelector("label"),a=e.querySelector(".quantity-input");if(n&&a){var r,i=$()(r=n.textContent).call(r);t[i]=z()(a.value)||0}}),t}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",tn):tn(),window.addEventListener("resize",function(){ft&&St()}),C()(a=document.querySelectorAll(".quantity-control")).call(a,function(e){var t=e.querySelector(".quantity-input");t.addEventListener("change",function(){var e=z()(t.value);isNaN(e)||e<0?t.value=0:e>99&&(t.value=99)})})}}]);