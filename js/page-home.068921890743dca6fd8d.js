(()=>{"use strict";var e,t={45828:(e,t,n)=>{var r,a=n(18979),i=n.n(a),c=n(16781),o=n.n(c),s=n(39841),l=n.n(s),u=n(26100),d=n.n(u),f=n(78928),p=n.n(f),h=n(36751),v=n.n(h),m=n(25110),g=n.n(m),b=n(53930),y=n.n(b),x=n(5773),w=n(27842),k=n(49859),E=n(85073),L=n(34963),S=n(44828),I=n.n(S),C=n(49763),A=n.n(C),B=n(48079),M=n.n(B),T=n(11393),D=n.n(T),R=n(86226),U=n.n(R),q=n(29544),z=n.n(q),P=n(64007),O=n.n(P),_=n(385),N=n.n(_),H=n(36586),j=n.n(H),G=n(61240),W=n.n(G),X=n(8628),Y=n.n(X),F=n(56255),V=n.n(F),Q=n(165),$=n.n(Q),J=n(43981),K=n.n(J),Z=n(66615),ee=n.n(Z),te=n(14166),ne=n.n(te),re=n(11265),ae=n.n(re),ie=n(73363),ce=n.n(ie),oe=n(57119),se=n.n(oe),le=n(50697),ue=n.n(le),de=n(14607),fe=n.n(de),pe=n(96984),he=n.n(pe),ve=n(29550),me=n.n(ve),ge=n(96319),be=n.n(ge),ye=n(38573),xe=n.n(ye),we=n(20354),ke=n.n(we);function Ee(e,t){var n=ue()(e);if(d()){var r=d()(e);t&&(r=be()(r).call(r,function(t){return p()(e,t).enumerable})),n.push.apply(n,r)}return n}function Le(e){for(var t=1;t<arguments.length;t++){var n,r,a=null!=arguments[t]?arguments[t]:{};t%2?U()(n=Ee(Object(a),!0)).call(n,function(t){(0,k.A)(e,t,a[t])}):v()?g()(e,v()(a)):U()(r=Ee(Object(a))).call(r,function(t){y()(e,t,p()(a,t))})}return e}function Se(e,t){var n=void 0!==o()&&l()(e)||e["@@iterator"];if(!n){if(ee()(e)||(n=function(e,t){if(e){var n;if("string"==typeof e)return Ie(e,t);var r=i()(n={}.toString.call(e)).call(n,8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?A()(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ie(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,s=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){u=!0,c=e},f:function(){try{s||null==n.return||n.return()}finally{if(u)throw c}}}}function Ie(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var Ce="front",Ae="white",Be=[],Me=null,Te=!1,De=!1,Re=null,Ue=0,qe=0,ze=0,Pe=0,Oe=0,_e=0,Ne=1,He=document.getElementById("tshirtContainer"),je=document.getElementById("tshirtBackground"),Ge=document.getElementById("resizeHandles"),We=(document.getElementById("tshirtImage"),document.getElementById("colorPicker"),{front:[],back:[]}),Xe={front:!1,back:!1},Ye={front:null,back:null};function Fe(){var e=A()(He.querySelectorAll(".uploaded-image"));We[Ce]=M()(e).call(e,function(e){return{src:e.src,className:e.className,style:{width:e.style.width,height:e.style.height,left:e.style.left,top:e.style.top},dataset:{aspectRatio:e.dataset.aspectRatio},isMemberCode:e.classList.contains("member-code-image")}})}function Ve(){var e=document.getElementById("memberCodeBtn");if(e){var t=Xe[Ce];e.textContent=t?"REMOVE MEMBER CODE":"INSERT MEMBER CODE"}}function Qe(){return $e.apply(this,arguments)}function $e(){return($e=(0,L.A)(I().mark(function e(){var t;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=document.getElementById("member-barcode-complete"))||!t.src||"none"===t.style.display){e.next=1;break}return e.abrupt("return",t.src);case 1:return e.next=2,Je();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)}))).apply(this,arguments)}function Je(){return Ke.apply(this,arguments)}function Ke(){return(Ke=(0,L.A)(I().mark(function e(){var t,n,r,a,i,c;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"undefined"!=typeof supabase){e.next=1;break}return e.abrupt("return",null);case 1:return e.next=2,supabase.auth.getUser();case 2:if(t=e.sent,n=t.data.user){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=4,supabase.from("profiles").select("manifesto, barcode").eq("user_id",n.id).single();case 4:if(r=e.sent,a=r.data,!r.error&&a){e.next=5;break}return e.abrupt("return",null);case 5:if(void 0===window.barcodeGenerator){e.next=7;break}return(i=document.createElement("img")).style.display="none",document.body.appendChild(i),e.next=6,window.barcodeGenerator.generateBarcodeImage(a.manifesto||"No manifesto",a.barcode,i.id||"temp-barcode");case 6:return c=e.sent,document.body.removeChild(i),e.abrupt("return",c);case 7:return e.abrupt("return",null);case 8:return e.prev=8,e.catch(0),e.abrupt("return",null);case 9:case"end":return e.stop()}},e,null,[[0,8]])}))).apply(this,arguments)}function Ze(){return et.apply(this,arguments)}function et(){return(et=(0,L.A)(I().mark(function e(){var t;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!Xe[Ce]){e.next=1;break}return e.abrupt("return");case 1:return e.next=2,Qe();case 2:if(t=e.sent){e.next=3;break}return alert("无法获取会员码，请确保已登录"),e.abrupt("return");case 3:return e.abrupt("return",new(W())(function(e,n){var r=new Image;r.onload=function(){var n=document.createElement("img");n.className="uploaded-image member-code-image",n.src=t,n.style.width="160px",n.style.height="auto";var r=He.offsetWidth||400;n.style.left=(r-160)/2+"px";var a=window.innerWidth<=899;n.style.top=a?"105px":"120px",n.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,He.appendChild(n),Ye[Ce]=n,Xe[Ce]=!0,Mt(n),Ve(),e(n)},r.onerror=function(){alert("会员码图片加载失败"),n(new Error("会员码图片加载失败"))},r.src=t}));case 4:throw e.prev=4,e.catch(0);case 5:case"end":return e.stop()}},e,null,[[0,4]])}))).apply(this,arguments)}function tt(){var e=Ye[Ce];if(e||(e=He.querySelector(".member-code-image")),e&&He.contains(e)){Me===e&&Ut(),He.removeChild(e);var t=O()(Be).call(Be,e);t>-1&&N()(Be).call(Be,t,1)}Ye[Ce]=null,Xe[Ce]=!1,Ve();He.querySelector(".member-code-image")}function nt(){return(nt=(0,L.A)(I().mark(function e(){return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!Xe[Ce]){e.next=1;break}tt(),e.next=2;break;case 1:return e.next=2,Ze();case 2:case"end":return e.stop()}},e)}))).apply(this,arguments)}function rt(){Fe();var e=document.getElementById("saveModal"),t=document.getElementById("frontPreview"),n=document.getElementById("backPreview");e&&t&&n&&(ct("front",t),ct("back",n),e.classList.remove("hidden"))}function at(e,t,n){return it.apply(this,arguments)}function it(){return it=(0,L.A)(I().mark(function e(t,n,r){var a,i,c,o,s,l,u,d,f,p,h,v,m,g,b=arguments;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=b.length>3&&void 0!==b[3]?b[3]:800,e.prev=1,t&&$()(t).call(t,"data:image/")){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=3,supabase.auth.getUser();case 3:if(c=e.sent,o=c.data.user,!c.error&&o){e.next=4;break}return e.abrupt("return",null);case 4:return e.next=5,lt(t,a,.8);case 5:if(s=e.sent){e.next=6;break}return e.abrupt("return",null);case 6:return l=st(s),u=D()(i="".concat(n,"/images/")).call(i,r),e.next=7,supabase.storage.from("design-files").upload(u,l,{cacheControl:"3600",upsert:!0,contentType:l.type});case 7:if(d=e.sent,d.data,!(f=d.error)){e.next=13;break}if(!(null!==(p=f.message)&&void 0!==p&&Y()(p).call(p,"duplicate")||null!==(h=f.message)&&void 0!==h&&Y()(h).call(h,"already exists"))){e.next=12;break}return e.next=8,supabase.storage.from("design-files").remove([u]);case 8:return e.next=9,supabase.storage.from("design-files").upload(u,l,{cacheControl:"3600",upsert:!0,contentType:l.type});case 9:if(v=e.sent,v.data,!v.error){e.next=10;break}return e.abrupt("return",null);case 10:(0,E.A)("data");case 11:e.next=13;break;case 12:return e.abrupt("return",null);case 13:if(m=supabase.storage.from("design-files").getPublicUrl(u),g=m.data.publicUrl){e.next=14;break}return e.abrupt("return",null);case 14:return e.abrupt("return",{fileName:u,publicUrl:g,size:l.size,optimized:!0,uploadTime:(new Date).toISOString()});case 15:return e.prev=15,e.catch(1),e.abrupt("return",null);case 16:case"end":return e.stop()}},e,null,[[1,15]])})),it.apply(this,arguments)}function ct(e,t){t.innerHTML="";var n={front:{white:"./images/white-front.png",black:"./images/black-front.png"},back:{white:"./images/white-back.png",black:"./images/black-back.png"}},r=n[e]&&n[e][Ae]?n[e][Ae]:"./images/white-front.png",a=document.createElement("img");a.src=r,a.crossOrigin="anonymous",a.style.cssText="\n        position: absolute;\n        top: 50%;\n        margin-top: -50%;\n        left: 0;\n        width: 100%;\n        object-fit: contain;\n        z-index: 1;\n    ",t.appendChild(a),t.style.cssText="\n        position: relative;\n        background: white;\n        overflow: hidden;\n        border: 0 ; \n    ";var i,c,o,s,l,u,d=window.innerWidth<=899,f=He.offsetWidth||400,p=He.offsetHeight||500;if(d?(i=120,c=150):(i=200,c=250),d){var h=i/f,v=c/p;o=.9*Math.min(h,v),s=(i-f*o)/2,l=(c-p*o)/2+2}else{var m=i/f,g=c/p;o=1.4*Math.min(m,g),s=(i-f*o)/2,l=(c-p*o)/2+3}We[e]&&We[e].length>0&&U()(u=We[e]).call(u,function(e,n){var r=document.createElement("img");r.src=e.src,r.className="preview-image",r.crossOrigin="anonymous",r.style.cssText="\n                position: absolute;\n                z-index: 10;\n                pointer-events: none;\n            ";var a=j()(e.style.width)*o,i=j()(e.style.height)*o,c=j()(e.style.left)*o+s,u=j()(e.style.top)*o+l;r.style.width=a+"px",r.style.height=i+"px",r.style.left=c+"px",r.style.top=d?u-5+"px":u-12+"px",t.appendChild(r)})}function ot(){document.getElementById("saveModal").classList.add("hidden")}function st(e){for(var t=e.split(","),n=t[0].match(/:(.*?);/)[1],r=atob(t[1]),a=r.length,i=new Uint8Array(a),c=0;c<a;c++)i[c]=r.charCodeAt(c);return new Blob([i],{type:n})}function lt(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return new(W())(function(r){var a=document.createElement("canvas"),i=a.getContext("2d"),c=new Image;c.onload=function(){var c=this.width,o=this.height;if(c>t){var s=t/c;c=t,o*=s}a.width=c,a.height=o,i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.drawImage(this,0,0,c,o);var l="image/jpeg",u=n;if(Y()(e).call(e,"data:image/png")){for(var d=i.getImageData(0,0,c,o).data,f=!1,p=3;p<d.length;p+=4)if(d[p]<255){f=!0;break}f&&(l="image/png",u=void 0)}var h=a.toDataURL(l,u);r(h)},c.src=e})}function ut(e){return dt.apply(this,arguments)}function dt(){return dt=(0,L.A)(I().mark(function e(t){var n,r,a=arguments;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:1200,r=a.length>2&&void 0!==a[2]?a[2]:"transparent",e.abrupt("return",new(W())(function(e,a){var i=document.createElement("canvas"),c=i.getContext("2d"),o=t.getBoundingClientRect(),s=o.width/o.height;if(i.width=n,i.height=n/s,"transparent"!==r&&(c.fillStyle=r,c.fillRect(0,0,i.width,i.height)),"svg"===t.tagName){var l=(new XMLSerializer).serializeToString(t),u=new Image;u.onload=function(){c.drawImage(this,0,0,i.width,i.height);var t=i.toDataURL("image/png");e(t)},u.onerror=a;var d=new Blob([l],{type:"image/svg+xml"}),f=he().createObjectURL(d);u.src=f}else ke()(t,{backgroundColor:"transparent"===r?null:r,useCORS:!0,scale:n/o.width,width:o.width,height:o.height}).then(function(t){var n=t.toDataURL("image/png");e(n)}).catch(a)}));case 1:case"end":return e.stop()}},e)})),dt.apply(this,arguments)}function ft(e){return pt.apply(this,arguments)}function pt(){return(pt=(0,L.A)(I().mark(function e(t){var n;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,ut(t,1200,"transparent");case 1:return n=e.sent,e.abrupt("return",n);case 2:return e.prev=2,e.catch(0),e.abrupt("return",null);case 3:case"end":return e.stop()}},e,null,[[0,2]])}))).apply(this,arguments)}function ht(){return vt.apply(this,arguments)}function vt(){return(vt=(0,L.A)(I().mark(function e(){var t,n,r,a,i,c,o,s,l,u,d,f,p,h,v,m,g,b,y,x,k,E,L;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(r=e.sent,a=r.data.user,!r.error){e.next=2;break}return alert("认证失败，请重新登录"),e.abrupt("return");case 2:if(a){e.next=3;break}return alert("请先登录"),e.abrupt("return");case 3:if(Ft()){e.next=4;break}return alert("请先添加设计元素再保存"),e.abrupt("return");case 4:if(Fe(),i=document.getElementById("frontPreview"),c=document.getElementById("backPreview"),i&&c){e.next=5;break}return alert("预览容器未找到，请重试"),e.abrupt("return");case 5:return e.next=6,mt(i);case 6:return e.next=7,mt(c);case 7:return o={backgroundColor:"#ffffff",useCORS:!0,allowTaint:!1,removeContainer:!0,scale:1,logging:!1,foreignObjectRendering:!1,imageTimeout:15e3,width:i.offsetWidth,height:i.offsetHeight,onclone:function(e){var t=e.querySelectorAll("img");U()(t).call(t,function(e){e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.transform="none"})}},e.prev=8,e.next=9,ke()(i,o);case 9:s=e.sent,e.next=12;break;case 10:return e.prev=10,e.catch(8),e.next=11,xt(i);case 11:s=e.sent;case 12:return e.prev=12,e.next=13,ke()(c,o);case 13:l=e.sent,e.next=16;break;case 14:return e.prev=14,e.catch(12),e.next=15,xt(c);case 15:l=e.sent;case 16:return u=bt(s),d=bt(l),e.next=17,kt(We.front,a.id,"front");case 17:return f=e.sent,e.next=18,kt(We.back,a.id,"back");case 18:return p=e.sent,h=me()(),v=null,m=null,e.prev=19,e.next=20,at(u,a.id,"".concat(h,"_preview_front.jpg"));case 20:v=e.sent,e.next=22;break;case 21:e.prev=21,e.catch(19);case 22:return e.prev=22,e.next=23,at(d,a.id,"".concat(h,"_preview_back.jpg"));case 23:m=e.sent,e.next=25;break;case 24:e.prev=24,e.catch(22);case 25:return g=Yt(),b={frontImages:M()(t=We.front).call(t,function(e,t){return Le(Le({},e),{},{storageFile:f[t]||null})}),backImages:M()(n=We.back).call(n,function(e,t){return Le(Le({},e),{},{storageFile:p[t]||null})}),color:Ae,currentView:Ce,timestamp:(new Date).toISOString(),sizeQuantities:g,frontPreviewFile:v||null,backPreviewFile:m||null},y={user_id:a.id,title:"Customized T-shirt ".concat((new Date).toLocaleString()),type:"tshirt",data:b,front_preview_image:v&&v.publicUrl?v.publicUrl:u,back_preview_image:m&&m.publicUrl?m.publicUrl:d,sizes:g},e.next=26,supabase.from("drafts").insert(y);case 26:x=e.sent,x.data,(k=x.error)?alert("保存失败: ".concat(k.message)):(be()(E=D()(L=[]).call(L,(0,w.A)(f),(0,w.A)(p))).call(E,function(e){return null!==e}).length,f.length+p.length,alert("SAVED！"),ot()),e.next=28;break;case 27:e.prev=27,e.catch(0),alert("保存失败，请检查控制台了解详情");case 28:case"end":return e.stop()}},e,null,[[0,27],[8,10],[12,14],[19,21],[22,24]])}))).apply(this,arguments)}function mt(e){return gt.apply(this,arguments)}function gt(){return gt=(0,L.A)(I().mark(function e(t){var n,r,a;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.querySelectorAll("img"),a=M()(n=A()(r)).call(n,function(e){return new(W())(function(t){if(e.complete&&e.naturalWidth>0)t();else{var n=function(){e.removeEventListener("load",n),e.removeEventListener("error",n),t()};e.addEventListener("load",n),e.addEventListener("error",n),V()(t,5e3)}})}),e.next=1,W().all(a);case 1:return e.next=2,new(W())(function(e){return V()(e,500)});case 2:case"end":return e.stop()}},e)})),gt.apply(this,arguments)}function bt(e){if(!e||0===e.width||0===e.height)return yt();for(var t=e.getContext("2d").getImageData(0,0,e.width,e.height).data,n=!1,r=0,a=0;a<t.length;a+=4){var i=t[a],c=t[a+1],o=t[a+2],s=t[a+3];r+=s,s>0&&(255!==i||255!==c||255!==o)&&(n=!0)}return!n||r<.1*t.length?yt():e.toDataURL("image/jpeg",.9)}function yt(){var e=document.createElement("canvas");e.width=200,e.height=250;var t=e.getContext("2d");return t.fillStyle="#ffffff",t.fillRect(0,0,e.width,e.height),t.fillStyle="#f0f0f0",t.fillRect(50,50,100,150),t.fillStyle="#666",t.font="14px Arial",t.textAlign="center",t.fillText("预览图",e.width/2,e.height/2),e.toDataURL("image/jpeg",.9)}function xt(e){return wt.apply(this,arguments)}function wt(){return wt=(0,L.A)(I().mark(function e(t){var n,r,a,i,c,o,s,l,u,d,f,p,h;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=document.createElement("canvas"),r=n.getContext("2d"),n.width=t.offsetWidth||200,n.height=t.offsetHeight||250,r.fillStyle="#ffffff",r.fillRect(0,0,n.width,n.height),(a=t.querySelector("img:first-child"))&&a.complete)try{r.drawImage(a,0,0,n.width,n.height)}catch(e){}i=t.querySelectorAll("img:not(:first-child)"),c=Se(i);try{for(c.s();!(o=c.n()).done;)if((s=o.value).complete&&s.naturalWidth>0)try{l=s.getBoundingClientRect(),u=t.getBoundingClientRect(),d=l.left-u.left,f=l.top-u.top,p=l.width,h=l.height,r.drawImage(s,d,f,p,h)}catch(e){}}catch(e){c.e(e)}finally{c.f()}return e.abrupt("return",n);case 1:case"end":return e.stop()}},e)})),wt.apply(this,arguments)}function kt(e,t,n){return Et.apply(this,arguments)}function Et(){return(Et=(0,L.A)(I().mark(function e(t,n,r){var a,i,c,o,s,l,u,d,f,p,h,v,m,g,b,y,x,w,k,E;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=[],i=me()(),c=0;case 1:if(!(c<t.length)){e.next=21;break}if(o=t[c],s=o.src,e.prev=2,p=void 0,h=void 0,v=void 0,!o.isMemberCode){e.next=7;break}if(!(m=Ye["front"===r?"front":"back"])){e.next=4;break}return e.next=3,ft(m);case 3:p=e.sent,h="png",e.next=6;break;case 4:return e.next=5,lt(s,1200,.9);case 5:p=e.sent,h="png";case 6:e.next=15;break;case 7:if(!$()(s).call(s,"data:image/svg")){e.next=12;break}if(!(g=document.querySelector('img[src="'.concat(s,'"]')))){e.next=9;break}return e.next=8,ut(g,1200);case 8:p=e.sent,e.next=11;break;case 9:return e.next=10,lt(s,1200,.9);case 10:p=e.sent;case 11:h="png",e.next=15;break;case 12:if(!$()(s).call(s,"data:image/")){e.next=14;break}return e.next=13,lt(s,2e3,.85);case 13:p=e.sent,h=Y()(p).call(p,"data:image/png")?"png":"jpg",e.next=15;break;case 14:return a.push(null),e.abrupt("continue",20);case 15:if(p){e.next=16;break}return a.push(null),e.abrupt("continue",20);case 16:return b=st(p),v=b.size,y=D()(l=D()(u=D()(d=D()(f="".concat(n,"/images/")).call(f,i,"_")).call(d,r,"_")).call(u,c,".")).call(l,h),e.next=17,supabase.storage.from("design-files").upload(y,b,{cacheControl:"3600",upsert:!0});case 17:if(x=e.sent,x.data,!x.error){e.next=18;break}return a.push(null),e.abrupt("continue",20);case 18:w=supabase.storage.from("design-files").getPublicUrl(y),k=w.data.publicUrl,E={fileName:y,publicUrl:k,side:r,originalSize:v,format:h,processedWidth:"png"===h&&(o.isMemberCode||$()(s).call(s,"data:image/svg"))?1e3:"auto",uploadTime:(new Date).toISOString(),type:o.isMemberCode?"memberCode":$()(s).call(s,"data:image/svg")?"svg":"regular"},a.push(E),e.next=20;break;case 19:e.prev=19,e.catch(2),a.push(null);case 20:c++,e.next=1;break;case 21:return be()(a).call(a,function(e){return null!==e}).length,e.abrupt("return",a);case 22:case"end":return e.stop()}},e,null,[[2,19]])}))).apply(this,arguments)}function Lt(e){var t;if(e!==Ce){var n;if(Fe(),n=He.querySelectorAll(".uploaded-image"),U()(n).call(n,function(e){He.removeChild(e)}),Ut(),function(e){var t;U()(t=We[e]).call(t,function(t){var n=document.createElement("img");n.src=t.src,n.className=t.className,z()(n.style,t.style),t.dataset.aspectRatio&&(n.dataset.aspectRatio=t.dataset.aspectRatio),He.appendChild(n),Mt(n),t.isMemberCode&&(Ye[e]=n,Xe[e]=!0)}),Ve()}(Ce=e),U()(t=document.querySelectorAll(".t-shirt-column button")).call(t,function(e){e.classList.remove("active")}),"color"!==e){var r=document.getElementById(e+"Btn");r&&r.classList.add("active")}var a=document.getElementById("colorMenu");a&&(a.classList.remove("show"),a.classList.add("hidden")),It(),Ve()}}function St(e){var t;Ae=e,U()(t=document.querySelectorAll(".color-option")).call(t,function(e){e.classList.remove("active")});var n=document.querySelector('[data-color="'.concat(e,'"]'));n&&n.classList.add("active");var r=document.getElementById("colorMenu");r&&(r.classList.add("hidden"),r.classList.remove("show")),It()}function It(){var e={front:{white:"./images/white-front.png",black:"./images/black-front.png"},back:{white:"./images/white-back.png",black:"./images/black-back.png"}},t=je.querySelector("img");e[Ce]&&e[Ce][Ae]&&t&&(t.src=e[Ce][Ae])}function Ct(){document.getElementById("fileInput").click()}function At(e){var t=e.target.files;if(t&&0!==t.length){for(var n=0;n<t.length;n++){var r,a=t[n];if($()(r=a.type).call(r,"image/")){var i=new FileReader;i.onload=function(e){Bt(e.target.result)},i.readAsDataURL(a)}else alert("请选择图片文件！")}e.target.value=""}}function Bt(e){var t=document.createElement("img");t.className="uploaded-image",t.src=e,t.onload=function(){var e=.6*He.offsetWidth,n=.6*He.offsetHeight,r=Math.min(e/this.naturalWidth,n/this.naturalHeight),a=this.naturalWidth*r,i=this.naturalHeight*r;t.style.width=a+"px",t.style.height=i+"px",t.style.left=(He.offsetWidth-a)/2+"px",t.style.top=(He.offsetHeight-i)/2+"px",t.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,He.appendChild(t),Be.push(t),Mt(t)}}function Mt(e){e.draggable=!1,e.style.touchAction="none",e.addEventListener("click",function(t){t.stopPropagation(),Rt(e)}),qt()?e.addEventListener("touchstart",function(t){t.preventDefault(),t.stopPropagation(),Rt(e)},{passive:!1}):(e.addEventListener("touchstart",function(t){if(t.preventDefault(),t.stopPropagation(),Rt(e),1===t.touches.length){var n=t.touches[0],r=e.getBoundingClientRect(),a=He.getBoundingClientRect();Te=!0,Ue=n.clientX-(r.left-a.left),qe=n.clientY-(r.top-a.top),e.classList.add("dragging")}},{passive:!1}),e.addEventListener("mousedown",function(t){t.target.classList.contains("resize-handle")||(Te=!0,Ue=t.clientX-e.offsetLeft,qe=t.clientY-e.offsetTop,e.classList.add("dragging"),t.preventDefault())}))}function Tt(){qt()?(document.addEventListener("touchmove",function(e){e.target.classList.contains("resize-handle")&&e.preventDefault()},{passive:!1}),document.addEventListener("touchend",function(e){(Te||De)&&(e.preventDefault(),Te=!1,De=!1,Re=null,Me&&Me.classList.remove("dragging"))},{passive:!1})):(document.addEventListener("touchmove",function(e){if(Te&&Me&&1===e.touches.length){e.preventDefault();var t=e.touches[0],n=He.getBoundingClientRect(),r=t.clientX-n.left-Ue,a=t.clientY-n.top-qe,i=n.width-Me.offsetWidth,c=n.height-Me.offsetHeight;Me.style.left=Math.max(0,Math.min(r,i))+"px",Me.style.top=Math.max(0,Math.min(a,c))+"px",zt()}else De&&Me&&1===e.touches.length&&(e.preventDefault(),function(e){if(!De||!Me)return;var t=e.clientX-Ue,n=(e.clientY,ze),r=Pe,a=Oe,i=_e;switch(Re){case"se":r=(n=Math.max(30,ze+t))/Ne;break;case"sw":r=(n=Math.max(30,ze-t))/Ne,a=Oe+(ze-n);break;case"ne":n=Math.max(30,ze+t),i=_e+(Pe-(r=n/Ne));break;case"nw":n=Math.max(30,ze-t),a=Oe+(ze-n),i=_e+(Pe-(r=n/Ne))}Me.style.width=n+"px",Me.style.height=r+"px",Me.style.left=a+"px",Me.style.top=i+"px",zt()}(e.touches[0]))},{passive:!1}),document.addEventListener("touchend",function(e){(Te||De)&&(e.preventDefault(),Te=!1,De=!1,Re=null,Me&&Me.classList.remove("dragging"))},{passive:!1}))}function Dt(){var e;(e=document.createElement("style")).textContent='\n            .uploaded-image {\n                touch-action: none;\n                -webkit-user-select: none;\n                user-select: none;\n                -webkit-touch-callout: none;\n            }\n            \n            .resize-handle {\n                touch-action: none;\n                -webkit-user-select: none;\n                user-select: none;\n            }\n            \n            /* Mobile-specific handle styles */\n            @media (max-width: 899px) {\n                .resize-handle {\n                    width: 30px !important;\n                    height: 30px !important;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    font-size: 23px;\n                    \n                    color: black;\n                    transform-origin: center center !important;\n                }\n                \n                /* Corner handles - resize controls */\n                .resize-handle[data-direction="nw"],\n                .resize-handle[data-direction="ne"] {\n                   \n                    border: 2px solid black;\n                }\n                \n                .resize-handle[data-direction="sw"],\n                .resize-handle[data-direction="se"] {\n                  \n                    border: 2px solid black;\n                }\n                \n                /* Side handles - movement controls */\n                .resize-handle[data-direction="n"],\n                .resize-handle[data-direction="s"],\n                .resize-handle[data-direction="e"],\n                .resize-handle[data-direction="w"] {\n\n                    border: 2px solid black;\n                }\n                \n              \n            }\n            \n           \n        ',document.head.appendChild(e),Tt()}function Rt(e){Me&&Me.classList.remove("selected"),(Me=e).classList.add("selected"),Ge.classList.remove("hidden"),zt(),Ot()}function Ut(){Me&&Me.classList.remove("selected"),Me=null,Ge.classList.add("hidden")}function qt(){return window.innerWidth<=899||"ontouchstart"in window}function zt(){var e;if(Me){Me.offsetHeight;var t=Me.getBoundingClientRect(),n=He.getBoundingClientRect(),r=t.left-n.left,a=t.top-n.top,i=t.width,c=t.height;Ge.style.transform=D()(e="translate(".concat(r,"px, ")).call(e,a,"px)"),Ge.style.width=i+"px",Ge.style.height=c+"px",Ge.style.position||(Ge.style.position="absolute",Ge.style.left="0",Ge.style.top="0"),qt()&&requestAnimationFrame(function(){Pt()})}}function Pt(){var e=Ge.querySelectorAll(".resize-handle");U()(e).call(e,function(e){switch(e.dataset.direction){case"nw":case"ne":e.innerHTML="+",e.title="Tap to enlarge";break;case"sw":case"se":e.innerHTML="−",e.title="Tap to shrink";break;case"n":e.innerHTML="↑",e.title="Move up";break;case"s":e.innerHTML="↓",e.title="Move down";break;case"e":e.innerHTML="→",e.title="Move right";break;case"w":e.innerHTML="←",e.title="Move left"}})}function Ot(){var e=Ge.querySelectorAll(".resize-handle");U()(e).call(e,function(e){e.replaceWith(e.cloneNode(!0))});var t=Ge.querySelectorAll(".resize-handle");U()(t).call(t,function(e){qt()?(e.addEventListener("touchstart",_t,{passive:!1}),e.addEventListener("touchend",Nt,{passive:!1}),e.addEventListener("touchmove",function(e){return e.preventDefault()},{passive:!1})):e.addEventListener("mousedown",function(e){e.stopPropagation(),Me&&(De=!0,Re=this.dataset.direction,Ue=e.clientX,qe=e.clientY,ze=Me.offsetWidth,Pe=Me.offsetHeight,Oe=Me.offsetLeft,_e=Me.offsetTop,Ne=K()(Me.dataset.aspectRatio)||1,e.preventDefault())})}),qt()&&Pt()}function _t(e){(e.preventDefault(),e.stopPropagation(),Me)&&(e.currentTarget.style.transformOrigin="center center")}function Nt(e){(e.preventDefault(),e.stopPropagation(),Me)&&function(e){if(!Me)return;var t=Me.offsetWidth,n=Me.offsetHeight,r=Me.offsetLeft,a=Me.offsetTop,i=K()(Me.dataset.aspectRatio)||1,c=He.offsetWidth,o=He.offsetHeight;switch(e){case"nw":case"ne":var s=Math.min(1.1*t,.9*c),l=s/i;if(l<=.9*o){Me.style.width=s+"px",Me.style.height=l+"px";var u=Math.max(0,Math.min(r+(t-s)/2,c-s)),d=Math.max(0,Math.min(a+(n-l)/2,o-l));Me.style.left=u+"px",Me.style.top=d+"px"}break;case"sw":case"se":var f=Math.max(.9*t,30),p=f/i;Me.style.width=f+"px",Me.style.height=p+"px";var h=Math.max(0,Math.min(r+(t-f)/2,c-f)),v=Math.max(0,Math.min(a+(n-p)/2,o-p));Me.style.left=h+"px",Me.style.top=v+"px";break;case"n":var m=Math.max(0,a-10);Me.style.top=m+"px";break;case"s":var g=Math.min(o-n,a+10);Me.style.top=g+"px";break;case"w":var b=Math.max(0,r-10);Me.style.left=b+"px";break;case"e":var y=Math.min(c-t,r+10);Me.style.left=y+"px"}requestAnimationFrame(function(){zt()})}(e.currentTarget.dataset.direction)}function Ht(){if(Me){if(Me.parentNode&&Me.parentNode.removeChild(Me),void 0!==Be&&ee()(Be)){var e=O()(Be).call(Be,Me);e>-1&&N()(Be).call(Be,e,1)}Ut()}}function jt(){var e=document.getElementById("frontBtn");e&&e.addEventListener("click",function(e){e.preventDefault(),Lt("front")});var t=document.getElementById("backBtn");t&&t.addEventListener("click",function(e){e.preventDefault(),Lt("back")});var n=document.getElementById("colorBtn");n&&n.addEventListener("click",function(e){var t;e.preventDefault(),(t=document.getElementById("colorMenu"))&&(t.classList.contains("hidden")?(t.classList.remove("hidden"),t.classList.add("show")):(t.classList.add("hidden"),t.classList.remove("show")))})}document.addEventListener("DOMContentLoaded",function(){Tt(),V()(function(){"function"==typeof window.displayUserProfile&&window.displayUserProfile().catch(function(e){})},1e3)}),"undefined"!=typeof supabase&&supabase.auth.onAuthStateChange(function(e,t){"SIGNED_IN"===e?V()(function(){"function"==typeof window.displayUserProfile&&window.displayUserProfile()},500):"SIGNED_OUT"===e&&Xe&&tt()}),window.addEventListener("resize",function(){V()(function(){Me&&(Ot(),zt())},100)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Dt):Dt(),document.addEventListener("mousemove",function(e){if(Te&&Me){var t=e.clientX-Ue,n=e.clientY-qe;Me.style.left=t+"px",Me.style.top=n+"px",zt()}else De&&function(e){if(De&&Me){var t=e.clientX-Ue,n=e.clientY-qe,r=ze,a=Pe,i=Oe,c=_e;switch(Re){case"nw":i=Oe+t,c=_e+(Pe-(a=(r=ze-t)/Ne));break;case"n":i=Oe-((r=(a=Pe-n)*Ne)-ze)/2,c=_e+n;break;case"ne":c=_e+(Pe-(a=(r=ze+t)/Ne));break;case"e":c=_e-((a=(r=ze+t)/Ne)-Pe)/2;break;case"se":a=(r=ze+t)/Ne;break;case"s":i=Oe-((r=(a=Pe+n)*Ne)-ze)/2;break;case"sw":a=(r=ze-t)/Ne,i=Oe+t;break;case"w":i=Oe+t,c=_e-((a=(r=ze-t)/Ne)-Pe)/2}r<20||a<20||(Me.style.width=r+"px",Me.style.height=a+"px",Me.style.left=i+"px",Me.style.top=c+"px",zt())}}(e)}),document.addEventListener("mouseup",function(){Te=!1,De=!1,Re=null,Me&&Me.classList.remove("dragging")}),He.addEventListener("click",function(e){e.target.classList.contains("uploaded-image")||Ut()}),document.addEventListener("dragstart",function(e){e.preventDefault()}),document.addEventListener("dragover",function(e){e.preventDefault()}),document.addEventListener("keydown",function(e){"Delete"===e.key&&Me?Ht():"Escape"===e.key&&Ut()}),window.addEventListener("resize",function(){Me&&zt()}),document.addEventListener("click",function(e){e.target.closest(".color-option")&&St(e.target.closest(".color-option").dataset.color);if(!e.target.closest("#colorBtn")&&!e.target.closest(".color-menu")){var t=document.getElementById("colorMenu");t&&t.classList.contains("show")&&(t.classList.add("hidden"),t.classList.remove("show"))}});var Gt=document.getElementById("saveModal");if(Gt){Gt.addEventListener("click",function(e){e.target===Gt&&ot()});var Wt=document.getElementById("memberCodeBtn");Wt&&Wt.addEventListener("click",function(){return nt.apply(this,arguments)})}function Xt(){var e=["tshirtContainer","tshirtBackground","resizeHandles","frontBtn","backBtn","colorBtn"];ne()(e).call(e,function(e){return document.getElementById(e)})?V()(function(){!function(){void 0===Be&&(window.uploadedImages=[]),void 0===Me&&(window.selectedImage=null);var e=document.getElementById("tshirtContainer");e&&void 0===He&&(window.container=e),document.getElementById("tshirtBackground"),document.getElementById("resizeHandles")}(),jt(),He?(Lt("front"),St("white"),Ve(),function(){var e=document.getElementById("fileBtn");e&&e.addEventListener("click",Ct);var t=document.getElementById("deleteBtn");t&&t.addEventListener("click",Ht);var n=document.getElementById("saveDesignBtn");n&&n.addEventListener("click",rt);var r=document.getElementById("saveToDraftBtn");r&&r.addEventListener("click",(0,L.A)(I().mark(function e(){return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.textContent="SAVING...",this.disabled=!0,e.next=1,ht();case 1:this.textContent="SAVE TO DRAFT",this.disabled=!1;case 2:case"end":return e.stop()}},e,this)})));var a=document.getElementById("addToCartBtn");a&&(a.replaceWith(a.cloneNode(!0)),document.getElementById("addToCartBtn").addEventListener("click",rn));var i=document.getElementById("backToEditBtn");i&&i.addEventListener("click",ot);var c=document.getElementById("fileInput");c&&c.addEventListener("change",At)}(),function(){Vt.apply(this,arguments)}(),V()(function(){var e=document.querySelector('[data-color="white"]');e&&e.classList.add("active")},100)):V()(Xt,1e3)},500):V()(Xt,500)}function Yt(){var e=document.querySelectorAll(".size-option"),t={};return U()(e).call(e,function(e){var n=e.querySelector("label"),r=e.querySelector(".quantity-input");if(n&&r){var a,i=ae()(a=n.textContent).call(a),c=j()(r.value)||0;c>0&&(t[i]=c)}}),t}function Ft(){var e=We.front&&We.front.length>0,t=We.back&&We.back.length>0;return e||t}function Vt(){return(Vt=(0,L.A)(I().mark(function e(){var t;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=getAndClearUrlParam("loadTshirtDraft"))){e.next=2;break}return e.next=1,Qt();case 1:return e.next=2,$t(t);case 2:case"end":return e.stop()}},e)}))).apply(this,arguments)}function Qt(){return new(W())(function(e){var t=function(){var n=document.getElementById("tshirtContainer"),r=document.getElementById("frontBtn"),a=document.getElementById("backBtn");n&&r&&a?e():V()(t,100)};t()})}function $t(e){return Jt.apply(this,arguments)}function Jt(){return(Jt=(0,L.A)(I().mark(function e(t){var n,r,a;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,document.getElementById("tshirtContainer")){e.next=1;break}return e.next=1,new(W())(function(e){return V()(e,1e3)});case 1:return e.next=2,supabase.from("drafts").select("*").eq("id",t).single();case 2:if(n=e.sent,r=n.data,!n.error&&r&&"tshirt"===r.type){e.next=3;break}return alert("无法加载T恤设计"),e.abrupt("return");case 3:if(a=r.data){e.next=4;break}return alert("草稿数据损坏"),e.abrupt("return");case 4:return a.color&&St(a.color),Kt(),Lt("front"),e.next=5,Zt("front",a.frontImages);case 5:return Lt("back"),e.next=6,Zt("back",a.backImages);case 6:a.sizeQuantities&&nn(a.sizeQuantities),a.currentView?Lt(a.currentView):Lt("front"),mr("The design has been loaded!","success"),e.next=8;break;case 7:e.prev=7,e.catch(0),alert("恢复失败，请重试");case 8:case"end":return e.stop()}},e,null,[[0,7]])}))).apply(this,arguments)}function Kt(){We.front=[],We.back=[];var e=document.getElementById("tshirtContainer");if(e){var t=e.querySelectorAll(".uploaded-image");U()(t).call(t,function(e){return e.remove()})}Xe.front=!1,Xe.back=!1,Ye.front=null,Ye.back=null,Be=[],Ut()}function Zt(e,t){return en.apply(this,arguments)}function en(){return(en=(0,L.A)(I().mark(function e(t,n){var r,a,i,c,o;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n&&ee()(n)){e.next=1;break}return e.abrupt("return");case 1:if(document.getElementById("tshirtContainer")){e.next=2;break}return e.abrupt("return");case 2:r=Se(n),e.prev=3,r.s();case 4:if((a=r.n()).done){e.next=10;break}if(i=a.value,e.prev=5,c=null,i.storageFile&&i.storageFile.publicUrl?c=i.storageFile.publicUrl:i.src&&(c=i.src),c){e.next=6;break}return e.abrupt("continue",9);case 6:return e.next=7,tn(c,i,t);case 7:e.next=9;break;case 8:e.prev=8,e.catch(5);case 9:e.next=4;break;case 10:e.next=12;break;case 11:e.prev=11,o=e.catch(3),r.e(o);case 12:return e.prev=12,r.f(),e.finish(12);case 13:Fe();case 14:case"end":return e.stop()}},e,null,[[3,11,12,13],[5,8]])}))).apply(this,arguments)}function tn(e,t,n){return new(W())(function(r,a){var i=new Image;i.onload=function(){var a=document.createElement("img");a.src=e,a.className=t.className||"uploaded-image",t.style&&(a.style.width=t.style.width,a.style.height=t.style.height,a.style.left=t.style.left,a.style.top=t.style.top),t.dataset&&t.dataset.aspectRatio?a.dataset.aspectRatio=t.dataset.aspectRatio:a.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,document.getElementById("tshirtContainer").appendChild(a),Mt(a),Be.push(a),(t.isMemberCode||a.classList.contains("member-code-image"))&&(Ye[n]=a,Xe[n]=!0,Ve()),r(a)},i.onerror=function(){a(new Error("图片加载失败"))},i.src=e})}function nn(e){var t;e&&U()(t=ue()(e)).call(t,function(t){var n=document.querySelector('.quantity-input[data-size="'.concat(t,'"]'));if(!n){var r,a=Se(document.querySelectorAll(".size-option"));try{for(a.s();!(r=a.n()).done;){var i,c=r.value,o=c.querySelector("label");if(o&&ae()(i=o.textContent).call(i)===t){n=c.querySelector(".quantity-input");break}}}catch(e){a.e(e)}finally{a.f()}}n&&(n.value=e[t]||0)})}function rn(){return an.apply(this,arguments)}function an(){return(an=(0,L.A)(I().mark(function e(){var t,n,r,a,i,c,o,s,l,u,d,f,p,h,v,m,g,b,y;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(n=e.sent,r=n.data.user){e.next=2;break}return alert("请先登录"),e.abrupt("return");case 2:if(a=Yt(),0!==(i=ce()(t=se()(a)).call(t,function(e,t){return e+t},0))){e.next=3;break}return alert("请至少选择一个尺码"),e.abrupt("return");case 3:if(!(c=document.getElementById("addToCartBtn"))){e.next=10;break}if(o=c.textContent,c.textContent="PROCESSING...",c.disabled=!0,e.prev=4,Fe(),s=We.front&&We.front.length>0,l=We.back&&We.back.length>0,u="",d="",f=0,p="",h=null,s||l?s&&l?(u="double-sided",d="double-sided-".concat(Ae),p="Double-sided Custom T-shirt",f=TSHIRT_PRICING["double-sided"][Ae]||TSHIRT_PRICING["double-sided"].white):(u="single-sided",d="single-sided-".concat(Ae),p="Single-sided Custom T-shirt",f=TSHIRT_PRICING["single-sided"][Ae]||TSHIRT_PRICING["single-sided"].white):(u="blank",d="blank-tshirt-".concat(Ae),p="Blank T-shirt (".concat(Ae,")"),f=TSHIRT_PRICING.blank[Ae]||TSHIRT_PRICING.blank.white),!s&&!l){e.next=6;break}return e.next=5,on(!0);case 5:if(h=e.sent){e.next=6;break}throw new Error("保存设计失败");case 6:return e.next=7,window.CartManager.addOrUpdateCartItem({draftId:h,itemData:{type:d,designType:u,color:Ae,title:p,unitPrice:f},sizes:a,userId:r.id});case 7:if(!(v=e.sent).success){e.next=8;break}ot(),g=f*i,b=M()(m=xe()(a)).call(m,function(e){var t,n=(0,x.A)(e,2),r=n[0],a=n[1];return D()(t="".concat(r,": ")).call(t,a)}).join(", "),confirm("Successfully added to cart!\n\n"+"Item: ".concat(p,"\n")+"Type: ".concat(u,"\n")+"Color: ".concat(Ae,"\n")+"Sizes: ".concat(b,"\n")+"Unit Price: $".concat(f.toFixed(2),"\n")+"Total Quantity: ".concat(i,"\n")+"Total Price: $".concat(g.toFixed(2),"\n\n")),e.next=9;break;case 8:throw new Error(v.error||"添加到购物车失败");case 9:return e.prev=9,c.textContent=o,c.disabled=!1,e.finish(9);case 10:e.next=12;break;case 11:e.prev=11,y=e.catch(0),alert("添加失败: "+y.message);case 12:case"end":return e.stop()}},e,null,[[0,11],[4,,9,10]])}))).apply(this,arguments)}function cn(){return new(W())(function(e){var t=fe()(function(){window.CartManager&&"function"==typeof window.CartManager.addOrUpdateCartItem&&(clearInterval(t),e())},100);V()(function(){clearInterval(t),e()},5e3)})}function on(){return sn.apply(this,arguments)}function sn(){return sn=(0,L.A)(I().mark(function e(){var t,n,r,a,i,c,o,s,l,u,d,f,p,h,v,m,g,b,y,x,w,k,E=arguments;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=E.length>0&&void 0!==E[0]&&E[0],e.prev=1,e.next=2,supabase.auth.getUser();case 2:if(a=e.sent,i=a.data.user){e.next=3;break}return t||alert("请先登录"),e.abrupt("return",null);case 3:if(Ft()){e.next=4;break}return e.abrupt("return",null);case 4:if(Fe(),c=document.getElementById("frontPreview"),o=document.getElementById("backPreview"),c&&o){e.next=5;break}return e.abrupt("return",null);case 5:return e.next=6,mt(c);case 6:return e.next=7,mt(o);case 7:return s={backgroundColor:"#ffffff",useCORS:!0,allowTaint:!1,removeContainer:!0,scale:1,logging:!1,foreignObjectRendering:!1,imageTimeout:15e3,width:c.offsetWidth,height:c.offsetHeight,onclone:function(e){var t=e.querySelectorAll("img");U()(t).call(t,function(e){e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.transform="none"})}},e.prev=8,e.next=9,ke()(c,s);case 9:l=e.sent,e.next=12;break;case 10:return e.prev=10,e.catch(8),e.next=11,xt(c);case 11:l=e.sent;case 12:return e.prev=12,e.next=13,ke()(o,s);case 13:u=e.sent,e.next=16;break;case 14:return e.prev=14,e.catch(12),e.next=15,xt(o);case 15:u=e.sent;case 16:return d=bt(l),f=bt(u),e.next=17,kt(We.front,i.id,"front");case 17:return p=e.sent,e.next=18,kt(We.back,i.id,"back");case 18:return h=e.sent,v=me()(),m=null,g=null,e.prev=19,e.next=20,at(d,i.id,"".concat(v,"_cart_preview_front.jpg"));case 20:m=e.sent,e.next=22;break;case 21:e.prev=21,e.catch(19);case 22:return e.prev=22,e.next=23,at(f,i.id,"".concat(v,"_cart_preview_back.jpg"));case 23:g=e.sent,e.next=25;break;case 24:e.prev=24,e.catch(22);case 25:return b=Yt(),y={frontImages:M()(n=We.front).call(n,function(e,t){return Le(Le({},e),{},{storageFile:p[t]||null})}),backImages:M()(r=We.back).call(r,function(e,t){return Le(Le({},e),{},{storageFile:h[t]||null})}),color:Ae,currentView:Ce,timestamp:(new Date).toISOString(),sizeQuantities:b,frontPreviewFile:m||null,backPreviewFile:g||null},x={user_id:i.id,title:"T恤设计 ".concat((new Date).toLocaleString()),type:"tshirt",data:y,front_preview_image:m&&m.publicUrl?m.publicUrl:d,back_preview_image:g&&g.publicUrl?g.publicUrl:f,sizes:b},e.next=26,supabase.from("drafts").insert(x).select().single();case 26:if(w=e.sent,k=w.data,!w.error){e.next=27;break}return e.abrupt("return",null);case 27:return e.abrupt("return",k.id);case 28:return e.prev=28,e.catch(1),e.abrupt("return",null);case 29:case"end":return e.stop()}},e,null,[[1,28],[8,10],[12,14],[19,21],[22,24]])})),sn.apply(this,arguments)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Xt):Xt(),U()(r=document.querySelectorAll(".quantity-control")).call(r,function(e){var t=e.querySelector(".quantity-input");t.addEventListener("change",function(){var e=j()(t.value);isNaN(e)||e<0?t.value=0:e>99&&(t.value=99)})}),document.addEventListener("DOMContentLoaded",(0,L.A)(I().mark(function e(){var t;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=1,cn();case 1:if(!window.CartManager||"function"!=typeof window.CartManager.initCartIcon){e.next=2;break}return e.next=2,window.CartManager.initCartIcon();case 2:U()(t=document.querySelectorAll(".quantity-input")).call(t,function(e){e.addEventListener("change",function(){var e=j()(this.value)||0;e<0&&(this.value=0),e>99&&(this.value=99)}),e.addEventListener("input",function(){this.value=this.value.replace(/[^0-9]/g,"")})});case 3:case"end":return e.stop()}},e)})));var ln,un,dn,fn,pn,hn=!1,vn=null,mn=[],gn=-1,bn="pencil",yn=2,xn=1,wn=3,kn=!1,En=0,Ln=0;function Sn(){var e=document.querySelector(".pencil-menu");e&&e.classList.remove("show")}function In(){(dn=document.getElementById("mySVG"))&&(Cn(),function(){var e=document.getElementById("pencil");e&&e.addEventListener("click",function(){Un("pencil"),qn(wn),Rn(wn),Sn()});var t=document.querySelector(".pencil-menu-trigger");t&&t.addEventListener("click",function(e){var t;e.stopPropagation(),(t=document.querySelector(".pencil-menu"))&&t.classList.toggle("show")});document.addEventListener("click",function(e){var t=document.getElementById("pencil");t&&!t.contains(e.target)&&Sn()});var n=document.getElementById("eraser");n&&n.addEventListener("click",function(){Un("eraser")});var r=document.getElementById("zoom-in");r&&r.addEventListener("click",function(){xn<3&&(xn=Math.min(1.25*xn,3),An())});var a=document.getElementById("zoom-out");a&&a.addEventListener("click",function(){xn>.5&&((xn=Math.max(xn/1.25,.5))<=1&&(xn=1,En=0,Ln=0),An())});var i=document.getElementById("drag");i&&i.addEventListener("click",function(){Un("drag")});var c=document.querySelectorAll(".pencil-menu [data-width]");U()(c).call(c,function(e){e.addEventListener("click",function(){var e=j()(this.getAttribute("data-width"));qn(e),wn=e,Rn(e),Sn()})}),qn(2),Rn(2)}(),function(){if(!dn)return;function e(e){var t,n;if(e.preventDefault(),"touchstart"===e.type){var r=e.touches[0];t=r.clientX,n=r.clientY}else t=e.clientX,n=e.clientY;var a=zn(t,n);"drag"===bn?(kn=!0,fn=t,pn=n,dn.style.cursor="grabbing"):(hn=!0,ln=a.x,un=a.y,Pn(a.x,a.y))}function t(e){var t,n;if(e.preventDefault(),"touchmove"===e.type){var r=e.touches[0];t=r.clientX,n=r.clientY}else t=e.clientX,n=e.clientY;var a=zn(t,n);if(kn){var i=t-fn,c=n-pn;fn=t,pn=n,En+=i,Ln+=c,An()}else hn&&(On(ln,un,a.x,a.y),ln=a.x,un=a.y)}function n(e){e.preventDefault(),kn?(kn=!1,dn.style.cursor="drag"===bn?"grab":"default"):hn&&(hn=!1,_n(),Hn())}dn.addEventListener("mousedown",function(e){e.preventDefault();var t=zn(e.clientX,e.clientY);"drag"===bn?(kn=!0,fn=e.clientX,pn=e.clientY,dn.style.cursor="grabbing"):(hn=!0,ln=t.x,un=t.y,Pn(t.x,t.y))}),dn.addEventListener("mousemove",function(e){e.preventDefault();var t=zn(e.clientX,e.clientY);if(kn){var n=e.clientX-fn,r=e.clientY-pn;fn=e.clientX,pn=e.clientY,En+=n,Ln+=r,An()}else hn&&(On(ln,un,t.x,t.y),ln=t.x,un=t.y)}),dn.addEventListener("mouseup",function(e){kn?(kn=!1,dn.style.cursor="grab"):hn&&(hn=!1,_n(),Hn())}),dn.addEventListener("mousedown",e),dn.addEventListener("mousemove",t),dn.addEventListener("mouseup",n),dn.addEventListener("touchstart",Mn),dn.addEventListener("touchmove",Tn),dn.addEventListener("touchend",Dn),dn.addEventListener("touchcancel",n,{passive:!1}),dn.addEventListener("touchstart",function(e){e.touches.length>1&&e.preventDefault()},{passive:!1})}(),Un("pencil"),Hn())}function Cn(){var e;if(dn){var t=dn.parentElement;if(t){var n=t.getBoundingClientRect(),r=Math.max(n.width,100),a=Math.max(n.height-60,100);dn.setAttribute("width",r),dn.setAttribute("height",a),dn.setAttribute("viewBox",D()(e="0 0 ".concat(r," ")).call(e,a))}}}function An(){var e,t,n;if(dn){var r=D()(e=D()(t=D()(n="".concat(-En/xn," ")).call(n,-Ln/xn," ")).call(t,dn.clientWidth/xn," ")).call(e,dn.clientHeight/xn);dn.setAttribute("viewBox",r)}}function Bn(){V()(function(){In(),function(){var e=document.getElementById("undoBtn");e&&e.addEventListener("click",jn);var t=document.getElementById("saveBtn");t&&t.addEventListener("click",Wn);var n=document.getElementById("clearBtn");n&&n.addEventListener("click",Gn);var r=document.getElementById("nextBtn");r&&r.addEventListener("click",Zn)}(),function(){sr.apply(this,arguments)}(),function(){hr.apply(this,arguments)}();var e=fe()(function(){document.getElementById("tshirtContainer")&&clearInterval(e)},500);V()(function(){return clearInterval(e)},1e4)},100)}function Mn(e){e.preventDefault();var t=e.touches[0],n=zn(t.clientX,t.clientY);"drag"===bn?(kn=!0,fn=t.clientX,pn=t.clientY):(hn=!0,ln=n.x,un=n.y,Pn(n.x,n.y))}function Tn(e){e.preventDefault();var t=e.touches[0],n=zn(t.clientX,t.clientY);if(kn){var r=t.clientX-fn,a=t.clientY-pn;fn=t.clientX,pn=t.clientY,En+=r,Ln+=a,An()}else hn&&(On(ln,un,n.x,n.y),ln=n.x,un=n.y)}function Dn(e){e.preventDefault(),kn?kn=!1:hn&&(hn=!1,_n(),Hn())}function Rn(e){var t=document.querySelectorAll(".pencil-menu [data-width]");U()(t).call(t,function(t){t.classList.remove("active"),j()(t.getAttribute("data-width"))===e&&t.classList.add("active")})}function Un(e){var t;bn=e,U()(t=document.querySelectorAll(".tools > div")).call(t,function(e){e.classList.remove("active")});var n=document.getElementById(e);n&&n.classList.add("active"),dn&&("pencil"===e?dn.classList.add("pencil-cursor"):(dn.classList.remove("pencil-cursor"),dn.style.cursor="eraser"===e?"crosshair":"drag"===e?"grab":"default"))}function qn(e){yn=e}function zn(e,t){if(!dn)return{x:0,y:0};var n=dn.getBoundingClientRect(),r=window.pageXOffset||document.documentElement.scrollLeft||0,a=window.pageYOffset||document.documentElement.scrollTop||0,i=e-n.left-r,c=t-n.top-a;return{x:(i-En)/xn,y:(c-Ln)/xn}}function Pn(e,t){if("pencil"===bn){var n;vn=document.createElementNS("http://www.w3.org/2000/svg","path");var r=Math.round(100*e)/100,a=Math.round(100*t)/100;vn.setAttribute("d",D()(n="M ".concat(r," ")).call(n,a)),vn.setAttribute("stroke","black"),vn.setAttribute("stroke-width",yn),vn.setAttribute("fill","none"),vn.setAttribute("stroke-linecap","square"),vn.setAttribute("stroke-linejoin","square"),dn.appendChild(vn)}else"eraser"===bn&&Nn(e,t)}function On(e,t,n,r){if("pencil"===bn&&vn){var a,i=Math.round(100*n)/100,c=Math.round(100*r)/100,o=vn.getAttribute("d");vn.setAttribute("d",o+D()(a=" L ".concat(i," ")).call(a,c))}else"eraser"===bn&&Nn(n,r)}function _n(){vn=null}function Nn(e,t){if(dn){var n=dn.querySelectorAll("path"),r=2*yn;U()(n).call(n,function(n){try{var a=n.getBBox();e>=a.x-r&&e<=a.x+a.width+r&&t>=a.y-r&&t<=a.y+a.height+r&&dn.removeChild(n)}catch(e){}})}}function Hn(){if(dn){++gn<mn.length&&(mn.length=gn),mn.push(dn.innerHTML);mn.length>20&&(mn.shift(),gn--)}}function jn(){!dn||gn<=0||(gn--,dn.innerHTML=mn[gn])}function Gn(){dn&&(dn.innerHTML="",Hn())}function Wn(){var e=document.getElementById("saveSvgModal");if(!e){var t=(new XMLSerializer).serializeToString(dn),n=new Blob([t],{type:"image/svg+xml"}),r=he().createObjectURL(n),a='\n            <div id="saveSvgModal" class="modal">\n                <div class="modal-content-svg">\n                    <div class="preview-container-svg">\n                        <div class="preview-item-svg">\n                            <span>PREVIEW</span>\n                            <div class="preview-svg" style="background-image: url(\''.concat(r,'\')"></div>\n                        </div>\n                    </div>\n                    <div class="modal-buttons">\n                        <button id="confirmSaveSvgBtn">SAVE TO DRAFT</button>\n                        <button id="addToGalleryBtn">ADD TO GALLERY</button>\n                    </div>\n                </div>\n            </div>\n        ');document.body.insertAdjacentHTML("beforeend",a),e=document.getElementById("saveSvgModal");var i=document.getElementById("confirmSaveSvgBtn");i&&i.addEventListener("click",function(){var e=(0,L.A)(I().mark(function e(t){return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.stopPropagation(),this.textContent="SAVING...",this.disabled=!0,e.next=1,Xn();case 1:this.textContent="SAVE TO DRAFT",this.disabled=!1;case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}());var c=document.getElementById("addToGalleryBtn");c&&c.addEventListener("click",function(){var e=(0,L.A)(I().mark(function e(t){return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.stopPropagation(),this.textContent="PROCESSING...",this.disabled=!0,e.next=1,$n();case 1:this.textContent="ADD TO GALLERY",this.disabled=!1;case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}())}e.classList.remove("hidden")}function Xn(){return Yn.apply(this,arguments)}function Yn(){return(Yn=(0,L.A)(I().mark(function e(){var t,n,r,a,i,c,o,s,l,u,d,f;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(n=e.sent,r=n.data.user){e.next=2;break}return alert("请先登录"),Fn(),e.abrupt("return");case 2:return a=(new XMLSerializer).serializeToString(dn),i=new Blob([a],{type:"image/svg+xml"}),c=me()(),o=D()(t="".concat(r.id,"/svg/")).call(t,c,"_drawing.svg"),e.next=3,supabase.storage.from("design-files").upload(o,i,{contentType:"image/svg+xml",cacheControl:"3600",upsert:!0});case 3:if(s=e.sent,s.data,!s.error){e.next=4;break}return alert("上传失败，请重试"),e.abrupt("return");case 4:return l=supabase.storage.from("design-files").getPublicUrl(o),u=l.data.publicUrl,e.next=5,Vn(a);case 5:return d=e.sent,e.next=6,supabase.from("drafts").insert({user_id:r.id,title:"SVG绘图 ".concat((new Date).toLocaleString()),type:"svg",data:{storageUrl:u,fileName:o,fileSize:i.size,uploadTime:(new Date).toISOString()},front_preview_image:d});case 6:f=e.sent,f.data,f.error?alert("保存失败，请重试"):(Fn(),alert("SAVED!")),e.next=8;break;case 7:e.prev=7,e.catch(0),alert("保存失败，请重试");case 8:case"end":return e.stop()}},e,null,[[0,7]])}))).apply(this,arguments)}function Fn(){var e=document.querySelectorAll("#saveSvgModal");U()(e).call(e,function(e){var t;null===(t=e.parentNode)||void 0===t||t.removeChild(e)})}function Vn(e){return Qn.apply(this,arguments)}function Qn(){return Qn=(0,L.A)(I().mark(function e(t){var n,r,a=arguments;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:400,r=a.length>2&&void 0!==a[2]?a[2]:400,e.abrupt("return",new(W())(function(e){var a=document.createElement("canvas"),i=a.getContext("2d"),c=new Image;a.width=n,a.height=r,i.fillStyle="#ffffff",i.fillRect(0,0,n,r),c.onload=function(){var t=.9*Math.min(n/this.width,r/this.height),o=this.width*t,s=this.height*t,l=(n-o)/2,u=(r-s)/2;i.drawImage(c,l,u,o,s),e(a.toDataURL("image/png",.9))},c.onerror=function(){i.fillStyle="#f0f0f0",i.fillRect(50,50,n-100,r-100),i.fillStyle="#666",i.font="20px Arial",i.textAlign="center",i.fillText("SVG预览",n/2,r/2),e(a.toDataURL("image/png",.9))};var o=new Blob([t],{type:"image/svg+xml"});c.src=he().createObjectURL(o)}));case 1:case"end":return e.stop()}},e)})),Qn.apply(this,arguments)}function $n(){return Jn.apply(this,arguments)}function Jn(){return(Jn=(0,L.A)(I().mark(function e(){var t,n,r,a,i,c,o,s,l,u,d,f,p,h,v;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.auth.getUser();case 1:if(t=e.sent,n=t.data.user){e.next=2;break}return alert("请先登录"),e.abrupt("return");case 2:if(dn&&0!==dn.children.length){e.next=3;break}return alert("请先绘制一些内容！"),e.abrupt("return");case 3:return r=(new XMLSerializer).serializeToString(dn),e.next=4,Vn(r);case 4:return a=e.sent,i=null,e.prev=5,o=new Blob([r],{type:"image/svg+xml"}),s=me()(),l=D()(c="".concat(n.id,"/gallery/")).call(c,s,"_artwork.svg"),e.next=6,supabase.storage.from("design-files").upload(l,o,{contentType:"image/svg+xml",cacheControl:"3600",upsert:!0});case 6:u=e.sent,u.data,u.error||(d=supabase.storage.from("design-files").getPublicUrl(l),f=d.data.publicUrl,i=f),e.next=8;break;case 7:e.prev=7,e.catch(5);case 8:return p={user_id:n.id,title:prompt("Give your artwork a title:","My Doodle")||"Untitled",description:prompt("Add a description (optional):","")||"",preview_image:a,svg_url:i,svg_data:r},e.next=9,supabase.from("gallery").insert(p).select();case 9:h=e.sent,h.data,(v=h.error)?alert("添加失败："+v.message):(alert("Successfully added to gallery!"),Fn(),confirm("View in gallery now?")&&("function"==typeof loadPage?loadPage("gallery"):window.location.href="/gallery")),e.next=11;break;case 10:e.prev=10,e.catch(0),alert("添加失败，请重试");case 11:case"end":return e.stop()}},e,null,[[0,10],[5,7]])}))).apply(this,arguments)}window.__svgModalHandlerBound||(window.__svgModalHandlerBound=!0,document.addEventListener("mousedown",function(e){"saveSvgModal"===e.target.id&&(e.preventDefault(),Fn())},!0),document.addEventListener("click",function(e){"saveSvgModal"===e.target.id&&(e.preventDefault(),e.stopPropagation(),Fn())},!0));var Kn=!1;function Zn(){return er.apply(this,arguments)}function er(){return(er=(0,L.A)(I().mark(function e(){var t,n,r,a,i,c,o,s,l,u,d,f,p,h,v,m;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!Kn){e.next=1;break}return e.abrupt("return");case 1:if(dn&&0!==dn.children.length){e.next=2;break}return mr("Draw something first！","error"),e.abrupt("return");case 2:if(Kn=!0,e.prev=3,i=dn.cloneNode(!0),0!==(c=i.querySelectorAll("path")).length){e.next=4;break}return mr("没有找到绘图内容！","error"),Kn=!1,e.abrupt("return");case 4:if(o=1/0,s=1/0,l=-1/0,u=-1/0,d=!1,U()(c).call(c,function(e){var t=e.getAttribute("d");if(t&&""!==ae()(t).call(t)){var n=tr(t);n.length>0&&(U()(n).call(n,function(e){o=Math.min(o,e.x),s=Math.min(s,e.y),l=Math.max(l,e.x),u=Math.max(u,e.y)}),d=!0)}}),d&&o!==1/0){e.next=5;break}return mr("没有找到有效的绘图内容！","error"),Kn=!1,e.abrupt("return");case 5:return f=l-o,p=u-s,h=Math.max(.1*Math.max(f,p),20),i.setAttribute("viewBox",D()(t=D()(n=D()(r="".concat(o-h," ")).call(r,s-h," ")).call(n,f+2*h," ")).call(t,p+2*h)),i.setAttribute("width","300"),i.setAttribute("height","300"),i.setAttribute("xmlns","http://www.w3.org/2000/svg"),U()(a=i.querySelectorAll("path")).call(a,function(e){e.getAttribute("stroke")||e.setAttribute("stroke","black"),e.getAttribute("stroke-width")||e.setAttribute("stroke-width","2"),e.getAttribute("fill")||e.setAttribute("fill","none")}),v=(new XMLSerializer).serializeToString(i),m="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(v))),e.next=6,gr(m);case 6:e.next=8;break;case 7:e.prev=7,mr("传输失败："+e.catch(3).message,"error");case 8:return e.prev=8,V()(function(){Kn=!1},500),e.finish(8);case 9:case"end":return e.stop()}},e,null,[[3,7,8,9]])}))).apply(this,arguments)}function tr(e){var t=[],n=e.match(/-?\d+(?:\.\d+)?/g);if(n&&n.length>=2)for(var r=0;r<n.length-1;r+=2){var a=K()(n[r]),i=K()(n[r+1]);isNaN(a)||isNaN(i)||t.push({x:a,y:i})}return t}var nr="pending_param_",rr=["loadTshirtDraft","loadSvgDraft","fromGallery","loadSvgUrl","loadRemixData"];function ar(e){var t=nr+e,n=sessionStorage.getItem(t);return null!==n?(sessionStorage.removeItem(t),n):null}var ir=!1;function cr(){return or.apply(this,arguments)}function or(){return(or=(0,L.A)(I().mark(function e(){var t,n,r,a,i;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!ir){e.next=1;break}return e.abrupt("return");case 1:if(ir=!0,e.prev=2,!(t=ar("loadTshirtDraft"))){e.next=4;break}return e.next=3,Qt();case 3:return e.next=4,$t(t);case 4:if(n=ar("loadSvgDraft"),ar("fromGallery"),!n){e.next=6;break}return e.next=5,lr();case 5:return e.next=6,ur(n);case 6:if(!(r=ar("loadSvgUrl"))){e.next=13;break}return e.prev=7,e.next=8,lr();case 8:return e.next=9,fetch(decodeURIComponent(r));case 9:if((a=e.sent).ok){e.next=10;break}throw new Error("fetch failed: "+a.status);case 10:return e.next=11,a.text();case 11:vr(e.sent),mr("Remix loaded! Start editing!","success"),e.next=13;break;case 12:e.prev=12,e.catch(7);case 13:if("true"!==ar("loadRemixData")){e.next=15;break}if(!(i=sessionStorage.getItem("remixSvgData"))){e.next=15;break}return e.next=14,lr();case 14:vr(i),sessionStorage.removeItem("remixSvgData"),mr("Remix loaded! Start editing!","success");case 15:e.next=17;break;case 16:e.prev=16,e.catch(2);case 17:return e.prev=17,ir=!1,e.finish(17);case 18:case"end":return e.stop()}},e,null,[[2,16,17,18],[7,12]])}))).apply(this,arguments)}function sr(){return(sr=(0,L.A)(I().mark(function e(){var t;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=getAndClearUrlParam("loadSvgDraft"))){e.next=2;break}return e.next=1,lr();case 1:return e.next=2,ur(t);case 2:case"end":return e.stop()}},e)}))).apply(this,arguments)}function lr(){return new(W())(function(e){var t=function(){void 0!==dn&&dn?e():V()(t,100)};t()})}function ur(e){return dr.apply(this,arguments)}function dr(){return(dr=(0,L.A)(I().mark(function e(t){var n,r,a,i,c,o,s,l;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,supabase.from("drafts").select("*").eq("id",t).single();case 1:if(a=e.sent,i=a.data,!a.error&&i){e.next=2;break}return alert("获取草稿失败"),e.abrupt("return");case 2:if(c=null,null===(n=i.data)||void 0===n||!n.storageUrl){e.next=4;break}return e.next=3,fr(i.data.storageUrl);case 3:c=e.sent,e.next=5;break;case 4:null!==(r=i.data)&&void 0!==r&&r.svgContent&&(c=i.data.svgContent);case 5:if(c){e.next=6;break}return alert("无法恢复SVG文件"),e.abrupt("return");case 6:dn&&(dn.innerHTML="",o=new DOMParser,s=o.parseFromString(c,"image/svg+xml"),l=s.querySelectorAll("path"),U()(l).call(l,function(e){var t=e.cloneNode(!0);dn.appendChild(t)}),Hn(),mr("The draft has been loaded!","success")),e.next=8;break;case 7:e.prev=7,e.catch(0),alert("恢复失败，请重试");case 8:case"end":return e.stop()}},e,null,[[0,7]])}))).apply(this,arguments)}function fr(e){return pr.apply(this,arguments)}function pr(){return(pr=(0,L.A)(I().mark(function e(t){var n,r;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,fetch(t);case 1:if((n=e.sent).ok){e.next=2;break}throw new Error("获取SVG失败");case 2:return e.next=3,n.text();case 3:return r=e.sent,e.abrupt("return",r);case 4:return e.prev=4,e.catch(0),e.abrupt("return",null);case 5:case"end":return e.stop()}},e,null,[[0,4]])}))).apply(this,arguments)}function hr(){return(hr=(0,L.A)(I().mark(function e(){var t,n,r,a,i;return I().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=getAndClearUrlParam("loadSvgDraft"),n="true"===getAndClearUrlParam("fromGallery"),!t||!n){e.next=1;break}return e.abrupt("return");case 1:if(!(r=getAndClearUrlParam("loadSvgUrl"))){e.next=8;break}return e.prev=2,e.next=3,lr();case 3:return e.next=4,fetch(decodeURIComponent(r));case 4:if((a=e.sent).ok){e.next=5;break}throw new Error("无法获取SVG文件");case 5:return e.next=6,a.text();case 6:vr(e.sent),mr("Remix loaded! Start editing!","success"),e.next=8;break;case 7:e.prev=7,e.catch(2),alert("无法加载Remix内容");case 8:if("true"!==getAndClearUrlParam("loadRemixData")){e.next=10;break}if(!(i=sessionStorage.getItem("remixSvgData"))){e.next=10;break}return e.next=9,lr();case 9:vr(i),mr("Remix loaded! Start editing!","success");case 10:case"end":return e.stop()}},e,null,[[2,7]])}))).apply(this,arguments)}function vr(e){if(dn){dn.innerHTML="";try{var t=(new DOMParser).parseFromString(e,"image/svg+xml");if(t.querySelector("parsererror"))return void alert("SVG文件格式错误");var n=t.querySelectorAll("path");if(0===n.length){var r=t.querySelectorAll("circle, rect, line, polyline, polygon, ellipse, path, text, g");U()(r).call(r,function(e){var t=e.cloneNode(!0);dn.appendChild(t)})}else U()(n).call(n,function(e){var t=e.cloneNode(!0);dn.appendChild(t)});Hn()}catch(e){alert("加载失败："+e.message)}}}function mr(e){var t=document.createElement("div");t.textContent=e;t.style.cssText="\n        position: fixed;\n        top: 0px;\n        right: 0px;\n        background: black;\n        color: white;\n        z-index: 9999;\n        font-size: 20px;\n        animation: slideIn 0.3s ease-out;\n    ";var n=document.createElement("style");n.textContent="\n        @keyframes slideIn {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n        }\n    ",document.head.querySelector("style[data-notification]")||(n.setAttribute("data-notification","true"),document.head.appendChild(n)),document.body.appendChild(t),V()(function(){document.body.contains(t)&&(t.style.animation="slideIn 0.3s ease-out reverse",V()(function(){document.body.contains(t)&&document.body.removeChild(t)},300))},3e3)}function gr(e){var t=null;if((t=document.getElementById("tshirtContainer"))||(t=document.getElementById("uploadedImagesContainer")),t||void 0===He||(t=He),t){var n=document.createElement("img");return n.className="uploaded-image svg-drawing",n.src=e,new(W())(function(e,r){n.onload=function(){try{var a=.4*t.offsetWidth,i=(t.offsetHeight,this.naturalWidth/this.naturalHeight);n.style.width=a+"px",n.style.height=a/i+"px",n.style.left=(t.offsetWidth-a)/2+"px",n.style.top="80px",n.style.position="absolute",n.dataset.aspectRatio=i,t.appendChild(n),void 0!==Be&&ee()(Be)||(window.uploadedImages=[]),Be.push(n),Mt(n),V()(function(){if(Rt(n),Fe(),void 0!==We&&void 0!==Ce){var r=A()(t.querySelectorAll(".uploaded-image"));We[Ce]=M()(r).call(r,function(e){return{src:e.src,className:e.className,style:{width:e.style.width,height:e.style.height,left:e.style.left,top:e.style.top},dataset:{aspectRatio:e.dataset.aspectRatio},isMemberCode:e.classList.contains("member-code-image")}})}e(n)},100)}catch(e){r(e)}},n.onerror=function(){alert("图片加载失败，请重试"),r(new Error("Failed to load image"))}})}alert("T恤设计区域未找到，请确保右侧面板已加载")}!function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:rr;try{var t=new(he())(window.location.href),n=t.searchParams,r=!1;if(U()(e).call(e,function(e){if(n.has(e)){var t=n.get(e);sessionStorage.setItem(nr+e,t),n.delete(e),r=!0}}),r){var a=t.pathname+(n.toString()?"?"+n.toString():"");window.history.replaceState({},document.title,a)}}catch(e){}}(),document.addEventListener("DOMContentLoaded",function(){cr()}),window.addEventListener("popstate",function(){V()(function(){return cr()},20)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Bn):Bn(),window.addEventListener("resize",function(){dn&&Cn()})}},n={};function r(e){var a=n[e];if(void 0!==a)return a.exports;var i=n[e]={exports:{}};return t[e].call(i.exports,i,i.exports,r),i.exports}r.m=t,e=[],r.O=(t,n,a,i)=>{if(!n){var c=1/0;for(u=0;u<e.length;u++){for(var[n,a,i]=e[u],o=!0,s=0;s<n.length;s++)(!1&i||c>=i)&&Object.keys(r.O).every(e=>r.O[e](n[s]))?n.splice(s--,1):(o=!1,i<c&&(c=i));if(o){e.splice(u--,1);var l=a();void 0!==l&&(t=l)}}return t}i=i||0;for(var u=e.length;u>0&&e[u-1][2]>i;u--)e[u]=e[u-1];e[u]=[n,a,i]},r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.j=390,(()=>{var e={390:0};r.O.j=t=>0===e[t];var t=(t,n)=>{var a,i,[c,o,s]=n,l=0;if(c.some(t=>0!==e[t])){for(a in o)r.o(o,a)&&(r.m[a]=o[a]);if(s)var u=s(r)}for(t&&t(n);l<c.length;l++)i=c[l],r.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return r.O(u)},n=self.webpackChunk=self.webpackChunk||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var a=r.O(void 0,[96],()=>r(45828));a=r.O(a)})();