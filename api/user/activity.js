import{Redis}from"@upstash/redis";const redis=new Redis({url:process.env.UPSTASH_REDIS_URL,token:process.env.UPSTASH_REDIS_TOKEN}),RATE_LIMIT_WINDOW=6e4,MAX_REQUESTS_PER_WINDOW=10;export default async function handler(e,r){if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});if(e.headers["x-api-key"]!==process.env.API_KEY&&"production"===process.env.NODE_ENV)return r.status(401).json({error:"Unauthorized"});try{const{userId:s}=e.body;if(!s||"string"!=typeof s)return r.status(400).json({error:"Valid userId is required"});const t=`rate_limit:${s}`,n=await redis.incr(t);if(1===n&&await redis.expire(t,60),n>10)return r.status(429).json({error:"Too many requests"});const o=Date.now(),i=`user:${s}`,a=redis.pipeline();a.zadd("user_activity_timeline",o,s),a.hset(i,{lastActive:o,userAgent:e.headers["user-agent"]||"unknown",ip:e.headers["x-forwarded-for"]||e.socket.remoteAddress||"unknown"}),a.expire(i,86400);const u=(new Date).toISOString().split("T")[0];return a.sadd(`active_users:${u}`,s),a.expire(`active_users:${u}`,172800),await a.exec(),r.status(200).json({success:!0,timestamp:o,userId:s.slice(0,8)+"..."})}catch(e){return r.status(500).json({error:"Internal server error",message:e.message})}}