import{Redis}from"@upstash/redis";import{createClient}from"@supabase/supabase-js";const redis=new Redis({url:process.env.UPSTASH_REDIS_URL,token:process.env.UPSTASH_REDIS_TOKEN}),supabaseAdmin=createClient(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});function verifyCronRequest(e){const s=e.headers["x-vercel-cron-secret"],t=process.env.CRON_SECRET;return"production"!==process.env.NODE_ENV||s===t}export default async function handler(e,s){if(!verifyCronRequest(e))return s.status(403).json({error:"Forbidden"});const t=Date.now();try{const e=Date.now()-18e5,r=await redis.zrangebyscore("user_activity_timeline",e,"+inf");if(0===r.length)return s.json({success:!0,message:"没有活跃用户需要刷新",refreshed:0,duration:Date.now()-t});const a=10;let n=0,i=0;for(let e=0;e<r.length;e+=a){const s=r.slice(e,e+a).map(async e=>{try{const{error:s}=await supabaseAdmin.auth.admin.updateUserById(e,{user_metadata:{last_keepalive:(new Date).toISOString(),keepalive_count:await redis.incr(`keepalive:${e}`)}});return s&&await supabaseAdmin.auth.admin.getUserById(e),n++,await redis.zadd("user_keepalive_success",Date.now(),e),{userId:e,success:!0}}catch(s){return i++,await redis.hset(`error:${e}`,{timestamp:Date.now(),error:s.message,type:"keepalive_failed"}),await redis.expire(`error:${e}`,3600),{userId:e,success:!1,error:s.message}}});await Promise.allSettled(s);e+a<r.length&&await new Promise(e=>setTimeout(e,1e3))}const o=Date.now()-864e5,c=await redis.zrangebyscore("user_activity_timeline",0,o);c.length>0&&await redis.zrem("user_activity_timeline",...c);const u=Date.now()-t;return s.status(200).json({success:!0,stats:{total_users:r.length,refreshed:n,failed:i,cleaned:c.length,duration_ms:u},timestamp:(new Date).toISOString()})}catch(e){return s.status(500).json({success:!1,error:e.message,timestamp:(new Date).toISOString()})}}