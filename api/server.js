const express=require("express"),http=require("http"),socketIO=require("socket.io"),{sql}=require("@vercel/postgres"),jwt=require("jsonwebtoken"),bcrypt=require("bcrypt"),cors=require("cors"),app=express(),server=http.createServer(app),io=socketIO(server,{cors:{origin:"*"}}),JWT_SECRET=process.env.JWT_SECRET||"your-secret-key-change-in-production";app.use(express.json()),app.use(cors()),app.post("/api/auth/register",async(s,e)=>{try{const{email:r,password:t,username:a}=s.body;if((await(sql`SELECT id FROM users WHERE email = ${r}`)).rows.length>0)return e.status(400).json({error:"用户已存在"});const o=await bcrypt.hash(t,10),n=(await(sql`
      INSERT INTO users (email, password, username)
      VALUES (${r}, ${o}, ${a})
      RETURNING id, email, username
    `)).rows[0],i=jwt.sign({userId:n.id},JWT_SECRET,{expiresIn:"7d"});e.json({token:i,user:n})}catch(s){e.status(500).json({error:s.message})}}),app.post("/api/auth/login",async(s,e)=>{try{const{email:r,password:t}=s.body,a=await(sql`SELECT id, password, username, email FROM users WHERE email = ${r}`);if(0===a.rows.length)return e.status(401).json({error:"用户不存在"});const o=a.rows[0];if(!await bcrypt.compare(t,o.password))return e.status(401).json({error:"密码错误"});const n=jwt.sign({userId:o.id},JWT_SECRET,{expiresIn:"7d"});e.json({token:n,user:{id:o.id,email:o.email,username:o.username}})}catch(s){e.status(500).json({error:s.message})}});const verifyToken=s=>{try{return jwt.verify(s,JWT_SECRET)}catch{return null}};app.get("/api/data/:table",async(s,e)=>{try{const{table:r}=s.params,t=await sql.query(`SELECT * FROM ${r}`);e.json(t.rows)}catch(s){e.status(500).json({error:s.message})}}),app.post("/api/data/:table",async(s,e)=>{try{const{table:r}=s.params,t=s.body,a=Object.keys(t),o=Object.values(t),n=a.map((s,e)=>`$${e+1}`).join(", "),i=await sql.query(`INSERT INTO ${r} (${a.join(", ")}) VALUES (${n}) RETURNING *`,o);io.emit(`${r}:insert`,i.rows[0]),e.json(i.rows[0])}catch(s){e.status(500).json({error:s.message})}}),app.put("/api/data/:table/:id",async(s,e)=>{try{const{table:r,id:t}=s.params,a=s.body,o=Object.keys(a),n=[...Object.values(a),t],i=o.map((s,e)=>`${s} = $${e+1}`).join(", "),c=await sql.query(`UPDATE ${r} SET ${i} WHERE id = $${o.length+1} RETURNING *`,n);io.emit(`${r}:update`,c.rows[0]),e.json(c.rows[0])}catch(s){e.status(500).json({error:s.message})}}),app.delete("/api/data/:table/:id",async(s,e)=>{try{const{table:r,id:t}=s.params;await sql.query(`DELETE FROM ${r} WHERE id = $1`,[t]),io.emit(`${r}:delete`,{id:t}),e.json({success:!0})}catch(s){e.status(500).json({error:s.message})}}),io.on("connection",s=>{s.on("subscribe",e=>{s.join(e)}),s.on("unsubscribe",e=>{s.leave(e)}),s.on("disconnect",()=>{})});const PORT=process.env.PORT||3001;server.listen(PORT,()=>{});