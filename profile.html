<head><link href="/css/styles.32f7ce7181a41c5d792b.css" rel="stylesheet"></head><style data-page="profile">* {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: Arial, sans-serif;
        height: 100vh;
        overflow: hidden;
    }

    .container {
        display: flex;
        height: 90vh;
        overflow: hidden;
    }

    .left-panel {
        flex: 0 0 calc(25% + 29px);
        padding-right: 20px;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
    }

    .right-panel {
        flex: 0 0 calc(75% - 29px);
        border: 2px black solid;
        padding: 15px;
        overflow-y: auto;
        box-sizing: border-box;
        height: 90vh;
      




    }

    .menu-item {
        border: 2px solid black;
        margin-bottom: 10px;
        cursor: pointer;


        text-align: center;
    }



    .menu-item.active {
        background-color: black;
        color: white;
    }

    .content-section {
        display: none;

    }

    .content-section.active {
        display: block;
    }

    .content-section h2 {
        margin-bottom: 20px;
        color: #333;
    }

    .content-section p {
        line-height: 1.5;
        color: black;
        margin-bottom: 10px;
    }

    .draft-item button:hover {
        background-color: black !important;
        color: white !important;
        cursor: pointer;
    }

    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }

    .gallery-item {
        height: 120px;
        background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: #666;
    }

    .member-info {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
    }

    .draft-item {
        background: white;
        padding: 10px;
        border: 2px solid black;
        margin-bottom: 15px;
    }

    .order-item {
        background: #d4edda;
        padding: 12px;
        border-left: 4px solid #28a745;
        margin-bottom: 10px;
    }

    .setting-item {
        background: #f8f9fa;
        padding: 15px;
        border: 1px solid #dee2e6;
        margin-bottom: 10px;
    }

    .member-code-container {

        text-align: center;
        font-size: 16px;
    }

    #member-barcode-complete {
        width: 100%;
        /* 宽度占满容器 */
        height: auto;
        /* 高度自适应 */
        max-width: 100%;
        /* 确保不超出容器 */
        object-fit: contain;
        /* 保持宽高比 */
        display: block;

    }

    .modal-buttons button:hover {
        background-color: black !important;
        color: white !important;
        cursor: pointer;
    }

    /* 响应式设计 */
    @media(max-width:899px) {
        .left-panel {
            flex: 0 0 50%;
            padding-right: 20px;
        }

        .right-panel {
            flex: 0 0 50%;
            border: 2px black solid;
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
            height: 100%;
        }

        #member-barcode-complete {
            width: 100%;
            height: auto;
        }

        .draft-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .draft-item>div {
            display: flex;
            flex-direction: column;
        }

        .draft-item>div>div:last-child {
            display: flex;
            flex-direction: row;
            justify-content: flex-end;
            margin-top: 10px;
        }
    }</style><div class="container"><div class="left-panel"><div class="menu-item" data-target="draft">DRAFT</div><div class="menu-item" data-target="order">ORDER</div><div class="menu-item" data-target="setting">SETTING</div><div class="menu-item">YOUR MEMBER CODE</div><div class="member-code-container"><img id="member-barcode-complete" alt="Member Code and Barcode" style="display: none;"></div></div><div class="right-panel"><div class="content-section" id="draft"></div><div class="content-section" id="order"></div><div class="content-section" id="setting"></div></div></div><script>// 菜单切换功能
    const menuItems = document.querySelectorAll('.menu-item');
    const contentSections = document.querySelectorAll('.content-section');


    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('menu-item')) {
            const target = e.target.getAttribute('data-target');
            if (!target) return;

            // 移除所有菜单项的active类
            document.querySelectorAll('.menu-item').forEach(menu => menu.classList.remove('active'));

            // 添加当前点击项的active类
            e.target.classList.add('active');

            // 隐藏所有内容区域
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

            // 显示对应的内容区域
            const targetSection = document.getElementById(target);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // 特殊处理
            if (target === 'draft') {
                loadDrafts();
            }
        }



        // 页面加载完成后，自动尝试显示条形码
        setTimeout(async () => {
            if (typeof window.displayUserProfile === 'function') {
                await window.displayUserProfile();
            } else {
                console.log('displayUserProfile函数不可用，等待加载...');
                // 如果函数还没加载，等待一段时间后再试
                setTimeout(async () => {
                    if (typeof window.displayUserProfile === 'function') {
                        await window.displayUserProfile();
                    }
                }, 1000);
            }
        }, 200);
    });

    // 全局暴露displayUserProfile函数，确保可以被调用
    if (typeof window !== 'undefined') {
        window.displayUserProfile = displayUserProfile;
    }

    // 添加一个专门的条形码重新加载函数
    window.reloadProfileBarcode = async function () {
        try {
            await displayUserProfile();
        } catch (error) {
            console.error('重新加载条形码失败:', error);
        }
    };

    // 监听页面切换事件，确保profile页面显示时重新加载条形码
    window.addEventListener('profilePageLoaded', async function () {
        await displayUserProfile();
    });


    // 在profile页面script中添加
    async function loadDrafts() {
        try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;

            const { data: drafts, error } = await supabase
                .from('drafts')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('加载草稿失败:', error);
                return;
            }

            displayDrafts(drafts);
        } catch (error) {
            console.error('加载草稿失败:', error);
        }
    }

    function displayDrafts(drafts) {
    const draftSection = document.getElementById('draft');
    if (!draftSection) return;

  

    const draftHTML = drafts.map(draft => {
        // 根据类型选择预览图片
        let previewImage = '';
        if (draft.type === 'svg') {
            previewImage = draft.front_preview_image;
        } else if (draft.type === 'tshirt') {
            previewImage = draft.front_preview_image; // 使用正面预览图
        }
        
        return `
        <div class="draft-item" data-id="${draft.id}">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img src="${previewImage}" alt="预览" 
                     style="width: 80px; height: 80px; object-fit: cover; border: 2px solid black;">
                <div style="flex: 1;">
                    <p>${draft.type === 'svg' ? 'DOODLE' : 'T-SHIRT'}</p>
                    <p>CREATED: ${new Date(draft.created_at).toLocaleString()}</p>
                </div>
                <div>
                    <button class="load-draft-btn" data-draft-id="${draft.id}" style="margin-right: 10px; border: 2px solid black; background:white; width:100px;font-size: 15px">LOAD</button>
                    <button class="delete-draft-btn" data-draft-id="${draft.id}" style="color: black;border: 2px solid black; background:white; width:100px; font-size: 15px">DELETE</button>
                </div>
            </div>
        </div>
        `;
    }).join('');

    draftSection.innerHTML = draftHTML;
}


async function deleteDraft(draftId) {
    if (!confirm('确定要删除这个草稿吗？')) return;

    try {
        // 先获取草稿信息，以便删除相关文件
        const { data: draft, error: fetchError } = await supabase
            .from('drafts')
            .select('*')
            .eq('id', draftId)
            .single();

        if (fetchError) {
            console.error('获取草稿信息失败:', fetchError);
            alert('删除失败');
            return;
        }

        // 删除Storage中的文件
        if (draft.type === 'tshirt' && draft.data) {
            const designData = draft.data;
            const filesToDelete = [];
            
            // 收集所有需要删除的文件
            if (designData.frontImages) {
                designData.frontImages.forEach(img => {
                    if (img.storageFile && img.storageFile.fileName) {
                        filesToDelete.push(img.storageFile.fileName);
                    }
                });
            }
            
            if (designData.backImages) {
                designData.backImages.forEach(img => {
                    if (img.storageFile && img.storageFile.fileName) {
                        filesToDelete.push(img.storageFile.fileName);
                    }
                });
            }
            
            // 批量删除文件
            if (filesToDelete.length > 0) {
                const { error: storageError } = await supabase.storage
                    .from('design-files')
                    .remove(filesToDelete);
                
                if (storageError) {
                    console.error('删除Storage文件失败:', storageError);
                    // 继续执行，不阻止数据库记录的删除
                }
            }
        }

        // 删除数据库记录
        const { error: deleteError } = await supabase
            .from('drafts')
            .delete()
            .eq('id', draftId);

        if (deleteError) {
            console.error('删除失败:', deleteError);
            alert('删除失败');
        } else {
            alert('草稿已删除');
            loadDrafts(); // 重新加载列表
        }
    } catch (error) {
        console.error('删除失败:', error);
        alert('删除失败');
    }
}

async function loadDraft(draftId) {
    try {
        const { data: draft, error } = await supabase
            .from('drafts')
            .select('*')
            .eq('id', draftId)
            .single();

        if (error) {
            console.error('加载草稿失败:', error);
            return;
        }

        if (draft.type === 'svg') {
            // SVG类型直接跳转编辑
            showSvgPreviewModal(draft);
        } else if (draft.type === 'tshirt') {
            // T恤类型显示预览模态框
            showDraftPreviewModal(draft);
        }
    } catch (error) {
        console.error('加载草稿失败:', error);
    }
}
function showSvgPreviewModal(draft) {
    // 创建模态框HTML
    const modalHTML = `
        <div id="draftPreviewModal" class="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 10000; ">
            <div class="modal-content" style="background: white; padding: 25px; max-width: 70vh; max-height: 80vh; overflow-y: auto; border: 2px black solid;">
                <div class="preview-container" style="display: flex; gap: 30px; justify-content: center; margin-bottom: 20px;">
                    <div class="preview-item" style="text-align: center;">
                        <span style="font-size: 18px; margin-bottom: 10px; display: block;">PREVIEW</span>
                        <div class="preview-tshirt" style="width: 200px; height: 250px; border: 2px solid black; background-image: url('${draft.front_preview_image}'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto;"></div>
                    </div>
                </div>
              
                <div class="modal-buttons" style="display: flex; gap: 20px; justify-content: space-between;">
                    <button class="edit-draft" data-draft-id="${draft.id}" style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 150px;">BACK TO EDIT</button>
                    <button class="add-to-cart" data-draft-id="${draft.id}"  style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 150px;">ADD IN GALLERY</button>
                   
                </div>
            </div>
        </div>
    `;
    
    // 添加到页面
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // 点击背景关闭模态框
    const modal = document.getElementById('draftPreviewModal');
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeDraftPreviewModal();
        }
    });
}


function showDraftPreviewModal(draft) {
    // 创建模态框HTML
    const sizeQuantities = draft.data?.sizeQuantities || draft.sizes || {
        XS: 0,
        S: 0,
        M: 0,
        L: 0,
        XL: 0,
        '2XL': 0,
        '3XL': 0
    };
    const modalHTML = `
        <div id="draftPreviewModal" class="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 10000; ">
            <div class="modal-content" style="background: white; padding: 25px; max-width: 70vh; max-height: 80vh; overflow-y: auto; border: 2px black solid;">
                <div class="preview-container" style="display: flex; gap: 30px; justify-content: center; margin-bottom: 20px;">
                    <div class="preview-item" style="text-align: center;">
                        <span style="font-size: 18px; margin-bottom: 10px; display: block;">FRONT</span>
                        <div class="preview-tshirt" style="width: 200px; height: 250px; border: 2px solid black; background-image: url('${draft.front_preview_image}'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto;"></div>
                    </div>
                    <div class="preview-item" style="text-align: center;">
                        <span style="font-size: 18px; margin-bottom: 10px; display: block;">BACK</span>
                        <div class="preview-tshirt" style="width: 200px; height: 250px; border: 2px solid black; background-image: url('${draft.back_preview_image}'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto;"></div>
                    </div>
                </div>
                <div class="size-selection-horizontal" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 20px;">
                    <div class="size-option">
                        <label>XS</label>
                        <div class="quantity-control" style="display: flex; align-items: center; overflow: hidden;">
                            <input type="number" class="quantity-input" value="${sizeQuantities.XS || 0}" min="0" max="99" style="width: 45px; height: 30px; text-align: center; border: 2px solid black;">
                        </div>
                    </div>
                    <div class="size-option">
                        <label>S</label>
                        <div class="quantity-control" style="display: flex; align-items: center; overflow: hidden;">
                            <input type="number" class="quantity-input" value="${sizeQuantities.S || 0}" min="0" max="99" style="width: 45px; height: 30px; text-align: center; border: 2px solid black;">
                        </div>
                    </div>
                    <div class="size-option">
                        <label>M</label>
                        <div class="quantity-control" style="display: flex; align-items: center; overflow: hidden;">
                            <input type="number" class="quantity-input" value="${sizeQuantities.M || 0}" min="0" max="99" style="width: 45px; height: 30px; text-align: center; border: 2px solid black;">
                        </div>
                    </div>
                    <div class="size-option">
                        <label>L</label>
                        <div class="quantity-control" style="display: flex; align-items: center; overflow: hidden;">
                            <input type="number" class="quantity-input" value="${sizeQuantities.L || 0}" min="0" max="99" style="width: 45px; height: 30px; text-align: center; border: 2px solid black;">
                        </div>
                    </div>
                    <div class="size-option">
                        <label>XL</label>
                        <div class="quantity-control" style="display: flex; align-items: center; overflow: hidden;">
                            <input type="number" class="quantity-input" value="${sizeQuantities.XL || 0}" min="0" max="99" style="width: 45px; height: 30px; text-align: center; border: 2px solid black;">
                        </div>
                    </div>
                    <div class="size-option">
                        <label>2XL</label>
                        <div class="quantity-control" style="display: flex; align-items: center; overflow: hidden;">
                            <input type="number" class="quantity-input" value="${sizeQuantities['2XL'] || 0}" min="0" max="99" style="width: 45px; height: 30px; text-align: center; border: 2px solid black;">
                        </div>
                    </div>
                    <div class="size-option">
                        <label>3XL</label>
                        <div class="quantity-control" style="display: flex; align-items: center; overflow: hidden;">
                            <input type="number" class="quantity-input" value="${sizeQuantities['3XL'] || 0}" min="0" max="99" style="width: 45px; height: 30px; text-align: center; border: 2px solid black;">
                        </div>
                    </div>
                </div>
                <div class="modal-buttons" style="display: flex; gap: 20px; justify-content: space-between;">
                    <button class="edit-draft" data-draft-id="${draft.id}" style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 150px;">BACK TO EDIT</button>
                    <button class="add-to-cart" data-draft-id="${draft.id}"  style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 150px;">ADD IN CART</button>
                   
                </div>
            </div>
        </div>
    `;
    
    // 添加到页面
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // 点击背景关闭模态框
    const modal = document.getElementById('draftPreviewModal');
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeDraftPreviewModal();
        }
    });
}

function closeDraftPreviewModal() {
    const modal = document.getElementById('draftPreviewModal');
    if (modal) {
        modal.remove();
    }
}

function addToCart(draftId) {
    // 这里实现加入购物车的逻辑
    alert('加入购物车功能待实现');
    closeDraftPreviewModal();
}

function editDraft(draftId) {
    // 跳转到T恤设计页面并加载设计
    window.location.href = '/design?loadTshirtDraft=' + draftId;
}


document.addEventListener('click', function(e) {
    // 处理LOAD按钮点击
    if (e.target.classList.contains('load-draft-btn')) {
        const draftId = e.target.getAttribute('data-draft-id');
        loadDraft(draftId);
    }
    
    // 处理DELETE按钮点击
    if (e.target.classList.contains('delete-draft-btn')) {
        const draftId = e.target.getAttribute('data-draft-id');
        deleteDraft(draftId);
    }

    if (e.target.classList.contains('edit-draft')) {
        const draftId = e.target.getAttribute('data-draft-id');
        editDraft(draftId);
    }
   
    if (e.target.classList.contains('add-to-cart')) {
        const draftId = e.target.getAttribute('data-draft-id');
        addToCart(draftId);
    }
});</script><script defer="defer" src="/js/vendors.fda70625bb53e8e32f0a.js"></script><script defer="defer" src="/js/styles.7aae21adbc8ce89b8327.js"></script><script defer="defer" src="/js/828.b336c9b18929bdd43135.js"></script><script defer="defer" src="/js/global.4565c858c8cef3d5c5cf.js"></script>