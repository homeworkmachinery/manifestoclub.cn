<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><title>宣言俱乐部</title><link rel="icon" href="./images/000.ico" type="image/x-icon"><link rel="shortcut icon" href="./images/000.ico" type="image/x-icon"><script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script><script type="module">import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
        window.supabase = createClient(
            "https://zdahntyxdcmkmbgjtizc.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkYWhudHl4ZGNta21iZ2p0aXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNDM3MjMsImV4cCI6MjA2NDYxOTcyM30.ew3haBr1qN5lSKQ8LWBRqlqrWw99b_s954GGjrK4brc"
        );</script><style>/* @font-face {
        font-family: "Mono";
        font-style: normal;
        font-weight: 400;
        src: url(/_nuxt/fonts/supply_mono.5330c62.woff2) format("woff2")
    } */

        * {
            box-sizing: border-box;
            /* font-family: Unica77LLWeb-Regular, Helvetica Neue, Helvetica, Arial, Lucida Grande, sans-serif; */
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji;
        }

        html {
            margin: 0;
            padding: 0
        }

        html.lock {
            overflow: hidden
        }

        body {
            font-size: 18px;
            margin: 0;
            padding: 0;
        }


        a {
            -webkit-text-decoration: none;
            text-decoration: none
        }

        a,
        a:focus,
        a:visited {
            color: #010101
        }

        .languages span {
            margin-left: 10px;
            border: 2px black solid;
            box-sizing: border-box;

            font-size: 18px;

        }

        .languages {
            margin-top: -45px;
            position: absolute;
            right: 0;
            margin-left: 20px;
            margin-right: 20px;
        }



        @media(max-width:899px) {

            .languages span {
                margin-left: 10px;
                border: 2px black solid;
                box-sizing: border-box;

                font-size: 18px;

            }

            .languages {
                margin-top: -45px;
                position: absolute;
                right: 0;
                margin-left: 10px;
                margin-right: 10px;
            }

        }</style><link href="/css/styles.2b4c472ffabc86239714.css" rel="stylesheet"></head><body><header class="header"><div class="header__inner"><div class="header__logo"><div class="header__logo-inner"><a href="" data-page="home"><img src="./images/000.jpg" alt="ManifestoClub"></a></div></div><aside class="header__radio"><div class="radio"><div class="radio__upper"><div id="play" class="radio__play"><input type="checkbox" id="playpause" name="check"> <label for="playpause"></label></div><div class="radio__live"></div><div class="header__mob-toggle"><img src="./images/000.jpg"></div></div><div class="radio__lower"><span>PLAYLIST</span> <span>CHAT</span></div></div></aside><nav class="header__nav"><ul><li><a href="" class="">(CD/LP)</a></li><li><a href="" data-page="merch">MERCH</a></li><li><a href="">(Print)</a></li><li><a href="" data-page="event">Event</a></li><li><a href="" data-page="about">About</a></li><li><span id="login-trigger">Login</span></li></ul></nav></div><div class="mobile-nav" id="mobileNav"><nav class="header__nav--mobile"><ul><li><a href="" data-page="home">HOME</a></li><li><a href="" class="">(CD/LP)</a></li><li><a href="" data-page="merch">MERCH</a></li><li><a href="">(PRINT)</a></li><li><a href="" data-page="event">EVENT</a></li><li><a href="" data-page="gallery">GALLERY</a></li><li><a href="" data-page="about">ABOUT</a></li><li><span>LOGIN</span></li></ul></nav></div><div class="cart" data-page="cart" id="cartIcon" style="display: none;">CART(<span id="cartBadge">0</span>)</div></header><main class="main--banner"><section class="page" id="dynamic-content"></section></main><div class="languages"><span>EN</span><span>中</span></div><div id="auth-modal" class="auth-modal"><div class="auth-modal-container"><div class="auth-modal-header" style="display: block;"><div id="barcode-container"><svg id="barcode"></svg></div></div><div id="login-form"><div class="login-wrapper"><input type="email" id="login-email" class="auth-form-input" placeholder="EMAIL/MANIFESTO"><p id="login-error" class="error-message" style="display: none;"></p></div><div class="password-input-wrapper"><input type="password" id="login-password" class="auth-form-input" placeholder="PASSWORD"> <span class="forgot-password-link">Forgot password?</span></div><p class="auth-form-btn" id="login-button">LOGIN</p><p class="auth-form-toggle signup">NOT A MEMBER YET?<span> SIGN UP</span></p></div><div id="signup-form"><div class="manifesto-wrapper"><input type="manifesto" id="manifesto" class="auth-form-input" placeholder="MANIFESTO" maxlength="30"><div class="check-manifesto check-icon"></div><p id="manifesto-error" class="error-message" style="display: none;"></p></div><div class="email-wrapper"><input type="email" id="signup-email" class="auth-form-input" placeholder="EMAIL"><div class="check-email check-icon"></div><p id="email-error" class="error-message" style="display: none;"></p></div><div class="password-wrapper"><input type="password" id="signup-password" class="auth-form-input" placeholder="PASSWORD"><div class="check-password check-icon"></div><p id="password-error" class="error-message" style="display: none;"></p></div><p class="auth-form-btn" id="signup-button">SIGN UP</p><p class="auth-form-toggle signup">ALREADY A MEMBER? <span>LOGIN</span></p></div><div id="password-reset-form" style="display:none;"><div class="reset-wrapper"><input type="email" id="reset-email" class="auth-form-input" placeholder="EMAIL"><p id="reset-error" class="error-message" style="display: none;"></p></div><p class="auth-form-btn" id="reset-link">SEND RESET LINK</p><p class="auth-form-toggle login">BACK TO LOGIN</p></div><div id="update-password-form" style="display:none;"><input type="email" id="reset-email-display" class="auth-form-input" placeholder="EMAIL" readonly="readonly" onfocus="this.blur()" style="background-color: #f5f5f5; cursor: default;"><div class="reset-password-wrapper"><input type="password" id="new-password" class="auth-form-input" placeholder="NEW PASSWORD"><div class="check-new-password check-icon"></div><p id="update-password-error" class="error-message" style="display: none;"></p></div><div class="confirm-password-wrapper"><input type="password" class="auth-form-input" id="confirm-password" placeholder="CONFIRM PASSWORD"><div class="check-confirm-password check-icon"></div><p id="confirm-password-error" class="error-message" style="display: none;"></p></div><p class="auth-form-btn" id="update-password">UPDATE PASSWORD</p></div><div id="signup-success-form" style="display:none;"><p>Registration Successful!</p><p>Your member code:</p><span id="manifesto-code"></span><div id="barcode-container"><svg id="barcode-success"></svg></div><p>We've sent a verification email to <span id="success-email"></span></p><div class="success-actions"><p class="auth-form-toggle" id="verify-button">Verify Later</p><p class="auth-form-btn" id="resend-button">Resend Verification Email</p></div></div></div></div><script>document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('click', function (e) {
                const pageLink = e.target.closest('[data-page]');
                if (pageLink) {
                    e.preventDefault();
                    loadPage(pageLink.dataset.page);
                    return;
                }
            })
            loadPage('home');
        })

        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        function closeMobileMenu() {
            document.getElementById('mobileNav').style.display = 'none';
        }

        window.pageLoadManager = {
    loadingPages: new Set(),
    loadedPages: new Set(),
    pageStates: {},
    scriptRegistry: new Map(),
    
    // 检查页面是否正在加载
    isPageLoading(page) {
        return this.loadingPages.has(page);
    },
    
    // 标记页面开始加载
    startPageLoad(page) {
        this.loadingPages.add(page);
    },
    
    // 标记页面加载完成
    finishPageLoad(page) {
        this.loadingPages.delete(page);
        this.loadedPages.add(page);
    },
    
    // 重置页面状态
    resetPage(page) {
        this.loadingPages.delete(page);
        this.loadedPages.delete(page);
        delete this.pageStates[page];
    }
};

async function loadPage(page) {
    const content = document.getElementById("dynamic-content");
    if (!content) {
        console.error('Dynamic content container not found');
        return;
    }

    // 防止重复加载同一页面
    if (window.pageLoadManager.isPageLoading(page)) {
        console.log(`Page ${page} is already loading, skipping...`);
        return;
    }

    // 如果是同一页面且已完全加载，直接返回
    if (window.currentPage === page && 
        window.pageLoadManager.loadedPages.has(page) &&
        window[`pageInitialized_${page}`]) {
        console.log(`Page ${page} already loaded and initialized`);
        return;
    }

    try {
        // 标记开始加载
        window.pageLoadManager.startPageLoad(page);

        // 清理当前页面
        await performPageCleanup();

        content.classList.add("fade-out");

        // 获取HTML内容
        const html = await fetchPageHTML(page);
        
        // 解析HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // 处理样式
        await handlePageStyles(doc, page);

        // 更新页面内容
        const pageContent = doc.body.innerHTML || html;
        content.innerHTML = pageContent;

        // 记录当前页面
        window.currentPage = page;
        
        // 等待DOM稳定
        await waitForDOM();
        
        // 加载外部脚本
        await loadPageScript(`page-${page}.js`);
        
        // 处理内联脚本（新的安全方式）
        await handleInlineScriptsSafely(page, doc);

        // 标记页面初始化完成
        window[`pageInitialized_${page}`] = true;
        window.pageLoadManager.finishPageLoad(page);

        // 页面特定初始化
        await handlePageSpecificInit(page);

        console.log(`✅ Page ${page} loaded successfully`);

    } catch (error) {
        console.error(`❌ Failed to load page ${page}:`, error);
        content.innerHTML = `<div class="error-page">
            <h2>页面加载失败</h2>
            <p>错误信息: ${error.message}</p>
            <button onclick="loadPage('${page}')">重新加载</button>
        </div>`;
        
        // 清理加载状态
        window.pageLoadManager.resetPage(page);
    } finally {
        content.classList.remove("fade-out");
        closeMobileMenu();
    }
}

// 获取页面HTML
async function fetchPageHTML(page) {
    let htmlPath;
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        htmlPath = `/pages/${page}.html`;
    } else {
        htmlPath = `${page}.html`;
    }
    
    const response = await fetch(htmlPath);
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    return await response.text();
}

// 等待DOM稳定
function waitForDOM() {
    return new Promise(resolve => {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', resolve, { once: true });
        } else {
            // 额外等待一帧，确保DOM完全渲染
            requestAnimationFrame(() => {
                setTimeout(resolve, 50);
            });
        }
    });
}

// 安全处理内联脚本
async function handleInlineScriptsSafely(page, doc) {
    const scripts = doc.querySelectorAll('script');
    
    // 先收集所有脚本内容
    const scriptContents = Array.from(scripts).map((script, index) => ({
        index,
        src: script.src,
        content: script.textContent?.trim(),
        isInline: !script.src && script.textContent?.trim()
    })).filter(s => s.isInline);

    console.log(`Found ${scriptContents.length} inline scripts for page ${page}`);

    // 检查关键函数是否已存在，如果存在则跳过相关脚本
    const criticalFunctions = ['transferToTShirt', 'saveToDraft', 'initCanvasSection'];
    const existingFunctions = criticalFunctions.filter(fn => typeof window[fn] === 'function');
    
    if (existingFunctions.length > 0) {
        console.log(`Critical functions already exist: ${existingFunctions.join(', ')}`);
        console.log(`Skipping inline script execution for page ${page}`);
        return;
    }

    // 执行脚本（只在函数不存在时）
    for (const scriptInfo of scriptContents) {
        await executeScriptSafely(page, scriptInfo);
    }
}

// 安全执行单个脚本
async function executeScriptSafely(page, scriptInfo) {
    const scriptId = `${page}_script_${scriptInfo.index}`;
    
    // 检查是否已执行
    if (window.pageLoadManager.scriptRegistry.has(scriptId)) {
        console.log(`Script ${scriptId} already executed, skipping`);
        return;
    }

    try {
        console.log(`Executing script ${scriptId}`);
        
        // 创建安全的执行环境
        const safeExecutor = new Function('page', 'scriptId', `
            // 防止重复执行检查
            if (window.pageLoadManager && window.pageLoadManager.scriptRegistry.has('${scriptId}')) {
                console.log('Script already executed: ${scriptId}');
                return;
            }
            
            // DOM安全检查包装器
            const originalGetElementById = document.getElementById;
            document.getElementById = function(id) {
                const element = originalGetElementById.call(document, id);
                if (!element) {
                    console.warn('Element not found:', id);
                }
                return element;
            };
            
            // 执行原始脚本
            try {
                ${scriptInfo.content}
            } catch (error) {
                console.error('Script execution error:', error);
                throw error;
            } finally {
                // 恢复原始方法
                document.getElementById = originalGetElementById;
            }
        `);
        
        // 执行脚本
        safeExecutor(page, scriptId);
        
        // 标记为已执行
        window.pageLoadManager.scriptRegistry.set(scriptId, {
            page,
            executed: true,
            timestamp: Date.now()
        });
        
    } catch (error) {
        console.error(`Failed to execute script ${scriptId}:`, error);
        // 不要阻止页面加载，继续执行其他脚本
    }
}

// 处理页面样式
async function handlePageStyles(doc, page) {
    const styles = doc.querySelectorAll('style');
    
    // 移除其他页面的样式
    const existingStyles = document.querySelectorAll(`style[data-page]`);
    existingStyles.forEach(existing => {
        if (existing.getAttribute('data-page') !== page) {
            existing.remove();
        }
    });

    // 检查并添加当前页面样式
    const existingStyle = document.querySelector(`style[data-page="${page}"]`);
    if (existingStyle) {
        existingStyle.remove();
    }

    styles.forEach(styleEl => {
        const newStyle = document.createElement('style');
        newStyle.textContent = styleEl.textContent;
        newStyle.setAttribute('data-page', page);
        document.head.appendChild(newStyle);
    });
}

// 执行页面清理（重命名避免递归冲突）
async function performPageCleanup() {
    if (!window.currentPage) return;

    const currentPageName = window.currentPage;
    
    // 安全调用通用清理函数（如果存在且不是当前函数）
    if (typeof window.cleanupCurrentPage === 'function' && 
        window.cleanupCurrentPage !== performPageCleanup) {
        try {
            console.log('Calling external cleanup function');
            window.cleanupCurrentPage();
        } catch (error) {
            console.error('Error in external cleanup function:', error);
        }
    }

    // 调用页面特定清理函数
    const cleanupFunctions = {
        'merch': 'cleanupMerchPage',
        'content': 'cleanupContentPage', 
        'profile': 'cleanupProfilePage',
        'home': 'cleanupHomePage'
    };

    const cleanupFnName = cleanupFunctions[currentPageName];
    if (cleanupFnName && typeof window[cleanupFnName] === 'function') {
        console.log(`Cleaning up ${currentPageName} page`);
        try {
            window[cleanupFnName]();
        } catch (error) {
            console.error(`Error in cleanup function ${cleanupFnName}:`, error);
        }
    }

    // 清理页面脚本和状态
    cleanupPageScripts(currentPageName);
    
    // 重置页面管理器状态
    window.pageLoadManager.resetPage(currentPageName);
}

// 页面特定初始化
async function handlePageSpecificInit(page) {
    // 等待一帧确保DOM完全ready
    await new Promise(resolve => requestAnimationFrame(resolve));
    
    switch(page) {
        case 'profile':
            setTimeout(() => {
                if (document.getElementById('dynamic-content')) {
                    window.dispatchEvent(new CustomEvent('profilePageLoaded'));
                }
            }, 100);
            break;
            
        case 'gallery':
            setTimeout(() => {
                if (typeof initGallery === 'function') {
                    initGallery();
                } else {
                    console.log('等待Gallery初始化函数...');
                    const checkGallery = setInterval(() => {
                        if (typeof initGallery === 'function') {
                            clearInterval(checkGallery);
                            initGallery();
                        }
                    }, 100);
                    
                    // 10秒后停止检查
                    setTimeout(() => clearInterval(checkGallery), 10000);
                }
            }, 200);
            break;
            
        case 'home':
            // 确保content页面的关键元素存在
            const checkContentElements = setInterval(() => {
                const canvas = document.getElementById('canvas');
                const tshirtContainer = document.getElementById('tshirtContainer');
                
                if (canvas && tshirtContainer) {
                    clearInterval(checkContentElements);
                    console.log('Content page elements ready');
                }
            }, 100);
            
            setTimeout(() => clearInterval(checkContentElements), 5000);
            break;
    }
}

// 改进的脚本清理
function cleanupPageScripts(page) {
    if (!page) return;
    
    console.log(`🧹 Cleaning up scripts for page: ${page}`);
    
    // 移除页面脚本
    const pageScript = document.querySelector(`script[data-page-script="page-${page}.js"]`);
    if (pageScript) {
        pageScript.remove();
        console.log(`Removed page script: page-${page}.js`);
    }
    
    // 清理初始化状态
    delete window[`pageInitialized_${page}`];
    
    // 清理脚本注册表中相关记录
    if (window.pageLoadManager.scriptRegistry) {
        const scriptsToRemove = [];
        window.pageLoadManager.scriptRegistry.forEach((info, scriptId) => {
            if (info.page === page) {
                scriptsToRemove.push(scriptId);
            }
        });
        
        scriptsToRemove.forEach(scriptId => {
            window.pageLoadManager.scriptRegistry.delete(scriptId);
        });
        
        console.log(`Cleaned ${scriptsToRemove.length} script registry entries`);
    }
    
    // 清理页面特定状态
    if (page === 'home') {
        // 重置transfer相关状态
        window.isTransferring = false;
        window.transferLock = false;
        
        // 清理可能的重复定义的函数
        const criticalFunctions = ['transferToTShirt', 'saveToDraft', 'initCanvasSection'];
        criticalFunctions.forEach(fn => {
            if (typeof window[fn] === 'function') {
                console.log(`Keeping critical function: ${fn}`);
                // 不删除，但可以重置相关状态
            }
        });
    }
}

// 改进的外部脚本加载
function loadPageScript(jsFileName) {
    return new Promise((resolve) => {
        // 检查关键函数是否已存在
        if (jsFileName === 'page-content.js') {
            const criticalFunctions = ['transferToTShirt', 'saveToDraft'];
            const allExist = criticalFunctions.every(fn => typeof window[fn] === 'function');
            
            if (allExist) {
                console.log('All critical functions exist, skipping script reload');
                resolve();
                return;
            }
        }
        
        // 移除现有脚本
        const existingScript = document.querySelector(`script[data-page-script="${jsFileName}"]`);
        if (existingScript) {
            existingScript.remove();
        }

        const script = document.createElement('script');
        script.src = `/js/${jsFileName}`;
        script.setAttribute('data-page-script', jsFileName);
        
        script.onload = () => {
            console.log(`✅ Loaded external script: ${jsFileName}`);
            resolve();
        };
        
        script.onerror = () => {
            console.warn(`⚠️ Failed to load: ${jsFileName}`);
            resolve(); // 不阻止页面加载
        };
        
        document.body.appendChild(script);
    });
}

// 工具函数：检查DOM元素是否存在
function waitForElement(selector, timeout = 5000) {
    return new Promise((resolve, reject) => {
        const element = document.querySelector(selector);
        if (element) {
            resolve(element);
            return;
        }
        
        const observer = new MutationObserver((mutations) => {
            const element = document.querySelector(selector);
            if (element) {
                observer.disconnect();
                resolve(element);
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        setTimeout(() => {
            observer.disconnect();
            reject(new Error(`Element ${selector} not found within ${timeout}ms`));
        }, timeout);
    });
}</script><script defer="defer" src="/js/vendors.08ee64c9e60251b5d335.js"></script><script defer="defer" src="/js/styles.7aae21adbc8ce89b8327.js"></script><script defer="defer" src="/js/828.dbea81369c5124811a1a.js"></script><script defer="defer" src="/js/33.545769f2acdaaebe9ae3.js"></script><script defer="defer" src="/js/798.b0cf1e47f6c8f7e444c1.js"></script><script defer="defer" src="/js/global.9e411c2b11604bb8b1b6.js"></script></body></html>