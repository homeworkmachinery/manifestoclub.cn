<style data-page="design">* {
        padding: 0;
        margin: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* é¡¶éƒ¨å¯¼èˆª */
    .nav-header {
        border: 2px solid black;
        padding: 5px;
        margin-bottom: 20px;
        background-color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: calc(100% - 40px);
        position: fixed;
        z-index: 10;
        top: 100px;

    }

    .nav-header h1 {
        font-size: 24px;
    }

    .back-btn {
        color: black;
        text-decoration: none;
        cursor: pointer;
        font-size: 16px;
    }



    .books {
        margin-top: 62px;
        border-top: 2px solid black;
    }

    .book {
        border: 2px solid black;
        padding: 5px;
        border-top: none;
        display: flex;
        position: relative;

    }

    .book-img {
        flex: 0 0 100px;
    }

    .book-img img {
        width: 100%;
        height: auto;
        display: block;

    }

    .book-description {
        flex: 1;
        margin-left: 15px;
        display: flex;
        flex-direction: column;
    }



    .book-btn {
        display: flex;
        gap: 10px;
        position: absolute;
        bottom: 10px;
    }

    .book-btn>div {
        border: 2px solid black;
        cursor: pointer;

    }

    .book-btn>div:hover {
        background-color: black;
        color: white;
    }

    .book-btn .want.active {
        background-color: Black;
        color: white;

    }

    .book-btn .read.active {
        background-color: Black;
        color: white;

    }

    /* Modal æ ·å¼ */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background-color: white;
        border: 2px solid black;
        padding: 20px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid black;
    }

    .modal-header h2 {
        font-size: 20px;
    }

    .close-btn {
        cursor: pointer;
        font-size: 24px;
        border: none;
        background: none;
        padding: 0;
    }

    .note-form {
        margin-bottom: 20px;
    }

    .note-form textarea {
        width: 100%;
        min-height: 120px;
        padding: 10px;
        border: 2px solid black;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
    }

    .note-form button {
        margin-top: 10px;
        padding: 8px 20px;
        border: 2px solid black;
        background-color: white;
        cursor: pointer;
        font-size: 14px;
    }

    .note-form button:hover {
        background-color: black;
        color: white;
    }

    .notes-list {
        margin-top: 20px;
    }

    .note-item {
        border: 2px solid black;
        padding: 15px;
        margin-bottom: 10px;
        font-size: 14px;
    }

    .note-content {
        margin-bottom: 10px;
        line-height: 1.6;
        white-space: pre-wrap;
        font-size: 14px; 
    }

    .note-meta {
        font-size: 12px;
        color: #666;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .note-delete {
        cursor: pointer;

        font-size: 12px;
    }

    .note-delete:hover {
        text-decoration: underline;
    }
    .note-print:hover {
        text-decoration: underline;
    }
    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .empty-notes {
        text-align: center;
        padding: 40px;
        color: #999;
    }

    .note-form textarea:focus,
    .note-form input:focus {
        outline: none;
        border: 2px solid black;
    }


    /* åœ¨ .book æ ·å¼åæ·»åŠ  */
    .book-notes-area {
        display: none;
        border: 2px solid black;
        padding: 15px;
        border-top: none;
    }

    .book-notes-area.show {
        display: block;
    }

    .notes-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;


    }

    .nav-arrow {
        cursor: pointer;
        padding: 5px 15px;
        border: 2px solid black;
        background-color: white;
        font-size: 18px;
    }

    .nav-arrow:hover {
        background-color: black;
        color: white;
    }

    .nav-arrow.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }



    .current-note {
        padding: 15px;
        border: 2px solid black;
        background-color: white;
        min-height: 100px;
    }

    .current-note-content {
        margin-bottom: 10px;
        line-height: 1.6;
        white-space: pre-wrap;
 
    }

    .current-note-meta {
        font-size: 12px;
        color: #666;
    }

/* åœ¨CSSæœ«å°¾æ·»åŠ æ³¨è§£æ ·å¼ */


    @media(max-width:899px) {
        .nav-header {
            margin-top: -20px;
            width: calc(100% - 20px);
        }

        .books {
            margin-top: 54px;
        }

        .books {
            font-size: 16px;
        }

        .book-btn {
            display: flex;
            gap: 5px;
            position: absolute;
            bottom: 10px;
        }

        .book-description {
            flex: 1;
            margin-left: 10px;
            display: flex;
            flex-direction: column;
        }

    }</style><link href="/css/styles.ffe12bf25f15d90e6cb1.css" rel="stylesheet"><body><div class="container"><div class="nav-header"><h1>DESIGN</h1><a data-page="print" class="back-btn">â† BACK TO LIBRARY</a></div><div class="books" id="booksContainer"></div></div><div class="modal" id="noteModal"><div class="modal-content"><div class="modal-header"><h2 id="modalBookTitle">Book Notes</h2><button class="close-btn" onclick="closeNoteModal()">Ã—</button></div><div class="note-form"><div style="display: flex; gap: 10px; margin-bottom: 10px;"><input type="number" id="pageStart" placeholder="Start Page" style="width: 100px; padding: 5px; border: 2px solid black;" oninput="this.style.borderColor='black'"> <span style="line-height: 30px;">-</span> <input type="number" id="pageEnd" placeholder="End Page" style="width: 100px; padding: 5px; border: 2px solid black;"></div><textarea id="noteContent" placeholder="Write your note here..."></textarea> <button onclick="saveNote()">Add Note</button></div><div class="notes-list" id="notesList"><div class="loading">Loading notes...</div></div></div></div><script>(function () {
            let bookNotesCache = {};
            let currentNoteIndex = {};
            let currentUser = null;
            let currentBookId = null;
            let noteAnnotations = {};

            console.log('designé¡µé¢å¼€å§‹åŠ è½½');
            console.log('BOOKS_DATA çŠ¶æ€:', typeof window.BOOKS_DATA !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
            console.log('supabase çŠ¶æ€:', typeof supabase !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½');




            // æ–°å¢ï¼šåŠ¨æ€ç”Ÿæˆä¹¦ç±åˆ—è¡¨
            function renderBooks() {
                const booksContainer = document.getElementById('booksContainer');
                const designBooks = Object.values(window.BOOKS_DATA).filter(book => book.category === 'design');

                if (designBooks.length === 0) {
                    booksContainer.innerHTML = '<div class="empty-message">æš‚æ— æ³•å¾‹ç±»ä¹¦ç±</div>';
                    return;
                }

                booksContainer.innerHTML = designBooks.map(book => `
            <div class="book" data-book-id="${book.id}" data-book-title="${book.title}">
                <div class="book-img">
                    <img src="${book.imgSrc}" alt="${book.title}" onerror="this.src='/images/default-book.jpg'">
                </div>
                <div class="book-description">
                    <div class="book-title">${book.title}</div>
                    <div class="book-meta">
                        ${book.author}${book.translator ? ' / ' + book.translator : ''} / ${book.publisher} / ${book.publishDate}${book.pages ? ' / Pages: ' + book.pages : ''}
                    </div>
                </div>
            </div>
        `).join('');
            }

     async function waitForDependencies() {
  return new Promise((resolve) => {
    const checkDependencies = setInterval(() => {
      // ç­‰å¾… authManagerã€supabase å’Œ BOOKS_DATA
      if (window.authManager && window.supabase && window.BOOKS_DATA) {
        clearInterval(checkDependencies);
        console.log('âœ… æ‰€æœ‰ä¾èµ–é¡¹å·²åŠ è½½');
        resolve();
      }
    }, 100);
  });
}

            async function initdesign() {
                console.log('å¼€å§‹åˆå§‹åŒ–designé¡µé¢');

                // ç­‰å¾…ä¾èµ–é¡¹åŠ è½½
                await waitForDependencies();

                // æ¸²æŸ“ä¹¦ç±åˆ—è¡¨
                renderBooks();
initializeBookButtons();
  // å…³é”®ï¼šå¼ºåˆ¶æ¢å¤ Supabase session
  console.log('ğŸ”„ å¼ºåˆ¶æ¢å¤ Supabase session');
  if (window.restoreSupabaseSession) {
    await window.restoreSupabaseSession();
  }

                await checkUser();
               // åˆå§‹åŒ–ä¹¦ç±æŒ‰é’®å’Œç¬”è®°åŒºåŸŸ
                await updateBookCounts(); // æ›´æ–°è®¡æ•°

                // ========== æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ»šåŠ¨åˆ°ç‰¹å®šä¹¦ç± ==========
                const scrollToBookId = sessionStorage.getItem('scrollToBookId');
                const shouldOpenNotes = sessionStorage.getItem('openNotesArea');

                if (scrollToBookId) {
                    // æ¸…é™¤ sessionStorage
                    sessionStorage.removeItem('scrollToBookId');
                    sessionStorage.removeItem('openNotesArea');

                    // ç­‰å¾…é¡µé¢æ¸²æŸ“å®Œæˆ
                    setTimeout(async () => {
                        const bookElement = document.querySelector(`.book[data-book-id="${scrollToBookId}"]`);
                        if (bookElement) {
                            // æ»šåŠ¨åˆ°ä¹¦ç±ä½ç½®
                            bookElement.scrollIntoView({ behavior: 'smooth', block: 'center' });


                            // æ·»åŠ é«˜äº®æ•ˆæœ
                            bookElement.style.backgroundColor = 'black';
                            bookElement.style.color = 'white';
                            bookElement.style.borderColor = 'white'; // è¾¹æ¡†å˜ç™½

                            const innerElements = bookElement.querySelectorAll('*');
                            const bookBtnDivs = bookElement.querySelectorAll('.book-btn > div'); // ç‰¹åˆ«é€‰æ‹©æŒ‰é’®å…ƒç´ 

                            innerElements.forEach(el => {
                                el.style.color = 'white';
                            });

                            // ç‰¹åˆ«å¤„ç†æŒ‰é’®è¾¹æ¡†
                            bookBtnDivs.forEach(btn => {
                                btn.style.borderColor = 'white';
                            });

                            setTimeout(() => {
                                bookElement.style.backgroundColor = '';
                                bookElement.style.color = '';
                                bookElement.style.borderColor = ''; // æ¢å¤è¾¹æ¡†é¢œè‰²

                                // æ¢å¤å†…éƒ¨å…ƒç´ çš„é¢œè‰²
                                innerElements.forEach(el => {
                                    el.style.color = '';
                                });

                                // æ¢å¤æŒ‰é’®è¾¹æ¡†é¢œè‰²
                                bookBtnDivs.forEach(btn => {
                                    btn.style.borderColor = '';
                                });
                            }, 1500);

                            // å¦‚æœéœ€è¦æ‰“å¼€ç¬”è®°åŒºåŸŸ
                            if (shouldOpenNotes === 'true') {
                                const bookTitle = bookElement.dataset.bookTitle;
                                // å†ç­‰å¾…ä¸€ä¸‹ï¼Œç¡®ä¿æ»šåŠ¨å®Œæˆ
                                setTimeout(() => {
                                    toggleNotesArea(scrollToBookId, bookTitle);
                                }, 500);
                            }
                        }
                    }, 300);


                }
            }

            // æ–°å¢ï¼šåˆå§‹åŒ–ä¹¦ç±æŒ‰é’®å’Œç¬”è®°åŒºåŸŸ
            function initializeBookButtons() {
                const books = document.querySelectorAll('.book');

                books.forEach(book => {
                    const bookId = book.dataset.bookId;
                    const bookTitle = book.dataset.bookTitle;
                    const bookDescription = book.querySelector('.book-description');

                    if (book.querySelector('.book-btn')) {
                        return; // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡
                    }


                    // åˆ›å»ºæŒ‰é’®åŒºåŸŸ
                    const bookBtn = document.createElement('div');
                    bookBtn.className = 'book-btn';
                    bookBtn.innerHTML = `
            <div class="want" onclick="toggleWant('${bookId}')">
                WANT(<span class="want-count">0</span>)
            </div>
            <div class="read" onclick="toggleReading('${bookId}')">
                READ(<span class="read-count">0</span>)
            </div>
            <div class="note" onclick="toggleNotesArea('${bookId}', '${bookTitle}')">
                NOTES(<span class="note-count">0</span>)
            </div>
            <div class="add" onclick="openNoteModal('${bookId}', '${bookTitle}')">+</div>
        `;
                    bookDescription.appendChild(bookBtn);

                    // åˆ›å»ºç¬”è®°å±•å¼€åŒºåŸŸ
                    const notesArea = document.createElement('div');
                    notesArea.className = 'book-notes-area';
                    notesArea.id = `notes-area-${bookId}`;
                    notesArea.innerHTML = `
            <div class="notes-navigation">
                <div class="nav-arrow" onclick="prevNote('${bookId}')">â†</div>
                <div class="note-page-info">
                    <span id="current-note-index-${bookId}">0</span> / <span id="total-notes-${bookId}">0</span>
                </div>
                <div class="nav-arrow" onclick="nextNote('${bookId}')">â†’</div>
            </div>
            <div class="current-note" id="current-note-${bookId}">
                <div class="loading">Loading notes...</div>
            </div>
        `;
                    book.parentNode.insertBefore(notesArea, book.nextSibling);
                });
            }






            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        // ä¿®æ”¹åçš„ checkUser å‡½æ•°
async function checkUser() {
  console.log('ğŸ” æ£€æŸ¥ç”¨æˆ·çŠ¶æ€');
  
  // ç­‰å¾… authManager å’Œ Supabase åˆå§‹åŒ–
  if (!window.authManager || !window.supabase) {
    console.log('â³ ç­‰å¾…ä¾èµ–é¡¹åŠ è½½...');
    await waitForDependencies();
  }
  
  // ç¬¬ä¸€æ­¥ï¼šä¼˜å…ˆä» authManager è·å–
  if (window.authManager) {
    const authUser = window.authManager.getCurrentUser();
    const isAuthenticated = window.authManager.isAuthenticated();
    
    if (authUser && isAuthenticated) {
      console.log('âœ… ç”¨æˆ·å·²é€šè¿‡ AuthManager è®¤è¯:', authUser.email);
      
      // ç¡®ä¿ Supabase session å·²æ¢å¤
      if (window.restoreSupabaseSession) {
        console.log('ğŸ”„ åŒæ­¥ Supabase session');
        const restored = await window.restoreSupabaseSession();
        if (!restored) {
          console.warn('âš ï¸ Supabase session æ¢å¤å¤±è´¥ï¼Œä½†ç»§ç»­ä½¿ç”¨ AuthManager ç”¨æˆ·');
        }
      }
      
      currentUser = authUser;
      return currentUser;
    } else if (authUser && !isAuthenticated) {
      console.log('âš ï¸ ç”¨æˆ·å­˜åœ¨ä½† token å¯èƒ½è¿‡æœŸ');
      // å°è¯•åˆ·æ–°
      const refreshed = await window.authManager.refreshToken();
      if (refreshed) {
        console.log('ğŸ”„ Token åˆ·æ–°æˆåŠŸ');
        return await checkUser();
      } else {
        console.log('âŒ Token åˆ·æ–°å¤±è´¥ï¼Œæ¸…é™¤ç”¨æˆ·');
        window.authManager.logout();
        currentUser = null;
        return null;
      }
    }
  }
  
  // ç¬¬äºŒæ­¥ï¼šå¦‚æœ authManager æ²¡æœ‰ç”¨æˆ·ï¼Œæ£€æŸ¥ Supabase
  try {
    const { data: { user }, error } = await supabase.auth.getUser();
    
    if (error) {
      console.log('âŒ Supabase è·å–ç”¨æˆ·å¤±è´¥:', error.message);
      currentUser = null;
    } else if (user) {
      console.log('âœ… ä» Supabase è·å–åˆ°ç”¨æˆ·:', user.email);
      
      // å¦‚æœä» Supabase è·å–åˆ°ç”¨æˆ·ï¼ŒåŒæ­¥åˆ° authManager
      if (window.authManager && !window.authManager.user) {
        console.log('ğŸ”„ å°† Supabase ç”¨æˆ·åŒæ­¥åˆ° AuthManager');
        // è¿™é‡Œéœ€è¦è·å–å®Œæ•´çš„ session æ•°æ®
        const { data: sessionData } = await supabase.auth.getSession();
        if (sessionData.session) {
          window.authManager.onLoginSuccess({
            data: {
              user: user,
              session: sessionData.session
            }
          });
        }
      }
      
      currentUser = user;
    } else {
      console.log('ğŸ‘¤ ç”¨æˆ·æœªç™»å½•');
      currentUser = null;
    }
  } catch (error) {
    console.error('æ£€æŸ¥ç”¨æˆ·æ—¶å‡ºé”™:', error);
    currentUser = null;
  }
  
  return currentUser;
}

            async function updateBookCounts() {
                const books = document.querySelectorAll('.book');
                const bookIds = Array.from(books).map(book => book.dataset.bookId);

                try {
                    // è·å–æƒ³è¯»è®¡æ•°
                    const { data: wantCounts } = await supabase
                        .from('book_wants')
                        .select('book_id')
                        .in('book_id', bookIds);

                    const wantCountMap = {};
                    if (wantCounts) {
                        wantCounts.forEach(item => {
                            wantCountMap[item.book_id] = (wantCountMap[item.book_id] || 0) + 1;
                        });
                    }

                    // è·å–åœ¨è¯»è®¡æ•°
                    const { data: readingCounts } = await supabase
                        .from('book_readings')
                        .select('book_id')
                        .in('book_id', bookIds);

                    const readingCountMap = {};
                    if (readingCounts) {
                        readingCounts.forEach(item => {
                            readingCountMap[item.book_id] = (readingCountMap[item.book_id] || 0) + 1;
                        });
                    }

                    // è·å–ç¬”è®°è®¡æ•°
                    const { data: noteCounts } = await supabase
                        .from('book_notes')
                        .select('book_id')
                        .in('book_id', bookIds);

                    const noteCountMap = {};
                    if (noteCounts) {
                        noteCounts.forEach(item => {
                            noteCountMap[item.book_id] = (noteCountMap[item.book_id] || 0) + 1;
                        });
                    }

                    // è·å–ç”¨æˆ·çŠ¶æ€
                    let userWants = new Set();
                    let userReadings = new Set();

                    if (currentUser) {
                        const { data: wants } = await supabase
                            .from('book_wants')
                            .select('book_id')
                            .eq('user_id', currentUser.id)
                            .in('book_id', bookIds);

                        if (wants) {
                            wants.forEach(want => userWants.add(want.book_id));
                        }

                        const { data: readings } = await supabase
                            .from('book_readings')
                            .select('book_id')
                            .eq('user_id', currentUser.id)
                            .in('book_id', bookIds);

                        if (readings) {
                            readings.forEach(reading => userReadings.add(reading.book_id));
                        }
                    }

                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    books.forEach(book => {
                        const bookId = book.dataset.bookId;
                        const wantBtn = book.querySelector('.want');
                        const readBtn = book.querySelector('.read');

                        // æ›´æ–°è®¡æ•°
                        book.querySelector('.want-count').textContent = wantCountMap[bookId] || 0;
                        book.querySelector('.read-count').textContent = readingCountMap[bookId] || 0;
                        book.querySelector('.note-count').textContent = noteCountMap[bookId] || 0;

                        if (wantBtn && readBtn) {
                            // æ›´æ–°è®¡æ•°ï¼ˆæ— è®ºæ˜¯å¦ç™»å½•éƒ½æ›´æ–°ï¼‰
                            const wantCountEl = book.querySelector('.want-count');
                            const readCountEl = book.querySelector('.read-count');
                            const noteCountEl = book.querySelector('.note-count');

                            if (wantCountEl) wantCountEl.textContent = wantCountMap[bookId] || 0;
                            if (readCountEl) readCountEl.textContent = readingCountMap[bookId] || 0;
                            if (noteCountEl) noteCountEl.textContent = noteCountMap[bookId] || 0;

                            // æ›´æ–°çŠ¶æ€ï¼ˆå¦‚æœç”¨æˆ·å·²ç™»å½•ï¼‰
                            if (currentUser) {
                                if (userWants.has(bookId)) {
                                    wantBtn.classList.add('active');
                                } else {
                                    wantBtn.classList.remove('active');
                                }

                                if (userReadings.has(bookId)) {
                                    readBtn.classList.add('active');
                                } else {
                                    readBtn.classList.remove('active');
                                }
                            } else {
                                // æœªç™»å½•æ—¶ç§»é™¤activeçŠ¶æ€
                                wantBtn.classList.remove('active');
                                readBtn.classList.remove('active');
                            }
                        }
                    });

                } catch (error) {
                    console.error('æ›´æ–°è®¡æ•°å¤±è´¥:', error);
                }
            }
            initdesign();

            // åˆ‡æ¢"æƒ³è¯»"çŠ¶æ€
            window.toggleWant = async function (bookId) {


               const user = await checkUserLogin();
if (!user) {
    return;
}

                try {
                    const { data: existingReading } = await supabase
                        .from('book_readings')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('book_id', bookId)
                        .maybeSingle();

                    // å¦‚æœå·²ç»åœ¨è¯»ï¼Œå…ˆåˆ é™¤åœ¨è¯»çŠ¶æ€
                    if (existingReading) {
                        await supabase.from('book_readings').delete().eq('id', existingReading.id);
                    }
                    const { data: existingWant } = await supabase
                        .from('book_wants')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('book_id', bookId)
                        .maybeSingle();

                    if (existingWant) {
                        // å¦‚æœå·²ç»æƒ³è¯»ï¼Œåˆ™å–æ¶ˆæƒ³è¯»
                        await supabase.from('book_wants').delete().eq('id', existingWant.id);
                    } else {
                        // å¦‚æœæ²¡æœ‰æƒ³è¯»ï¼Œåˆ™æ·»åŠ æƒ³è¯»
                        await supabase.from('book_wants').insert([{ user_id: currentUser.id, book_id: bookId }]);
                    }
                    await updateBookCounts();
                } catch (error) {
                    console.error('æ“ä½œå¤±è´¥:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }


            window.toggleReading = async function (bookId) {
              const user = await checkUserLogin();
if (!user) {
    return;
}

                try {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æƒ³è¯»
                    const { data: existingWant } = await supabase
                        .from('book_wants')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('book_id', bookId)
                        .maybeSingle();

                    // å¦‚æœå·²ç»æƒ³è¯»ï¼Œå…ˆåˆ é™¤æƒ³è¯»çŠ¶æ€
                    if (existingWant) {
                        await supabase.from('book_wants').delete().eq('id', existingWant.id);
                    }

                    const { data: existingReading } = await supabase
                        .from('book_readings')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('book_id', bookId)
                        .maybeSingle();

                    if (existingReading) {
                        // å¦‚æœå·²ç»åœ¨è¯»ï¼Œåˆ™å–æ¶ˆåœ¨è¯»
                        await supabase.from('book_readings').delete().eq('id', existingReading.id);
                    } else {
                        // å¦‚æœæ²¡æœ‰åœ¨è¯»ï¼Œåˆ™æ·»åŠ åœ¨è¯»
                        await supabase.from('book_readings').insert([{ user_id: currentUser.id, book_id: bookId }]);
                    }

                    await updateBookCounts();
                } catch (error) {
                    console.error('æ“ä½œå¤±è´¥:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }

            window.saveNote = async function () {
              const user = await checkUserLogin();
if (!user) {
    return;
}

                const noteContent = document.getElementById('noteContent');
                const pageStart = document.getElementById('pageStart');
                const pageEnd = document.getElementById('pageEnd');
                const rawContent = noteContent.value.trim();
                const content = rawContent.split('\n').map(para => {
    
                    const trimmed = para.trim();
    if (trimmed === '') {
                return '';
            }
            
            let cleanPara = trimmed.replace(/^ã€€+/g, '');
            return 'ã€€ã€€' + cleanPara;
        }).join('\n');



                // ç§»é™¤æŠ–åŠ¨æ•ˆæœ
                pageStart.classList.remove('input-shake');
                pageEnd.classList.remove('input-shake');

                if (!content) {
                    alert('è¯·è¾“å…¥ç¬”è®°å†…å®¹');
                    return;
                }

                // éªŒè¯é¡µç ï¼šå¿…é¡»è‡³å°‘å¡«å†™èµ·å§‹é¡µ
                if (!pageStart.value) {
                    alert('è¯·å¡«å†™é¡µç ');
                    return;
                }

                if (pageEnd.value && parseInt(pageEnd.value) < parseInt(pageStart.value)) {
                    alert('ç»“æŸé¡µä¸èƒ½å°äºèµ·å§‹é¡µ');
                    return;
                }

                try {
                    const noteData = {
                        user_id: currentUser.id,
                        book_id: currentBookId,
                        content: content,
                        page_start: pageStart.value ? parseInt(pageStart.value) : null,
                        page_end: pageEnd.value ? parseInt(pageEnd.value) : null
                    };

                    const { error } = await supabase
                        .from('book_notes')
                        .insert([noteData]);

                    if (error) throw error;

                    // æ¸…ç©ºè¾“å…¥
                    noteContent.value = '';
                    pageStart.value = '';
                    pageEnd.value = '';

                    // é‡æ–°åŠ è½½ç”¨æˆ·ç¬”è®°
                    await loadUserNotes(currentBookId);

                    // æ›´æ–°è®¡æ•°
                    await updateBookCounts();

                    // å¦‚æœç¬”è®°åŒºåŸŸæ˜¯å±•å¼€çš„ï¼Œåˆ·æ–°å®ƒ
                    const notesArea = document.getElementById(`notes-area-${currentBookId}`);
                    if (notesArea && notesArea.classList.contains('show')) {
                        await loadAllNotes(currentBookId);
                        // è·³åˆ°æœ€åä¸€æ¡ç¬”è®°ï¼ˆåˆšæ·»åŠ çš„ï¼‰
                        currentNoteIndex[currentBookId] = (bookNotesCache[currentBookId] || []).length - 1;
                        displayCurrentNote(currentBookId);
                    }

                } catch (error) {
                    console.error('ä¿å­˜ç¬”è®°å¤±è´¥:', error);
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }



            // æ‰“å¼€ç¬”è®°Modal
            window.openNoteModal = async function (bookId, bookTitle) {
              const user = await checkUserLogin();
if (!user) {
    return;
}
                currentBookId = bookId;

                const modal = document.getElementById('noteModal');
                const modalTitle = document.getElementById('modalBookTitle');
                const noteContent = document.getElementById('noteContent');

                modalTitle.textContent = `${bookTitle}`;
                noteContent.value = '';
                modal.classList.add('show');

                await loadUserNotes(bookId);
            }

            // å…³é—­ç¬”è®°Modal
            window.closeNoteModal = function () {
    const modal = document.getElementById('noteModal');
    modal.classList.remove('show');
    currentBookId = null;
    
    // å¦‚æœæœ‰å±•å¼€çš„ç¬”è®°åŒºåŸŸï¼Œåˆ·æ–°å®ƒ
    const openNotesArea = document.querySelector('.book-notes-area.show');
    if (openNotesArea) {
        const bookIdMatch = openNotesArea.id.match(/notes-area-(.+)/);
        if (bookIdMatch) {
            const bookId = bookIdMatch[1];
            // å¼ºåˆ¶åˆ·æ–°ç¼“å­˜å¹¶é‡æ–°æ˜¾ç¤º
            setTimeout(async () => {
                await loadAllNotes(bookId, true);
                await displayCurrentNote(bookId);
            }, 100);
        }
    }
}

            window.toggleNotesArea = async function (bookId, bookTitle) {

                const notesArea = document.getElementById(`notes-area-${bookId}`);

                // å¦‚æœå·²å±•å¼€ï¼Œåˆ™æ”¶èµ·
                if (notesArea.classList.contains('show')) {
                    notesArea.classList.remove('show');
                    return;
                }

                // æ”¶èµ·å…¶ä»–æ‰€æœ‰å±•å¼€çš„ç¬”è®°åŒºåŸŸ
                document.querySelectorAll('.book-notes-area.show').forEach(area => {
                    area.classList.remove('show');
                });

                // å±•å¼€å½“å‰åŒºåŸŸ
                notesArea.classList.add('show');

                // åŠ è½½æ‰€æœ‰ç¬”è®°ï¼ˆæŒ‰é¡µç æ’åºï¼‰
                await loadAllNotes(bookId);

                // æ˜¾ç¤ºç¬¬ä¸€æ¡ç¬”è®°
                currentNoteIndex[bookId] = 0;
                displayCurrentNote(bookId);
            }



            window.loadAllNotes = async function (bookId, forceRefresh = false) {
    try {
        // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–ç¼“å­˜ä¸ºç©ºï¼Œä»æ•°æ®åº“é‡æ–°åŠ è½½
        if (forceRefresh || !bookNotesCache[bookId]) {
            const { data: notes, error } = await supabase
                .from('book_notes')
                .select('*')
                .eq('book_id', bookId)
                .order('page_start', { ascending: true, nullsFirst: false });

            if (error) throw error;

            // ç¼“å­˜ç¬”è®°æ•°æ®
            bookNotesCache[bookId] = notes || [];

            // ä¸ºæ¯æ¡ç¬”è®°è·å–å¹¶å¤„ç†æ³¨è§£
            for (let note of bookNotesCache[bookId]) {
                const annotations = await getNoteAnnotations(note.id);
                
                // å¦‚æœæ•°æ®åº“ä¸­æœ‰æ³¨è§£ï¼Œä½†å†…å®¹ä¸­æ²¡æœ‰æ ‡è®°ï¼Œåˆ™æ·»åŠ æ ‡è®°
                if (annotations && annotations.length > 0) {
                    let content = note.content;
                    const hasMarkers = /[â‘ -â‘³â“ª]/.test(content);
                    
                    if (!hasMarkers) {
                        // æŒ‰display_orderæ’åº
                        const sortedAnnotations = [...annotations].sort((a, b) => a.display_order - b.display_order);
                        
                        // ä¸ºæ¯ä¸ªæ³¨è§£æŸ¥æ‰¾åŸæ–‡å¹¶æ·»åŠ æ ‡è®°
                        sortedAnnotations.forEach(ann => {
                            if (ann.original_text && content.includes(ann.original_text)) {
                                const circledNum = getCircledNumber(ann.display_order);
                                // åªæ›¿æ¢ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
                                content = content.replace(ann.original_text, ann.original_text + circledNum);
                            }
                        });
                        
                        // æ›´æ–°ç¬”è®°å†…å®¹
                        note.content = content;
                    }
                }
            }
        }

        // æ›´æ–°æ€»ç¬”è®°æ•°
        document.getElementById(`total-notes-${bookId}`).textContent = bookNotesCache[bookId].length;

    } catch (error) {
        console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
        bookNotesCache[bookId] = [];
    }
}

   // æ˜¾ç¤ºå½“å‰ç¬”è®°
async function displayCurrentNote(bookId) {
    const notes = bookNotesCache[bookId] || [];
    const currentIndex = currentNoteIndex[bookId] || 0;
    const noteContainer = document.getElementById(`current-note-${bookId}`);

    if (notes.length === 0) {
        noteContainer.innerHTML = '<div class="empty-notes">No notes yet</div>';
        document.getElementById(`current-note-index-${bookId}`).textContent = '0';
        return;
    }

    const note = notes[currentIndex];
    
    // é‡æ–°ä»æ•°æ®åº“è·å–ç¬”è®°å’Œæ³¨è§£ï¼Œç¡®ä¿æ˜¯æœ€æ–°æ•°æ®
    try {
        const { data: freshNote, error } = await supabase
            .from('book_notes')
            .select('*')
            .eq('id', note.id)
            .single();
            
        if (error) throw error;
        
        const annotations = await getNoteAnnotations(note.id);
        
        // æ›´æ–°ç¼“å­˜ä¸­çš„ç¬”è®°æ•°æ®
        notes[currentIndex] = freshNote;
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        const { data: profile } = await supabase
            .from('profiles')
            .select('manifesto')
            .eq('user_id', freshNote.user_id)
            .single();

        const userName = profile?.manifesto || 'Anonymous';
        const createdDate = new Date(freshNote.created_at).toLocaleDateString('zh-CN');

        let pageInfo = '';
        if (freshNote.page_start && freshNote.page_end) {
            pageInfo = `P${freshNote.page_start}-${freshNote.page_end}`;
        } else if (freshNote.page_start) {
            pageInfo = `P${freshNote.page_start}`;
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·çš„ç¬”è®°
        const isOwner = currentUser && currentUser.id === freshNote.user_id;
        const ownerButtons = isOwner ? `
            <span class="note-delete" onclick="editNoteFromArea('${freshNote.id}', '${bookId}', ${freshNote.page_start}, ${freshNote.page_end})" style="cursor: pointer; margin-left: 15px;">ç¼–è¾‘</span>
            <span class="note-delete" onclick="deleteNote('${freshNote.id}', '${bookId}')" style="cursor: pointer; margin-left: 10px;">åˆ é™¤</span>
        ` : '';
const printButton = `<span class="note-print" onclick="printNote('${bookId}', ${currentIndex})" style="cursor: pointer; margin-left: 10px;">æ‰“å°</span>`;
       
        // æ¸²æŸ“å†…å®¹
        let contentWithAnnotations = freshNote.content;

        // æ¸²æŸ“æ³¨è§£éƒ¨åˆ†
        const annotationsHtml = annotations && annotations.length > 0 ? `
            <div class="note-annotations" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <div style="font-weight: bold; margin-bottom: 10px; font-size: 16px;">æ³¨è§£:</div>
                ${annotations.map(ann => `
                    <div style="margin-bottom: 8px; line-height: 1.4; font-size: 15px;">
                        <span style="color: black; font-weight: bold; margin-right: 6px;">${getCircledNumber(ann.display_order)}</span>
                        <span>${ann.annotation_text || 'ï¼ˆæ— æ³¨è§£å†…å®¹ï¼‰'}</span>
                    </div>
                `).join('')}
            </div>
        ` : '';

        noteContainer.innerHTML = `
        <div class="current-note-content" style="line-height: 1.6; margin-bottom: 15px; white-space: pre-wrap;">${contentWithAnnotations}</div>
        ${annotationsHtml}<div class="current-note-meta"><span>${pageInfo ? pageInfo + ' Â· ' : ''}${userName} Â· ${createdDate}</span>${ownerButtons}${printButton}</div>
        `;

    } catch (error) {
        console.error('è·å–ç¬”è®°è¯¦æƒ…å¤±è´¥:', error);
        noteContainer.innerHTML = '<div class="empty-notes">åŠ è½½ç¬”è®°å¤±è´¥</div>';
    }

    // æ›´æ–°å½“å‰ç´¢å¼•æ˜¾ç¤º
    document.getElementById(`current-note-index-${bookId}`).textContent = currentIndex + 1;

    // æ›´æ–°å·¦å³ç®­å¤´çŠ¶æ€
    updateNavigationButtons(bookId);
}

function extractOriginalContent(content) {
    // ç®€å•çš„æ­£åˆ™åŒ¹é…æ¥ç§»é™¤æ³¨è§£æ ‡è®°ï¼ˆå¦‚â‘ ã€â‘¡ç­‰ï¼‰
    const annotationMarkers = /[â‘ -â‘³â“ª]\s*/g;
    let cleanedContent = content.replace(annotationMarkers, '');
    
    // æ£€æŸ¥æ˜¯å¦åŒ…å«æ³¨è§£éƒ¨åˆ†
    const hasAnnotations = content.includes('<div class="annotations-section">') || 
                          content.includes('æ³¨è§£:') ||
                          /[â‘ -â‘³â“ª]/.test(content);
    
    // å¦‚æœåŒ…å«æ³¨è§£HTMLéƒ¨åˆ†ï¼Œç§»é™¤å®ƒ
    if (content.includes('<div class="annotations-section">')) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        const annotationSection = tempDiv.querySelector('.annotations-section');
        if (annotationSection) {
            annotationSection.remove();
        }
        cleanedContent = tempDiv.innerHTML;
    }
    
    return {
        originalContent: cleanedContent,
        hasAnnotations: hasAnnotations
    };
}

function injectAnnotationsIntoContent(content, annotations) {
    if (!annotations || annotations.length === 0) {
        return content;
    }

    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨æ¥è§£æHTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = content;
    
    // æŒ‰æ˜¾ç¤ºé¡ºåºæ’åºæ³¨è§£
    const sortedAnnotations = [...annotations].sort((a, b) => a.display_order - b.display_order);
    
    // åœ¨ç¬”è®°æœ«å°¾æ·»åŠ æ³¨è§£å†…å®¹
    let resultContent = content;
    
    // æ·»åŠ æ³¨è§£åˆ—è¡¨
    if (sortedAnnotations.length > 0) {
        resultContent += '\n\n<div class="annotations-section">';
        resultContent += '<div class="annotations-title" style="font-weight: bold; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">æ³¨è§£:</div>';
        
        sortedAnnotations.forEach(ann => {
            resultContent += `
                <div class="annotation-item" style="margin-bottom: 10px;">
                    <span class="annotation-marker" style="color: #0066cc; font-weight: bold;">${getCircledNumber(ann.display_order)}</span>
                    <span class="annotation-text">${ann.annotation_text}</span>
                </div>
            `;
        });
        
        resultContent += '</div>';
    }
    
    return resultContent;
}

async function saveAnnotationsToDatabase(noteId, annotations) {
    try {
        // å…ˆåˆ é™¤è¯¥ç¬”è®°çš„æ‰€æœ‰æ—§æ³¨è§£
        const { error: deleteError } = await supabase
            .from('note_annotations')
            .delete()
            .eq('note_id', noteId);

        if (deleteError) throw deleteError;

        // å¦‚æœæœ‰æ–°æ³¨è§£ï¼Œæ’å…¥åˆ°æ•°æ®åº“
        if (annotations && annotations.length > 0) {
            // æŒ‰æ³¨è§£çš„numberå­—æ®µæ’åº
            const sortedAnnotations = [...annotations].sort((a, b) => a.number - b.number);
            
            const annotationsToInsert = sortedAnnotations.map((ann, index) => ({
                note_id: noteId,
                original_text: ann.text, // ä¿å­˜åŸæ–‡
                annotation_text: ann.note || '',
                display_order: ann.number,
                created_at: new Date().toISOString()
            }));

            const { error: insertError } = await supabase
                .from('note_annotations')
                .insert(annotationsToInsert);

            if (insertError) throw insertError;
        }
    } catch (error) {
        console.error('ä¿å­˜æ³¨è§£å¤±è´¥:', error);
        throw error;
    }
}


async function getNoteAnnotations(noteId) {
    try {
        const { data: annotations, error } = await supabase
            .from('note_annotations')
            .select('*')
            .eq('note_id', noteId)
            .order('display_order', { ascending: true });

        if (error) throw error;
        return annotations || [];
    } catch (error) {
        console.error('è·å–æ³¨è§£å¤±è´¥:', error);
        return [];
    }
}


function renderAnnotationsForDisplay(annotations) {
    if (!annotations || annotations.length === 0) {
        return '';
    }

    // æŒ‰æ˜¾ç¤ºé¡ºåºæ’åº
    const sortedAnnotations = [...annotations].sort((a, b) => a.display_order - b.display_order);
    
    return `
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
            <div style="font-weight: bold; margin-bottom: 10px; font-size: 14px;">æ³¨è§£:</div>
            ${sortedAnnotations.map(ann => `
                <div style="margin-bottom: 8px; line-height: 1.4; font-size: 13px;">
                    <span style="color: #0066cc; font-weight: bold; margin-right: 6px;">${getCircledNumber(ann.display_order)}</span>
                    <span>${ann.annotation_text || 'ï¼ˆæ— æ³¨è§£å†…å®¹ï¼‰'}</span>
                </div>
            `).join('')}
        </div>
    `;
}

window.editNoteFromArea = async function (noteId, bookId, pageStart, pageEnd) {
    const noteContainer = document.getElementById(`current-note-${bookId}`);
    
    // ä»æ•°æ®åº“åŠ è½½å·²æœ‰æ³¨è§£
    const existingAnnotations = await getNoteAnnotations(noteId);
    
    // åˆå§‹åŒ–noteAnnotationsæ•°ç»„
    if (!noteAnnotations[noteId]) {
        noteAnnotations[noteId] = [];
    }
    
    // æ¸…ç©ºç°æœ‰æ³¨è§£å¹¶é‡æ–°æ·»åŠ 
    noteAnnotations[noteId] = [];
    
    if (existingAnnotations && existingAnnotations.length > 0) {
        // æŒ‰display_orderæ’åº
        const sortedAnnotations = [...existingAnnotations].sort((a, b) => a.display_order - b.display_order);
        
        sortedAnnotations.forEach(ann => {
            noteAnnotations[noteId].push({
                id: ann.id || Date.now(),
                number: ann.display_order,
                text: ann.original_text || '',
                note: ann.annotation_text || ''
            });
        });
    }

    // è·å–ç¬”è®°å†…å®¹
    const notes = bookNotesCache[bookId] || [];
    const note = notes.find(n => n.id === noteId);
    
    if (!note) {
        alert('ç¬”è®°æœªæ‰¾åˆ°');
        return;
    }
    
    let contentToEdit = note.content;
    // ç§»é™¤å¸¦åœˆæ•°å­—æ ‡è®°
    contentToEdit = contentToEdit.replace(/[â‘ -â‘³â“ª]/g, '');
    
    // ç§»é™¤æ¯æ®µå¼€å¤´çš„å…¨è§’ç©ºæ ¼
    contentToEdit = contentToEdit.split('\n').map(para => {
        const trimmed = para.trim();
        if (trimmed === '') {
            return '';
        }
        // ç§»é™¤å¼€å¤´çš„å…¨è§’ç©ºæ ¼
        return trimmed.replace(/^ã€€+/g, '');
    }).join('\n');


    noteContainer.innerHTML = `
        <div style="margin-bottom: 10px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="number" id="area-edit-pageStart-${noteId}" value="${pageStart || ''}" placeholder="èµ·å§‹é¡µ" 
                    style="width: 100px; padding: 5px; border: 2px solid black;">
                <span style="line-height: 30px;">-</span>
                <input type="number" id="area-edit-pageEnd-${noteId}" value="${pageEnd || ''}" placeholder="ç»“æŸé¡µ" 
                    style="width: 100px; padding: 5px; border: 2px solid black;">
            </div>
            <div style="margin-bottom: 10px;">
                <button onclick="addAnnotationFromArea('${noteId}', '${bookId}')" style="padding: 5px 15px; border: 2px solid black; background-color: white; cursor: pointer;">æ·»åŠ æ³¨è§£</button>
                <span style="margin-left: 10px; font-size: 12px; color: #666;">é€‰ä¸­æ–‡å­—åç‚¹å‡»æ­¤æŒ‰é’®</span>
            </div>
            <div id="area-edit-content-${noteId}" contenteditable="true" style="width: 100%; min-height: 120px; padding: 10px; border: 2px solid black; font-family: inherit; font-size: 14px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6;">${contentToEdit}</div>
            <div id="area-annotations-${noteId}" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid black;">
                <!-- æ³¨è§£åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="area-save-btn-${noteId}" onclick="saveEditNoteFromArea('${noteId}', '${bookId}')" style="padding: 5px 15px; border: 2px solid black; background-color: white; cursor: pointer;">ä¿å­˜</button>
            <button onclick="cancelEditNoteFromArea('${bookId}')" style="padding: 5px 15px; border: 2px solid black; background-color: white; cursor: pointer;">å–æ¶ˆ</button>
        </div>
    `;

    // æ¸²æŸ“æ³¨è§£åˆ—è¡¨
    renderAnnotationsFromArea(noteId);
}

window.cancelEditNoteFromArea = function(bookId) {
    // é‡æ–°æ˜¾ç¤ºå½“å‰ç¬”è®°
    displayCurrentNote(bookId);
}

function insertAnnotationMarksInEditContent(noteId) {
    const editContent = document.getElementById(`area-edit-content-${noteId}`);
    const annotations = noteAnnotations[noteId] || [];
    
    if (annotations.length === 0) return;
    
    let content = editContent.textContent || editContent.innerText;
    
    // ä¸ºæ¯ä¸ªæ³¨è§£åœ¨å†…å®¹ä¸­æŸ¥æ‰¾å¹¶æ ‡è®°ï¼ˆç®€åŒ–ç‰ˆï¼šåœ¨æœ«å°¾æ·»åŠ ï¼‰
    annotations.forEach(ann => {
        // å°è¯•åœ¨æ–‡æœ¬ä¸­æ‰¾åˆ°åŸæ–‡
        const textIndex = content.indexOf(ann.text);
        if (textIndex !== -1) {
            // åœ¨æ‰¾åˆ°çš„æ–‡æœ¬åæ’å…¥æ ‡è®°
            const before = content.substring(0, textIndex + ann.text.length);
            const after = content.substring(textIndex + ann.text.length);
            content = before + getCircledNumber(ann.number) + after;
        }
    });
    
    editContent.innerHTML = content;
}


     

            window.addAnnotationFromArea = function(noteId, bookId) {
    const selection = window.getSelection();
    if (!selection.rangeCount || selection.isCollapsed) {
        alert('è¯·å…ˆé€‰ä¸­éœ€è¦æ³¨è§£çš„æ–‡å­—');
        return;
    }

    const selectedText = selection.toString();
    const range = selection.getRangeAt(0);
    const editContent = document.getElementById(`area-edit-content-${noteId}`);
    
    // ç¡®ä¿é€‰åŒºåœ¨ç¼–è¾‘åŒºåŸŸå†…
    if (!editContent.contains(range.commonAncestorContainer)) {
        alert('è¯·åœ¨ç¬”è®°å†…å®¹åŒºåŸŸé€‰æ‹©æ–‡å­—');
        return;
    }

    // è·å–å½“å‰æ‰€æœ‰æ³¨è§£ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªåºå·
    const currentAnnotations = noteAnnotations[noteId] || [];
    const nextNumber = currentAnnotations.length + 1;

    // åˆ›å»ºæ³¨è§£
    const annotation = {
        id: Date.now(),
        number: nextNumber, // è¿™æ˜¯æ˜¾ç¤ºé¡ºåºï¼Œä¸æ˜¯åˆ›å»ºæ—¶é—´
        text: selectedText,
        note: ''
    };

    // åœ¨é€‰ä¸­æ–‡å­—åæ’å…¥å¸¦åœˆæ•°å­—
    const circledNumber = getCircledNumber(nextNumber);
    const span = document.createElement('span');
    span.style.color = '#0066cc';
    span.style.fontSize = '0.85em';
    span.style.verticalAlign = 'super';
    span.textContent = circledNumber;
    
    range.collapse(false);
    range.insertNode(span);

    // ä¿å­˜æ³¨è§£åˆ°æ•°ç»„
    if (!noteAnnotations[noteId]) {
        noteAnnotations[noteId] = [];
    }
    noteAnnotations[noteId].push(annotation);
    
    // æ¸…é™¤é€‰åŒº
    selection.removeAllRanges();
    
    // é‡æ–°æ¸²æŸ“æ³¨è§£åˆ—è¡¨
    renderAnnotationsFromArea(noteId);
}

// åŒæ ·ä¿®æ”¹addAnnotationå‡½æ•°ï¼ˆç”¨äºmodalä¸­çš„ç¼–è¾‘ï¼‰
window.addAnnotation = function(noteId) {
    const selection = window.getSelection();
    if (!selection.rangeCount || selection.isCollapsed) {
        alert('è¯·å…ˆé€‰ä¸­éœ€è¦æ³¨è§£çš„æ–‡å­—');
        return;
    }

    const selectedText = selection.toString();
    const range = selection.getRangeAt(0);
    const editContent = document.getElementById(`edit-content-${noteId}`);
    
    // ç¡®ä¿é€‰åŒºåœ¨ç¼–è¾‘åŒºåŸŸå†…
    if (!editContent.contains(range.commonAncestorContainer)) {
        alert('è¯·åœ¨ç¬”è®°å†…å®¹åŒºåŸŸé€‰æ‹©æ–‡å­—');
        return;
    }

    // è·å–å½“å‰æ‰€æœ‰æ³¨è§£ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªåºå·
    const currentAnnotations = noteAnnotations[noteId] || [];
    const nextNumber = currentAnnotations.length + 1;

    // åˆ›å»ºæ³¨è§£
    const annotation = {
        id: Date.now(),
        number: nextNumber,
        text: selectedText,
        note: ''
    };


    // åœ¨é€‰ä¸­æ–‡å­—åæ’å…¥å¸¦åœˆæ•°å­—
    const circledNumber = getCircledNumber(nextNumber);
    const span = document.createElement('span');
    span.style.color = '#0066cc';
    span.style.fontSize = '0.85em';
    span.style.verticalAlign = 'super';
    span.textContent = circledNumber;
    
    range.collapse(false);
    range.insertNode(span);

    // ä¿å­˜æ³¨è§£
    if (!noteAnnotations[noteId]) {
        noteAnnotations[noteId] = [];
    }
    noteAnnotations[noteId].push(annotation);
    
    // æ¸…é™¤é€‰åŒº
    selection.removeAllRanges();
    
    // é‡æ–°æ¸²æŸ“æ³¨è§£åˆ—è¡¨
    renderAnnotations(noteId);
}

// æ¸²æŸ“å±•å¼€åŒºåŸŸçš„æ³¨è§£åˆ—è¡¨
function renderAnnotationsFromArea(noteId) {
    const annotationsContainer = document.getElementById(`area-annotations-${noteId}`);
    if (!annotationsContainer) return;

    const annotations = noteAnnotations[noteId] || [];
    
    if (annotations.length === 0) {
        annotationsContainer.innerHTML = '<div style="color: #999; font-size: 14px;">æš‚æ— æ³¨è§£</div>';
        return;
    }

    annotationsContainer.innerHTML = annotations.map(ann => `
        <div style="margin-bottom: 15px; padding: 10px; border: 2px solid black; background-color: white;">
            <div style="margin-bottom: 5px;">
                <span style="color: black; font-weight: bold;">${getCircledNumber(ann.number)}</span>
                <span style="color: black; font-size: 14px;">"${ann.text}"</span>
                <button onclick="deleteAnnotationFromArea('${noteId}', '${ann.id}')" style="float: right; padding: 0px 8px; border: 2px solid black; background: white; cursor: pointer; font-size: 12px;">åˆ é™¤</button>
            </div>
            <textarea id="area-annotation-note-${ann.id}" style="width: 100%; min-height: 60px; padding: 5px; border: 2px solid black; font-size: 13px;" placeholder="åœ¨æ­¤è¾“å…¥æ³¨è§£å†…å®¹...">${ann.note}</textarea>
        </div>
    `).join('');

    // ç»‘å®štextareaçš„changeäº‹ä»¶
    annotations.forEach(ann => {
        const textarea = document.getElementById(`area-annotation-note-${ann.id}`);
        if (textarea) {
            textarea.addEventListener('input', function() {
                const annotation = noteAnnotations[noteId].find(a => a.id === ann.id);
                if (annotation) {
                    annotation.note = this.value;
                }
            });
        }
    });
}// ä»å±•å¼€åŒºåŸŸåˆ é™¤æ³¨è§£ - ä¿®å¤ç‰ˆ
window.deleteAnnotationFromArea = function(noteId, annotationId) {
    if (!confirm(`ç¡®å®šåˆ é™¤è¿™æ¡æ³¨è§£å—ï¼Ÿ`)) return;

    const annotations = noteAnnotations[noteId] || [];
    const deleteIndex = annotations.findIndex(a => a.id == annotationId);
    if (deleteIndex === -1) return;

    // 1. ä»æ•°ç»„ä¸­åˆ é™¤æ³¨è§£
    annotations.splice(deleteIndex, 1);

    // 2. é‡æ–°ç¼–å·æ‰€æœ‰å‰©ä½™çš„æ³¨è§£
    annotations.forEach((ann, idx) => {
        ann.number = idx + 1;
    });

    // 3. æ›´æ–°ç¼–è¾‘åŒºåŸŸä¸­çš„æ ‡è®°
    const editContent = document.getElementById(`area-edit-content-${noteId}`);
    const modalEditContent = document.getElementById(`edit-content-${noteId}`);
    
    // æ›´æ–°å±•å¼€åŒºåŸŸçš„å†…å®¹
    if (editContent) {
        updateContentWithAnnotations(editContent, annotations);
    }
    
    // æ›´æ–°Modalä¸­çš„å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (modalEditContent) {
        updateContentWithAnnotations(modalEditContent, annotations);
    }

    // 4. é‡æ–°æ¸²æŸ“æ³¨è§£åˆ—è¡¨
    renderAnnotationsFromArea(noteId);
    
    // 5. å¦‚æœModalä¸­ä¹Ÿæ˜¾ç¤ºäº†ç›¸åŒçš„ç¬”è®°ï¼Œæ›´æ–°Modalä¸­çš„æ³¨è§£åˆ—è¡¨
    const modalAnnotationsContainer = document.getElementById(`annotations-${noteId}`);
    if (modalAnnotationsContainer) {
        renderAnnotations(noteId);
    }
}


// è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°å†…å®¹ä¸­çš„æ³¨è§£æ ‡è®°
function updateContentWithAnnotations(contentElement, annotations) {
    if (!contentElement) return;
    
    // è·å–å½“å‰æ–‡æœ¬å†…å®¹ï¼ˆä¸å«æ ‡è®°ï¼‰
    let textContent = contentElement.textContent || contentElement.innerText;
    
    // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„å¸¦åœˆæ•°å­—æ ‡è®°
    textContent = textContent.replace(/[â‘ -â‘³â“ª]/g, '');
    
    // æ¸…é™¤å½“å‰å†…å®¹
    contentElement.innerHTML = '';
    
    // å¦‚æœæœ‰æ³¨è§£ï¼Œæ’å…¥æ–°çš„æ ‡è®°
    if (annotations && annotations.length > 0) {
        // åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹å¹¶é‡æ–°æ’å…¥
        const sortedAnnotations = [...annotations].sort((a, b) => a.number - b.number);
        
        // åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ç‰‡æ®µæ¥æ„å»ºæ–°å†…å®¹
        const fragment = document.createDocumentFragment();
        
        // å¤„ç†æ–‡æœ¬è¡Œ
        const lines = textContent.split('\n');
        
        lines.forEach((line, lineIndex) => {
            if (lineIndex > 0) {
                fragment.appendChild(document.createElement('br'));
            }
            
            let processedLine = line;
            let offset = 0;
            
            // ä¸ºæ¯ä¸ªæ³¨è§£åœ¨è¡Œä¸­æŸ¥æ‰¾å¹¶æ ‡è®°
            sortedAnnotations.forEach(ann => {
                if (ann.text && processedLine.includes(ann.text)) {
                    // æ‰¾åˆ°æ–‡æœ¬ä½ç½®
                    const textIndex = processedLine.indexOf(ann.text);
                    if (textIndex !== -1) {
                        // æ·»åŠ æ³¨è§£æ–‡æœ¬å‰çš„éƒ¨åˆ†
                        if (textIndex > 0) {
                            const beforeText = document.createTextNode(processedLine.substring(0, textIndex));
                            fragment.appendChild(beforeText);
                        }
                        
                        // æ·»åŠ æ³¨è§£æ–‡æœ¬
                        const annotationText = document.createTextNode(ann.text);
                        fragment.appendChild(annotationText);
                        
                        // æ·»åŠ å¸¦åœˆæ•°å­—æ ‡è®°
                        const markerSpan = document.createElement('span');
                        markerSpan.style.color = '#0066cc';
                        markerSpan.style.fontSize = '0.85em';
                        markerSpan.style.verticalAlign = 'super';
                        markerSpan.textContent = getCircledNumber(ann.number);
                        fragment.appendChild(markerSpan);
                        
                        // æ›´æ–°å·²å¤„ç†çš„è¡Œå†…å®¹
                        processedLine = processedLine.substring(textIndex + ann.text.length);
                    }
                }
            });
            
            // æ·»åŠ å‰©ä½™çš„è¡Œå†…å®¹
            if (processedLine.length > 0) {
                const remainingText = document.createTextNode(processedLine);
                fragment.appendChild(remainingText);
            }
        });
        
        contentElement.appendChild(fragment);
    } else {
        // æ²¡æœ‰æ³¨è§£ï¼Œç›´æ¥è®¾ç½®æ–‡æœ¬
        // ä¿æŒåŸæœ‰çš„æ¢è¡Œ
        const lines = textContent.split('\n');
        lines.forEach((line, index) => {
            if (index > 0) {
                contentElement.appendChild(document.createElement('br'));
            }
            contentElement.appendChild(document.createTextNode(line));
        });
    }
}
window.saveEditNoteFromArea = async function (noteId, bookId) {
    const saveBtn = document.getElementById(`area-save-btn-${noteId}`);
    const originalText = saveBtn.textContent;
    
    // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
    saveBtn.textContent = 'ä¿å­˜ä¸­...';
    saveBtn.disabled = true;
    saveBtn.style.opacity = '0.7';
    saveBtn.style.cursor = 'not-allowed';

    try {
        const contentElement = document.getElementById(`area-edit-content-${noteId}`);
        const pageStartElement = document.getElementById(`area-edit-pageStart-${noteId}`);
        const pageEndElement = document.getElementById(`area-edit-pageEnd-${noteId}`);

        // è·å–åŒ…å«HTMLçš„å†…å®¹
        let htmlContent = contentElement.innerHTML;
        
        // ç§»é™¤æ—§çš„å¸¦åœˆæ•°å­—æ ‡è®°
        htmlContent = htmlContent.replace(/<span[^>]*>[â‘ -â‘³â“ª]<\/span>/g, '');
        htmlContent = htmlContent.replace(/[â‘ -â‘³â“ª]/g, '');
        
  
        
        // æ¸…ç†å†…å®¹ - ç§»é™¤å¤šä½™çš„ç©ºæ ¼å’Œåˆ¶è¡¨ç¬¦
        htmlContent = htmlContent
            .replace(/<div>/g, '\n')
            .replace(/<\/div>/g, '')
            .replace(/<br>/g, '\n')
            .replace(/<br\s*\/?>/g, '\n')
            .replace(/&nbsp;/g, ' ')
            .replace(/<[^>]+>/g, '')
            .trim();
        
            let content = htmlContent;

        // ä¸ºæ¯æ®µæ·»åŠ ä¸¤ä¸ªå…¨è§’ç©ºæ ¼ - ç®€åŒ–é€»è¾‘
        content = content.split('\n').map(para => {
            const trimmed = para;
            if (trimmed === '') {
                return '';
            }
            // ç§»é™¤ä»»ä½•ç°æœ‰çš„å…¨è§’ç©ºæ ¼ï¼Œç„¶åæ·»åŠ ä¸¤ä¸ªå…¨è§’ç©ºæ ¼
            const cleanPara = trimmed.replace(/^ã€€+/g, '');
            return 'ã€€ã€€' + cleanPara;
        }).join('\n');
        
        const pageStart = pageStartElement.value;
        const pageEnd = pageEndElement.value;

        if (!content || content.trim() === '') {
            alert('è¯·è¾“å…¥ç¬”è®°å†…å®¹');
            throw new Error('å†…å®¹ä¸ºç©º');
        }

        // éªŒè¯é¡µç 
        if (!pageStart) {
            alert('è¯·å¡«å†™é¡µç ');
            throw new Error('é¡µç ä¸ºç©º');
        }

        if (pageEnd && parseInt(pageEnd) < parseInt(pageStart)) {
            alert('ç»“æŸé¡µä¸èƒ½å°äºèµ·å§‹é¡µ');
            throw new Error('é¡µç é”™è¯¯');
        }

        // è·å–å½“å‰çš„æ³¨è§£æ•°ç»„
        const annotations = noteAnnotations[noteId] || [];
        
        // å¦‚æœæœ‰æ³¨è§£ï¼Œåœ¨å†…å®¹ä¸­æ’å…¥æ–°çš„å¸¦åœˆæ•°å­—æ ‡è®°
        if (annotations.length > 0) {
            // æŒ‰numberæ’åº
            const sortedAnnotations = [...annotations].sort((a, b) => a.number - b.number);
            
            // ä¸ºæ¯ä¸ªæ³¨è§£æŸ¥æ‰¾æ–‡æœ¬å¹¶æ’å…¥æ ‡è®°
            sortedAnnotations.forEach(ann => {
                if (ann.text && content.includes(ann.text)) {
                    const circledNum = getCircledNumber(ann.number);
                    // åªæ›¿æ¢ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
                    const regex = new RegExp(ann.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    let count = 0;
                    content = content.replace(regex, (match) => {
                        count++;
                        return count === 1 ? match + circledNum : match;
                    });
                }
            });
        }

        // æ›´æ–°ç¬”è®°å†…å®¹ï¼ˆåŒ…å«æ ‡è®°ï¼‰
        const { error: noteError } = await supabase
            .from('book_notes')
            .update({
                content: content,
                page_start: parseInt(pageStart),
                page_end: pageEnd ? parseInt(pageEnd) : null,
                updated_at: new Date().toISOString()
            })
            .eq('id', noteId);

        if (noteError) throw noteError;
        
        // ä¿å­˜æ³¨è§£åˆ°æ•°æ®åº“
        if (annotations.length > 0) {
            // åˆ é™¤æ—§çš„æ³¨è§£
            const { error: deleteError } = await supabase
                .from('note_annotations')
                .delete()
                .eq('note_id', noteId);
            
            if (deleteError) throw deleteError;
            
            // æ’å…¥æ–°çš„æ³¨è§£
            const annotationsToInsert = annotations.map((ann, index) => ({
                note_id: noteId,
                original_text: ann.text,
                annotation_text: ann.note || '',
                display_order: ann.number,
                created_at: new Date().toISOString()
            }));
            
            const { error: insertError } = await supabase
                .from('note_annotations')
                .insert(annotationsToInsert);
                
            if (insertError) throw insertError;
        } else {
            // å¦‚æœæ²¡æœ‰æ³¨è§£ï¼Œåˆ é™¤æ‰€æœ‰ç›¸å…³æ³¨è§£
            await supabase
                .from('note_annotations')
                .delete()
                .eq('note_id', noteId);
        }
        
        // æ¸…é™¤ç¼“å­˜
        delete bookNotesCache[bookId];
        delete noteAnnotations[noteId];
        
        // é‡æ–°åŠ è½½ç¬”è®°
        await loadAllNotes(bookId);
        await updateBookCounts();

        // é‡æ–°æ˜¾ç¤ºå½“å‰ç¬”è®°
        await displayCurrentNote(bookId);

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        saveBtn.textContent = 'ä¿å­˜æˆåŠŸ!';
        setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            saveBtn.style.opacity = '1';
            saveBtn.style.cursor = 'pointer';
        }, 1000);

    } catch (error) {
        console.error('æ›´æ–°ç¬”è®°å¤±è´¥:', error);
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
        saveBtn.style.opacity = '1';
        saveBtn.style.cursor = 'pointer';
        
        if (error.message !== 'å†…å®¹ä¸ºç©º' && error.message !== 'é¡µç ä¸ºç©º' && error.message !== 'é¡µç é”™è¯¯') {
            alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
}
            // æ–°å¢ï¼šæ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
             function updateNavigationButtons(bookId) {
    const notes = bookNotesCache[bookId] || [];
    
    // å¦‚æœç¬”è®°æ•°ä¸º0æˆ–1ï¼Œç¦ç”¨æ‰€æœ‰ç®­å¤´
    if (notes.length <= 1) {
        const prevBtn = document.querySelector(`#notes-area-${bookId} .nav-arrow:first-child`);
        const nextBtn = document.querySelector(`#notes-area-${bookId} .nav-arrow:last-child`);
        
        if (prevBtn) prevBtn.classList.add('disabled');
        if (nextBtn) nextBtn.classList.add('disabled');
        return;
    }
    
    // å¾ªç¯æµè§ˆæ—¶ç®­å¤´ä¸éœ€è¦ç¦ç”¨ï¼Œæ‰€ä»¥ç§»é™¤disabledç±»
    const prevBtn = document.querySelector(`#notes-area-${bookId} .nav-arrow:first-child`);
    const nextBtn = document.querySelector(`#notes-area-${bookId} .nav-arrow:last-child`);
    
    if (prevBtn) prevBtn.classList.remove('disabled');
    if (nextBtn) nextBtn.classList.remove('disabled');
}

            // æ–°å¢ï¼šä¸Šä¸€æ¡ç¬”è®°
        window.prevNote = function (bookId) {
    const notes = bookNotesCache[bookId] || [];
    if (notes.length === 0) return;
    
    const currentIndex = currentNoteIndex[bookId] || 0;
    
    if (currentIndex > 0) {
        // æ­£å¸¸æƒ…å†µï¼šå¾€å‰ç¿»ä¸€é¡µ
        currentNoteIndex[bookId] = currentIndex - 1;
    } else {
        // å¦‚æœæ˜¯ç¬¬ä¸€æ¡ç¬”è®°ï¼šè·³è½¬åˆ°æœ€åä¸€æ¡ç¬”è®°
        currentNoteIndex[bookId] = notes.length - 1;
    }
    
    displayCurrentNote(bookId);
}


            // æ–°å¢ï¼šä¸‹ä¸€æ¡ç¬”è®°
          window.nextNote = function (bookId) {
    const notes = bookNotesCache[bookId] || [];
    if (notes.length === 0) return;
    
    const currentIndex = currentNoteIndex[bookId] || 0;
    
    if (currentIndex < notes.length - 1) {
        // æ­£å¸¸æƒ…å†µï¼šå¾€åç¿»ä¸€é¡µ
        currentNoteIndex[bookId] = currentIndex + 1;
    } else {
        // å¦‚æœæ˜¯æœ€åä¸€æ¡ç¬”è®°ï¼šè·³è½¬åˆ°ç¬¬ä¸€æ¡ç¬”è®°
        currentNoteIndex[bookId] = 0;
    }
    
    displayCurrentNote(bookId);
}




            async function loadUserNotes(bookId) {
    const notesList = document.getElementById('notesList');
    notesList.innerHTML = '<div class="loading">Loading notes...</div>';

    if (!currentUser) {
        notesList.innerHTML = '<div class="empty-notes">è¯·å…ˆç™»å½•</div>';
        return;
    }

    try {
        // åªæŸ¥è¯¢å½“å‰ç”¨æˆ·çš„ç¬”è®°
        const { data: notes, error } = await supabase
            .from('book_notes')
            .select('*')
            .eq('book_id', bookId)
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!notes || notes.length === 0) {
            notesList.innerHTML = '<div class="empty-notes">You have no notes yet</div>';
            return;
        }

        // ä¸ºæ¯æ¡ç¬”è®°è·å–æ³¨è§£
        const notesWithAnnotations = await Promise.all(
            notes.map(async (note) => {
                const annotations = await getNoteAnnotations(note.id);
                
                let content = note.content;
                
                // å¦‚æœå†…å®¹ä¸­æ²¡æœ‰æ ‡è®°ä½†æœ‰æ³¨è§£ï¼Œæ·»åŠ æ ‡è®°
                if (annotations && annotations.length > 0 && !/[â‘ -â‘³â“ª]/.test(content)) {
                    const sortedAnnotations = [...annotations].sort((a, b) => a.display_order - b.display_order);
                    
                    sortedAnnotations.forEach(ann => {
                        if (ann.original_text && content.includes(ann.original_text)) {
                            const circledNum = getCircledNumber(ann.display_order);
                            // åªæ›¿æ¢ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
                            content = content.replace(ann.original_text, ann.original_text + circledNum);
                        }
                    });
                }
                
                return { ...note, content, annotations };
            })
        );



        notesList.innerHTML = notesWithAnnotations.map(note => {
            const createdDate = new Date(note.created_at).toLocaleDateString('zh-CN');

            let pageInfo = '';
            if (note.page_start && note.page_end) {
                pageInfo = `P${note.page_start}-${note.page_end} Â· `;
            } else if (note.page_start) {
                pageInfo = `P${note.page_start} Â· `;
            }

            // æ¸²æŸ“æ³¨è§£éƒ¨åˆ†
            const annotationsHtml = note.annotations && note.annotations.length > 0 ? `
                <div class="note-annotations" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 13px;">æ³¨è§£:</div>
                    ${note.annotations.map(ann => `
                        <div style="margin-bottom: 6px; line-height: 1.4; font-size: 12px;">
                            <span style="color: #0066cc; font-weight: bold; margin-right: 4px;">${getCircledNumber(ann.display_order)}</span>
                            <span>${ann.annotation_text || 'ï¼ˆæ— æ³¨è§£å†…å®¹ï¼‰'}</span>
                        </div>
                    `).join('')}
                </div>
            ` : '';

            return `
                <div class="note-item" id="note-item-${note.id}">
                    <div class="note-content" id="note-content-${note.id}">${note.content}</div>
                    ${annotationsHtml}
                    <div class="note-meta">
                        <span>${pageInfo}${createdDate}</span>
                        <span>
                            <span class="note-delete" onclick="editNote('${note.id}', ${note.page_start}, ${note.page_end})" style="cursor: pointer; margin-right: 10px;">ç¼–è¾‘</span>
                            <span class="note-delete" onclick="deleteNote('${note.id}')">åˆ é™¤</span>
                        </span>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
        notesList.innerHTML = '<div class="empty-notes">åŠ è½½ç¬”è®°å¤±è´¥</div>';
    }
}

            // ç¼–è¾‘ç¬”è®°
            window.editNote = function (noteId, pageStart, pageEnd) {
    const noteContentElement = document.getElementById(`note-content-${noteId}`);
    const noteItemElement = document.getElementById(`note-item-${noteId}`);
    const currentContent = noteContentElement.textContent;
    
    // æ¸…ç©ºç°æœ‰çš„æ³¨è§£ç¼“å­˜
    if (!noteAnnotations[noteId]) {
        noteAnnotations[noteId] = [];
    } else {
        noteAnnotations[noteId] = [];
    }

    // ä»æ•°æ®åº“åŠ è½½å·²æœ‰æ³¨è§£
    getNoteAnnotations(noteId).then(async (annotations) => {
        if (annotations && annotations.length > 0) {
            annotations.forEach(ann => {
                noteAnnotations[noteId].push({
                    id: ann.id || Date.now(),
                    number: ann.display_order,
                    text: ann.original_text || '',
                    note: ann.annotation_text || ''
                });
            });
        }

        let editContent = currentContent;
        editContent = editContent.replace(/[â‘ -â‘³â“ª]/g, '');
        
        // ç§»é™¤æ¯æ®µå¼€å¤´çš„å…¨è§’ç©ºæ ¼
        editContent = editContent.split('\n').map(para => {
            const trimmed = para.trim();
            if (trimmed === '') {
                return '';
            }
            // ç§»é™¤å¼€å¤´çš„å…¨è§’ç©ºæ ¼
            return trimmed.replace(/^ã€€+/g, '');
        }).join('\n');

        noteItemElement.innerHTML = `
        <div style="margin-bottom: 10px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="number" id="edit-pageStart-${noteId}" value="${pageStart || ''}" placeholder="Start Page" 
                    style="width: 100px; padding: 5px; border: 2px solid black;"
                    oninput="this.style.borderColor='black'">
                <span style="line-height: 30px;">-</span>
                <input type="number" id="edit-pageEnd-${noteId}" value="${pageEnd || ''}" placeholder="End Page" 
                    style="width: 100px; padding: 5px; border: 2px solid black;"
                    oninput="this.style.borderColor='black'">
            </div>
            <div style="margin-bottom: 10px;">
                <button onclick="addAnnotation('${noteId}')" style="padding: 5px 15px; border: 2px solid black; background-color: white; cursor: pointer;">æ·»åŠ æ³¨è§£</button>
                <span style="margin-left: 10px; font-size: 12px; color: #666;">é€‰ä¸­æ–‡å­—åç‚¹å‡»æ­¤æŒ‰é’®</span>
            </div>
            <div id="edit-content-${noteId}" contenteditable="true" style="width: 100%; min-height: 120px; padding: 10px; border: 2px solid black; font-family: inherit; font-size: 14px; overflow-y: auto; white-space: pre-wrap;">${editContent}</div>  <!-- å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ editContent è€Œä¸æ˜¯ currentContent -->
            <div id="annotations-${noteId}" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid black;">
                <!-- æ³¨è§£åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="saveEditNote('${noteId}')" style="padding: 5px 15px; border: 2px solid black; background-color: white; cursor: pointer;">ä¿å­˜</button>
            <button onclick="cancelEditNoteInModal('${noteId}')" style="padding: 5px 15px; border: 2px solid black; background-color: white; cursor: pointer;">å–æ¶ˆ</button>
        </div>
    `;

        // æ¸²æŸ“å·²æœ‰æ³¨è§£
        renderAnnotations(noteId);
        
        // åœ¨å†…å®¹ä¸­æ’å…¥æ³¨è§£æ ‡è®°
        insertAnnotationMarksInModalContent(noteId, annotations);
    }).catch(error => {
        console.error('åŠ è½½æ³¨è§£å¤±è´¥:', error);
    });
}

window.cancelEditNoteInModal = function(noteId) {
    // é‡æ–°åŠ è½½ç¬”è®°åˆ—è¡¨
    loadUserNotes(currentBookId);
}


function insertAnnotationMarksInModalContent(noteId, annotations) {
    if (!annotations || annotations.length === 0) return;
    
    const editContent = document.getElementById(`edit-content-${noteId}`);
    let content = editContent.textContent || editContent.innerText;
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»åŒ…å«å¸¦åœˆæ•°å­—æ ‡è®°
    const hasExistingMarkers = /[â‘ -â‘³â“ª]/.test(content);
    
    // å¦‚æœå·²ç»æœ‰æ ‡è®°ï¼Œå…ˆç§»é™¤æ‰€æœ‰æ ‡è®°
    if (hasExistingMarkers) {
        content = content.replace(/[â‘ -â‘³â“ª]/g, '');
    }
    
    // æŒ‰é¡ºåºæ’å…¥æ ‡è®°
    const sortedAnnotations = [...annotations].sort((a, b) => a.display_order - b.display_order);
    
    sortedAnnotations.forEach(ann => {
        if (ann.original_text && content.includes(ann.original_text)) {
            const circledNum = getCircledNumber(ann.display_order);
            // æ›¿æ¢ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œåœ¨åŸæ–‡åæ·»åŠ æ ‡è®°
            content = content.replace(ann.original_text, ann.original_text + circledNum);
        }
    });
    
    editContent.innerHTML = content;
}

            // æ·»åŠ æ³¨è§£
            window.addAnnotation = function(noteId) {
    const selection = window.getSelection();
    if (!selection.rangeCount || selection.isCollapsed) {
        alert('è¯·å…ˆé€‰ä¸­éœ€è¦æ³¨è§£çš„æ–‡å­—');
        return;
    }

    const selectedText = selection.toString();
    const range = selection.getRangeAt(0);
    const editContent = document.getElementById(`edit-content-${noteId}`);
    
    // ç¡®ä¿é€‰åŒºåœ¨ç¼–è¾‘åŒºåŸŸå†…
    if (!editContent.contains(range.commonAncestorContainer)) {
        alert('è¯·åœ¨ç¬”è®°å†…å®¹åŒºåŸŸé€‰æ‹©æ–‡å­—');
        return;
    }

    // è·å–å½“å‰æ‰€æœ‰æ³¨è§£ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªåºå·
    const currentAnnotations = noteAnnotations[noteId] || [];
    const nextNumber = currentAnnotations.length + 1;

    // åˆ›å»ºæ³¨è§£
    const annotation = {
        id: Date.now(),
        number: nextNumber,
        text: selectedText,
        note: ''
    };

    // åœ¨é€‰ä¸­æ–‡å­—åæ’å…¥å¸¦åœˆæ•°å­—
    const circledNumber = getCircledNumber(nextNumber);
    const span = document.createElement('span');
    span.style.color = '#0066cc';
    span.style.fontSize = '0.85em';
    span.style.verticalAlign = 'super';
    span.textContent = circledNumber;
    
    range.collapse(false);
    range.insertNode(span);

    // ä¿å­˜æ³¨è§£
    if (!noteAnnotations[noteId]) {
        noteAnnotations[noteId] = [];
    }
    noteAnnotations[noteId].push(annotation);
    
    // æ¸…é™¤é€‰åŒº
    selection.removeAllRanges();
    
    // é‡æ–°æ¸²æŸ“æ³¨è§£åˆ—è¡¨
    renderAnnotations(noteId);
}

            
            function getCircledNumber(num) {
                const circledNumbers = ['â“ª','â‘ ','â‘¡','â‘¢','â‘£','â‘¤','â‘¥','â‘¦','â‘§','â‘¨','â‘©',
                                       'â‘ª','â‘«','â‘¬','â‘­','â‘®','â‘¯','â‘°','â‘±','â‘²','â‘³'];
                if (num <= 20) {
                    return circledNumbers[num];
                }
                return `(${num})`;
            }

            // æ¸²æŸ“æ³¨è§£åˆ—è¡¨
            function renderAnnotations(noteId) {
    const annotationsContainer = document.getElementById(`annotations-${noteId}`);
    if (!annotationsContainer) return;

    const annotations = noteAnnotations[noteId] || [];
    
    if (annotations.length === 0) {
        annotationsContainer.innerHTML = '<div style="color: #999; font-size: 14px;">æš‚æ— æ³¨è§£</div>';
        return;
    }

    annotationsContainer.innerHTML = annotations.map(ann => `
        <div style="margin-bottom: 15px; padding: 10px; border: 2px solid black; background-color: white;">
            <div style="margin-bottom: 5px;">
                <span>${getCircledNumber(ann.number)}</span>
                <span style="color: black; font-size: 14px;">"${ann.text}"</span>
                <button onclick="deleteAnnotationFromArea('${noteId}', '${ann.id}')" style="float: right; padding: 0px 8px; border: 2px solid black; background: white; cursor: pointer; font-size: 12px;">åˆ é™¤</button>
            </div>
            <textarea id="annotation-note-${ann.id}" style="width: 100%; min-height: 60px; padding: 5px; border: 2px solid black; font-size: 13px;" placeholder="åœ¨æ­¤è¾“å…¥æ³¨è§£å†…å®¹...">${ann.note}</textarea>
        </div>
    `).join('');

    // ç»‘å®štextareaçš„changeäº‹ä»¶
    annotations.forEach(ann => {
        const textarea = document.getElementById(`annotation-note-${ann.id}`);
        if (textarea) {
            textarea.addEventListener('input', function() {
                const annotation = noteAnnotations[noteId].find(a => a.id === ann.id);
                if (annotation) {
                    annotation.note = this.value;
                }
            });
        }
    });
}


        
   
// ä¿å­˜ç¼–è¾‘çš„ç¬”è®°
// ä¿å­˜ç¼–è¾‘çš„ç¬”è®°
window.saveEditNote = async function (noteId) {
    const contentElement = document.getElementById(`edit-content-${noteId}`);
    const pageStartElement = document.getElementById(`edit-pageStart-${noteId}`);
    const pageEndElement = document.getElementById(`edit-pageEnd-${noteId}`);

    // è·å–åŒ…å«HTMLçš„å†…å®¹
    let htmlContent = contentElement.innerHTML;
    
    // ç§»é™¤æ—§çš„å¸¦åœˆæ•°å­—æ ‡è®°ï¼ˆæ¥è‡ªä¹‹å‰çš„çŠ¶æ€ï¼‰
    htmlContent = htmlContent.replace(/<span[^>]*>[â‘ -â‘³â“ª]<\/span>/g, '');
    htmlContent = htmlContent.replace(/[â‘ -â‘³â“ª]/g, '');
    

 // è½¬æ¢ä¸ºçº¯æ–‡æœ¬
 htmlContent = htmlContent
        .replace(/<div>/g, '\n') // <div> è½¬æ¢ä¸ºæ¢è¡Œ
        .replace(/<\/div>/g, '') // ç§»é™¤ </div>
        .replace(/<br>/g, '\n')  // <br> è½¬æ¢ä¸ºæ¢è¡Œ
        .replace(/<br\s*\/?>/g, '\n') // å¤„ç†å„ç§æ ¼å¼çš„<br>
        .replace(/&nbsp;/g, ' ') // &nbsp; è½¬æ¢ä¸ºç©ºæ ¼
        .replace(/<[^>]+>/g, '') // ç§»é™¤å…¶ä»–æ‰€æœ‰HTMLæ ‡ç­¾
        .trim();
    
    // å°†å†…å®¹åˆ†å‰²ä¸ºè¡Œ
    let content = htmlContent;
    
    // ä¸ºæ¯æ®µæ·»åŠ ä¸¤ä¸ªå…¨è§’ç©ºæ ¼
    content = content.split('\n').map(para => {
        const trimmed = para.trim();
        if (trimmed === '') {
            return ''; // ä¿æŒç©ºè¡Œ
        }
        
        let cleanPara = trimmed.replace(/^ã€€+/g, '');
        return 'ã€€ã€€' + cleanPara;
    }).join('\n');
    
    // è·å–å½“å‰çš„æ³¨è§£æ•°ç»„
    const annotations = noteAnnotations[noteId] || [];
    
    // å¦‚æœæœ‰æ³¨è§£ï¼Œåœ¨å†…å®¹ä¸­æ’å…¥æ–°çš„å¸¦åœˆæ•°å­—æ ‡è®°
    if (annotations.length > 0) {
        // æŒ‰numberæ’åº
        const sortedAnnotations = [...annotations].sort((a, b) => a.number - b.number);
        
        // ä¸ºæ¯ä¸ªæ³¨è§£æŸ¥æ‰¾æ–‡æœ¬å¹¶æ’å…¥æ ‡è®°
        sortedAnnotations.forEach(ann => {
            if (ann.text && content.includes(ann.text)) {
                const circledNum = getCircledNumber(ann.number);
                // åªæ›¿æ¢ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
                const regex = new RegExp(ann.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                let count = 0;
                content = content.replace(regex, (match) => {
                    count++;
                    return count === 1 ? match + circledNum : match;
                });
            }
        });
    }
    
    const pageStart = pageStartElement.value;
    const pageEnd = pageEndElement.value;

    // é‡ç½®è¾¹æ¡†é¢œè‰²
    pageStartElement.style.borderColor = 'black';
    pageEndElement.style.borderColor = 'black';

    if (!content || content.trim() === '') {
        alert('è¯·è¾“å…¥ç¬”è®°å†…å®¹');
        return;
    }

    // éªŒè¯é¡µç ï¼šå¿…é¡»è‡³å°‘å¡«å†™èµ·å§‹é¡µ
    if (!pageStart) {
        alert('è¯·å¡«å†™é¡µç ');
        return;
    }

    // å¦‚æœå¡«å†™äº†ç»“æŸé¡µï¼ŒéªŒè¯ç»“æŸé¡µä¸èƒ½å°äºèµ·å§‹é¡µ
    if (pageEnd && parseInt(pageEnd) < parseInt(pageStart)) {
        alert('ç»“æŸé¡µä¸èƒ½å°äºèµ·å§‹é¡µ');
        return;
    }

    try {
        // å…ˆæ›´æ–°ç¬”è®°å†…å®¹ï¼ˆåŒ…å«é‡æ–°ç¼–å·åçš„æ ‡è®°ï¼‰
        const { error: noteError } = await supabase
            .from('book_notes')
            .update({
                content: content, // ä¿å­˜é‡æ–°ç¼–å·åçš„å†…å®¹
                page_start: parseInt(pageStart),
                page_end: pageEnd ? parseInt(pageEnd) : null,
                updated_at: new Date().toISOString()
            })
            .eq('id', noteId);

        if (noteError) throw noteError;
        
        // ä¿å­˜æ³¨è§£åˆ°æ•°æ®åº“ï¼ˆä½¿ç”¨é‡æ–°ç¼–å·åçš„åºå·ï¼‰
        if (annotations.length > 0) {
            // åˆ é™¤æ—§çš„æ³¨è§£
            const { error: deleteError } = await supabase
                .from('note_annotations')
                .delete()
                .eq('note_id', noteId);
            
            if (deleteError) throw deleteError;
            
            // æ’å…¥æ–°çš„æ³¨è§£ï¼ˆæŒ‰é‡æ–°ç¼–å·åçš„é¡ºåºï¼‰
            const annotationsToInsert = annotations.map((ann) => ({
                note_id: noteId,
                original_text: ann.text,
                annotation_text: ann.note || '',
                display_order: ann.number, // ä½¿ç”¨é‡æ–°ç¼–å·åçš„åºå·
                created_at: new Date().toISOString()
            }));
            
            const { error: insertError } = await supabase
                .from('note_annotations')
                .insert(annotationsToInsert);
                
            if (insertError) throw insertError;
        } else {
            // å¦‚æœæ²¡æœ‰æ³¨è§£ï¼Œåˆ é™¤æ‰€æœ‰ç›¸å…³æ³¨è§£
            await supabase
                .from('note_annotations')
                .delete()
                .eq('note_id', noteId);
        }
        
        // æ¸…é™¤ç¼“å­˜
        if (bookNotesCache[currentBookId]) {
            delete bookNotesCache[currentBookId];
        }
        
        // æ¸…é™¤å½“å‰ç¬”è®°çš„æ³¨è§£ç¼“å­˜
        if (noteAnnotations[noteId]) {
            delete noteAnnotations[noteId];
        }

        // é‡æ–°åŠ è½½ç¬”è®°åˆ—è¡¨
        await loadUserNotes(currentBookId);
        await updateBookCounts();

        // å¦‚æœç¬”è®°åŒºåŸŸæ˜¯å±•å¼€çš„ï¼Œåˆ·æ–°å®ƒ
        const notesArea = document.getElementById(`notes-area-${currentBookId}`);
        if (notesArea && notesArea.classList.contains('show')) {
            // é‡æ–°åŠ è½½æ‰€æœ‰ç¬”è®°
            await loadAllNotes(currentBookId);
            
            // æ‰¾åˆ°å½“å‰ç¬”è®°çš„æ–°ç´¢å¼•
            const notes = bookNotesCache[currentBookId] || [];
            const currentIndex = notes.findIndex(note => note.id === noteId);
            if (currentIndex !== -1) {
                currentNoteIndex[currentBookId] = currentIndex;
            }
            
            // é‡æ–°æ˜¾ç¤ºå½“å‰ç¬”è®°
            await displayCurrentNote(currentBookId);
        }

        

    } catch (error) {
        console.error('æ›´æ–°ç¬”è®°å¤±è´¥:', error);
        alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}


            window.deleteNote = async function (noteId) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('book_notes')
                        .delete()
                        .eq('id', noteId);

                    if (error) throw error;

                    await loadUserNotes(currentBookId);
                    await updateBookCounts();

                    // å¦‚æœç¬”è®°åŒºåŸŸæ˜¯å±•å¼€çš„ï¼Œåˆ·æ–°å®ƒ
                    const notesArea = document.getElementById(`notes-area-${currentBookId}`);
                    if (notesArea && notesArea.classList.contains('show')) {
                        await loadAllNotes(currentBookId);
                        // å¦‚æœå½“å‰ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œè°ƒæ•´åˆ°æœ€åä¸€æ¡
                        const notes = bookNotesCache[currentBookId] || [];
                        if (currentNoteIndex[currentBookId] >= notes.length) {
                            currentNoteIndex[currentBookId] = Math.max(0, notes.length - 1);
                        }
                        displayCurrentNote(currentBookId);
                    }

                } catch (error) {
                    console.error('åˆ é™¤ç¬”è®°å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }



         // æ‰“å°ç¬”è®°åŠŸèƒ½
window.printNote = function(bookId, noteIndex) {
    const notes = bookNotesCache[bookId] || [];
    if (notes.length === 0 || noteIndex >= notes.length) {
        alert('æ²¡æœ‰å¯æ‰“å°çš„ç¬”è®°');
        return;
    }

    const note = notes[noteIndex];
    const bookData = window.BOOKS_DATA[bookId];
    const bookTitle = bookData ? bookData.title : 'æœªçŸ¥ä¹¦ç±';
    const bookImgSrc = bookData ? bookData.imgSrc : '';
    
    // è·å–æ³¨è§£
    getNoteAnnotations(note.id).then(annotations => {
        // åˆ›å»ºæ‰“å°çª—å£
        const printWindow = window.open('', '_blank');
        
        let pageInfo = '';
        if (note.page_start && note.page_end) {
            pageInfo = `P${note.page_start}-${note.page_end}`;
        } else if (note.page_start) {
            pageInfo = `P${note.page_start}`;
        }

        const annotationsHtml = renderAnnotationsForPrint(annotations);

        const printContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>æ‰“å°ç¬”è®° - ${bookTitle}</title>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                        padding: 15px;
                        max-width: 800px;
                        margin: 0 auto;
                    }
                    .book-meta {
                        font-size: 14px;
                        margin-bottom: 15px;
                        line-height: 1.6;
                        text-align: center;
                    }
                    .book-title {
                        font-size: 22px;
                        font-weight: bold;
                        margin-bottom: 10px;
                        text-align: center;
                    }
                    .page-info {
                        margin-top: -5px;
                        font-size: 14px;
                        text-align: center;
                    }
                    .header {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        margin-bottom: 20px;
                        width: 100%;
                    }
                    .book-cover {
                        width: 250px;          
                        object-fit: cover;
                        margin-bottom: 20px;
                    }
                    .book-info {
                        text-align: center;
                        width: 100%;
                    }
               
                    .note-content {
                        font-size: 13px;
                        line-height: 1.6;
                        white-space: pre-wrap;
                        margin-bottom: 20px;
                    }
                    .annotations-section {
                        margin-top: 30px;
                        padding-top: 20px;
                        border-top: 1px solid #ddd;
                    }
                    .annotations-title {
                        font-weight: bold;
                        margin-bottom: 10px;
                        font-size: 14px;
                    }
                    .annotation-item {
                        margin-bottom: 10px;
                        line-height: 1.5;
                         font-size: 13px;
                    }
                    .annotation-marker {
                        color: black;
                        font-weight: bold;
                        margin-right: 8px;
                    }
                    .print-date {
                        margin-top: 20px;
                        font-size: 12px;
                        text-align: center
                    }
                        .disclaimer{
                        font-size: 11px;
                         text-align: center;
                        }
                    @media print {
                      @page {
        margin: 0 !important;  /* ç§»é™¤æ‰€æœ‰é¡µè¾¹è· */
        size: auto;
    }
                        body {
                            align-items: center;
                           
                        }
                        
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    ${bookImgSrc ? `
                        <img class="book-cover" src="${bookImgSrc}" alt="${bookTitle}" onerror="this.style.display='none'">
                    ` : ''}
                    <div class="book-info">
                        <div class="book-title">${bookTitle}</div>
                        <div class="book-meta">
                            ${bookData ? `
                                ${bookData.author || ''}
                                ${bookData.translator ? ' / ' + bookData.translator : ''}
                                ${bookData.publisher ? ' / ' + bookData.publisher : ''}
                                ${bookData.publishDate ? ' / ' + bookData.publishDate : ''}
                            ` : ''}
                        </div>
                        ${pageInfo ? `<div class="page-info">${pageInfo}</div>` : ''}
                    </div>
                </div>
                
                <div class="note-content">${note.content}</div>
                
                ${annotationsHtml}
                
                <div class="print-date">
                    CREATED AT: ${new Date(note.created_at).toLocaleString('zh-CN')}<br>
                    PRINTED AT: ${new Date().toLocaleString('zh-CN')}
                    
                </div>
                <div class="disclaimer">è‘—ä½œæƒå½’åŸä½œè€…æ‰€æœ‰ï¼Œç¬”è®°ä»…ä¾›ä¸ªäººå­¦ä¹ ä½¿ç”¨
                    <br>
                    Copyright belongs to the original author(s). These notes are for personal study use only.</div>
                <script>
                    window.onload = function() {
                        setTimeout(function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 5000);
                        }, 500);
                    }
                <\\/script>
            <\\/body>
            <\\/html>
        `;

        printWindow.document.write(printContent);
        printWindow.document.close();
    });
};

// æ¸²æŸ“æ‰“å°ç”¨çš„æ³¨è§£
function renderAnnotationsForPrint(annotations) {
    if (!annotations || annotations.length === 0) {
        return '';
    }

    // æŒ‰æ˜¾ç¤ºé¡ºåºæ’åº
    const sortedAnnotations = [...annotations].sort((a, b) => a.display_order - b.display_order);
    
    return `
        <div class="annotations-section">
            <div class="annotations-title">æ³¨è§£:</div>
            ${sortedAnnotations.map(ann => `
                <div class="annotation-item">
                    <span class="annotation-marker">${getCircledNumber(ann.display_order)}</span>
                    <span class="annotation-text">${ann.annotation_text}</span>
                </div>
            `).join('')}
        </div>
    `;
}

            // ç‚¹å‡»Modalå¤–éƒ¨å…³é—­
            document.getElementById('noteModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeNoteModal();
                }
            });

        })();</script><script defer="defer" src="/js/vendors.515c171d2c3970a6f856.js"></script><script defer="defer" src="/js/styles.ce885c7f7bfcf71c21e1.js"></script><script defer="defer" src="/js/global.3120b01887ec508766ae.js"></script></body>