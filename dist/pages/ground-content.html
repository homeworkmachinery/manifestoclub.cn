<link rel="stylesheet" href="/lib/pdfReader.css"><style>* {
        padding: 0;
        margin: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;

    }
    .container {
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
 
    align-items: start; /* ä¿®æ”¹ä¸ºä»é¡¶éƒ¨å¯¹é½ï¼Œè®©é«˜åº¦è‡ªç„¶å»¶ä¼¸ */
}

  

    /* é¡¶éƒ¨å¯¼èˆª */
    .nav-header {
        border: 2px solid black;
        padding: 5px;
        margin-bottom: 20px;
        background-color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: calc(100% - 40px);
        position: fixed;
        top: 100px;
        z-index:100;

    }

    .nav-header h1 {
        font-size: 24px;
    }

    .back-btn {

        color: black;
        text-decoration: none;
        cursor: pointer;
        font-size: 16px;

    }






    /* å·¦ä¾§å›¾ç‰‡åŒºåŸŸ */
    .panel-left {
    grid-column: 1;
    margin-top: 60px;
    border: 2px solid black;
    overflow: hidden; /* ç¡®ä¿å›¾ç‰‡è¶…å‡ºæ—¶è¢«è£å‰ª */
    position: relative;
    /* é«˜åº¦å°†ç”±JavaScriptè®¾ç½® */
}

.panel-left img {
    width: 100%;
    height: 100%; /* å¡«å……æ•´ä¸ªå®¹å™¨ */
    object-fit: cover; /* å…³é”®ï¼šè£å‰ªä»¥å¡«å…… */
    object-position: center center; /* è£å‰ªæ—¶ä¿æŒä¸­å¿ƒ */
    display: block;
}


    /* å³ä¾§ä¿¡æ¯åŒºåŸŸ */
    .panel-right {
        grid-column: 2;
    grid-row: 1;
    padding: 30px;
    display: flex;
    flex-direction: column;
    border: 2px solid black;
    margin-top: 60px;
}

    .product-title {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }

    .product-name {
        font-style: italic;
    }

    .product-year {
        font-size: 16px;
        color: #666;
        margin-bottom: 20px;
    }

    .product-price {
        font-size: 32px;
        font-weight: bold;
        color: black;
        margin-bottom: 20px;
    }

    .product-category {
        margin-bottom: 15px;
    }

    .category-label {
        font-size: 14px;
        color: black;
        margin-bottom: 8px;
    }

    .category-value {
        font-size: 16px;
        padding: 5px;
        display: inline-block;
        border: 2px solid black;
    }

    .add-to-cart-btn {
        width: 100%;
        padding: 10px;
        background-color: black;
        color: white;
        border: none;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
    }



    .stock-info {
        font-size: 14px;
        color: black;
        margin-bottom: 20px;
    }




    /* è¯¦æƒ…åŒºåŸŸ */
    .product-details {
    grid-column: 1 / span 2;
    grid-row: 2;
    width: 100%;
    margin-top: 20px;
}

    .details-header {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 15px;
        padding-bottom: 15px;

    }

    .details-content {
        line-height: 1.8;
    

    }

    .details-content img {
        width: 100%;
        max-width: 100%;
        height: auto;
        display: block;
    }


    .details-content h3 {
        font-size: 18px;
        margin: 15px 0 15px 0;
        color: black;
    }

    .details-content p {
        margin-bottom: 15px;
        font-size: 16px;
    }

    .details-content ul {
        margin-left: 20px;
        margin-bottom: 20px;
    }

    .details-content li {
        margin-bottom: 10px;
        font-size: 15px;
    }

    .detail-images {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .detail-images img {
        width: 100%;
        height: auto;

    }







    .game-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 10px;
    }

    .game-option {
        padding: 5px;
        border: 2px solid black;
        background-color: white;
        cursor: pointer;
        text-align: center;
    }

    .game-option:hover {
        background-color: black;
        color: white;
    }

    .game-option.selected {
        border-color: black;
        background-color: black;
        color: white;
    }

    .game-name {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 4px;
    }

    .game-desc {
        font-size: 11px;
        opacity: 0.8;
    }


@media (max-width: 768px) {
    
    .container {
        display: flex;
        flex-direction: column;
        width: 100%;
        box-sizing: border-box;
        padding: 0;
    }
  
  
 
      .panel-left {
      
        width: 100%;
        box-sizing: border-box;
        position: relative;
        background: transparent !important; /* å¼ºåˆ¶é€æ˜èƒŒæ™¯ */
        border: 2px solid black;
        overflow: hidden;
        z-index: 1; /* é™ä½z-index */
    }
  .container {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    

    
    /* ä¿®å¤7ï¼šbodyé»˜è®¤è¾¹è· */
    body {
        padding: 0 !important;
        margin: 0 !important;
        overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»šåŠ¨ */
    }
    
    /* ä¿®å¤8ï¼šproduct-detailsè¾¹è·é—®é¢˜ */
    .product-details {
        margin-top: 5px;
        padding: 0 !important;
        width: 100%;
        box-sizing: border-box;
    }
    
    /* ä¿®å¤9ï¼šç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½æ­£ç¡®ç›’æ¨¡å‹ */
    * {
        box-sizing: border-box;
    }

  .panel-right {
        grid-column: 1;
        grid-row: 3;
        width: 100%;
        order: 3;
        position: relative;
        right: auto;
        top: auto;
        margin-top: 0px;
   
    }
    

}


  @media(max-width:768px) {
        .game-options {
            grid-template-columns: repeat(3, 1fr);
        }

        .nav-header {
            margin-top: -20px;
            width: calc(100% - 20px);
        }

        .panel-left {
            width: 100%;
            margin-top: 55px;
        }

        .panel-right {
            position: relative;
            width: 100%;
            right: 0px;
            top: -10px;
            padding: 15px;
        }

        .product-details {
            width: 100%;
            right: 0px;
            top: 0px;
            margin-top: 5px;
            padding: 5px;
        }
    }</style><link href="/css/styles.b042754357efc2e19b1c.css" rel="stylesheet"><body><div class="container"><div class="nav-header"><h1>BOOKS</h1><a data-page="ground-ip" class="back-btn">â† BACK TO GROUND</a></div><div class="panel-left"><img id="mainImage" src="" alt="Product Image"></div><div class="panel-right"><h2 class="product-title" id="productName">Loading...</h2><p class="product-name" id="productTitle">-</p><div class="product-price" id="productPrice">$0</div><div class="stock-info"></div><button class="add-to-cart-btn" id="addToCartBtn">ADD TO CART</button></div><div class="product-details"><div class="details-content" id="productDetails"></div></div></div><div class="print-modal-overlay" id="printModalOverlay"><div class="print-modal"><div class="print-modal-header"><h3>Select Print Pages</h3><button class="close-modal-btn" id="closePrintModalBtn">Ã—</button></div><div class="print-modal-content" id="printModalContent"></div><div class="print-modal-footer"><button class="cancel-btn" id="cancelPrintBtn">Cancel</button> <button class="confirm-print-btn" id="confirmPrintBtn" disabled="disabled">Print Selected Pages</button></div></div></div><script defer="defer" src="/js/vendors.515c171d2c3970a6f856.js"></script><script defer="defer" src="/js/styles.42c0758976f42d12a89f.js"></script><script defer="defer" src="/js/global.d3e7bfb9867a43954787.js"></script></body><script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script><script src="/lib/pdfReader.js"></script><script>(function () {
    
            function syncPanelHeights() {
    const leftPanel = document.querySelector('.panel-left');
    const rightPanel = document.querySelector('.panel-right');
    
    if (!leftPanel || !rightPanel) return;
    
    // è·å–å³ä¾§é¢æ¿çš„å®é™…é«˜åº¦
    const rightHeight = rightPanel.offsetHeight;
    
    // è®¾ç½®å·¦ä¾§é¢æ¿é«˜åº¦ä¸å³ä¾§ç›¸åŒ
    leftPanel.style.height = rightHeight + 'px';
    
    console.log('å·¦ä¾§é¢æ¿é«˜åº¦å·²è®¾ç½®ä¸º:', rightHeight, 'px');
}

// åœ¨å›¾ç‰‡åŠ è½½åé‡æ–°è®¡ç®—é«˜åº¦
function handleImageLoad() {
    setTimeout(syncPanelHeights, 100); // å»¶è¿Ÿç¡®ä¿DOMå·²æ›´æ–°
}

// åœ¨é¡µé¢åŠ è½½åè°ƒæ•´å›¾ç‰‡å®¹å™¨é«˜åº¦
window.addEventListener('load', function() {
    syncPanelHeights();
    // æ·»åŠ å›¾ç‰‡åŠ è½½ç›‘å¬
    const mainImage = document.getElementById('mainImage');
    if (mainImage) {
        mainImage.addEventListener('load', handleImageLoad);
    }
});

// DOM åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒæ­¥
    setTimeout(syncPanelHeights, 500);
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', syncPanelHeights);
    
    // ç›‘å¬æ¸¸æˆé€‰æ‹©å™¨çš„ç‚¹å‡»ï¼ˆå¦‚æœä½ çš„é¡µé¢æœ‰ï¼‰
    const gameOptions = document.querySelectorAll('.game-option');
    if (gameOptions.length > 0) {
        gameOptions.forEach(option => {
            option.addEventListener('click', function() {
                // å›¾ç‰‡åˆ‡æ¢åé‡æ–°è®¡ç®—é«˜åº¦
                setTimeout(syncPanelHeights, 300);
            });
        });
    }
});



            async function getCurrentUser() {
                // ä¼˜å…ˆä½¿ç”¨ authManager
                if (window.authManager && window.authManager.isAuthenticated()) {
                    return window.authManager.getCurrentUser();
                }

                // å¤‡ç”¨ï¼šä½¿ç”¨ Supabase
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    return user;
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·å¤±è´¥:', error);
                    return null;
                }
            }

     async function checkUserLogin() {
    const user = await getCurrentUser();
    if (!user) {
        // ç›´æ¥è°ƒç”¨ç°æœ‰çš„è®¤è¯å‡½æ•°æ‰“å¼€ç™»å½• modal
        if (typeof window.openAuthModal === 'function') {
            window.openAuthModal();
        }
        if (typeof window.showLoginForm === 'function') {
            window.showLoginForm();
        }
      
    
        return null;
    }
    return user;
}


            if (!window.currentPageParams) {
                window.currentPageParams = {};
            }

            function cleanupContentPage() {
                console.log('Cleaning up content page...');
                // æ¸…ç†å…¨å±€å˜é‡
                delete window.currentProduct;
                delete window.cleanupContentPage;

                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                const backBtn = document.querySelector('.back-btn');
                if (backBtn && window.contentBackHandler) {
                    backBtn.removeEventListener('click', window.contentBackHandler);
                }

                const addBtn = document.getElementById('addToCartBtn');
                if (addBtn && window.contentAddToCartHandler) {
                    addBtn.removeEventListener('click', window.contentAddToCartHandler);
                }

                delete window.contentBackHandler;
                delete window.contentAddToCartHandler;
            }

            // å…ˆæ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§å†…å®¹
            if (typeof window.cleanupContentPage === 'function') {
                window.cleanupContentPage();
            }

            const PRODUCT_CACHE = new Map();
            // äº§å“æ•°æ®åº“
            const productDatabase = {
                '001': {
                    name: 'From Pirate Printing Presses to Feudal Digital Societies',
                    title:"ä»ç›—ç‰ˆå°åˆ·æœºåˆ°å°å»ºæ•°å­—ç¤¾ä¼š",
                    price: 'Â¥45',
                    category: 'Game Cartridge',
                    mainImage: '/images/library/ground-ip/001/000.png',
                    // pdfUrl: '/images/library/ground-ip/001.pdf',
                    imagesFolder:'/images/library/ground-ip/001',
                    variants: {
                        'a': {
                            name: 'Simplified Chinese',
                            image: '',
                            description: 'ç®€ä¸­'
                        },
                      
                        'b': {
                            name: 'English',
                            image: '',
                            description: 'è‹±æ–‡'
                        },
                                        
                    },

                    description: `
                
                    `
                }
            };


            function renderGameSelector(product, productId) {
                // åªä¸ºäº§å“5æ·»åŠ æ¸¸æˆé€‰æ‹©å™¨
                if (productId !== '001' || !product.variants) {
                    return;
                }

                const existingSelector = document.querySelector('.game-options');
                if (existingSelector) {
                    existingSelector.remove();
                }

                const stockInfo = document.querySelector('.stock-info');
                if (stockInfo) {
                    const selectorHTML = `
            <div class="game-options">
                ${Object.entries(product.variants).map(([key, variant]) => `
                    <div class="game-option" data-variant="${key}">
                        <div class="game-name">${variant.name}</div>
                        <div class="game-desc">${variant.description}</div>
                    </div>
                `).join('')}
            </div>
        `;

                    stockInfo.insertAdjacentHTML('beforebegin', selectorHTML);
                    bindGameSelectionEvents(product);
                }
            }


            // 3. æ·»åŠ æ¸¸æˆé€‰æ‹©äº‹ä»¶å¤„ç†
            function bindGameSelectionEvents(product) {
                const mainImage = document.getElementById('mainImage');
                const gameOptions = document.querySelectorAll('.game-option');

                // åˆ›å»ºäº‹ä»¶å¤„ç†å™¨ï¼ˆé¿å…é—­åŒ…é—®é¢˜ï¼‰
                const handleGameClick = (e) => {
                    const option = e.currentTarget;
                    const variantKey = option.dataset.variant;
                    const variant = product.variants[variantKey];

                    if (!variant) return;

                    // æ›´æ–°é€‰ä¸­çŠ¶æ€
                    gameOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');

                    // æ›´æ–°ä¸»å›¾
                    if (mainImage && variant.image) {
                        mainImage.src = variant.image;
                        mainImage.alt = variant.name;
                    }

                    // ä¿å­˜é€‰ä¸­çš„å˜ä½“
                    window.currentProduct.selectedVariant = {
                        key: variantKey,
                        ...variant
                    };

                    console.log('é€‰ä¸­æ¸¸æˆ:', variant.name);
                };

                // ç»‘å®šäº‹ä»¶
                gameOptions.forEach((option, index) => {
                    option.addEventListener('click', handleGameClick);
                    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
                    if (index === 0) {
                        option.click();
                    }
                });
            }

            // åŠ è½½äº§å“ä¿¡æ¯
            function loadProduct() {
                console.log('Content page: Loading product information...');

                let productId = null;

                // ä¼˜å…ˆä»URLå‚æ•°è·å–
                if (window.currentPageParams?.id) {
                    productId = window.currentPageParams.id;
                } else {
                    // å°è¯•ä» sessionStorage è·å–
                    try {
                        const pendingData = sessionStorage.getItem('pendingProduct');
                        if (pendingData) {
                            const data = JSON.parse(pendingData);
                            productId = data.id;
                            sessionStorage.removeItem('pendingProduct');
                        }
                    } catch (e) {
                        console.error('è§£æ pending product å¤±è´¥:', e);
                    }
                }

                if (!productId) {
                    showError('No product ID found');
                    return;
                }

                // âœ… ä¼˜åŒ–ï¼šæ£€æŸ¥ç¼“å­˜
                if (PRODUCT_CACHE.has(productId)) {
                    console.log('ğŸ“¦ ä½¿ç”¨ç¼“å­˜çš„äº§å“:', productId);
                    updatePageContent(PRODUCT_CACHE.get(productId), productId);
                    return;
                }

                const product = productDatabase[productId];
                if (product) {
        // ç¼“å­˜äº§å“
        PRODUCT_CACHE.set(productId, product);
        updatePageContent(product, productId);
        
        // å›¾ç‰‡åŠ è½½å®ŒæˆååŒæ­¥é«˜åº¦
        const mainImage = document.getElementById('mainImage');
        if (mainImage) {
            mainImage.onload = function() {
                setTimeout(syncPanelHeights, 200);
            };
        }}
                
                if (!product) {
                    showError('Product not found');
                    return;
                }
  

            }



            // æ›´æ–°é¡µé¢å†…å®¹
            function updatePageContent(product, productId) {
    // æ›´æ–°äº§å“ä¿¡æ¯ï¼ˆåŸæœ‰çš„ä»£ç ï¼‰
    const mainImage = document.getElementById('mainImage');
    if (mainImage) {
        mainImage.src = product.mainImage || `/images/merch/${productId}.jpg`;
        mainImage.alt = product.name;
    }

    // æ›´æ–°äº§å“ä¿¡æ¯
    const elements = {
        'productName': product.name,
        'productTitle': product.title,
        'productPrice': product.price,
        'productCategory': product.category
    };

    for (const [id, content] of Object.entries(elements)) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = content;
        }
    }

    // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ä¹¦ç±äº§å“ï¼Œæ˜¾ç¤ºPDFé¢„è§ˆ
    if (productId === '001') { // ä½ çš„ä¹¦ç±äº§å“ID
        renderPDFPreview(product);
    } else {
        // å…¶ä»–äº§å“æ˜¾ç¤ºæ™®é€šè¯¦æƒ…
        const detailsEl = document.getElementById('productDetails');
        if (detailsEl) {
            detailsEl.innerHTML = product.description || '';
        }
    }

    // å­˜å‚¨å½“å‰äº§å“ä¿¡æ¯
    window.currentProduct = {
        ...product,
        id: productId
    };

    renderGameSelector(product, productId);
    console.log('Product loaded successfully:', product.name);
}


            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            function showError() {
                const nameEl = document.getElementById('productName');
                const detailsEl = document.getElementById('productDetails');

                if (nameEl) nameEl.textContent = 'Product Not Found';
                if (detailsEl) detailsEl.innerHTML = '<p>Sorry, this product could not be found.</p>';
            }

            // åˆå§‹åŒ–
            function initContentPage() {
                console.log('Initializing content page...');

                // ç«‹å³åŠ è½½äº§å“
                loadProduct();
                setTimeout(() => {
                    try {
                        const usedProduct = sessionStorage.getItem('pendingProduct');
                        if (usedProduct) {
                            console.log('Cleaning up used sessionStorage data');
                            sessionStorage.removeItem('pendingProduct');
                            sessionStorage.removeItem('lastProductClick');
                        }
                    } catch (e) {
                        console.error('Error cleaning sessionStorage:', e);
                    }
                }, 1000);
                // ç›‘å¬URLå‚æ•°å˜åŒ–
                window.paramsEventHandler = function (event) {
                    if (event.detail.page === 'ground-content') {
                        console.log('URL parameters changed, reloading product:', event.detail.params);
                        // æ›´æ–°å‚æ•°å¹¶é‡æ–°åŠ è½½
                        window.currentPageParams = event.detail.params;
                        loadProduct();
                    }
                };
                window.addEventListener('pageParamsLoaded', window.paramsEventHandler);



                // ç»‘å®šè¿”å›æŒ‰é’®
                const backBtn = document.querySelector('.back-btn');
                if (backBtn) {
                    backBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        // ä½¿ç”¨è·¯ç”±å¯¼èˆªè¿”å›å•†å“åˆ—è¡¨é¡µ
                        if (window.router && window.router.navigate) {
                            window.router.navigate('ground-ip');
                        } else if (typeof window.loadPage === 'function') {
                            window.loadPage('ground-ip');
                        }
                    });
                }

                // ç»‘å®šæ·»åŠ åˆ°è´­ç‰©è½¦æŒ‰é’®
                const addBtn = document.getElementById('addToCartBtn');
                if (addBtn) {
                    addBtn.addEventListener('click', handleAddToCart);
                }
            }

            // æ·»åŠ åˆ°è´­ç‰©è½¦å¤„ç†å‡½æ•°
async function handleAddToCart() {
    const addBtn = document.getElementById('addToCartBtn');
    if (!addBtn) return;
    
    // ä¿å­˜åŸå§‹æŒ‰é’®çŠ¶æ€
    const originalText = addBtn.textContent;
    const originalBg = addBtn.style.backgroundColor || 'black';
    
    try {
        if (!window.currentProduct) {
            alert('äº§å“ä¿¡æ¯æœªåŠ è½½');
            restoreButtonState(addBtn, originalText, originalBg);
            return;
        }

        const product = window.currentProduct;
        console.log('Adding console product to cart:', product.name);

        // æ˜¾ç¤º"æ·»åŠ ä¸­"çŠ¶æ€
        addBtn.textContent = 'ADDING...';
        addBtn.style.backgroundColor = '#666'; // ç°è‰²è¡¨ç¤ºå¤„ç†ä¸­
        addBtn.disabled = true;

        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        const user = await checkUserLogin();
        if (!user) {
            restoreButtonState(addBtn, originalText, originalBg);
            return;
        }

        // å‡†å¤‡å•†å“æ•°æ®
        const priceNumber = parseFloat(product.price.replace(/[^0-9.]/g, ''));

        // å‡†å¤‡å˜ä½“ä¿¡æ¯
        const selectedVariant = window.currentProduct.selectedVariant;
        const variantSuffix = selectedVariant ? `-${selectedVariant.key}` : '';
        const variantName = selectedVariant ? ` - ${selectedVariant.name}` : '';

        const cartItemData = {
            user_id: user.id,
            draft_id: null,
            type: `console-${product.id}${variantSuffix}`,
            quantity: 1,
            sizes: { 'default': 1 },
            price: priceNumber,
            total_price: priceNumber,
            item_data: {
                productId: product.id,
                productName: product.name + variantName,
                productDes: product.des,
                productCategory: product.category,
                productImage: selectedVariant?.image || product.mainImage || `/images/merch/${product.id}.jpg`,
                productType: 'retro-console',
                variantKey: selectedVariant?.key,
                variantName: selectedVariant?.name,
                variantDescription: selectedVariant?.description
            },
            added_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        console.log('ğŸ“¤ å‘é€åˆ°åç«¯çš„å®Œæ•´æ•°æ®:', JSON.stringify(cartItemData, null, 2));

        // è°ƒç”¨åç«¯ API
        const API_BASE_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3001'
            : '';

        // è·å– token
        let token;
        if (window.authManager && window.authManager.getToken) {
            token = window.authManager.getToken();
        }

        if (!token && window.supabase) {
            const { data: { session } } = await supabase.auth.getSession();
            token = session?.access_token;
        }

        if (!token) {
            alert('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
            restoreButtonState(addBtn, originalText, originalBg);
            return;
        }

        // å°è¯•è°ƒç”¨ä¸» API
        try {
            const response = await fetch(`${API_BASE_URL}/api/cart/add`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cartItemData
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'æœªçŸ¥é”™è¯¯' }));
                console.error('âŒ API é”™è¯¯:', errorData);
                alert('æ·»åŠ å¤±è´¥ï¼š' + (errorData.error || 'æœªçŸ¥é”™è¯¯'));
                restoreButtonState(addBtn, originalText, originalBg);
                return;
            }

            const result = await response.json();
            console.log('âœ… API å“åº”:', result);

            // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€ï¼ˆâœ“ ADDED TO CARTï¼‰
            showButtonSuccess(addBtn, originalText);

            // æ›´æ–°è´­ç‰©è½¦å¾½ç« 
            if (window.CartManager && window.CartManager.updateCartBadge) {
                await window.CartManager.updateCartBadge();
            }

        } catch (error) {
            console.error('âŒ API è°ƒç”¨å¤±è´¥:', error);

         
                restoreButtonState(addBtn, originalText, originalBg);
              
            
            console.log('ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥è°ƒç”¨ Supabase...');

            // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨ Supabase
            try {
                // å…ˆæ£€æŸ¥è´­ç‰©è½¦ä¸­æ˜¯å¦å·²æœ‰æ­¤äº§å“
                const { data: existingItems, error: fetchError } = await supabase
                    .from('cart_items')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('type', cartItemData.type);

                if (fetchError) {
                    console.error('Error checking existing items:', fetchError);
                    alert('æŸ¥è¯¢è´­ç‰©è½¦å¤±è´¥');
                    restoreButtonState(addBtn, originalText, originalBg);
                    return;
                }

                if (existingItems && existingItems.length > 0) {
                    // äº§å“å·²å­˜åœ¨ï¼Œæ›´æ–°æ•°é‡
                    const existingItem = existingItems[0];
                    const currentQty = existingItem.quantity || 1;
                    const newQty = currentQty + 1;

                    const { data, error } = await supabase
                        .from('cart_items')
                        .update({
                            quantity: newQty,
                            total_price: priceNumber * newQty,
                            sizes: { 'default': newQty },
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingItem.id)
                        .select()
                        .single();

                    if (error) {
                        console.error('Update error:', error);
                        alert('æ›´æ–°å¤±è´¥');
                        restoreButtonState(addBtn, originalText, originalBg);
                        return;
                    }

                    console.log('Updated existing item:', data);
                    showButtonSuccess(addBtn, originalText);

                } else {
                    // æ·»åŠ æ–°äº§å“åˆ°è´­ç‰©è½¦
                    const { data, error } = await supabase
                        .from('cart_items')
                        .insert(cartItemData)
                        .select()
                        .single();

                    if (error) {
                        console.error('Insert error:', error);

                        // å¦‚æœ item_data å­—æ®µä¸å­˜åœ¨ï¼Œå°è¯•ä¸åŒ…å«å®ƒ
                        if (error.message && error.message.includes('item_data')) {
                            console.log('Retrying without item_data field...');
                            delete cartItemData.item_data;

                            const { data: retryData, error: retryError } = await supabase
                                .from('cart_items')
                                .insert(cartItemData)
                                .select()
                                .single();

                            if (retryError) {
                                alert('æ·»åŠ å¤±è´¥ï¼š' + retryError.message);
                                restoreButtonState(addBtn, originalText, originalBg);
                                return;
                            }

                            console.log('Added to cart (without item_data):', retryData);
                        } else {
                            alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);
                            restoreButtonState(addBtn, originalText, originalBg);
                            return;
                        }
                    } else {
                        console.log('Added to cart:', data);
                    }

                    showButtonSuccess(addBtn, originalText);
                }

                // æ›´æ–°è´­ç‰©è½¦å¾½ç« 
                if (window.CartManager && window.CartManager.updateCartBadge) {
                    await window.CartManager.updateCartBadge();
                }

            } catch (fallbackError) {
                console.error('å¤‡ç”¨æ–¹æ¡ˆå¤±è´¥:', fallbackError);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                restoreButtonState(addBtn, originalText, originalBg);
            }
        }

    } catch (error) {
        console.error('Add to cart failed:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        restoreButtonState(addBtn, originalText, originalBg);
    }
}

// è¾…åŠ©å‡½æ•°ï¼šæ¢å¤æŒ‰é’®çŠ¶æ€
function restoreButtonState(button, originalText, originalBg) {
    if (!button) return;
    button.textContent = originalText;
    button.style.backgroundColor = originalBg;
    button.disabled = false;
}

// è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºæˆåŠŸçŠ¶æ€
function showButtonSuccess(button, originalText) {
    if (!button) return;
    
    // è®¾ç½®æˆåŠŸçŠ¶æ€
    button.textContent = 'âœ“ ADDED TO CART';
    button.style.backgroundColor = 'black';
    button.disabled = true;
    
    // è§¦å‘è´­ç‰©è½¦æ›´æ–°æ•ˆæœ
    if (window.CartManager) {
        if (window.CartManager.showCartAddedEffect) {
            window.CartManager.showCartAddedEffect();
        }
        if (window.CartManager.updateCartCount) {
            window.CartManager.updateCartCount();
        }
    }
    
    // å»¶è¿Ÿåæ¢å¤åŸçŠ¶
    setTimeout(() => {
        restoreButtonState(button, originalText, 'black');
    }, 2000);
}

            // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initContentPage);
            } else {
                initContentPage();
            }

            // SPAå¯¼èˆªåé‡æ–°åˆå§‹åŒ–
            window.addEventListener('contentPageLoaded', initContentPage);
        })();</script>