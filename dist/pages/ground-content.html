<style>* {
        padding: 0;
        margin: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;

    }
    .container {
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
 
    align-items: start; /* ä¿®æ”¹ä¸ºä»é¡¶éƒ¨å¯¹é½ï¼Œè®©é«˜åº¦è‡ªç„¶å»¶ä¼¸ */
}

  

    /* é¡¶éƒ¨å¯¼èˆª */
    .nav-header {
        border: 2px solid black;
        padding: 5px;
        margin-bottom: 20px;
        background-color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: calc(100% - 40px);
        position: fixed;
        top: 100px;
        z-index:100;

    }

    .nav-header h1 {
        font-size: 24px;
    }

    .back-btn {

        color: black;
        text-decoration: none;
        cursor: pointer;
        font-size: 16px;

    }






    /* å·¦ä¾§å›¾ç‰‡åŒºåŸŸ */
    .panel-left {
    grid-column: 1;
    margin-top: 60px;
    border: 2px solid black;
    overflow: hidden; /* ç¡®ä¿å›¾ç‰‡è¶…å‡ºæ—¶è¢«è£å‰ª */
    position: relative;
    /* é«˜åº¦å°†ç”±JavaScriptè®¾ç½® */
}

.panel-left img {
    width: 100%;
    height: 100%; /* å¡«å……æ•´ä¸ªå®¹å™¨ */
    object-fit: cover; /* å…³é”®ï¼šè£å‰ªä»¥å¡«å…… */
    object-position: center center; /* è£å‰ªæ—¶ä¿æŒä¸­å¿ƒ */
    display: block;
}


    /* å³ä¾§ä¿¡æ¯åŒºåŸŸ */
    .panel-right {
        grid-column: 2;
    grid-row: 1;
    padding: 30px;
    display: flex;
    flex-direction: column;
    border: 2px solid black;
    margin-top: 60px;
}

    .product-title {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }

    .product-name {
        font-style: italic;
    }

    .product-year {
        font-size: 16px;
        color: #666;
        margin-bottom: 20px;
    }

    .product-price {
        font-size: 32px;
        font-weight: bold;
        color: black;
        margin-bottom: 20px;
    }

    .product-category {
        margin-bottom: 15px;
    }

    .category-label {
        font-size: 14px;
        color: black;
        margin-bottom: 8px;
    }

    .category-value {
        font-size: 16px;
        padding: 5px;
        display: inline-block;
        border: 2px solid black;
    }

    .add-to-cart-btn {
        width: 100%;
        padding: 10px;
        background-color: black;
        color: white;
        border: none;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
    }



    .stock-info {
        font-size: 14px;
        color: black;
        margin-bottom: 20px;
    }




    /* è¯¦æƒ…åŒºåŸŸ */
    .product-details {
    grid-column: 1 / span 2;
    grid-row: 2;
    width: 100%;
    margin-top: 20px;
}

    .details-header {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid black;
    }

    .details-content {
        line-height: 1.8;
    

    }

    .details-content img {
        width: 100%;
        max-width: 100%;
        height: auto;
        display: block;
    }


    .details-content h3 {
        font-size: 18px;
        margin: 15px 0 15px 0;
        color: black;
    }

    .details-content p {
        margin-bottom: 15px;
        font-size: 16px;
    }

    .details-content ul {
        margin-left: 20px;
        margin-bottom: 20px;
    }

    .details-content li {
        margin-bottom: 10px;
        font-size: 15px;
    }

    .detail-images {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .detail-images img {
        width: 100%;
        height: auto;

    }

/* PDFé˜…è¯»å™¨ç›¸å…³æ ·å¼ */
.pdf-reader-container {
    width: 100%; /* æ”¹ä¸º100%å®½åº¦ï¼Œç»§æ‰¿çˆ¶å®¹å™¨å®½åº¦ */
    border: 2px solid black;
    background: white;
    position: relative;
    overflow: hidden;
}

/* PDFå·¥å…·æ  */
.pdf-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;

    border-bottom: 2px solid black;
    flex-wrap: wrap;
    gap: 10px;
}

.toolbar-left, .toolbar-center, .toolbar-right {
    display: flex;
    align-items: center;
    gap: 10px;
}

.toolbar-btn {
    padding: 0px 12px;
    background: white;
    border: 2px solid black;

    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.toolbar-btn:hover {
    background: black;

    color: white;
}

.toolbar-btn:active {
    background: black;
    color: white;
}

.zoom-controls {
    display: flex;
    align-items: center;
    gap: 5px;
}

.zoom-btn {
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: 2px solid black;

    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
}

.zoom-btn:hover {
    background: #f0f0f0;
}

.zoom-percent {
    min-width: 60px;
    text-align: center;
    font-size: 14px;
    font-weight: bold;
}

.page-info {
    font-size: 14px;
    color: #666;
    white-space: nowrap;
}

/* PDFé¡µé¢å®¹å™¨ */
.pdf-pages-container {
    width: 100%;
    height: 70vh;
    min-height: 500px;
    max-height: 800px;
    overflow: hidden;
    position: relative;
}
.pdf-viewport {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: transform 0.3s ease;
}

.pdf-page-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

.pdf-canvas-container {
    position: relative;

    background: white;
    overflow: hidden;
}

.pdf-canvas {
    display: block;
    max-width: 100%;
    max-height: 100%;
}

/* æ°´å° */
.pdf-watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    color: rgba(0,0,0,0.1);
    font-size: 40px;
    font-weight: bold;
    pointer-events: none;
    white-space: nowrap;
    z-index: 1;
}

/* é¡µé¢å¯¼èˆªå™¨ */
.pdf-navigator {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 15px 20px;
 
    border-top: 2px solid black;
    gap: 20px;
}

.nav-btn {
    
    background: black;
    color: white;
    border: none;
  
    cursor: pointer;
    font-size: 18px;
 
    min-width: 100px;
}

.nav-btn:hover {
    background: #333;
}

.nav-btn:disabled {

    cursor: not-allowed;
}

.page-input {
    width: 60px;
    padding: 5px;
    text-align: center;
    border: 2px solid black;

    font-size: 14px;
}

/* åŠ è½½çŠ¶æ€ */
.pdf-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #666;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
border: 2px solid black;

    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* é”™è¯¯çŠ¶æ€ */
.pdf-error {
    padding: 40px;
    text-align: center;
    color: #666;
}

/* ç§»é™¤æˆ–ä¿®æ”¹åŸæ¥çš„å…¨å±æ ·å¼ */
.pdf-reader-container.fullscreen {
    /* ä¿®æ”¹ä¸ºä»¥ä¸‹æ ·å¼ */
}

/* æ·»åŠ æ­£ç¡®çš„æ–°æ ·å¼ */
#pdfReader:fullscreen {
    background: white !important;
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: auto !important;
}

#pdfReader:fullscreen .pdf-toolbar {
    background: white;
    border-bottom: 2px solid black;
    padding: 15px 20px;
    flex-shrink: 0;
    z-index: 1000;
}

#pdfReader:fullscreen .pdf-pages-container {
    flex: 1;
    min-height: 0;
    height: auto !important;
}

#pdfReader:fullscreen .pdf-navigator {
    background: white;
    border-top: 2px solid black;
    padding: 15px 20px;
    flex-shrink: 0;
}

/* æµè§ˆå™¨å‰ç¼€ */
#pdfReader:-webkit-full-screen,
#pdfReader:-moz-full-screen,
#pdfReader:-ms-fullscreen {
    background: white !important;
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: auto !important;
}

/* å…¨å±æ—¶éšè—é¡µé¢å…¶ä»–å†…å®¹ï¼ˆå…³é”®ï¼‰ */
:fullscreen #pdfReader,
:-webkit-full-screen #pdfReader,
:-moz-full-screen #pdfReader,
:-ms-fullscreen #pdfReader {
    display: block !important;
}

/* ç¡®ä¿å…¨å±æ—¶PDFé˜…è¯»å™¨å¯è§ */
body:fullscreen #pdfReader,
body:-webkit-full-screen #pdfReader,
body:-moz-full-screen #pdfReader,
body:-ms-fullscreen #pdfReader {
    width: 100vw !important;
    height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
    background: white !important;
    display: flex !important;
    flex-direction: column !important;
}



/* æ‰“å°æ ·å¼ */
@media print {
    body * {
        visibility: hidden;
    }
    
    .pdf-reader-container,
    .pdf-reader-container * {
        visibility: visible !important;
    }
    
    .pdf-reader-container {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: auto !important;
        border: none !important;
        box-shadow: none !important;
        background: white !important;
    }
    
    .pdf-toolbar,
    .pdf-navigator,
    .exit-fullscreen-btn,
    .nav-header,
    .back-btn {
        display: none !important;
    }
    
    .pdf-pages-container {
        height: auto !important;
        max-height: none !important;
        overflow: visible !important;
    }
    
    .pdf-viewport {
        height: auto !important;
    }
    
    .pdf-page-wrapper {
        position: relative !important;
        page-break-inside: avoid;
        page-break-after: always;
    }
    
    .pdf-canvas-container {
        box-shadow: none !important;
        border: none !important;
        width: 100% !important;
        height: auto !important;
    }
    
    .pdf-canvas {
        width: 100% !important;
        height: auto !important;
        max-width: 100% !important;
        max-height: none !important;
    }
}
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .panels {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .panels-right {
            padding: 20px;
        }

        .product-title {
            font-size: 24px;
        }

        .product-price {
            font-size: 28px;
        }

        .product-details {
            padding: 20px;
        }

        .detail-images {
            grid-template-columns: 1fr;
        }
    }





    .game-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 10px;
    }

    .game-option {
        padding: 5px;
        border: 2px solid black;
        background-color: white;
        cursor: pointer;
        text-align: center;
    }

    .game-option:hover {
        background-color: black;
        color: white;
    }

    .game-option.selected {
        border-color: black;
        background-color: black;
        color: white;
    }

    .game-name {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 4px;
    }

    .game-desc {
        font-size: 11px;
        opacity: 0.8;
    }



    /* å“åº”å¼è®¾è®¡ */
    @media(max-width:600px) {
        .game-options {
            grid-template-columns: repeat(3, 1fr);
        }

        .nav-header {
            margin-top: -20px;
            width: calc(100% - 20px);
        }

        .panel-left {
            width: 100%;
            margin-top: 55px;
        }

        .panel-right {
            position: relative;
            width: 100%;
            right: 0px;
            top: -10px;
            padding: 15px;
        }

        .product-details {
            width: 100%;
            right: 0px;
            top: 0px;
            margin-top: 5px;
            padding: 5px;
        }
    }</style><link href="/css/styles.ffe12bf25f15d90e6cb1.css" rel="stylesheet"><body><div class="container"><div class="nav-header"><h1>BOOK</h1><a data-page="ground-ip" class="back-btn">â† BACK TO GROUND</a></div><div class="panel-left"><img id="mainImage" src="" alt="Product Image"></div><div class="panel-right"><h2 class="product-title" id="productName">Loading...</h2><p class="product-name" id="productTitle">-</p><div class="product-price" id="productPrice">$0</div><div class="stock-info"></div><button class="add-to-cart-btn" id="addToCartBtn">ADD TO CART</button></div><div class="product-details"><div class="details-content" id="productDetails"></div></div></div><script>(function () {

            class PDFReader {
                constructor() {
        this.pdfDoc = null;
        this.currentPage = 1;
        this.totalPages = 0;
        this.scale = 1.0;
        this.isLoading = false;
        this.canvases = new Map();
        this.renderQueue = [];
        this.isRendering = false;
        this.isFullscreen = false;
        this.originalBodyOverflow = '';
    }
    // åˆå§‹åŒ–PDFé˜…è¯»å™¨
    async init(product) {
        try {
            // ç¡®ä¿PDF.jså·²åŠ è½½
            await this.ensurePDFJSLoaded();
            
            // åˆ›å»ºé˜…è¯»å™¨ç•Œé¢
            this.createUI();
            
            // åŠ è½½PDFæ–‡æ¡£
            await this.loadPDF(product.pdfUrl);
            
        } catch (error) {
            console.error('PDFé˜…è¯»å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            this.showError('Failed to load PDF file');
        }
    }

    // ç¡®ä¿PDF.jså·²åŠ è½½
    ensurePDFJSLoaded() {
        return new Promise((resolve, reject) => {
            if (window.pdfjsLib) {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
            
            script.onload = () => {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 
                    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                console.log('PDF.js loaded');
                resolve();
            };
            
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // åˆ›å»ºé˜…è¯»å™¨ç•Œé¢
    createUI() {
        const detailsEl = document.getElementById('productDetails');
        if (!detailsEl) return;

        detailsEl.innerHTML = `
            <div class="pdf-reader-container" id="pdfReader">

                
                <!-- å·¥å…·æ  -->
                <div class="pdf-toolbar">
                    <div class="toolbar-left">
                        <button class="toolbar-btn" id="zoomOutBtn" title="ç¼©å°">
                            <span>âˆ’</span>
                        </button>
                        <div class="zoom-controls">
                            <span class="zoom-percent" id="zoomPercent">100%</span>
                        </div>
                        <button class="toolbar-btn" id="zoomInBtn" title="æ”¾å¤§">
                            <span>+</span>
                        </button>
                     
                    </div>
                    
                    <div class="toolbar-center">
                        <span class="page-info" id="pageInfo"></span>
                    </div>
                    
                    <div class="toolbar-right">
                        <button class="toolbar-btn" id="fullscreenBtn" title="å…¨å±">
                            â›¶
                        </button>
                        <button class="toolbar-btn" id="printBtn" title="æ‰“å°å½“å‰é¡µé¢">
                            PRINT
                        </button>
                    </div>
                </div>

                <!-- é¡µé¢æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="pdf-pages-container" id="pdfPagesContainer">
                    <div class="pdf-viewport" id="pdfViewport">
                        <!-- é¡µé¢ä¼šåŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
                    </div>
                    
                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div class="pdf-loading" id="pdfLoading">
                        <div class="loading-spinner"></div>
                        <div>æ­£åœ¨åŠ è½½PDF...</div>
                    </div>
                </div>

                <!-- é¡µé¢å¯¼èˆª -->
                <div class="pdf-navigator">
                    <button class="nav-btn" id="prevPageBtn" disabled>Prev</button>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" class="page-input" id="pageInput" min="1" value="1">
                        <span>/ <span id="totalPages">?</span></span>
                    </div>
                    
                    <button class="nav-btn" id="nextPageBtn">Next</button>
                </div>
            </div>
        `;

setTimeout(() => {
        this.addFullscreenEventListeners();
    }, 100);

        // ç»‘å®šäº‹ä»¶
        this.bindEvents();
    }


    // ç»‘å®šäº‹ä»¶
    bindEvents() {
        // ç¼©æ”¾æ§åˆ¶
        document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomIn());
        document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomOut());
      
        
        // é¡µé¢å¯¼èˆª
        document.getElementById('prevPageBtn').addEventListener('click', () => this.prevPage());
        document.getElementById('nextPageBtn').addEventListener('click', () => this.nextPage());
        document.getElementById('pageInput').addEventListener('change', (e) => this.goToPage(parseInt(e.target.value)));
        
        // æ‰“å°
        document.getElementById('printBtn').addEventListener('click', () => window.print());
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => this.handleKeydown(e));
        
        // é¼ æ ‡æ»šè½®ç¼©æ”¾
        document.getElementById('pdfPagesContainer').addEventListener('wheel', (e) => {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                if (e.deltaY < 0) this.zoomIn();
                else this.zoomOut();
            }
        });

            // å…¨å±æ§åˆ¶
    document.getElementById('fullscreenBtn').addEventListener('click', () => this.requestFullscreen());
   
    }

    // åœ¨ PDFReader ç±»ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•ï¼š

// è¯·æ±‚è¿›å…¥å…¨å±
async requestFullscreen() {
    const container = document.getElementById('pdfReader');
    if (!container) return;
    
    try {
        // åœ¨è¿›å…¥å…¨å±å‰ï¼Œç¡®ä¿PDFé˜…è¯»å™¨åœ¨DOMä¸­æ­£ç¡®
        const detailsEl = document.getElementById('productDetails');
        if (detailsEl) {
            // ä¸´æ—¶å°†PDFé˜…è¯»å™¨ç§»åˆ°bodyæœ€å¤–å±‚ï¼Œé¿å…è¢«å…¶ä»–å…ƒç´ å½±å“
            const pdfReader = document.getElementById('pdfReader');
            if (pdfReader) {
                document.body.appendChild(pdfReader);
            }
        }
        
        // è¯·æ±‚å…¨å±
        if (container.requestFullscreen) {
            await container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
            await container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
            await container.msRequestFullscreen();
        } else if (container.mozRequestFullScreen) {
            await container.mozRequestFullScreen();
        }
        
        this.isFullscreen = true;
        console.log('è¿›å…¥å…¨å±æ¨¡å¼');
        
    } catch (error) {
        console.error('å…¨å±è¯·æ±‚å¤±è´¥:', error);
    }
}
// é€€å‡ºå…¨å±
async exitFullscreen() {
    try {
        if (document.exitFullscreen) {
            await document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            await document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            await document.msExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            await document.mozCancelFullScreen();
        }
        
        this.isFullscreen = false;
        console.log('é€€å‡ºå…¨å±æ¨¡å¼');
        
        // é€€å‡ºå…¨å±åï¼Œå°†PDFé˜…è¯»å™¨æ”¾å›åŸä½ç½®
        setTimeout(() => {
            this.restorePDFReaderPosition();
        }, 100);
        
    } catch (error) {
        console.error('é€€å‡ºå…¨å±å¤±è´¥:', error);
    }
}

restorePDFReaderPosition() {
    const pdfReader = document.getElementById('pdfReader');
    const detailsEl = document.getElementById('productDetails');
    
    if (pdfReader && detailsEl) {
        // å°†PDFé˜…è¯»å™¨æ”¾å›product-detailsä¸­
        detailsEl.innerHTML = '';
        detailsEl.appendChild(pdfReader);
    }
}

addFullscreenEventListeners() {
    const container = document.getElementById('pdfReader');
    
    const fullscreenChangeHandler = () => {
        const isFullscreen = !!(document.fullscreenElement || 
                              document.webkitFullscreenElement || 
                              document.mozFullScreenElement || 
                              document.msFullscreenElement);
        
        this.isFullscreen = isFullscreen;
        
        if (isFullscreen) {
            // è¿›å…¥å…¨å±æ—¶çš„å¤„ç†
            container.classList.add('fullscreen');
            document.getElementById('fullscreenBtn').style.display = 'none';
         
            
            // è°ƒæ•´é¡µé¢æ˜¾ç¤º
            setTimeout(() => {
                this.centerPage();
                this.refreshPage();
            }, 100);
            
        } else {
            // é€€å‡ºå…¨å±æ—¶çš„å¤„ç†
            container.classList.remove('fullscreen');
            document.getElementById('fullscreenBtn').style.display = 'inline-block';
         
            
            // æ¢å¤PDFé˜…è¯»å™¨ä½ç½®
            this.restorePDFReaderPosition();
            
            // è°ƒæ•´é¡µé¢æ˜¾ç¤º
            setTimeout(() => {
                this.centerPage();
                this.refreshPage();
            }, 100);
        }
    };
    
    document.addEventListener('fullscreenchange', fullscreenChangeHandler);
    document.addEventListener('webkitfullscreenchange', fullscreenChangeHandler);
    document.addEventListener('mozfullscreenchange', fullscreenChangeHandler);
    document.addEventListener('MSFullscreenChange', fullscreenChangeHandler);
}

// å…¨å±çŠ¶æ€å˜åŒ–å¤„ç†
onFullscreenChange() {
    const container = document.getElementById('pdfReader');
    if (!container) return;
    
    if (this.isFullscreen) {
        container.classList.add('fullscreen');
        document.body.classList.add('pdf-fullscreen');
        
        // å…¨å±æ—¶çš„é¢å¤–å¤„ç†
        this.adjustForFullscreen();
        
    } else {
        container.classList.remove('fullscreen');
        document.body.classList.remove('pdf-fullscreen');
    }
    
    // é‡æ–°è°ƒæ•´é¡µé¢
    setTimeout(() => {
        this.centerPage();
        this.refreshPage();
    }, 100);
}

// å…¨å±æ—¶çš„è°ƒæ•´
adjustForFullscreen() {
    // éšè—ä¸å¿…è¦çš„å…ƒç´ 
    const elementsToHide = [
        '.nav-header',
        '.panel-left', 
        '.panel-right',
        '.product-details'
    ];
    
    elementsToHide.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
            el.style.display = 'none';
        });
    });
}

// è¿˜åŸæ˜¾ç¤ºçš„å…ƒç´ 
restoreElements() {
    const elementsToShow = [
        '.nav-header',
        '.panel-left',
        '.panel-right', 
        '.product-details'
    ];
    
    elementsToShow.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
            el.style.display = '';
        });
    });
}

// å¤‡ç”¨å…¨å±æ–¹æ¡ˆï¼ˆå¦‚æœæµè§ˆå™¨ä¸æ”¯æŒ Fullscreen APIï¼‰
enterFullscreenFallback() {
    console.log('ä½¿ç”¨å¤‡ç”¨å…¨å±æ–¹æ¡ˆ');
    const container = document.getElementById('pdfReader');
    
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '100vw';
    container.style.height = '100vh';
    container.style.zIndex = '9999';
    container.style.backgroundColor = 'white';
    container.style.margin = '0';
    container.style.padding = '0';
    container.style.border = 'none';
    
    this.isFullscreen = true;
    this.adjustForFullscreen();
}

// å¤‡ç”¨é€€å‡ºå…¨å±æ–¹æ¡ˆ
exitFullscreenFallback() {
    console.log('é€€å‡ºå¤‡ç”¨å…¨å±æ–¹æ¡ˆ');
    const container = document.getElementById('pdfReader');
    
    container.style.position = '';
    container.style.top = '';
    container.style.left = '';
    container.style.width = '';
    container.style.height = '';
    container.style.zIndex = '';
    container.style.backgroundColor = '';
    container.style.margin = '';
    container.style.padding = '';
    container.style.border = '';
    
    this.isFullscreen = false;
    this.restoreElements();
}



    // åŠ è½½PDFæ–‡æ¡£
    async loadPDF(pdfUrl) {
        try {
            this.showLoading(true);
            
            // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
            const timestamp = Date.now();
            const url = `${pdfUrl}?t=${timestamp}`;
            
            // åŠ è½½PDF
            const loadingTask = pdfjsLib.getDocument(url);
            this.pdfDoc = await loadingTask.promise;
            this.totalPages = this.pdfDoc.numPages;
            
            // æ›´æ–°é¡µé¢ä¿¡æ¯
            this.updatePageInfo();
            
            // åŠ è½½ç¬¬ä¸€é¡µ
            await this.loadPage(this.currentPage);
            
            this.showLoading(false);
            
        } catch (error) {
            console.error('PDFåŠ è½½å¤±è´¥:', error);
            this.showError('PDFæ–‡ä»¶åŠ è½½å¤±è´¥');
            throw error;
        }
    }

    // åŠ è½½æŒ‡å®šé¡µé¢
    async loadPage(pageNum) {
        if (pageNum < 1 || pageNum > this.totalPages) return;
        
        this.currentPage = pageNum;
        this.updatePageInfo();
        
        // æ›´æ–°è¾“å…¥æ¡†
        document.getElementById('pageInput').value = pageNum;
        
        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        document.getElementById('prevPageBtn').disabled = pageNum <= 1;
        document.getElementById('nextPageBtn').disabled = pageNum >= this.totalPages;
        
        // æ£€æŸ¥æ˜¯å¦å·²ç¼“å­˜
        if (this.canvases.has(pageNum)) {
            this.displayPage(pageNum);
            return;
        }
        
        // æ¸²æŸ“é¡µé¢
        await this.renderPage(pageNum);
    }

    // æ¸²æŸ“é¡µé¢
    async renderPage(pageNum) {
        if (this.isRendering) {
            this.renderQueue.push(pageNum);
            return;
        }
        
        this.isRendering = true;
        
        try {
            const page = await this.pdfDoc.getPage(pageNum);
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ä»¥é€‚åº”å®¹å™¨
            const container = document.getElementById('pdfPagesContainer');
            const viewport = page.getViewport({ scale: 1 });
            
            // è®¡ç®—æœ€ä½³ç¼©æ”¾æ¯”ä¾‹
            const containerWidth = container.clientWidth - 40; // å‡å»è¾¹è·
            const containerHeight = container.clientHeight - 40;
            
            const scaleX = containerWidth / viewport.width;
            const scaleY = containerHeight / viewport.height;
            const scale = Math.min(scaleX, scaleY, 2) * this.scale; // é™åˆ¶æœ€å¤§ç¼©æ”¾2å€
            
            // åˆ›å»ºcanvas
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.className = 'pdf-canvas';
            
            // è®¾ç½®canvaså°ºå¯¸
            const canvasViewport = page.getViewport({ scale });
            canvas.width = canvasViewport.width;
            canvas.height = canvasViewport.height;
            
            // æ¸²æŸ“é¡µé¢
            const renderContext = {
                canvasContext: context,
                viewport: canvasViewport
            };
            
            await page.render(renderContext).promise;
            
            // æ·»åŠ æ°´å°
            this.addWatermark(canvas, context);
            
            // ç¼“å­˜canvas
            this.canvases.set(pageNum, canvas);
            
            // æ˜¾ç¤ºé¡µé¢
            this.displayPage(pageNum);
            
        } catch (error) {
            console.error('é¡µé¢æ¸²æŸ“å¤±è´¥:', error);
        } finally {
            this.isRendering = false;
            
            // å¤„ç†æ¸²æŸ“é˜Ÿåˆ—
            if (this.renderQueue.length > 0) {
                const nextPage = this.renderQueue.shift();
                this.renderPage(nextPage);
            }
        }
    }

    // æ˜¾ç¤ºé¡µé¢
    displayPage(pageNum) {
        const viewport = document.getElementById('pdfViewport');
        viewport.innerHTML = '';
        
        const canvas = this.canvases.get(pageNum);
        if (!canvas) return;
        
        // åˆ›å»ºé¡µé¢å®¹å™¨
        const pageWrapper = document.createElement('div');
        pageWrapper.className = 'pdf-page-wrapper';
        
        const canvasContainer = document.createElement('div');
        canvasContainer.className = 'pdf-canvas-container';
        canvasContainer.style.width = `${canvas.width}px`;
        canvasContainer.style.height = `${canvas.height}px`;
        
        canvasContainer.appendChild(canvas);
        pageWrapper.appendChild(canvasContainer);
        viewport.appendChild(pageWrapper);
        
        // å±…ä¸­æ˜¾ç¤º
        this.centerPage();
    }

    // å±…ä¸­é¡µé¢
    centerPage() {
        const viewport = document.getElementById('pdfViewport');
        const pageWrapper = viewport.querySelector('.pdf-page-wrapper');
        if (!pageWrapper) return;
        
        const container = document.getElementById('pdfPagesContainer');
        const pageRect = pageWrapper.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        const left = (containerRect.width - pageRect.width) / 2;
        const top = (containerRect.height - pageRect.height) / 2;
        
        pageWrapper.style.left = `${left}px`;
        pageWrapper.style.top = `${top}px`;
    }

    // æ·»åŠ æ°´å°
    addWatermark(canvas, context) {
        context.save();
        
        // è®¾ç½®æ°´å°æ ·å¼
        context.globalAlpha = 0.05;
        context.fillStyle = '#000000';
        context.font = 'bold 30px Arial';
        context.textAlign = 'center';
        context.textBaseline = 'middle';
        
        // æ—‹è½¬æ°´å°
        context.translate(canvas.width / 2, canvas.height / 2);
        context.rotate(-Math.PI / 4);
        
        // ç»˜åˆ¶æ°´å°æ–‡å­—
        context.fillText('é¢„è§ˆæ ·ç«  ', 0, 0);
        context.fillText('MANIFESTOCLUB.CN ', 0, 40);
        
        context.restore();
    }

    // ç¼©æ”¾æ§åˆ¶
    zoomIn() {
        this.scale = Math.min(this.scale + 0.1, 3.0); // æœ€å¤§æ”¾å¤§3å€
        this.updateZoom();
        this.refreshPage();
    }

    zoomOut() {
        this.scale = Math.max(this.scale - 0.1, 0.5); // æœ€å°ç¼©å°0.5å€
        this.updateZoom();
        this.refreshPage();
    }

    fitToWidth() {
        if (!this.pdfDoc || this.currentPage < 1) return;
        
        const container = document.getElementById('pdfPagesContainer');
        const page = this.canvases.get(this.currentPage);
        if (!page) return;
        
        const containerWidth = container.clientWidth - 40;
        this.scale = containerWidth / page.width;
        this.updateZoom();
        this.refreshPage();
    }

    fitToPage() {
        if (!this.pdfDoc || this.currentPage < 1) return;
        
        const container = document.getElementById('pdfPagesContainer');
        const page = this.canvases.get(this.currentPage);
        if (!page) return;
        
        const containerWidth = container.clientWidth - 40;
        const containerHeight = container.clientHeight - 40;
        
        const scaleX = containerWidth / page.width;
        const scaleY = containerHeight / page.height;
        
        this.scale = Math.min(scaleX, scaleY, 2); // é™åˆ¶æœ€å¤§2å€
        this.updateZoom();
        this.refreshPage();
    }

    updateZoom() {
        const percent = Math.round(this.scale * 100);
        document.getElementById('zoomPercent').textContent = `${percent}%`;
    }

    refreshPage() {
        // æ¸…é™¤å½“å‰é¡µé¢çš„ç¼“å­˜
        this.canvases.delete(this.currentPage);
        // é‡æ–°æ¸²æŸ“å½“å‰é¡µé¢
        this.renderPage(this.currentPage);
    }

    // é¡µé¢å¯¼èˆª
    prevPage() {
        if (this.currentPage > 1) {
            this.loadPage(this.currentPage - 1);
        }
    }

    nextPage() {
        if (this.currentPage < this.totalPages) {
            this.loadPage(this.currentPage + 1);
        }
    }

    goToPage(pageNum) {
        const page = Math.max(1, Math.min(pageNum, this.totalPages));
        this.loadPage(page);
    }

    updatePageInfo() {
        document.getElementById('pageInfo').textContent = 
            `ç¬¬ ${this.currentPage} é¡µ / å…± ${this.totalPages} é¡µ`;
        document.getElementById('totalPages').textContent = this.totalPages;
    }

    // é”®ç›˜å¿«æ·é”®
    handleKeydown(e) {
          if (e.key === 'Escape' && this.isFullscreen) {
        e.preventDefault();
        this.exitFullscreen();
        return;
    }
    
    // F11 é”®ä¹Ÿæ”¯æŒå…¨å±åˆ‡æ¢
    if (e.key === 'F11') {
        e.preventDefault();
        if (this.isFullscreen) {
            this.exitFullscreen();
        } else {
            this.requestFullscreen();
        }
        return;
    }

        if (e.target.tagName === 'INPUT') return;
        
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                this.prevPage();
                break;
            case 'ArrowRight':
                e.preventDefault();
                this.nextPage();
                break;
            case '+':
            case '=':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    this.zoomIn();
                }
                break;
            case '-':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    this.zoomOut();
                }
                break;
            case '0':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    this.fitToPage();
                }
                break;
        }
    }

    // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
    showLoading(show) {
        const loadingEl = document.getElementById('pdfLoading');
        if (loadingEl) {
            loadingEl.style.display = show ? 'block' : 'none';
        }
    }

    // æ˜¾ç¤ºé”™è¯¯
    showError(message) {
        const container = document.getElementById('pdfReader');
        if (container) {
            container.innerHTML = `
                <div class="pdf-error">
                    <h3>PDF Preview</h3>
                    <p>${message}</p>
                    <p>You can still purchase this book and view the full content via the included TF card.</p>
                </div>
            `;
        }
    }
}

// ä¿®æ”¹ä½ çš„ renderPDFPreview å‡½æ•°
async function renderPDFPreview(product) {
    const detailsEl = document.getElementById('productDetails');
    if (!detailsEl) return;
    
    try {
        // åˆ›å»ºPDFé˜…è¯»å™¨å®ä¾‹
        const pdfReader = new PDFReader();
        await pdfReader.init(product);
        
        // å­˜å‚¨é˜…è¯»å™¨å®ä¾‹ä»¥ä¾¿å…¶ä»–å‡½æ•°è®¿é—®
        window.pdfReader = pdfReader;
        
    } catch (error) {
        console.error('PDFé˜…è¯»å™¨åˆ›å»ºå¤±è´¥:', error);
        // æ˜¾ç¤ºå¤‡ç”¨é¢„è§ˆ
        showSimplePreview(product);
    }
}


            function syncPanelHeights() {
    const leftPanel = document.querySelector('.panel-left');
    const rightPanel = document.querySelector('.panel-right');
    
    if (!leftPanel || !rightPanel) return;
    
    // è·å–å³ä¾§é¢æ¿çš„å®é™…é«˜åº¦
    const rightHeight = rightPanel.offsetHeight;
    
    // è®¾ç½®å·¦ä¾§é¢æ¿é«˜åº¦ä¸å³ä¾§ç›¸åŒ
    leftPanel.style.height = rightHeight + 'px';
    
    console.log('å·¦ä¾§é¢æ¿é«˜åº¦å·²è®¾ç½®ä¸º:', rightHeight, 'px');
}

// åœ¨å›¾ç‰‡åŠ è½½åé‡æ–°è®¡ç®—é«˜åº¦
function handleImageLoad() {
    setTimeout(syncPanelHeights, 100); // å»¶è¿Ÿç¡®ä¿DOMå·²æ›´æ–°
}

// åœ¨é¡µé¢åŠ è½½åè°ƒæ•´å›¾ç‰‡å®¹å™¨é«˜åº¦
window.addEventListener('load', function() {
    syncPanelHeights();
    // æ·»åŠ å›¾ç‰‡åŠ è½½ç›‘å¬
    const mainImage = document.getElementById('mainImage');
    if (mainImage) {
        mainImage.addEventListener('load', handleImageLoad);
    }
});

// DOM åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒæ­¥
    setTimeout(syncPanelHeights, 500);
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', syncPanelHeights);
    
    // ç›‘å¬æ¸¸æˆé€‰æ‹©å™¨çš„ç‚¹å‡»ï¼ˆå¦‚æœä½ çš„é¡µé¢æœ‰ï¼‰
    const gameOptions = document.querySelectorAll('.game-option');
    if (gameOptions.length > 0) {
        gameOptions.forEach(option => {
            option.addEventListener('click', function() {
                // å›¾ç‰‡åˆ‡æ¢åé‡æ–°è®¡ç®—é«˜åº¦
                setTimeout(syncPanelHeights, 300);
            });
        });
    }
});



            async function getCurrentUser() {
                // ä¼˜å…ˆä½¿ç”¨ authManager
                if (window.authManager && window.authManager.isAuthenticated()) {
                    return window.authManager.getCurrentUser();
                }

                // å¤‡ç”¨ï¼šä½¿ç”¨ Supabase
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    return user;
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·å¤±è´¥:', error);
                    return null;
                }
            }

     async function checkUserLogin() {
    const user = await getCurrentUser();
    if (!user) {
        // ç›´æ¥è°ƒç”¨ç°æœ‰çš„è®¤è¯å‡½æ•°æ‰“å¼€ç™»å½• modal
        if (typeof window.openAuthModal === 'function') {
            window.openAuthModal();
        }
        if (typeof window.showLoginForm === 'function') {
            window.showLoginForm();
        }
      
    
        return null;
    }
    return user;
}


            if (!window.currentPageParams) {
                window.currentPageParams = {};
            }

            function cleanupContentPage() {
                console.log('Cleaning up content page...');
                // æ¸…ç†å…¨å±€å˜é‡
                delete window.currentProduct;
                delete window.cleanupContentPage;

                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                const backBtn = document.querySelector('.back-btn');
                if (backBtn && window.contentBackHandler) {
                    backBtn.removeEventListener('click', window.contentBackHandler);
                }

                const addBtn = document.getElementById('addToCartBtn');
                if (addBtn && window.contentAddToCartHandler) {
                    addBtn.removeEventListener('click', window.contentAddToCartHandler);
                }

                delete window.contentBackHandler;
                delete window.contentAddToCartHandler;
            }

            // å…ˆæ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§å†…å®¹
            if (typeof window.cleanupContentPage === 'function') {
                window.cleanupContentPage();
            }

            const PRODUCT_CACHE = new Map();
            // äº§å“æ•°æ®åº“
            const productDatabase = {
                '001': {
                    name: 'From Pirate Printing Presses to Feudal Digital Societies',
                    title:"ä»ç›—ç‰ˆå°åˆ·æœºåˆ°å°å»ºæ•°å­—ç¤¾ä¼š",
                    price: 'Â¥45',
                    category: 'Game Cartridge',
                    mainImage: '',
                    pdfUrl: '/images/library/ground-ip/001.pdf',
                    variants: {
                        'a': {
                            name: 'Chinese Ver.',
                            image: '',
                            description: 'ä¸­æ–‡ç‰ˆ'
                        },
                        'b': {
                            name: 'English Ver.',
                            image: '',
                            description: 'è‹±æ–‡ç‰ˆ'
                        },
                                        
                    },

                    description: `
                
                    `
                }
            };


            function renderGameSelector(product, productId) {
                // åªä¸ºäº§å“5æ·»åŠ æ¸¸æˆé€‰æ‹©å™¨
                if (productId !== '001' || !product.variants) {
                    return;
                }

                const existingSelector = document.querySelector('.game-options');
                if (existingSelector) {
                    existingSelector.remove();
                }

                const stockInfo = document.querySelector('.stock-info');
                if (stockInfo) {
                    const selectorHTML = `
            <div class="game-options">
                ${Object.entries(product.variants).map(([key, variant]) => `
                    <div class="game-option" data-variant="${key}">
                        <div class="game-name">${variant.name}</div>
                        <div class="game-desc">${variant.description}</div>
                    </div>
                `).join('')}
            </div>
        `;

                    stockInfo.insertAdjacentHTML('beforebegin', selectorHTML);
                    bindGameSelectionEvents(product);
                }
            }


            // 3. æ·»åŠ æ¸¸æˆé€‰æ‹©äº‹ä»¶å¤„ç†
            function bindGameSelectionEvents(product) {
                const mainImage = document.getElementById('mainImage');
                const gameOptions = document.querySelectorAll('.game-option');

                // åˆ›å»ºäº‹ä»¶å¤„ç†å™¨ï¼ˆé¿å…é—­åŒ…é—®é¢˜ï¼‰
                const handleGameClick = (e) => {
                    const option = e.currentTarget;
                    const variantKey = option.dataset.variant;
                    const variant = product.variants[variantKey];

                    if (!variant) return;

                    // æ›´æ–°é€‰ä¸­çŠ¶æ€
                    gameOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');

                    // æ›´æ–°ä¸»å›¾
                    if (mainImage && variant.image) {
                        mainImage.src = variant.image;
                        mainImage.alt = variant.name;
                    }

                    // ä¿å­˜é€‰ä¸­çš„å˜ä½“
                    window.currentProduct.selectedVariant = {
                        key: variantKey,
                        ...variant
                    };

                    console.log('é€‰ä¸­æ¸¸æˆ:', variant.name);
                };

                // ç»‘å®šäº‹ä»¶
                gameOptions.forEach((option, index) => {
                    option.addEventListener('click', handleGameClick);
                    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
                    if (index === 0) {
                        option.click();
                    }
                });
            }

            // åŠ è½½äº§å“ä¿¡æ¯
            function loadProduct() {
                console.log('Content page: Loading product information...');

                let productId = null;

                // ä¼˜å…ˆä»URLå‚æ•°è·å–
                if (window.currentPageParams?.id) {
                    productId = window.currentPageParams.id;
                } else {
                    // å°è¯•ä» sessionStorage è·å–
                    try {
                        const pendingData = sessionStorage.getItem('pendingProduct');
                        if (pendingData) {
                            const data = JSON.parse(pendingData);
                            productId = data.id;
                            sessionStorage.removeItem('pendingProduct');
                        }
                    } catch (e) {
                        console.error('è§£æ pending product å¤±è´¥:', e);
                    }
                }

                if (!productId) {
                    showError('No product ID found');
                    return;
                }

                // âœ… ä¼˜åŒ–ï¼šæ£€æŸ¥ç¼“å­˜
                if (PRODUCT_CACHE.has(productId)) {
                    console.log('ğŸ“¦ ä½¿ç”¨ç¼“å­˜çš„äº§å“:', productId);
                    updatePageContent(PRODUCT_CACHE.get(productId), productId);
                    return;
                }

                const product = productDatabase[productId];
                if (product) {
        // ç¼“å­˜äº§å“
        PRODUCT_CACHE.set(productId, product);
        updatePageContent(product, productId);
        
        // å›¾ç‰‡åŠ è½½å®ŒæˆååŒæ­¥é«˜åº¦
        const mainImage = document.getElementById('mainImage');
        if (mainImage) {
            mainImage.onload = function() {
                setTimeout(syncPanelHeights, 200);
            };
        }}
                
                if (!product) {
                    showError('Product not found');
                    return;
                }

              

                

            }

            // æ›´æ–°é¡µé¢å†…å®¹
            function updatePageContent(product, productId) {
    // æ›´æ–°äº§å“ä¿¡æ¯ï¼ˆåŸæœ‰çš„ä»£ç ï¼‰
    const mainImage = document.getElementById('mainImage');
    if (mainImage) {
        mainImage.src = product.mainImage || `/images/merch/${productId}.jpg`;
        mainImage.alt = product.name;
    }

    // æ›´æ–°äº§å“ä¿¡æ¯
    const elements = {
        'productName': product.name,
        'productTitle': product.title,
        'productPrice': product.price,
        'productCategory': product.category
    };

    for (const [id, content] of Object.entries(elements)) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = content;
        }
    }

    // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ä¹¦ç±äº§å“ï¼Œæ˜¾ç¤ºPDFé¢„è§ˆ
    if (productId === '001') { // ä½ çš„ä¹¦ç±äº§å“ID
        renderPDFPreview(product);
    } else {
        // å…¶ä»–äº§å“æ˜¾ç¤ºæ™®é€šè¯¦æƒ…
        const detailsEl = document.getElementById('productDetails');
        if (detailsEl) {
            detailsEl.innerHTML = product.description || '';
        }
    }

    // å­˜å‚¨å½“å‰äº§å“ä¿¡æ¯
    window.currentProduct = {
        ...product,
        id: productId
    };

    renderGameSelector(product, productId);
    console.log('Product loaded successfully:', product.name);
}


            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            function showError() {
                const nameEl = document.getElementById('productName');
                const detailsEl = document.getElementById('productDetails');

                if (nameEl) nameEl.textContent = 'Product Not Found';
                if (detailsEl) detailsEl.innerHTML = '<p>Sorry, this product could not be found.</p>';
            }

            // åˆå§‹åŒ–
            function initContentPage() {
                console.log('Initializing content page...');

                // ç«‹å³åŠ è½½äº§å“
                loadProduct();
                setTimeout(() => {
                    try {
                        const usedProduct = sessionStorage.getItem('pendingProduct');
                        if (usedProduct) {
                            console.log('Cleaning up used sessionStorage data');
                            sessionStorage.removeItem('pendingProduct');
                            sessionStorage.removeItem('lastProductClick');
                        }
                    } catch (e) {
                        console.error('Error cleaning sessionStorage:', e);
                    }
                }, 1000);
                // ç›‘å¬URLå‚æ•°å˜åŒ–
                window.paramsEventHandler = function (event) {
                    if (event.detail.page === 'ground-content') {
                        console.log('URL parameters changed, reloading product:', event.detail.params);
                        // æ›´æ–°å‚æ•°å¹¶é‡æ–°åŠ è½½
                        window.currentPageParams = event.detail.params;
                        loadProduct();
                    }
                };
                window.addEventListener('pageParamsLoaded', window.paramsEventHandler);



                // ç»‘å®šè¿”å›æŒ‰é’®
                const backBtn = document.querySelector('.back-btn');
                if (backBtn) {
                    backBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        // ä½¿ç”¨è·¯ç”±å¯¼èˆªè¿”å›å•†å“åˆ—è¡¨é¡µ
                        if (window.router && window.router.navigate) {
                            window.router.navigate('ground-ip');
                        } else if (typeof window.loadPage === 'function') {
                            window.loadPage('ground-ip');
                        }
                    });
                }

                // ç»‘å®šæ·»åŠ åˆ°è´­ç‰©è½¦æŒ‰é’®
                const addBtn = document.getElementById('addToCartBtn');
                if (addBtn) {
                    addBtn.addEventListener('click', handleAddToCart);
                }
            }

            // æ·»åŠ åˆ°è´­ç‰©è½¦å¤„ç†å‡½æ•°
async function handleAddToCart() {
    const addBtn = document.getElementById('addToCartBtn');
    if (!addBtn) return;
    
    // ä¿å­˜åŸå§‹æŒ‰é’®çŠ¶æ€
    const originalText = addBtn.textContent;
    const originalBg = addBtn.style.backgroundColor || 'black';
    
    try {
        if (!window.currentProduct) {
            alert('äº§å“ä¿¡æ¯æœªåŠ è½½');
            restoreButtonState(addBtn, originalText, originalBg);
            return;
        }

        const product = window.currentProduct;
        console.log('Adding console product to cart:', product.name);

        // æ˜¾ç¤º"æ·»åŠ ä¸­"çŠ¶æ€
        addBtn.textContent = 'ADDING...';
        addBtn.style.backgroundColor = '#666'; // ç°è‰²è¡¨ç¤ºå¤„ç†ä¸­
        addBtn.disabled = true;

        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        const user = await checkUserLogin();
        if (!user) {
            restoreButtonState(addBtn, originalText, originalBg);
            return;
        }

        // å‡†å¤‡å•†å“æ•°æ®
        const priceNumber = parseFloat(product.price.replace(/[^0-9.]/g, ''));

        // å‡†å¤‡å˜ä½“ä¿¡æ¯
        const selectedVariant = window.currentProduct.selectedVariant;
        const variantSuffix = selectedVariant ? `-${selectedVariant.key}` : '';
        const variantName = selectedVariant ? ` - ${selectedVariant.name}` : '';

        const cartItemData = {
            user_id: user.id,
            draft_id: null,
            type: `console-${product.id}${variantSuffix}`,
            quantity: 1,
            sizes: { 'default': 1 },
            price: priceNumber,
            total_price: priceNumber,
            item_data: {
                productId: product.id,
                productName: product.name + variantName,
                productDes: product.des,
                productCategory: product.category,
                productImage: selectedVariant?.image || product.mainImage || `/images/merch/${product.id}.jpg`,
                productType: 'retro-console',
                variantKey: selectedVariant?.key,
                variantName: selectedVariant?.name,
                variantDescription: selectedVariant?.description
            },
            added_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        console.log('ğŸ“¤ å‘é€åˆ°åç«¯çš„å®Œæ•´æ•°æ®:', JSON.stringify(cartItemData, null, 2));

        // è°ƒç”¨åç«¯ API
        const API_BASE_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3001'
            : '';

        // è·å– token
        let token;
        if (window.authManager && window.authManager.getToken) {
            token = window.authManager.getToken();
        }

        if (!token && window.supabase) {
            const { data: { session } } = await supabase.auth.getSession();
            token = session?.access_token;
        }

        if (!token) {
            alert('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
            restoreButtonState(addBtn, originalText, originalBg);
            return;
        }

        // å°è¯•è°ƒç”¨ä¸» API
        try {
            const response = await fetch(`${API_BASE_URL}/api/cart/add`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cartItemData
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'æœªçŸ¥é”™è¯¯' }));
                console.error('âŒ API é”™è¯¯:', errorData);
                alert('æ·»åŠ å¤±è´¥ï¼š' + (errorData.error || 'æœªçŸ¥é”™è¯¯'));
                restoreButtonState(addBtn, originalText, originalBg);
                return;
            }

            const result = await response.json();
            console.log('âœ… API å“åº”:', result);

            // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€ï¼ˆâœ“ ADDED TO CARTï¼‰
            showButtonSuccess(addBtn, originalText);

            // æ›´æ–°è´­ç‰©è½¦å¾½ç« 
            if (window.CartManager && window.CartManager.updateCartBadge) {
                await window.CartManager.updateCartBadge();
            }

        } catch (error) {
            console.error('âŒ API è°ƒç”¨å¤±è´¥:', error);

            // è¯¢é—®ç”¨æˆ·æ˜¯å¦ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            const useFallback = confirm('API è°ƒç”¨å¤±è´¥ã€‚æ˜¯å¦ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼Ÿ');
            if (!useFallback) {
                restoreButtonState(addBtn, originalText, originalBg);
                return;
            }

            console.log('ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥è°ƒç”¨ Supabase...');

            // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨ Supabase
            try {
                // å…ˆæ£€æŸ¥è´­ç‰©è½¦ä¸­æ˜¯å¦å·²æœ‰æ­¤äº§å“
                const { data: existingItems, error: fetchError } = await supabase
                    .from('cart_items')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('type', cartItemData.type);

                if (fetchError) {
                    console.error('Error checking existing items:', fetchError);
                    alert('æŸ¥è¯¢è´­ç‰©è½¦å¤±è´¥');
                    restoreButtonState(addBtn, originalText, originalBg);
                    return;
                }

                if (existingItems && existingItems.length > 0) {
                    // äº§å“å·²å­˜åœ¨ï¼Œæ›´æ–°æ•°é‡
                    const existingItem = existingItems[0];
                    const currentQty = existingItem.quantity || 1;
                    const newQty = currentQty + 1;

                    const { data, error } = await supabase
                        .from('cart_items')
                        .update({
                            quantity: newQty,
                            total_price: priceNumber * newQty,
                            sizes: { 'default': newQty },
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingItem.id)
                        .select()
                        .single();

                    if (error) {
                        console.error('Update error:', error);
                        alert('æ›´æ–°å¤±è´¥');
                        restoreButtonState(addBtn, originalText, originalBg);
                        return;
                    }

                    console.log('Updated existing item:', data);
                    showButtonSuccess(addBtn, originalText);

                } else {
                    // æ·»åŠ æ–°äº§å“åˆ°è´­ç‰©è½¦
                    const { data, error } = await supabase
                        .from('cart_items')
                        .insert(cartItemData)
                        .select()
                        .single();

                    if (error) {
                        console.error('Insert error:', error);

                        // å¦‚æœ item_data å­—æ®µä¸å­˜åœ¨ï¼Œå°è¯•ä¸åŒ…å«å®ƒ
                        if (error.message && error.message.includes('item_data')) {
                            console.log('Retrying without item_data field...');
                            delete cartItemData.item_data;

                            const { data: retryData, error: retryError } = await supabase
                                .from('cart_items')
                                .insert(cartItemData)
                                .select()
                                .single();

                            if (retryError) {
                                alert('æ·»åŠ å¤±è´¥ï¼š' + retryError.message);
                                restoreButtonState(addBtn, originalText, originalBg);
                                return;
                            }

                            console.log('Added to cart (without item_data):', retryData);
                        } else {
                            alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);
                            restoreButtonState(addBtn, originalText, originalBg);
                            return;
                        }
                    } else {
                        console.log('Added to cart:', data);
                    }

                    showButtonSuccess(addBtn, originalText);
                }

                // æ›´æ–°è´­ç‰©è½¦å¾½ç« 
                if (window.CartManager && window.CartManager.updateCartBadge) {
                    await window.CartManager.updateCartBadge();
                }

            } catch (fallbackError) {
                console.error('å¤‡ç”¨æ–¹æ¡ˆå¤±è´¥:', fallbackError);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                restoreButtonState(addBtn, originalText, originalBg);
            }
        }

    } catch (error) {
        console.error('Add to cart failed:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        restoreButtonState(addBtn, originalText, originalBg);
    }
}

// è¾…åŠ©å‡½æ•°ï¼šæ¢å¤æŒ‰é’®çŠ¶æ€
function restoreButtonState(button, originalText, originalBg) {
    if (!button) return;
    button.textContent = originalText;
    button.style.backgroundColor = originalBg;
    button.disabled = false;
}

// è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºæˆåŠŸçŠ¶æ€
function showButtonSuccess(button, originalText) {
    if (!button) return;
    
    // è®¾ç½®æˆåŠŸçŠ¶æ€
    button.textContent = 'âœ“ ADDED TO CART';
    button.style.backgroundColor = 'black';
    button.disabled = true;
    
    // è§¦å‘è´­ç‰©è½¦æ›´æ–°æ•ˆæœ
    if (window.CartManager) {
        if (window.CartManager.showCartAddedEffect) {
            window.CartManager.showCartAddedEffect();
        }
        if (window.CartManager.updateCartCount) {
            window.CartManager.updateCartCount();
        }
    }
    
    // å»¶è¿Ÿåæ¢å¤åŸçŠ¶
    setTimeout(() => {
        restoreButtonState(button, originalText, 'black');
    }, 2000);
}

            // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initContentPage);
            } else {
                initContentPage();
            }

            // SPAå¯¼èˆªåé‡æ–°åˆå§‹åŒ–
            window.addEventListener('contentPageLoaded', initContentPage);
        })();</script><script defer="defer" src="/js/vendors.515c171d2c3970a6f856.js"></script><script defer="defer" src="/js/styles.ce885c7f7bfcf71c21e1.js"></script><script defer="defer" src="/js/global.29ae42a5a12d3894d4f3.js"></script></body>