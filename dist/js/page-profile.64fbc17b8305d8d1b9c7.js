/*! For license information please see page-profile.64fbc17b8305d8d1b9c7.js.LICENSE.txt */
(()=>{function e(n){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(n)}function n(e){return function(e){if(Array.isArray(e))return t(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,n){if(e){if("string"==typeof e)return t(e,n);var a={}.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?t(e,n):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function t(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,a=Array(n);t<n;t++)a[t]=e[t];return a}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach(function(n){i(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}function i(n,t,a){return(t=function(n){var t=function(n,t){if("object"!=e(n)||!n)return n;var a=n[Symbol.toPrimitive];if(void 0!==a){var r=a.call(n,t||"default");if("object"!=e(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(n)}(n,"string");return"symbol"==e(t)?t:t+""}(t))in n?Object.defineProperty(n,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[t]=a,n}function o(){var e,n,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",r=t.toStringTag||"@@toStringTag";function i(t,a,r,i){var o=a&&a.prototype instanceof c?a:c,l=Object.create(o.prototype);return s(l,"_invoke",function(t,a,r){var i,o,s,c=0,l=r||[],u=!1,p={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(n,t){return i=n,o=0,s=e,p.n=t,d}};function f(t,a){for(o=t,s=a,n=0;!u&&c&&!r&&n<l.length;n++){var r,i=l[n],f=p.p,g=i[2];t>3?(r=g===a)&&(s=i[(o=i[4])?5:(o=3,3)],i[4]=i[5]=e):i[0]<=f&&((r=t<2&&f<i[1])?(o=0,p.v=a,p.n=i[1]):f<g&&(r=t<3||i[0]>a||a>g)&&(i[4]=t,i[5]=a,p.n=g,o=0))}if(r||t>1)return d;throw u=!0,a}return function(r,l,g){if(c>1)throw TypeError("Generator is already running");for(u&&1===l&&f(l,g),o=l,s=g;(n=o<2?e:s)||!u;){i||(o?o<3?(o>1&&(p.n=-1),f(o,s)):p.n=s:p.v=s);try{if(c=2,i){if(o||(r="next"),n=i[r]){if(!(n=n.call(i,s)))throw TypeError("iterator result is not an object");if(!n.done)return n;s=n.value,o<2&&(o=0)}else 1===o&&(n=i.return)&&n.call(i),o<2&&(s=TypeError("The iterator does not provide a '"+r+"' method"),o=1);i=e}else if((n=(u=p.n<0)?s:t.call(a,p))!==d)break}catch(n){i=e,o=1,s=n}finally{c=1}}return{value:n,done:u}}}(t,r,i),!0),l}var d={};function c(){}function l(){}function u(){}n=Object.getPrototypeOf;var p=[][a]?n(n([][a]())):(s(n={},a,function(){return this}),n),f=u.prototype=c.prototype=Object.create(p);function g(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,s(e,r,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=u,s(f,"constructor",u),s(u,"constructor",l),l.displayName="GeneratorFunction",s(u,r,"GeneratorFunction"),s(f),s(f,r,"Generator"),s(f,a,function(){return this}),s(f,"toString",function(){return"[object Generator]"}),(o=function(){return{w:i,m:g}})()}function s(e,n,t,a){var r=Object.defineProperty;try{r({},"",{})}catch(e){r=0}s=function(e,n,t,a){if(n)r?r(e,n,{value:t,enumerable:!a,configurable:!a,writable:!a}):e[n]=t;else{var i=function(n,t){s(e,n,function(e){return this._invoke(n,t,e)})};i("next",0),i("throw",1),i("return",2)}},s(e,n,t,a)}function d(e,n,t,a,r,i,o){try{var s=e[i](o),d=s.value}catch(e){return void t(e)}s.done?n(d):Promise.resolve(d).then(a,r)}function c(e){return function(){var n=this,t=arguments;return new Promise(function(a,r){var i=e.apply(n,t);function o(e){d(i,a,r,o,s,"next",e)}function s(e){d(i,a,r,o,s,"throw",e)}o(void 0)})}}var l,u="undefined"!=typeof window&&"localhost"===window.location.hostname?"http://localhost:3001":"";function p(e){return f.apply(this,arguments)}function f(){return f=c(o().m(function e(n){var t,a,i,s,d,c,l,p,f,m,b,y,v=arguments;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return t=v.length>1&&void 0!==v[1]?v[1]:{},e.n=1,g();case 1:a=null;try{if(i=localStorage.getItem("supabase.auth.token"))try{s=JSON.parse(i),a=s.access_token}catch(e){}}catch(e){}if(!a&&window.authManager&&window.authManager.isAuthenticated()&&(a=window.authManager.getToken()),a||!window.supabase){e.n=5;break}return e.p=2,e.n=3,window.supabase.auth.getSession();case 3:d=e.v,c=d.data.session,d.error||(a=(null==c?void 0:c.access_token)||null),e.n=5;break;case 4:e.p=4,e.v;case 5:return l=r({"Content-Type":"application/json"},t.headers),a&&(l.Authorization="Bearer ".concat(a)),e.p=6,e.n=7,fetch("".concat(u).concat(n),r(r({},t),{},{headers:l}));case 7:if((p=e.v).ok){e.n=12;break}return f="",e.p=8,e.n=9,p.text();case 9:f=e.v,e.n=11;break;case 10:e.p=10,e.v,JSON.parse(f);case 11:401===p.status&&(localStorage.removeItem("supabase.auth.token"),window.authManager&&window.authManager.clearSession(),window.dispatchEvent(new CustomEvent("authStateChanged",{detail:{isAuthenticated:!1}})),setTimeout(function(){window.dispatchEvent(new CustomEvent("showAuthModal",{detail:{message:"会话已过期，请重新登录",redirect:window.location.href}}))},500)),m="API 请求失败: ".concat(p.status);try{b=JSON.parse(f),m=b.error||m}catch(e){f&&(m=f)}throw new Error(m);case 12:return e.n=13,p.json();case 13:return y=e.v,e.a(2,y);case 14:throw e.p=14,e.v;case 15:return e.a(2)}},e,null,[[8,10],[6,14],[2,4]])})),f.apply(this,arguments)}function g(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;return new Promise(function(t){var a=0,r=function(){window.authManager||a>=e?t():(a++,setTimeout(r,n))};r()})}function m(){return b.apply(this,arguments)}function b(){return(b=c(o().m(function e(){var n,t;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!window.authManager||!window.authManager.isAuthenticated()){e.n=1;break}return e.a(2,window.authManager.getCurrentUser());case 1:if(e.p=1,!window.supabase){e.n=3;break}return e.n=2,window.supabase.auth.getUser();case 2:return n=e.v,t=n.data.user,e.a(2,t);case 3:e.n=5;break;case 4:e.p=4,e.v;case 5:return e.a(2,null)}},e,null,[[1,4]])}))).apply(this,arguments)}function y(){return v.apply(this,arguments)}function v(){return(v=c(o().m(function e(){var n,t;return o().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,m();case 1:if(n=e.v){e.n=2;break}return alert("请先登录"),t=new CustomEvent("showAuthModal",{detail:{message:"请登录后操作",redirect:window.location.href}}),window.dispatchEvent(t),e.a(2,null);case 2:return e.a(2,n)}},e)}))).apply(this,arguments)}(l=document.getElementById("library"))&&!l.classList.contains("active")&&l.classList.add("active");var w=!1;function h(){window.eventListenersInitialized||(window.eventListenersInitialized=!0,document.addEventListener("click",handleGlobalClick),document.addEventListener("keydown",function(e){"Escape"===e.key&&N()}))}function x(e){return k.apply(this,arguments)}function k(){return(k=c(o().m(function e(t){var a;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!t||"function"!=typeof t.then){e.n=4;break}return e.p=1,e.n=2,t;case 2:t=e.v,e.n=4;break;case 3:return e.p=3,e.v,e.a(2,"");case 4:if(Array.isArray(t)&&0!==t.length){e.n=5;break}return e.a(2,"");case 5:return a=n(t).sort(function(e,n){return e.display_order-n.display_order}),e.a(2,'\n        <div class="note-annotations" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">\n            <div style="font-weight: bold; margin-bottom: 8px; font-size: 13px;">注解:</div>\n            '.concat(a.map(function(e){return'\n                <div style="margin-bottom: 6px; line-height: 1.4; font-size: 12px;">\n                    <span style="color: #0066cc; font-weight: bold; margin-right: 4px;">'.concat(E(e.display_order),"</span>\n                    <span>").concat(e.annotation_text||"（无注解内容）","</span>\n                </div>\n            ")}).join(""),"\n        </div>\n    "))}},e,null,[[1,3]])}))).apply(this,arguments)}function E(e){return e<=20?["⓪","①","②","③","④","⑤","⑥","⑦","⑧","⑨","⑩","⑪","⑫","⑬","⑭","⑮","⑯","⑰","⑱","⑲","⑳"][e]:"(".concat(e,")")}function S(e){var n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,function(e){return n[e]})}function I(){return(I=c(o().m(function e(n,t){var a,i,s,d,c,l,u,p,f,g,m;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("drafts").select("*").eq("id",n).single();case 1:if(a=e.v,i=a.data,!a.error&&i){e.n=2;break}return alert("Unable to add to cart"),e.a(2);case 2:return s=29.99,i.data&&(d=i.data,c=d.color||"white",l=d.backImages&&d.backImages.length>0,u=l?"double-sided":"single-sided",window.TSHIRT_PRICING&&window.TSHIRT_PRICING[u]&&(s="white"===c?window.TSHIRT_PRICING[u].white:"black"===c?window.TSHIRT_PRICING[u].black:window.TSHIRT_PRICING[u].colored)),e.n=3,y();case 3:if(p=e.v){e.n=4;break}return e.a(2);case 4:return f=r(r({},i.data),{},{sizeQuantities:t}),e.n=5,supabase.from("drafts").update({data:f,sizes:t,updated_at:(new Date).toISOString()}).eq("id",n);case 5:if(g=e.v,g.error,!window.CartManager||!window.CartManager.addOrUpdateCartItem){e.n=7;break}return e.n=6,window.CartManager.addOrUpdateCartItem({draftId:n,itemData:{type:"custom-design",designType:"custom",color:(null===(m=i.data)||void 0===m?void 0:m.color)||"white",title:i.title||"Custom T-shirt Design",unitPrice:s},sizes:t,userId:p.id});case 6:e.v;case 7:e.n=9;break;case 8:e.p=8,e.v,alert("Operation failed, please try again.");case 9:return e.a(2)}},e,null,[[0,8]])}))).apply(this,arguments)}function P(){return T.apply(this,arguments)}function T(){return(T=c(o().m(function e(){return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,p("/api/drafts");case 1:A(e.v),e.n=3;break;case 2:e.p=2,e.v;case 3:return e.a(2)}},e,null,[[0,2]])}))).apply(this,arguments)}function A(e){var n=document.getElementById("draft");if(n)if(e&&0!==e.length){var t=e.map(function(e){var n="";return("svg"===e.type||"tshirt"===e.type)&&(n=e.front_preview_image),'\n        <div class="draft-item" data-id="'.concat(e.id,'">\n            <div style="display: flex; align-items: center; gap: 10px;">\n                <img src="').concat(n,'" alt="预览" \n                     style="width: 80px; height: 80px; object-fit: cover;  border: 2px solid black; aspect-ratio: 1 / 1; ">\n                <div style="flex: 1;">\n                    <p>').concat("svg"===e.type?"DOODLE":"T-SHIRT","</p>\n                    <p>CREATED: ").concat(new Date(e.created_at).toLocaleString(),'</p>\n                </div>\n                <div class="button-containe">\n                    <button class="load-draft-btn" data-draft-id="').concat(e.id,'" style="margin-right: 10px; border: 2px solid black; background:white; width:100px;font-size: 15px">LOAD</button>\n                    <button class="delete-draft-btn" data-draft-id="').concat(e.id,'" style="color: black;border: 2px solid black; background:white; width:100px; font-size: 15px">DELETE</button>\n                </div>\n            </div>\n        </div>\n        ')}).join("");n.innerHTML=t}else n.innerHTML='\n            <div style="text-align: center; padding: 40px;">\n                <h2 style="color: black; margin-bottom: 20px;">NO DRAFTS YET</h2>\n                <p style="color: #999;">Your drafts will appear here after you save your design</p>\n            </div>\n        '}function C(){return(C=c(o().m(function e(n){return o().w(function(e){for(;;)switch(e.n){case 0:if(!w){e.n=1;break}return e.a(2);case 1:w=!0,setTimeout(c(o().m(function e(){return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("确定要删除这个草稿吗？")){e.n=1;break}return w=!1,e.a(2);case 1:return e.p=1,e.n=2,p("/api/drafts/".concat(n),{method:"DELETE"});case 2:return alert("草稿已删除"),e.n=3,P();case 3:e.n=5;break;case 4:e.p=4,e.v,alert("删除失败");case 5:return e.p=5,setTimeout(function(){w=!1},500),e.f(5);case 6:return e.a(2)}},e,null,[[1,4,5,6]])})),0);case 2:return e.a(2)}},e)}))).apply(this,arguments)}function _(){return(_=c(o().m(function e(n){var t;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,p("/api/drafts/".concat(n));case 1:"svg"===(t=e.v).type?L(t):"tshirt"===t.type&&D(t),e.n=3;break;case 2:e.p=2,e.v;case 3:return e.a(2)}},e,null,[[0,2]])}))).apply(this,arguments)}function L(e){var n='\n    \n        <div id="draftPreviewModal" class="modal-overlay-svg" style="position: fixed; top: 0; left: 5px; width: calc(100% - 10px); height: 100%; z-index: 10000;  display: flex; justify-content: center; align-items: center; ">\n            <div class="modal-content-svg" style="background: white; padding: 20px;  max-width: 100vw; max-height: 100vh;  border: 2px solid black;">\n                <div class="preview-container" style="display: flex; gap: 30px; justify-content: center; margin-bottom: 20px;">\n                    <div class="preview-item" style="text-align: center;">\n                        <span style="font-size: 18px; margin-bottom: 10px; display: block;">PREVIEW</span>\n                        <div class="preview-tshirt" style="width: 200px; height: 250px; background-image: url(\''.concat(e.front_preview_image,'\'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto; outline: none; box-shadow: none;border: 2px solid black;"></div>\n                    </div>\n                </div>\n              \n                <div class="modal-buttons" style="display: flex; gap: 20px; justify-content: space-between;">\n                    <button class="edit-draft" data-draft-id="').concat(e.id,'" style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 150px;">BACK TO EDIT</button>\n                    <button class="add-in-gallery" data-draft-id="').concat(e.id,'" style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 150px;">ADD TO GALLERY</button>\n                </div>\n            </div>\n        </div>\n    ');document.body.insertAdjacentHTML("beforeend",n)}function D(e){var n,t=(null===(n=e.data)||void 0===n?void 0:n.sizeQuantities)||e.sizes||{XS:0,S:0,M:0,L:0,XL:0,"2XL":0,"3XL":0},a='\n    <div id="draftPreviewModal" class="modal-overlay" style="position: fixed; top: 0; left: 5px; width: calc(100% - 10px); height: 100%; z-index: 10000; display: flex; justify-content: center; align-items: center;">\n      <div class="modal-content" style="background: white; padding: 25px; max-width: 70vh; max-height: 80vh; overflow-y: auto; border: 2px solid black; position: relative;">\n        <div class="preview-container" style="display: flex; gap: 30px; justify-content: center; margin-bottom: 20px;">\n          <div class="preview-item" style="text-align: center;">\n            <span style="font-size: 18px; margin-bottom: 10px; display: block;">FRONT</span>\n            <div style="border: 2px black solid;">\n              <div class="preview-tshirt" style="width: 200px; height: 250px; min-width: 120px; background-image: url(\''.concat(e.front_preview_image,'\'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto;"></div>\n            </div>\n          </div>\n          <div class="preview-item" style="text-align: center;">\n            <span style="font-size: 18px; margin-bottom: 10px; display: block;">BACK</span>\n            <div style="border: 2px black solid;">\n              <div class="preview-tshirt" style="width: 200px; height: 250px; min-width: 100px; background-image: url(\'').concat(e.back_preview_image,'\'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto;"></div>\n            </div>\n          </div>\n        </div>\n        \n        <div class="size-selection-horizontal" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 20px;">\n          ').concat(["XS","S","M","L","XL","2XL","3XL"].map(function(e){return'\n            <div class="size-option">\n              <label>'.concat(e,'</label>\n              <div class="quantity-control" style="display: flex; align-items: center; overflow: hidden;">\n                <input type="number" class="quantity-input" data-size="').concat(e,'" value="').concat(t[e]||0,'" min="0" max="99" style="width: 45px; height: 30px; text-align: center; border: 2px solid black;">\n              </div>\n            </div>\n          ')}).join(""),'\n        </div>\n        \n        <div class="modal-buttons" style="display: flex; gap: 20px; justify-content: space-between;">\n          <button class="edit-draft" data-draft-id="').concat(e.id,'" style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 120px;">BACK TO EDIT</button>\n          <button class="add-to-cart-tshirt" data-draft-id="').concat(e.id,'" style="width: 200px; font-size: 16px; border: 2px solid black; background: white; cursor: pointer; min-width: 120px;">UPDATE CART</button>\n        </div>\n      </div>\n    </div>\n    ');document.body.insertAdjacentHTML("beforeend",a)}function N(){var e=document.getElementById("draftPreviewModal");e&&e.remove()}function O(){return(O=c(o().m(function e(n){var t,a;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("drafts").select("*").eq("id",n).single();case 1:if(t=e.v,a=t.data,!t.error&&a){e.n=2;break}return alert("无法加载草稿"),e.a(2);case 2:"svg"===a.type?window.location.href="/?loadSvgDraft=".concat(n):"tshirt"===a.type&&(window.location.href="/?loadTshirtDraft=".concat(n)),e.n=4;break;case 3:e.p=3,e.v,alert("加载失败，请重试");case 4:return e.a(2)}},e,null,[[0,3]])}))).apply(this,arguments)}function B(){return(B=c(o().m(function e(n){var t,a,r,i,s,d,c,l,u,p,f,g;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,y();case 1:if(i=e.v){e.n=2;break}return e.a(2);case 2:return e.n=3,supabase.from("drafts").select("*").eq("id",n).single();case 3:if(s=e.v,d=s.data,!s.error&&d){e.n=4;break}return alert("无法获取草稿信息"),e.a(2);case 4:if("svg"===d.type){e.n=5;break}return alert("只能将SVG草稿添加到Gallery"),e.a(2);case 5:return e.n=6,supabase.from("gallery").select("id").eq("draft_id",n).maybeSingle();case 6:if(c=e.v,!c.data){e.n=7;break}return alert("This artwork is already in the gallery!"),e.a(2);case 7:return l=prompt("Give your artwork a title:","My Doodle")||"Untitled",u=prompt("Add a description (optional):","")||"",p={user_id:i.id,draft_id:n,title:l,description:u,preview_image:d.front_preview_image,svg_url:(null===(t=d.data)||void 0===t?void 0:t.storageUrl)||null,svg_data:(null===(a=d.data)||void 0===a?void 0:a.svgContent)||(null===(r=d.data)||void 0===r?void 0:r.svgData)||null},e.n=8,supabase.from("gallery").insert([p]).select().single();case 8:if(f=e.v,f.data,!(g=f.error)){e.n=9;break}return alert("添加失败："+g.message),e.a(2);case 9:if(!confirm("Successfully added to gallery! Do you want to delete this draft?")){e.n=11;break}return e.n=10,z(n);case 10:e.n=13;break;case 11:if(N(),!confirm("View in gallery now?")){e.n=12;break}"function"==typeof loadPage?loadPage("gallery"):window.location.href="/gallery",e.n=13;break;case 12:return e.n=13,P();case 13:e.n=15;break;case 14:e.p=14,e.v,alert("添加失败，请重试");case 15:return e.a(2)}},e,null,[[0,14]])}))).apply(this,arguments)}function z(e){return M.apply(this,arguments)}function M(){return(M=c(o().m(function e(t){var a,r,i,s,d,c,l,u,p,f;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("drafts").select("*").eq("id",t).single();case 1:if(a=e.v,r=a.data,!a.error){e.n=2;break}return e.a(2);case 2:if(i=[],s=function(e){if(!e||"string"!=typeof e)return null;var n=e.match(/\/storage\/v1\/object\/public\/design-files\/(.+)/);return n?n[1]:null},"svg"===r.type&&(null!==(d=r.data)&&void 0!==d&&d.storageUrl&&(l=s(r.data.storageUrl))&&i.push(l),null!==(c=r.data)&&void 0!==c&&c.fileName&&i.push(r.data.fileName)),!((u=n(new Set(i))).length>0)){e.n=4;break}return e.n=3,supabase.storage.from("design-files").remove(u);case 3:p=e.v,p.error;case 4:return e.n=5,supabase.from("drafts").delete().eq("id",t);case 5:if(f=e.v,!f.error){e.n=6;break}alert("草稿删除失败"),e.n=8;break;case 6:if(N(),!confirm("Draft deleted. View in gallery now?")){e.n=7;break}"function"==typeof loadPage?loadPage("gallery"):window.location.href="/gallery",e.n=8;break;case 7:return e.n=8,P();case 8:e.n=10;break;case 9:e.p=9,e.v;case 10:return e.a(2)}},e,null,[[0,9]])}))).apply(this,arguments)}function j(){return R.apply(this,arguments)}function R(){return(R=c(o().m(function e(){var n,t;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,(n=document.getElementById("order"))&&(n.innerHTML='\n                <div style="padding: 20px; text-align: center;">\n                    <div class="loading">Loading orders...</div>\n                </div>\n            '),e.n=1,p("/api/orders");case 1:F(e.v),e.n=3;break;case 2:e.p=2,e.v,(t=document.getElementById("order"))&&(t.innerHTML='<p style="text-align: center; padding: 20px;">Error loading orders. Please try again.</p>');case 3:return e.a(2)}},e,null,[[0,2]])}))).apply(this,arguments)}function F(e){var n=document.getElementById("order");if(n)if(e&&0!==e.length){var t="";e.forEach(function(e){var n=new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),a=e.paid_at?new Date(e.paid_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Not paid",r="",i="#666";switch(e.status){case"awaiting_verification":r="AWAITING VERIFICATION (等待审核)",i="#FFA500";break;case"verified":r="PAYMENT VERIFIED (付款已确认)",i="#28a745";break;case"shipped":r="SHIPPED (已发货)",i="#17a2b8";break;case"delivered":r="DELIVERED (已送达)",i="#28a745";break;case"cancelled":r="CANCELLED (已取消)",i="#dc3545";break;default:r=e.status.toUpperCase()}var o=parseFloat(e.amount)||0,s=parseFloat(e.shipping_cost)||0,d=parseFloat(e.tax_amount)||0,c=o+s+d,l="";"awaiting_verification"===e.status||"verified"===e.status?l+='\n         <button class="cancel-order-btn" data-order-id="'.concat(e.order_id,'"  style="\n             padding: 5px 20px;\n             font-size:15px;\n             background: white;\n             color: black;\n             cursor: pointer;\n             border: 2px black solid;\n         ">CANCEL ORDER</button>\n     '):"shipped"!==e.status&&"delivered"!==e.status||(l+='\n         <button class="track-order-btn" data-order-id="'.concat(e.order_id,'" data-tracking-number="').concat(e.tracking_number||"",'"  style="\n         padding: 5px 20px;\n         font-size:15px;\n         background: white;\n         color: black;\n         cursor: pointer;\n         border: 2px black solid;\n         ">ORDER TRACKING</button>\n     ')),t+='\n            <div class="order-item" style="\n                background: white;\n                border: 2px solid black;\n                padding: 20px;\n                margin-bottom: 20px;\n                position: relative;\n            ">\n                <div class="order-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;  ">\n                    <div >\n                        <h3 style="margin: 0; font-size: 20px;">ORDER #'.concat(e.order_id,'</h3>\n                        <p style="color: #666; margin: 5px 0; font-size: 14px;">Placed on ').concat(n,'</p>\n                    </div>\n                    <div class="status" style="text-align: right;">\n                        <span class="status-badge" style="\n                            background: ').concat(i,';\n                        ">').concat(r,'</span>\n                    </div>\n                </div>\n\n                <div style="  margin-bottom: 15px; font-size: 15px;">\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">\n                        <span>Manifesto#:</span>\n                        <span>').concat(e.manifesto||"Anonymous",'</span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">\n                        <span>Payment Method:</span>\n                        <span>').concat("alipay"===e.payment_method?"Alipay (支付宝)":"wechat"===e.payment_method?"WeChat Pay (微信支付)":e.payment_method,"</span>\n                    </div>\n                    ").concat(e.paid_at?'\n                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">\n                            <span>Paid At:</span>\n                            <span>'.concat(a,"</span>\n                        </div>\n                    "):"",'\n                </div>\n\n                <div style="border-top: 2px solid black; padding-top: 15px; margin-bottom: 15px;">\n                    <h4 style="margin-bottom: 10px;">Items (').concat(e.items?e.items.length:0,")</h4>\n                    ").concat(e.items&&e.items.length>0?'\n                        <div style="max-height: 200px; overflow-y: auto;">\n                            '.concat(e.items.map(function(e){return'\n                                <div style="\n                                    display: flex;\n                                    justify-content: space-between;\n                                   \n                                    margin-bottom: 5px;\n                                ">\n                                    <div>\n                                        <strong>'.concat(function(e){if(!e)return"Unknown Item";if(e.title)return e.title;if(e.productName)return e.productName;if(e.name)return e.name;if(e.item_data)if("string"==typeof e.item_data)try{var n=JSON.parse(e.item_data);if(n.productName)return n.productName;if(n.name)return n.name}catch(e){}else if(e.item_data.productName)return e.item_data.productName;if(e.type){if(e.type.startsWith("console-")){var t=e.type.replace("console-","");return"RETRO CONSOLE #".concat(t)}if(e.type.includes("blank-tshirt"))return"BLANK T-SHIRT";if(e.type.includes("custom-design")||e.draft_id)return"CUSTOMIZED T-SHIRT"}return"PRODUCT"}(e),"</strong>\n                                        ").concat(e.size?'<span style="color: #666; ">Size: '.concat(e.size,"</span>"):"","\n                                        ").concat(e.quantity>1?'<span style="color: #666; margin-left: 10px;">× '.concat(e.quantity,"</span>"):"","\n                                    </div>\n                                    <div>\n                                        ¥").concat((parseFloat(e.price)*(e.quantity||1)).toFixed(2),"\n                                    </div>\n                                </div>\n                            ")}).join(""),"\n                        </div>\n                    "):'<p style="color: #999;">No item details available</p>','\n                </div>\n\n                <div style="border-top: black 2px solid ; padding-top: 15px; margin-bottom: 15px;">\n                    <h4 style="margin-bottom: 10px;">Shipping Address</h4>\n                    ').concat(e.shipping_address?'\n                        <div style="  font-size: 14px;">\n                       '.concat(e.shipping_address.fullName||e.shipping_address.name||"","<br>\n                        ").concat(e.shipping_address.email?"Email: ".concat(e.shipping_address.email,"<br>"):"","\n                        ").concat(e.shipping_address.phone?"Phone: ".concat(e.shipping_address.phone,"<br>"):"","\n                        ").concat(e.shipping_address.address1||e.shipping_address.street||"","<br>\n                        ").concat(e.shipping_address.address2?"".concat(e.shipping_address.address2,"<br>"):"","\n                        ").concat(e.shipping_address.city||""," ").concat(e.shipping_address.state||""," ").concat(e.shipping_address.zipCode||"","<br>\n                        ").concat(e.shipping_address.country||"","\n                        </div>\n                    "):'<p style="color: #999;">No shipping address provided</p>','\n                </div>\n\n                <div style="border-top: 2px solid black; padding-top: 15px;">\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size:15px;">\n                        <span>Subtotal:</span>\n                        <span>¥').concat(o.toFixed(2),'</span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size:15px;">\n                        <span>Shipping:</span>\n                        <span>¥').concat(s.toFixed(2),'</span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size:15px;">\n                        <span>Tax:</span>\n                        <span>¥').concat(d.toFixed(2),'</span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">\n                        <span>Total:</span>\n                        <span>¥').concat(c.toFixed(2),"</span>\n                    </div>\n                </div>\n\n               \n                ").concat(e.tracking_number?'\n                    <div style="margin-top: 15px; padding: 10px;  border: 2px solid black;">\n                        <strong>Tracking Number:</strong> '.concat(e.tracking_number,"<br>\n                        <strong>Courier:</strong> ").concat(e.courier,"\n                    </div>\n                "):"",'\n\n                <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">\n                    ').concat(l,"\n                </div>\n          \n               \n        </div>\n        ")}),n.innerHTML=t}else n.innerHTML='\n            <div style="text-align: center; padding: 40px;">\n                <h2 style="color: black; margin-bottom: 20px;">NO ORDERS YET</h2>\n                <p style="color: #999;">Your orders will appear here after purchase</p>\n            </div>\n        '}function q(){return(q=c(o().m(function e(n,t,a){var r;return o().w(function(e){for(;;)switch(e.n){case 0:if(t){e.n=1;break}return alert("Tracking number not available yet.\n追踪号码尚未生成。\n\nPlease check back later.\n请稍后再查看。"),e.a(2);case 1:r="https://www.17track.net/en#nums=".concat(t,"&auto=1"),window.open(r,"_blank");case 2:return e.a(2)}},e)}))).apply(this,arguments)}document.addEventListener("DOMContentLoaded",function(){var e=setInterval(function(){window.authManager&&(clearInterval(e),window.authManager.isAuthenticated()&&(setTimeout(c(o().m(function e(){return o().w(function(e){for(;;)switch(e.n){case 0:if("function"!=typeof window.displayUserProfile){e.n=2;break}return e.n=1,window.displayUserProfile();case 1:case 2:return e.a(2)}},e)})),200),h()))},100)}),window.loadedSections={library:!1,order:!1,draft:!1,setting:!1},window.forceReloadSection=function(e){window.loadedSections.hasOwnProperty(e)&&(window.loadedSections[e]=!1)},window.handleGlobalClick=function(e){if(e.target.classList.contains("menu-item")){var n=e.target.getAttribute("data-target");if(!n)return;if(!window.authManager||!window.authManager.isAuthenticated()){alert("请先登录");var t=new CustomEvent("showAuthModal",{detail:{message:"请登录后操作",redirect:window.location.href}});return void window.dispatchEvent(t)}document.querySelectorAll(".menu-item").forEach(function(e){return e.classList.remove("active")}),e.target.classList.add("active"),document.querySelectorAll(".content-section").forEach(function(e){return e.classList.remove("active")});var a=document.getElementById(n);return a&&a.classList.add("active"),"library"===n&&(window.loadedSections.library||setTimeout(c(o().m(function e(){return o().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,window.loadLibrary();case 1:window.loadedSections.library=!0;case 2:return e.a(2)}},e)})),50)),"draft"===n&&setTimeout(function(){P()},50),"order"===n&&(window.loadedSections.order||setTimeout(c(o().m(function e(){return o().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,j();case 1:window.loadedSections.order=!0;case 2:return e.a(2)}},e)})),50)),void("setting"===n&&setTimeout(function(){G()},50))}if(e.target.classList.contains("load-draft-btn")){e.preventDefault(),e.stopPropagation();var r=e.target.getAttribute("data-draft-id");r&&function(e){_.apply(this,arguments)}(r)}else if(e.target.classList.contains("delete-draft-btn")){e.preventDefault(),e.stopPropagation();var i=e.target.getAttribute("data-draft-id");i&&!w&&function(e){C.apply(this,arguments)}(i)}else if(e.target.classList.contains("edit-draft")){e.preventDefault(),e.stopPropagation();var s=e.target.getAttribute("data-draft-id");s&&function(e){O.apply(this,arguments)}(s)}else if(e.target.classList.contains("add-to-cart-tshirt")){e.preventDefault(),e.stopPropagation();var d=e.target.getAttribute("data-draft-id");if(d){var l=document.querySelectorAll("#draftPreviewModal .quantity-input"),u={},p=!1;if(l.forEach(function(e){var n=e.getAttribute("data-size"),t=parseInt(e.value)||0;t>0&&(u[n]=t,p=!0)}),!p)return void alert("Please select at least one size");!function(e,n){I.apply(this,arguments)}(d,u)}}else if(e.target.classList.contains("add-in-gallery")){e.preventDefault(),e.stopPropagation();var f=e.target.getAttribute("data-draft-id");f&&function(e){B.apply(this,arguments)}(f)}else if(e.target.classList.contains("modal-overlay")||e.target.classList.contains("modal-overlay-svg"))"draftPreviewModal"===e.target.id&&N();else if(e.target.classList.contains("view-order-details-btn")){e.preventDefault(),e.stopPropagation();var g=e.target.getAttribute("data-order-id");g&&viewOrderDetails(g)}else if(e.target.classList.contains("cancel-order-btn")){e.preventDefault(),e.stopPropagation();var m=e.target.getAttribute("data-order-id");m&&function(e){H.apply(this,arguments)}(m)}else if(e.target.classList.contains("track-order-btn")){e.preventDefault(),e.stopPropagation();var b=e.target.getAttribute("data-order-id"),y=e.target.getAttribute("data-tracking-number");b&&function(e,n,t){q.apply(this,arguments)}(b,y)}else if(e.target.classList.contains("reorder-items-btn")){e.preventDefault(),e.stopPropagation();var v=e.target.getAttribute("data-order-id");v&&reorderItems(v)}else{if(e.target.classList.contains("close-tracking-modal-x-btn"))return e.preventDefault(),e.stopPropagation(),void closeTrackingModal();if(e.target.classList.contains("close-tracking-modal-btn"))return e.preventDefault(),e.stopPropagation(),void closeTrackingModal();if(e.target.classList.contains("open-courier-website-btn")){e.preventDefault(),e.stopPropagation();var h=e.target.getAttribute("data-tracking-number");h&&window.open("https://www.example-courier.com/track/".concat(h),"_blank")}else e.target.classList.contains("modal-overlay")?"draftPreviewModal"===e.target.id&&N():"trackingModal"!==e.target.id||closeTrackingModal()}},"undefined"!=typeof window&&"undefined"!=typeof displayUserProfile&&(window.displayUserProfile=displayUserProfile),window.reloadProfileBarcode=c(o().m(function e(){return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,displayUserProfile();case 1:e.n=3;break;case 2:e.p=2,e.v;case 3:return e.a(2)}},e,null,[[0,2]])})),window.addEventListener("profilePageLoaded",c(o().m(function e(){return o().w(function(e){for(;;)switch(e.n){case 0:if("function"!=typeof displayUserProfile){e.n=1;break}return e.n=1,displayUserProfile();case 1:return e.a(2)}},e)}))),window.initializeEventListeners=h,window.apiRequest=p,window.loadLibrary=c(o().m(function e(){var n,t,a,r,i,s,d,c,l,u,f,g,m,b,y,v,w,h,k;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=document.getElementById("library")){e.n=1;break}return e.a(2);case 1:return n.innerHTML='\n        <div style="padding: 20px; text-align: center;">\n            <div class="loading">Loading your library...</div>\n        </div>\n    ',e.p=2,e.n=3,p("/api/library");case 3:if(t=e.v,a=window.BOOKS_DATA||{},r="<div>",t.readingBooks&&t.readingBooks.length>0&&(r+='<div class="library-section" style="margin-bottom: 10px;">',r+='<div style="font-size: 22px;  border: 2px black solid; ">READ ('+t.readingBooks.length+")</div>",r+='<div style="margin-bottom: 10px;"></div>',r+='<div class="library-books-grid" style=" display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">',t.readingBooks.forEach(function(e){var n=a[e.book_id];if(n){var i,o=(null===(i=t.notesByBook[e.book_id])||void 0===i?void 0:i.length)||0;r+='\n                        <div class="library-book-card" style="border: 2px solid black; padding: 10px; cursor: pointer;" \n                             onclick="scrollToBook(\''.concat(n.id,"', '").concat(n.category,'\')"\n                             >\n                             <div style="display: flex; justify-content: center; width: 100%; margin-bottom: 10px;">\n                            <img src="').concat(n.imgSrc,'" alt="').concat(n.title,'" style="width: 100px; height: auto; object-fit: cover;">\n                            </div>\n                            <span style="font-size: 16px;">').concat(n.title,'</span><br>\n                            <span style="font-size: 12px; color: #666;">').concat(o," NOTES</span>\n                        </div>\n                    ")}}),r+="</div></div>"),t.wantBooks&&t.wantBooks.length>0&&(r+='<div class="library-section" style="margin-bottom: 10px;">',r+='<div style="font-size: 22px; border: 2px black solid;">WANT ('+t.wantBooks.length+")</div>",r+='<div style="margin-bottom: 10px;"></div>',r+='<div class="library-books-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">',t.wantBooks.forEach(function(e){var n=a[e.book_id];if(n){var i,o=(null===(i=t.notesByBook[e.book_id])||void 0===i?void 0:i.length)||0;r+='\n                        <div class="library-book-card" style="border: 2px solid black; padding: 10px; cursor: pointer; " \n                             onclick="scrollToBook(\''.concat(n.id,"', '").concat(n.category,'\')"\n                             >\n                             <div style="display: flex; justify-content: center; width: 100%; margin-bottom: 10px;">\n                            <img src="').concat(n.imgSrc,'" alt="').concat(n.title,'" style="width: 100px; height: auto; object-fit: cover; "></div>\n                            <span style="font-size: 16px; margin-bottom: 5px;">').concat(n.title,'</span><br>\n                            <span style="font-size: 12px; color: #666;">').concat(o," NOTES</span>\n                        </div>\n                    ")}}),r+="</div></div>"),!(t.userNotes&&t.userNotes.length>0)){e.n=17;break}r+='<div class="library-section" style="margin-bottom: 10px;">',r+='<div style="font-size: 22px; border: 2px black solid;">MY NOTES ('+t.userNotes.length+")</div>",r+='<div style="margin-bottom: 10px;"></div>',i=0,s=Object.keys(t.notesByBook);case 4:if(!(i<s.length)){e.n=16;break}if(d=s[i],c=a[d],l=t.notesByBook[d],!(c&&l&&l.length>0)){e.n=15;break}r+='\n                        <div class="book-notes-section" style="margin-bottom: 10px; padding: 10px; border: 2px solid black;">\n                            <span style="font-size: 18px; cursor: pointer; font-weight: bold;" onclick="scrollToBook(\''.concat(d,"', '").concat(c.category,"')\">\n                                ").concat(c.title," (").concat(l.length,')\n                            </span>\n                            <div class="notes-list" id="library-notes-list-').concat(d,'">\n                    '),u=0;case 5:if(!(u<l.length)){e.n=14;break}if(f=l[u],g=new Date(f.created_at).toLocaleDateString("zh-CN"),m="",f.page_start&&f.page_end?m="P".concat(f.page_start,"-").concat(f.page_end):f.page_start&&(m="P".concat(f.page_start)),b=S(f.content),!f.annotations){e.n=9;break}if(!(y=f.annotations)||"function"!=typeof y.then){e.n=7;break}return e.n=6,y;case 6:y=e.v;case 7:return e.n=8,x(y);case 8:e.v;case 9:if(v=r,w='\n                            <div class="library-note-item" id="library-note-'.concat(f.id,'" style="margin-bottom: 10px; padding: 10px; border: 2px solid black; background-color: white;">\n                                <div class="note-content-display" style="margin-bottom: 10px; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-break: break-word;">').concat(b,"</div>\n                               "),!f.annotations){e.n=11;break}return e.n=10,x(f.annotations);case 10:h=e.v,e.n=12;break;case 11:h="";case 12:k=h,r=v+=w.concat.call(w,k,'\n                                <div class="note-meta" style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #666; margin-top: 10px;">\n                                    <span>').concat(m?m+" · ":"").concat(g,'</span>\n                                    <div style="display: flex; gap: 10px;">\n                                        <span class="note-edit-btn" onclick="editLibraryNote(\'').concat(f.id,"', '").concat(d,"', ").concat(f.page_start||"null",", ").concat(f.page_end||"null",')" style="cursor: pointer; color: #666; ">编辑</span>\n                                        <span class="note-delete-btn" onclick="deleteLibraryNote(\'').concat(f.id,"', '").concat(d,'\')" style="cursor: pointer; color: #666; ">删除</span>\n                                    </div>\n                                </div>\n                            </div>\n                        ');case 13:u++,e.n=5;break;case 14:r+="</div></div>";case 15:i++,e.n=4;break;case 16:r+="</div>";case 17:t.readingBooks&&0!==t.readingBooks.length||t.wantBooks&&0!==t.wantBooks.length||t.userNotes&&0!==t.userNotes.length||(r='\n                <div style="padding: 40px; text-align: center;">\n                     <h2 style="color: black; margin-bottom: 20px;">NO DRAFTS YET</h2>\n                    <p style="color: #999;">Go add some books or sound</p>\n                </div>\n            '),r+="</div>",n.innerHTML=r,e.n=19;break;case 18:e.p=18,e.v,n.innerHTML='\n            <div style="padding: 40px; text-align: center;">\n                <p style="color: red;">加载失败，请刷新重试</p>\n            </div>\n        ';case 19:return e.a(2)}},e,null,[[2,18]])})),window.scrollToBook=function(e,n){var t={law:"/law",game:"/game",design:"/design",culture:"/culture"}[n]||"/law";sessionStorage.setItem("scrollToBookId",e),sessionStorage.setItem("openNotesArea","true"),window.location.href=t},window.editLibraryNote=function(){var e=c(o().m(function e(n,t,a,r){var i,s,d,c;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,p("/api/library/notes/".concat(n));case 1:if(i=e.v){e.n=2;break}return alert("笔记未找到"),e.a(2);case 2:s=document.getElementById("library-note-".concat(n)),d=(d=i.content.replace(/[①-⑳⓪]/g,"")).split("\n").map(function(e){var n=e.trim();return n?n.replace(/^　+/g,""):""}).join("\n"),s.innerHTML='\n            <div style="margin-bottom: 10px;">\n                <div style="display: flex; gap: 10px; margin-bottom: 10px;">\n                    <input type="number" id="lib-edit-pageStart-'.concat(n,'" value="').concat(a||"",'" placeholder="起始页" \n                        style="width: 100px; padding: 5px; border: 2px solid black;">\n                    <span style="line-height: 30px;">-</span>\n                    <input type="number" id="lib-edit-pageEnd-').concat(n,'" value="').concat(r||"",'" placeholder="结束页" \n                        style="width: 100px; padding: 5px; border: 2px solid black;">\n                </div>\n                <div id="lib-edit-content-').concat(n,'" contenteditable="true" style="width: 100%; min-height: 120px; padding: 10px; border: 2px solid black; font-family: inherit; font-size: 14px; white-space: pre-wrap; line-height: 1.6;">').concat(S(d),'</div>\n            </div>\n            <div style="display: flex; gap: 10px; margin-top: 10px;">\n                <button onclick="saveLibraryNoteEdit(\'').concat(n,"', '").concat(t,'\')" style="padding: 5px 15px; border: 2px solid black; background-color: white; cursor: pointer;">保存</button>\n                <button onclick="cancelLibraryNoteEdit(\'').concat(n,"', '").concat(t,'\')" style="padding: 5px 15px; border: 2px solid black; background-color: white; cursor: pointer;">取消</button>\n            </div>\n        '),e.n=4;break;case 3:e.p=3,(c=e.v).message.includes("404")||c.message.includes("Not found")?alert("笔记不存在或已被删除\n笔记ID: ".concat(n)):c.message.includes("401")||c.message.includes("未授权")?(alert("登录已过期，请重新登录"),window.dispatchEvent(new CustomEvent("showAuthModal"))):alert("加载笔记失败，请重试\n错误: "+c.message);case 4:return e.a(2)}},e,null,[[0,3]])}));return function(n,t,a,r){return e.apply(this,arguments)}}(),window.saveLibraryNoteEdit=function(){var e=c(o().m(function e(n,t){var a,r,i,s;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,a=document.getElementById("lib-edit-content-".concat(n)),r=document.getElementById("lib-edit-pageStart-".concat(n)).value,i=document.getElementById("lib-edit-pageEnd-".concat(n)).value,s=(s=a.textContent.trim()).split("\n").map(function(e){var n=e.trim();return n?"　　"+n:""}).join("\n")){e.n=1;break}return alert("请输入笔记内容"),e.a(2);case 1:if(r){e.n=2;break}return alert("请填写页码"),e.a(2);case 2:return e.n=3,p("/api/library/notes/".concat(n),{method:"PATCH",body:JSON.stringify({content:s,page_start:parseInt(r),page_end:i?parseInt(i):null})});case 3:return e.n=4,loadLibrary();case 4:e.n=6;break;case 5:e.p=5,e.v,alert("保存失败，请重试");case 6:return e.a(2)}},e,null,[[0,5]])}));return function(n,t){return e.apply(this,arguments)}}(),window.cancelLibraryNoteEdit=function(){var e=c(o().m(function e(n,t){return o().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,loadLibrary();case 1:return e.a(2)}},e)}));return function(n,t){return e.apply(this,arguments)}}(),window.deleteLibraryNote=function(){var e=c(o().m(function e(n,t){return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("确定要删除这条笔记吗？")){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,p("/api/library/notes/".concat(n),{method:"DELETE"});case 2:return e.n=3,loadLibrary();case 3:e.n=5;break;case 4:e.p=4,e.v,alert("删除失败，请重试");case 5:return e.a(2)}},e,null,[[1,4]])}));return function(n,t){return e.apply(this,arguments)}}(),window.addEventListener("orderSubmitted",function(e){var n=document.getElementById("order");n&&n.classList.contains("active")&&j()});var U=window.confirmPayment;function H(){return(H=c(o().m(function e(n){var t;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.n=1,y();case 1:if(e.v){e.n=2;break}return e.a(2);case 2:if(confirm("Are you sure you want to cancel order #".concat(n,"?\n您确定要取消订单 #").concat(n," 吗？\n\nThis action cannot be undone.\n此操作无法撤销。"))){e.n=3;break}return e.a(2);case 3:return e.p=3,e.n=4,p("/api/orders/".concat(n,"/cancel"),{method:"PATCH"});case 4:return e.v,alert("Order #".concat(n," has been successfully cancelled.\n订单 #").concat(n," 已成功取消。")),e.n=5,j();case 5:e.n=7;break;case 6:e.p=6,(t=e.v).message.includes("404")?alert("Order not found or you do not have permission to cancel it.\n订单不存在或您无权限取消。"):t.message.includes("订单无法取消")?alert('The current order status does not allow cancellation.\nOnly pending or verified orders can be cancelled.\n\n当前订单状态不允许取消\n只有"待审核"或"已确认"的订单可以取消'):alert("Cancellation failed: ".concat(t.message,"\n取消失败: ").concat(t.message));case 7:return e.a(2)}},e,null,[[3,6]])}))).apply(this,arguments)}function G(){return V.apply(this,arguments)}function V(){return(V=c(o().m(function e(){var n,t,a,r;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=document.getElementById("setting")){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,m();case 2:if(t=e.v){e.n=3;break}return n.innerHTML='<p style="text-align: center; padding: 20px;">Please login to access settings</p>',e.a(2);case 3:return e.n=4,p("/api/profile/info");case 4:a=e.v,r=a||{},window.currentAddresses=(null==r?void 0:r.shipping_addresses)||[],n.innerHTML='\n            <style>\n                .settings-section {\n                    border: 2px solid black;\n                    padding: 20px;\n                    margin-bottom: 20px;\n                    background: white;\n                }\n                \n                .settings-section h3 {\n                    margin-top: 0;\n                    margin-bottom: 20px;\n                    font-size: 20px;\n                    border-bottom: 2px solid black;\n                    padding-bottom: 10px;\n                }\n                \n                .form-group {\n                    margin-bottom: 15px;\n                }\n                \n                .form-group label {\n                    display: block;\n                    margin-bottom: 5px;\n                    font-weight: bold;\n                    font-size: 14px;\n                }\n                \n                .form-group input, .form-group select {\n                    width: 100%;\n                    padding: 10px;\n                    border: 2px solid black;\n                    font-size: 14px;\n                    box-sizing: border-box;\n                    background: white;\n                }\n                \n                .form-group input[type="checkbox"] {\n                    width: auto;\n                    margin-right: 10px;\n                    transform: scale(1.2);\n                }\n                \n                .form-group label input[type="checkbox"] {\n                    display: inline;\n                    margin-right: 8px;\n                }\n                \n                .settings-btn {\n                    padding: 8px 20px;\n                    background: black;\n                    color: white;\n                    border: none;\n                    cursor: pointer;\n                    font-size: 16px;\n                    margin-right: 10px;\n                    margin-bottom: 5px;\n                }\n                \n                .settings-btn:hover {\n                    background: #333;\n                }\n                \n                .settings-btn:disabled {\n                    background: #999;\n                    cursor: not-allowed;\n                }\n                \n                .settings-btn.secondary {\n                    background: #666;\n                }\n                \n                .settings-btn.secondary:hover {\n                    background: #555;\n                }\n                \n                .success-message, .error-message {\n                    background: black;\n                    color: white;\n                    padding: 5px;\n                    margin-bottom: 10px;\n                    display: none;\n                    border-radius:0;\n                    position: relative;\n                    font-size:16px;\n                }\n                \n                \n                .two-columns {\n                    display: grid;\n                    grid-template-columns: 1fr 1fr;\n                    gap: 15px;\n                }\n                \n                .address-card {\n                    border: 2px solid black;\n                    padding: 15px;\n                    margin-bottom: 15px;\n                    position: relative;\n                }\n                \n                .address-card .address-header {\n                    display: flex;\n                    align-items: center;\n                    margin-bottom: 10px;\n                }\n                \n                .address-card .default-badge {\n                    background: black;\n                    color: white;\n                    padding: 2px 8px;\n                    font-size: 12px;\n                    margin-left: 15px;\n                    font-weight: bold;\n                }\n                \n                .address-card .address-info {\n                    font-size: 14px;\n                    color: #555;\n                    line-height: 1.4;\n                }\n                \n                .address-card .address-actions {\n                    margin-top: 15px;\n                    display: flex;\n                    gap: 10px;\n                    flex-wrap: wrap;\n                }\n                \n                .address-card .settings-btn {\n                    padding: 5px 12px;\n                    font-size: 12px;\n                    margin: 0;\n                }\n                \n                @media (max-width: 768px) {\n                    .two-columns {\n                        grid-template-columns: 1fr;\n                    }\n                    \n                    .address-card .address-actions {\n                        flex-direction: column;\n                    }\n                    \n                    .address-card .settings-btn {\n                        width: 100%;\n                        margin-bottom: 5px;\n                    }\n                }\n            </style>\n            \n            \x3c!-- Manifesto Section --\x3e\n            <div class="settings-section">\n                <h3>MANIFESTO USERNAME</h3>\n                <div id="manifestoMessage" class="success-message">Manifesto updated successfully!</div>\n                <div id="manifestoError" class="error-message"></div>\n                \n                <form id="manifestoForm">\n                    <div class="form-group">\n                        <label for="manifesto">Your Manifesto:</label>\n                        <input type="text" \n                               id="manifesto" \n                               name="manifesto" \n                               value="'.concat((null==r?void 0:r.manifesto)||"",'" \n                               placeholder="Enter your manifesto"\n                               maxlength="50">\n                    </div>\n                    <button type="submit" class="settings-btn save-manifesto-btn">SAVE MANIFESTO</button>\n                </form>\n            </div>\n            \n            \x3c!-- Shipping Information Section --\x3e\n            <div class="settings-section">\n                <h3>SHIPPING INFORMATION</h3>\n                <div id="shippingMessage" class="success-message">Shipping information updated successfully!</div>\n                <div id="shippingError" class="error-message"></div>\n                \n                \x3c!-- 已保存的地址列表 --\x3e\n                ').concat(null!=r&&r.shipping_addresses&&r.shipping_addresses.length>0?'\n                    <div style="margin-bottom: 25px;">\n                        <h4 style="margin-bottom: 15px; font-size: 16px;">Saved Addresses:</h4>\n                        '.concat(r.shipping_addresses.map(function(e,n){return'\n                            <div class="address-card">\n                                <div class="address-header">\n                                    <strong style="font-size: 16px;">'.concat(e.fullName,"</strong>\n                                    ").concat(e.isDefault?'<span class="default-badge">DEFAULT</span>':"",'\n                                </div>\n                                <div class="address-info">\n                                    ').concat(e.phone,"<br>\n                                    ").concat(e.address1," ").concat(e.address2||"","<br>\n                                    ").concat(e.city,", ").concat(e.state," ").concat(e.zipCode,"<br>\n                                    ").concat(e.country,'\n                                </div>\n                                <div class="address-actions">\n                                    <button class="settings-btn edit-address-btn" \n                                            data-address-index="').concat(n,'" style="background:white; border:black 2px solid;color:black; padding:0 10px; ">\n                                        EDIT\n                                    </button>\n                                    <button class="settings-btn delete-address-btn" \n                                            data-address-index="').concat(n,'"\n                                            style="background:white; border:black 2px solid; color:black; padding:0 10px;">\n                                        DELETE\n                                    </button>\n                                    ').concat(e.isDefault?"":'\n                                        <button class="settings-btn set-default-btn" \n                                                data-address-index="'.concat(n,'"\n                                                style="background:white; border:black 2px solid;color:black; padding:0 10px;">\n                                            SET AS DEFAULT\n                                        </button>\n                                    '),"\n                                </div>\n                            </div>\n                        ")}).join(""),"\n                    </div>\n                "):"",'\n                \n                \x3c!-- 添加/编辑地址表单 --\x3e\n                <div id="addressFormContainer">\n                    <h4 style="margin-bottom: 15px; font-size: 16px;">\n                        <span id="addressFormTitle">Add New Address</span>\n                    </h4>\n                    <form id="shippingForm">\n                        <input type="hidden" id="addressIndex" value="">\n                        \n                        <div class="two-columns">\n                            <div class="form-group">\n                                <label for="fullName">Full Name:</label>\n                                <input type="text" \n                                       id="fullName" \n                                       name="fullName" \n                                       value=""\n                                       required>\n                            </div>\n                            \n                            <div class="form-group">\n                                <label for="phone">Phone Number:</label>\n                                <input type="tel" \n                                       id="phone" \n                                       name="phone" \n                                       value=""\n                                       required>\n                            </div>\n                        </div>\n                        \n                        <div class="form-group">\n                            <label for="email">Email:</label>\n                            <input type="email" \n                                   id="email" \n                                   name="email" \n                                   value="').concat(t.email||"",'"\n                                   required>\n                        </div>\n                        \n                        <div class="form-group">\n                            <label for="address1">Address Line 1:</label>\n                            <input type="text" \n                                   id="address1" \n                                   name="address1" \n                                   value=""\n                                   required>\n                        </div>\n                        \n                        <div class="form-group">\n                            <label for="address2">Address Line 2 (Optional):</label>\n                            <input type="text" \n                                   id="address2" \n                                   name="address2" \n                                   value="">\n                        </div>\n                        \n                        <div class="two-columns">\n                            <div class="form-group">\n                                <label for="city">City:</label>\n                                <input type="text" \n                                       id="city" \n                                       name="city" \n                                       value=""\n                                       required>\n                            </div>\n                            \n                            <div class="form-group">\n                                <label for="state">State/Province:</label>\n                                <input type="text" \n                                       id="state" \n                                       name="state" \n                                       value=""\n                                       required>\n                            </div>\n                        </div>\n                        \n                        <div class="two-columns">\n                            <div class="form-group">\n                                <label for="zipCode">ZIP/Postal Code:</label>\n                                <input type="text" \n                                       id="zipCode" \n                                       name="zipCode" \n                                       value=""\n                                       required>\n                            </div>\n                            \n                            <div class="form-group">\n                                <label for="country">Country:</label>\n                                <select id="country" name="country" required>\n                                    <option value="">Select Country</option>\n                                    <option value="CN">中国</option>\n                                    <option value="HK">Hong Kong</option>\n                                    <option value="TW">臺灣</option>\n                                    <option value="JP">Japan</option>\n                                    <option value="UK">United Kingdom</option>\n                                <option value="US">United States</option>\n                                <option value="OTHER">Other</option>\n                                </select>\n                            </div>\n                        </div>\n                        \n                        <div class="form-group">\n                            <label>\n                                <input type="checkbox" id="setAsDefault" name="setAsDefault">\n                                Set as default address\n                            </label>\n                        </div>\n                        \n                        <button type="submit" class="settings-btn save-shipping-btn">SAVE ADDRESS</button>\n                        <button type="button" class="settings-btn secondary cancel-edit-btn" style="display: none;">CANCEL</button>\n                    </form>\n                </div>\n            </div>\n            \n            \x3c!-- Change Password Section --\x3e\n            <div class="settings-section">\n                <h3>CHANGE PASSWORD</h3>\n                <div id="passwordMessage" class="success-message">Password updated successfully!</div>\n                <div id="passwordError" class="error-message"></div>\n                \n                <form id="passwordForm">\n                    <div class="form-group">\n                        <label for="currentPassword">Current Password:</label>\n                        <input type="password" \n                               id="currentPassword" \n                               name="currentPassword" \n                               placeholder="Enter current password"\n                               required>\n                    </div>\n                    \n                    <div class="form-group">\n                        <label for="newPassword">New Password:</label>\n                        <input type="password" \n                               id="newPassword" \n                               name="newPassword" \n                               placeholder="Enter new password"\n                               minlength="6"\n                               required>\n                    </div>\n                    \n                    <div class="form-group">\n                        <label for="confirmPassword">Confirm New Password:</label>\n                        <input type="password" \n                               id="confirmPassword" \n                               name="confirmPassword" \n                               placeholder="Confirm new password"\n                               minlength="6"\n                               required>\n                    </div>\n                    \n                    <button type="submit" class="settings-btn change-password-btn">CHANGE PASSWORD</button>\n                </form>\n            </div>\n            \n            \x3c!-- Account Info Section --\x3e\n            <div class="settings-section">\n                <h3>ACCOUNT INFORMATION</h3>\n                <div style="line-height: 1.6;">\n                    <p><strong>Email:</strong> ').concat(t.email,"</p>\n                    <p><strong>User ID:</strong> ").concat(t.id,"</p>\n                    <p><strong>Account Created:</strong> ").concat(new Date(t.created_at).toLocaleDateString(),"</p>\n                </div>\n            </div>\n        "),W(),e.n=6;break;case 5:e.p=5,e.v,n.innerHTML='<p style="text-align: center; padding: 20px; color: red;">Error loading settings. Please try again.</p>';case 6:return e.a(2)}},e,null,[[1,5]])}))).apply(this,arguments)}function W(){var e=document.getElementById("manifestoForm");e&&e.addEventListener("submit",function(){var e=c(o().m(function e(n){return o().w(function(e){for(;;)switch(e.n){case 0:return n.preventDefault(),e.n=1,K();case 1:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}());var n=document.getElementById("shippingForm");n&&n.addEventListener("submit",function(){var e=c(o().m(function e(n){return o().w(function(e){for(;;)switch(e.n){case 0:return n.preventDefault(),e.n=1,Y();case 1:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}());var t=document.getElementById("passwordForm");t&&t.addEventListener("submit",function(){var e=c(o().m(function e(n){return o().w(function(e){for(;;)switch(e.n){case 0:return n.preventDefault(),e.n=1,$();case 1:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}()),document.querySelectorAll(".edit-address-btn").forEach(function(e){e.addEventListener("click",function(e){!function(e){var n=(window.currentAddresses||[])[e];if(!n)return;document.getElementById("addressIndex").value=e,document.getElementById("fullName").value=n.fullName||"",document.getElementById("phone").value=n.phone||"",document.getElementById("email").value=n.email||"",document.getElementById("address1").value=n.address1||"",document.getElementById("address2").value=n.address2||"",document.getElementById("city").value=n.city||"",document.getElementById("state").value=n.state||"",document.getElementById("zipCode").value=n.zipCode||"",document.getElementById("country").value=n.country||"",document.getElementById("setAsDefault").checked=n.isDefault||!1,document.getElementById("addressFormTitle").textContent="Edit Address",document.querySelector(".save-shipping-btn").textContent="UPDATE ADDRESS",document.querySelector(".cancel-edit-btn").style.display="inline-block";var t=document.querySelector(".right-panel"),a=document.getElementById("addressFormContainer");if(t&&a){var r=a.offsetTop;t.scrollTo({top:r-20,behavior:"smooth"})}}(parseInt(e.target.dataset.addressIndex))})}),document.querySelectorAll(".delete-address-btn").forEach(function(e){e.addEventListener("click",function(e){!function(e){Q.apply(this,arguments)}(parseInt(e.target.dataset.addressIndex))})}),document.querySelectorAll(".set-default-btn").forEach(function(e){e.addEventListener("click",function(e){!function(e){Z.apply(this,arguments)}(parseInt(e.target.dataset.addressIndex))})});var a=document.querySelector(".cancel-edit-btn");a&&a.addEventListener("click",function(){!function(){document.getElementById("shippingForm").reset(),document.getElementById("addressIndex").value="",document.getElementById("addressFormTitle").textContent="Add New Address",document.querySelector(".cancel-edit-btn").style.display="none";var e=supabase.auth.getUser().data.user;e&&(document.getElementById("email").value=e.email||"")}()})}function K(){return J.apply(this,arguments)}function J(){return(J=c(o().m(function e(){var n,t,a,r;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=document.getElementById("manifesto").value.trim(),t=document.getElementById("manifestoMessage"),a=document.getElementById("manifestoError"),r=document.querySelector(".save-manifesto-btn"),t.style.display="none",a.style.display="none",n){e.n=1;break}return a.textContent="Manifesto name cannot be empty",a.style.display="block",e.a(2);case 1:return r.disabled=!0,r.textContent="SAVING...",e.p=2,e.n=3,p("/api/profile/manifesto",{method:"PATCH",body:JSON.stringify({manifesto:n})});case 3:if(t.style.display="block","function"!=typeof displayUserProfile){e.n=4;break}return e.n=4,displayUserProfile();case 4:setTimeout(function(){t.style.display="none"},3e3),e.n=6;break;case 5:e.p=5,e.v,a.textContent="Failed to update manifesto. Please try again.",a.style.display="block";case 6:return e.p=6,r.disabled=!1,r.textContent="SAVE MANIFESTO",e.f(6);case 7:return e.a(2)}},e,null,[[2,5,6,7]])}))).apply(this,arguments)}function Y(){return X.apply(this,arguments)}function X(){return(X=c(o().m(function e(){var n,t,a,r,i,s,d,c,l;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=document.getElementById("shippingForm"),t=new FormData(n),a=document.getElementById("shippingMessage"),r=document.getElementById("shippingError"),i=document.querySelector(".save-shipping-btn"),s=document.getElementById("addressIndex").value,a.style.display="none",r.style.display="none",d={fullName:t.get("fullName"),phone:t.get("phone"),email:t.get("email"),address1:t.get("address1"),address2:t.get("address2")||"",city:t.get("city"),state:t.get("state"),zipCode:t.get("zipCode"),country:t.get("country"),isDefault:"on"===t.get("setAsDefault")},i.disabled=!0,i.textContent="SAVING...",e.p=1,c="/api/profile/address",l="POST",""!==s&&(c="/api/profile/address/".concat(s),l="PATCH"),e.n=2,p(c,{method:l,body:JSON.stringify(d)});case 2:a.style.display="block",setTimeout(function(){a.style.display="none",G()},2e3),e.n=4;break;case 3:e.p=3,e.v,r.textContent="Failed to update shipping information. Please try again.",r.style.display="block";case 4:return e.p=4,i.disabled=!1,i.textContent="SAVE ADDRESS",e.f(4);case 5:return e.a(2)}},e,null,[[1,3,4,5]])}))).apply(this,arguments)}function Q(){return(Q=c(o().m(function e(n){var t,a;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("Are you sure you want to delete this address?")){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,p("/api/profile/address/".concat(n),{method:"DELETE"});case 2:(t=document.getElementById("shippingMessage")).textContent="Address deleted successfully!",t.style.display="block",setTimeout(function(){t.style.display="none",G()},2e3),e.n=4;break;case 3:e.p=3,e.v,(a=document.getElementById("shippingError")).textContent="Failed to delete address. Please try again.",a.style.display="block",setTimeout(function(){a.style.display="none"},5e3);case 4:return e.a(2)}},e,null,[[1,3]])}))).apply(this,arguments)}function Z(){return(Z=c(o().m(function e(n){var t,a;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,p("/api/profile/address/".concat(n,"/default"),{method:"PATCH"});case 1:(t=document.getElementById("shippingMessage")).textContent="Default address updated successfully!",t.style.display="block",setTimeout(function(){t.style.display="none",G()},2e3),e.n=3;break;case 2:e.p=2,e.v,(a=document.getElementById("shippingError")).textContent="Failed to set default address. Please try again.",a.style.display="block",setTimeout(function(){a.style.display="none"},5e3);case 3:return e.a(2)}},e,null,[[0,2]])}))).apply(this,arguments)}function $(){return ee.apply(this,arguments)}function ee(){return(ee=c(o().m(function e(){var n,t,a,r,i,s,d,c,l,u,p,f;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=document.getElementById("currentPassword").value,t=document.getElementById("newPassword").value,a=document.getElementById("confirmPassword").value,r=document.getElementById("passwordMessage"),i=document.getElementById("passwordError"),s=document.querySelector(".change-password-btn"),r.style.display="none",i.style.display="none",n){e.n=1;break}return i.textContent="Please enter your current password.",i.style.display="block",e.a(2);case 1:if(t){e.n=2;break}return i.textContent="Please enter a new password.",i.style.display="block",e.a(2);case 2:if(a){e.n=3;break}return i.textContent="Please confirm your new password.",i.style.display="block",e.a(2);case 3:if(t===a){e.n=4;break}return i.textContent="New passwords do not match.",i.style.display="block",e.a(2);case 4:if(!(t.length<6)){e.n=5;break}return i.textContent="Password must be at least 6 characters.",i.style.display="block",e.a(2);case 5:if(n!==t){e.n=6;break}return i.textContent="New password must be different from current password.",i.style.display="block",e.a(2);case 6:return s.disabled=!0,s.textContent="UPDATING...",e.p=7,e.n=8,m();case 8:if(d=e.v){e.n=9;break}return i.textContent="Please login first.",i.style.display="block",s.disabled=!1,s.textContent="CHANGE PASSWORD",e.a(2);case 9:return e.n=10,window.supabase.auth.signInWithPassword({email:d.email,password:n});case 10:if(c=e.v,!(l=c.error)){e.n=11;break}return l.message.includes("Invalid login credentials")||l.message.includes("Invalid password")?i.textContent="Current password is incorrect.":i.textContent="Password verification failed: "+l.message,i.style.display="block",s.disabled=!1,s.textContent="CHANGE PASSWORD",e.a(2);case 11:return e.n=12,window.supabase.auth.updateUser({password:t});case 12:if(u=e.v,!(p=u.error)){e.n=13;break}return i.textContent="Failed to update password: "+p.message,i.style.display="block",s.disabled=!1,s.textContent="CHANGE PASSWORD",e.a(2);case 13:r.textContent="Password updated successfully!",r.style.display="block",document.getElementById("currentPassword").value="",document.getElementById("newPassword").value="",document.getElementById("confirmPassword").value="",setTimeout(function(){r.style.display="none"},5e3),e.n=15;break;case 14:e.p=14,(f=e.v).message&&f.message.includes("Invalid login credentials")?i.textContent="Current password is incorrect.":i.textContent=f.message||"Failed to update password. Please try again.",i.style.display="block";case 15:return e.p=15,s.disabled=!1,s.textContent="CHANGE PASSWORD",e.f(15);case 16:return e.a(2)}},e,null,[[7,14,15,16]])}))).apply(this,arguments)}window.confirmPayment=c(o().m(function e(){var n,t,a,r,i,s,d,c,l,u,p,f,g,m;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.n=1,U.call(this);case 1:return window.dispatchEvent(new CustomEvent("orderSubmitted",{detail:{orderId:null===(n=window.currentOrder)||void 0===n?void 0:n.orderId}})),e.p=2,e.n=3,supabase.auth.getUser();case 3:if(t=e.v,a=t.data.user,!t.error&&a){e.n=4;break}return alert("Please login to complete payment"),e.a(2);case 4:return e.n=5,getCartItems();case 5:return r=e.v,i=generateOrderId(),s=calculateSubtotal(r),d=calculateShipping(),c=calculateTax(s),l=r.map(function(e){return{draft_id:e.draft_id,size:e.size,quantity:e.quantity,price:e.price,title:e.title||"Custom Design"}}),u={order_id:i,user_id:a.id,items:l,status:"awaiting_verification",amount:s,shipping_cost:d,tax_amount:c,payment_method:window.selectedPaymentMethod||"pending",shipping_address:window.shippingAddress||{},manifesto:window.currentManifesto||null,created_at:(new Date).toISOString(),paid_at:(new Date).toISOString()},e.n=6,supabase.from("orders").insert([u]).select().single();case 6:if(p=e.v,f=p.data,!p.error){e.n=7;break}return alert("Failed to create order"),e.a(2);case 7:return e.n=8,saveDraftImagesToOrderStorage(f.order_id,l);case 8:if(!((g=e.v)&&g.length>0)){e.n=10;break}return e.n=9,supabase.from("orders").update({saved_images:g}).eq("order_id",f.order_id);case 9:m=e.v,m.error;case 10:return e.n=11,clearCart();case 11:return showPaymentSuccessModal(f.order_id),window.dispatchEvent(new CustomEvent("orderSubmitted",{detail:{orderId:f.order_id}})),window.currentOrder={orderId:f.order_id},e.a(2,f);case 12:return e.p=12,e.v,alert("Payment processing failed. Please try again."),e.a(2,null)}},e,this,[[2,12]])})),document.addEventListener("authStateChanged",c(o().m(function e(){var n,t,a;return o().w(function(e){for(;;)switch(e.n){case 0:if(!window.authManager||!window.authManager.isAuthenticated()){e.n=10;break}if(!(n=document.querySelector(".content-section.active"))){e.n=9;break}t=n.id,a=t,e.n="library"===a?1:"draft"===a?3:"order"===a?5:"setting"===a?7:9;break;case 1:return e.n=2,window.loadLibrary();case 2:return e.a(3,9);case 3:return e.n=4,P();case 4:return e.a(3,9);case 5:return e.n=6,j();case 6:return e.a(3,9);case 7:return e.n=8,G();case 8:return e.a(3,9);case 9:e.n=11;break;case 10:["library","draft","order","setting"].forEach(function(e){var n=document.getElementById(e);n&&(n.innerHTML='\n                    <div style="padding: 40px; text-align: center;">\n                        <p>请登录查看内容</p>\n                    </div>\n                ')});case 11:return e.a(2)}},e)})))})();