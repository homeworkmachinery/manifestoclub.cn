/*! For license information please see page-home.df9c68f3684cf59bdd51.js.LICENSE.txt */
(()=>{"use strict";var e,t,n,r={5828:(e,t,n)=>{var r=n(354),a=n.n(r);function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function o(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,i,o,c=[],s=!0,l=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;s=!1}else for(;!(s=(r=i.call(n)).done)&&(c.push(r.value),c.length!==t);s=!0);}catch(e){l=!0,a=e}finally{try{if(!s&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(l)throw a}}return c}}(e,t)||p(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e){return function(e){if(Array.isArray(e))return m(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||p(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach(function(t){u(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function u(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=i(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=i(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==i(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function d(e){throw new TypeError('"'+e+'" is read-only')}function f(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=p(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){c=!0,i=e},f:function(){try{o||null==n.return||n.return()}finally{if(c)throw i}}}}function p(e,t){if(e){if("string"==typeof e)return m(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?m(e,t):void 0}}function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function h(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",a=n.toStringTag||"@@toStringTag";function i(n,r,a,i){var s=r&&r.prototype instanceof c?r:c,l=Object.create(s.prototype);return v(l,"_invoke",function(n,r,a){var i,c,s,l=0,u=a||[],d=!1,f={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return i=t,c=0,s=e,f.n=n,o}};function p(n,r){for(c=n,s=r,t=0;!d&&l&&!a&&t<u.length;t++){var a,i=u[t],p=f.p,m=i[2];n>3?(a=m===r)&&(s=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=e):i[0]<=p&&((a=n<2&&p<i[1])?(c=0,f.v=r,f.n=i[1]):p<m&&(a=n<3||i[0]>r||r>m)&&(i[4]=n,i[5]=r,f.n=m,c=0))}if(a||n>1)return o;throw d=!0,r}return function(a,u,m){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&p(u,m),c=u,s=m;(t=c<2?e:s)||!d;){i||(c?c<3?(c>1&&(f.n=-1),p(c,s)):f.n=s:f.v=s);try{if(l=2,i){if(c||(a="next"),t=i[a]){if(!(t=t.call(i,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,c<2&&(c=0)}else 1===c&&(t=i.return)&&t.call(i),c<2&&(s=TypeError("The iterator does not provide a '"+a+"' method"),c=1);i=e}else if((t=(d=f.n<0)?s:n.call(r,f))!==o)break}catch(t){i=e,c=1,s=t}finally{l=1}}return{value:t,done:d}}}(n,a,i),!0),l}var o={};function c(){}function s(){}function l(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(v(t={},r,function(){return this}),t),d=l.prototype=c.prototype=Object.create(u);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,v(e,a,"GeneratorFunction")),e.prototype=Object.create(d),e}return s.prototype=l,v(d,"constructor",l),v(l,"constructor",s),s.displayName="GeneratorFunction",v(l,a,"GeneratorFunction"),v(d),v(d,a,"Generator"),v(d,r,function(){return this}),v(d,"toString",function(){return"[object Generator]"}),(h=function(){return{w:i,m:f}})()}function v(e,t,n,r){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}v=function(e,t,n,r){if(t)a?a(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n;else{var i=function(t,n){v(e,t,function(e){return this._invoke(t,n,e)})};i("next",0),i("throw",1),i("return",2)}},v(e,t,n,r)}function g(e,t,n,r,a,i,o){try{var c=e[i](o),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(r,a)}function y(e){return function(){var t=this,n=arguments;return new Promise(function(r,a){var i=e.apply(t,n);function o(e){g(i,r,a,o,c,"next",e)}function c(e){g(i,r,a,o,c,"throw",e)}o(void 0)})}}var b="front",w="white",k=[],E=null,L=!1,S=!1,x=null,I=0,C=0,T=0,B=0,A=0,M=0,O=1,R=document.getElementById("tshirtContainer"),D=document.getElementById("tshirtBackground"),P=document.getElementById("resizeHandles"),U=(document.getElementById("tshirtImage"),document.getElementById("colorPicker"),{front:[],back:[]}),_={front:!1,back:!1},j={front:null,back:null};function q(){var e=Array.from(R.querySelectorAll(".uploaded-image"));U[b]=e.map(function(e){return{src:e.src,className:e.className,style:{width:e.style.width,height:e.style.height,left:e.style.left,top:e.style.top},dataset:{aspectRatio:e.dataset.aspectRatio},isMemberCode:e.classList.contains("member-code-image")}})}function z(){var e=document.getElementById("memberCodeBtn");if(e){var t=_[b];e.textContent=t?"REMOVE USER CODE":"INSERT USER CODE"}}function N(){return H.apply(this,arguments)}function H(){return(H=y(h().m(function e(){var t;return h().w(function(e){for(;;)switch(e.n){case 0:if(!(t=document.getElementById("member-barcode-complete"))||!t.src||"none"===t.style.display){e.n=1;break}return e.a(2,t.src);case 1:return e.n=2,G();case 2:return e.a(2,e.v)}},e)}))).apply(this,arguments)}function G(){return W.apply(this,arguments)}function W(){return(W=y(h().m(function e(){var t,n,r,a,i,o;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,"undefined"!=typeof supabase){e.n=1;break}return e.a(2,null);case 1:return e.n=2,supabase.auth.getUser();case 2:if(t=e.v,n=t.data.user){e.n=3;break}return e.a(2,null);case 3:return e.n=4,supabase.from("profiles").select("manifesto, barcode").eq("user_id",n.id).single();case 4:if(r=e.v,a=r.data,!r.error&&a){e.n=5;break}return e.a(2,null);case 5:if(void 0===window.barcodeGenerator){e.n=7;break}return(i=document.createElement("img")).style.display="none",document.body.appendChild(i),e.n=6,window.barcodeGenerator.generateBarcodeImage(a.manifesto||"No manifesto",a.barcode,i.id||"temp-barcode");case 6:return o=e.v,document.body.removeChild(i),e.a(2,o);case 7:return e.a(2,null);case 8:return e.p=8,e.v,e.a(2,null)}},e,null,[[0,8]])}))).apply(this,arguments)}function X(){return F.apply(this,arguments)}function F(){return(F=y(h().m(function e(){var t,n;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.auth.getUser();case 1:if(t=e.v,t.data.user){e.n=2;break}return openAuthModal(),showLoginForm(),e.a(2,null);case 2:if(!_[b]){e.n=3;break}return e.a(2);case 3:return e.n=4,N();case 4:if(n=e.v){e.n=5;break}return alert("无法获取用户代码，请确保您的档案信息完整"),e.a(2);case 5:return e.a(2,new Promise(function(e,t){var r=new Image;r.onload=function(){var t=document.createElement("img");t.className="uploaded-image member-code-image",t.src=n,t.style.width="160px",t.style.height="auto";var r=R.offsetWidth||400;t.style.left=(r-160)/2+"px";var a=window.innerWidth<=899;t.style.top=a?"105px":"120px",t.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,R.appendChild(t),j[b]=t,_[b]=!0,Ee(t),z(),e(t)},r.onerror=function(){alert("用户代码图片加载失败"),t(new Error("用户代码图片加载失败"))},r.src=n}));case 6:throw e.p=6,e.v;case 7:return e.a(2)}},e,null,[[0,6]])}))).apply(this,arguments)}function V(){var e=j[b];if(e||(e=R.querySelector(".member-code-image")),e&&R.contains(e)){E===e&&Ie(),R.removeChild(e);var t=k.indexOf(e);t>-1&&k.splice(t,1)}j[b]=null,_[b]=!1,z();R.querySelector(".member-code-image")}function Y(){return(Y=y(h().m(function e(){return h().w(function(e){for(;;)switch(e.n){case 0:if(!_[b]){e.n=1;break}V(),e.n=2;break;case 1:return e.n=2,X();case 2:return e.a(2)}},e)}))).apply(this,arguments)}function Q(){q();var e=document.getElementById("saveModal"),t=document.getElementById("frontPreview"),n=document.getElementById("backPreview");e&&t&&n&&(K("front",t),K("back",n),e.classList.remove("hidden"))}function $(e,t,n){return J.apply(this,arguments)}function J(){return J=y(h().m(function e(t,n,r){var a,i,o,c,s,l,u,f,p,m,v,g,y,b=arguments;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(a=b.length>3&&void 0!==b[3]?b[3]:800,e.p=1,t&&t.startsWith("data:image/")){e.n=2;break}return e.a(2,null);case 2:return e.n=3,supabase.auth.getUser();case 3:if(i=e.v,o=i.data.user,!i.error&&o){e.n=4;break}return e.a(2,null);case 4:return e.n=5,te(t,a,.8);case 5:if(c=e.v){e.n=6;break}return e.a(2,null);case 6:return s=ee(c),l="".concat(n,"/images/").concat(r),e.n=7,supabase.storage.from("design-files").upload(l,s,{cacheControl:"3600",upsert:!0,contentType:s.type});case 7:if(u=e.v,u.data,!(f=u.error)){e.n=13;break}if(!(null!==(p=f.message)&&void 0!==p&&p.includes("duplicate")||null!==(m=f.message)&&void 0!==m&&m.includes("already exists"))){e.n=12;break}return e.n=8,supabase.storage.from("design-files").remove([l]);case 8:return e.n=9,supabase.storage.from("design-files").upload(l,s,{cacheControl:"3600",upsert:!0,contentType:s.type});case 9:if(v=e.v,v.data,!v.error){e.n=10;break}return e.a(2,null);case 10:d("data");case 11:e.n=13;break;case 12:return e.a(2,null);case 13:if(g=supabase.storage.from("design-files").getPublicUrl(l),y=g.data.publicUrl){e.n=14;break}return e.a(2,null);case 14:return e.a(2,{fileName:l,publicUrl:y,size:s.size,optimized:!0,uploadTime:(new Date).toISOString()});case 15:return e.p=15,e.v,e.a(2,null)}},e,null,[[1,15]])})),J.apply(this,arguments)}function K(e,t){t.innerHTML="";var n={front:{white:"./images/white-front.png",black:"./images/black-front.png"},back:{white:"./images/white-back.png",black:"./images/black-back.png"}},r=n[e]&&n[e][w]?n[e][w]:"./images/white-front.png",a=document.createElement("img");a.src=r,a.crossOrigin="anonymous",a.style.cssText="\n        position: absolute;\n        top: 50%;\n        margin-top: -50%;\n        left: 0;\n        width: 100%;\n        object-fit: contain;\n        z-index: 1;\n    ",t.appendChild(a),t.style.cssText="\n        position: relative;\n        background: white;\n        overflow: hidden;\n        border: 0 ; \n    ";var i,o,c,s,l,u=window.innerWidth<=899,d=R.offsetWidth||400,f=R.offsetHeight||500;if(u?(i=120,o=150):(i=200,o=250),u){var p=i/d,m=o/f;c=.9*Math.min(p,m),s=(i-d*c)/2,l=(o-f*c)/2+2}else{var h=i/d,v=o/f;c=1.4*Math.min(h,v),s=(i-d*c)/2,l=(o-f*c)/2+3}U[e]&&U[e].length>0&&U[e].forEach(function(e,n){var r=document.createElement("img");r.src=e.src,r.className="preview-image",r.crossOrigin="anonymous",r.style.cssText="\n                position: absolute;\n                z-index: 10;\n                pointer-events: none;\n            ";var a=parseInt(e.style.width)*c,i=parseInt(e.style.height)*c,o=parseInt(e.style.left)*c+s,d=parseInt(e.style.top)*c+l;r.style.width=a+"px",r.style.height=i+"px",r.style.left=o+"px",r.style.top=u?d-5+"px":d-12+"px",t.appendChild(r)})}function Z(){document.getElementById("saveModal").classList.add("hidden")}function ee(e){for(var t=e.split(","),n=t[0].match(/:(.*?);/)[1],r=atob(t[1]),a=r.length,i=new Uint8Array(a),o=0;o<a;o++)i[o]=r.charCodeAt(o);return new Blob([i],{type:n})}function te(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return new Promise(function(r){var a=document.createElement("canvas"),i=a.getContext("2d"),o=new Image;o.onload=function(){var o=this.width,c=this.height;if(o>t){var s=t/o;o=t,c*=s}a.width=o,a.height=c,i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.drawImage(this,0,0,o,c);var l="image/jpeg",u=n;if(e.includes("data:image/png")){for(var d=i.getImageData(0,0,o,c).data,f=!1,p=3;p<d.length;p+=4)if(d[p]<255){f=!0;break}f&&(l="image/png",u=void 0)}var m=a.toDataURL(l,u);r(m)},o.src=e})}function ne(e){return re.apply(this,arguments)}function re(){return re=y(h().m(function e(t){var n,r,i=arguments;return h().w(function(e){for(;;)if(0===e.n)return n=i.length>1&&void 0!==i[1]?i[1]:1200,r=i.length>2&&void 0!==i[2]?i[2]:"transparent",e.a(2,new Promise(function(e,i){var o=t.getBoundingClientRect?t.getBoundingClientRect():{width:300,height:300},c=o.width/o.height||1,s=document.createElement("canvas");s.width=n,s.height=n/c;var l=s.getContext("2d");if("transparent"!==r&&(l.fillStyle=r,l.fillRect(0,0,s.width,s.height)),t.tagName&&"svg"===t.tagName.toLowerCase()){var u=(new XMLSerializer).serializeToString(t),d=new Blob([u],{type:"image/svg+xml;charset=utf-8"}),f=URL.createObjectURL(d),p=new Image;p.onload=function(){try{l.drawImage(p,0,0,s.width,s.height);var t=s.toDataURL("image/png");URL.revokeObjectURL(f),e(t)}catch(e){i(e)}},p.onerror=function(e){URL.revokeObjectURL(f),i(new Error("SVG 转 PNG 加载失败"))},p.src=f}else a()(t,{backgroundColor:"transparent"===r?null:r,useCORS:!0,scale:n/o.width,width:o.width,height:o.height}).then(function(t){var n=t.toDataURL("image/png");e(n)}).catch(function(e){return i(e)})}))},e)})),re.apply(this,arguments)}function ae(e){return ie.apply(this,arguments)}function ie(){return(ie=y(h().m(function e(t){var n;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,ne(t,1200,"transparent");case 1:return n=e.v,e.a(2,n);case 2:return e.p=2,e.v,e.a(2,null)}},e,null,[[0,2]])}))).apply(this,arguments)}function oe(){return ce.apply(this,arguments)}function ce(){return(ce=y(h().m(function e(){var t,n,r,i,o,s,u,d,f,p,m,v,g,y,k,E,L,S;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,checkUserLogin();case 1:if(t=e.v){e.n=2;break}return e.a(2);case 2:if(qe()){e.n=3;break}return alert("请先添加设计元素再保存"),e.a(2);case 3:if(q(),n=document.getElementById("frontPreview"),r=document.getElementById("backPreview"),n&&r){e.n=4;break}return alert("预览容器未找到，请重试"),e.a(2);case 4:return e.n=5,se(n);case 5:return e.n=6,se(r);case 6:return i={backgroundColor:"#ffffff",useCORS:!0,allowTaint:!1,removeContainer:!0,scale:1,logging:!1,foreignObjectRendering:!1,imageTimeout:15e3,width:n.offsetWidth,height:n.offsetHeight,onclone:function(e){e.querySelectorAll("img").forEach(function(e){e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.transform="none"})}},e.p=7,e.n=8,a()(n,i);case 8:o=e.v,e.n=11;break;case 9:return e.p=9,e.v,e.n=10,fe(n);case 10:o=e.v;case 11:return e.p=11,e.n=12,a()(r,i);case 12:s=e.v,e.n=15;break;case 13:return e.p=13,e.v,e.n=14,fe(r);case 14:s=e.v;case 15:return u=ue(o),d=ue(s),e.n=16,me(U.front,t.id,"front");case 16:return f=e.v,e.n=17,me(U.back,t.id,"back");case 17:return p=e.v,m=Date.now(),v=null,g=null,e.p=18,e.n=19,$(u,t.id,"".concat(m,"_preview_front.jpg"));case 19:v=e.v,e.n=21;break;case 20:e.p=20,e.v;case 21:return e.p=21,e.n=22,$(d,t.id,"".concat(m,"_preview_back.jpg"));case 22:g=e.v,e.n=24;break;case 23:e.p=23,e.v;case 24:return y=je(),k={frontImages:U.front.map(function(e,t){return l(l({},e),{},{storageFile:f[t]||null})}),backImages:U.back.map(function(e,t){return l(l({},e),{},{storageFile:p[t]||null})}),color:w,currentView:b,timestamp:(new Date).toISOString(),sizeQuantities:y,frontPreviewFile:v||null,backPreviewFile:g||null},E={user_id:t.id,title:"Customized T-shirt ".concat((new Date).toLocaleString()),type:"tshirt",data:k,front_preview_image:v&&v.publicUrl?v.publicUrl:u,back_preview_image:g&&g.publicUrl?g.publicUrl:d,sizes:y},e.n=25,supabase.from("drafts").insert(E);case 25:L=e.v,L.data,(S=L.error)?alert("保存失败: ".concat(S.message)):([].concat(c(f),c(p)).filter(function(e){return null!==e}).length,f.length+p.length,alert("Design saved to drafts. Review it in your profile."),Z()),e.n=27;break;case 26:e.p=26,e.v,alert("保存失败，请检查控制台了解详情");case 27:return e.a(2)}},e,null,[[21,23],[18,20],[11,13],[7,9],[0,26]])}))).apply(this,arguments)}function se(e){return le.apply(this,arguments)}function le(){return le=y(h().m(function e(t){var n,r;return h().w(function(e){for(;;)switch(e.n){case 0:return n=t.querySelectorAll("img"),r=Array.from(n).map(function(e){return new Promise(function(t){if(e.complete&&e.naturalWidth>0)t();else{var n=function(){e.removeEventListener("load",n),e.removeEventListener("error",n),t()};e.addEventListener("load",n),e.addEventListener("error",n),setTimeout(t,5e3)}})}),e.n=1,Promise.all(r);case 1:return e.n=2,new Promise(function(e){return setTimeout(e,500)});case 2:return e.a(2)}},e)})),le.apply(this,arguments)}function ue(e){if(!e||0===e.width||0===e.height)return de();for(var t=e.getContext("2d").getImageData(0,0,e.width,e.height).data,n=!1,r=0,a=0;a<t.length;a+=4){var i=t[a],o=t[a+1],c=t[a+2],s=t[a+3];r+=s,s>0&&(255!==i||255!==o||255!==c)&&(n=!0)}return!n||r<.1*t.length?de():e.toDataURL("image/jpeg",.9)}function de(){var e=document.createElement("canvas");e.width=200,e.height=250;var t=e.getContext("2d");return t.fillStyle="#ffffff",t.fillRect(0,0,e.width,e.height),t.fillStyle="#f0f0f0",t.fillRect(50,50,100,150),t.fillStyle="#666",t.font="14px Arial",t.textAlign="center",t.fillText("预览图",e.width/2,e.height/2),e.toDataURL("image/jpeg",.9)}function fe(e){return pe.apply(this,arguments)}function pe(){return pe=y(h().m(function e(t){var n,r,a,i,o,c,s,l,u,d,p,m,v;return h().w(function(e){for(;;)if(0===e.n){if(n=document.createElement("canvas"),r=n.getContext("2d"),n.width=t.offsetWidth||200,n.height=t.offsetHeight||250,r.fillStyle="#ffffff",r.fillRect(0,0,n.width,n.height),(a=t.querySelector("img:first-child"))&&a.complete)try{r.drawImage(a,0,0,n.width,n.height)}catch(e){}i=t.querySelectorAll("img:not(:first-child)"),o=f(i);try{for(o.s();!(c=o.n()).done;)if((s=c.value).complete&&s.naturalWidth>0)try{l=s.getBoundingClientRect(),u=t.getBoundingClientRect(),d=l.left-u.left,p=l.top-u.top,m=l.width,v=l.height,r.drawImage(s,d,p,m,v)}catch(e){}}catch(e){o.e(e)}finally{o.f()}return e.a(2,n)}},e)})),pe.apply(this,arguments)}function me(e,t,n){return he.apply(this,arguments)}function he(){return(he=y(h().m(function e(t,n,r){var a,i,o,c,s,l,u,d,f,p,m,v,g,y,b,w;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:a=[],i=Date.now(),o=0;case 1:if(!(o<t.length)){e.n=21;break}if(c=t[o],s=c.src,e.p=2,l=void 0,u=void 0,d=void 0,!c.isMemberCode){e.n=7;break}if(!(f=j["front"===r?"front":"back"])){e.n=4;break}return e.n=3,ae(f);case 3:l=e.v,u="png",e.n=6;break;case 4:return e.n=5,te(s,1200,.9);case 5:l=e.v,u="png";case 6:e.n=15;break;case 7:if(!s.startsWith("data:image/svg")){e.n=12;break}if(!(p=document.querySelector('img[src="'.concat(s,'"]')))){e.n=9;break}return e.n=8,ne(p,1200);case 8:l=e.v,e.n=11;break;case 9:return e.n=10,te(s,1200,.9);case 10:l=e.v;case 11:u="png",e.n=15;break;case 12:if(!s.startsWith("data:image/")){e.n=14;break}return e.n=13,te(s,2e3,.85);case 13:l=e.v,u=l.includes("data:image/png")?"png":"jpg",e.n=15;break;case 14:return a.push(null),e.a(3,20);case 15:if(l){e.n=16;break}return a.push(null),e.a(3,20);case 16:return m=ee(l),d=m.size,v="".concat(n,"/images/").concat(i,"_").concat(r,"_").concat(o,".").concat(u),e.n=17,supabase.storage.from("design-files").upload(v,m,{cacheControl:"3600",upsert:!0});case 17:if(g=e.v,g.data,!g.error){e.n=18;break}return a.push(null),e.a(3,20);case 18:y=supabase.storage.from("design-files").getPublicUrl(v),b=y.data.publicUrl,w={fileName:v,publicUrl:b,side:r,originalSize:d,format:u,processedWidth:"png"===u&&(c.isMemberCode||s.startsWith("data:image/svg"))?1e3:"auto",uploadTime:(new Date).toISOString(),type:c.isMemberCode?"memberCode":s.startsWith("data:image/svg")?"svg":"regular"},a.push(w),e.n=20;break;case 19:e.p=19,e.v,a.push(null);case 20:o++,e.n=1;break;case 21:return a.filter(function(e){return null!==e}).length,e.a(2,a)}},e,null,[[2,19]])}))).apply(this,arguments)}function ve(e){if(e!==b){if(q(),R.querySelectorAll(".uploaded-image").forEach(function(e){R.removeChild(e)}),Ie(),function(e){U[e].forEach(function(t){var n=document.createElement("img");n.src=t.src,n.className=t.className,Object.assign(n.style,t.style),t.dataset.aspectRatio&&(n.dataset.aspectRatio=t.dataset.aspectRatio),R.appendChild(n),Ee(n),t.isMemberCode&&(j[e]=n,_[e]=!0)}),z()}(b=e),document.querySelectorAll(".t-shirt-column button").forEach(function(e){e.classList.remove("active")}),"color"!==e){var t=document.getElementById(e+"Btn");t&&t.classList.add("active")}var n=document.getElementById("colorMenu");n&&(n.classList.remove("show"),n.classList.add("hidden")),ye(),z()}}function ge(e){w=e,document.querySelectorAll(".color-option").forEach(function(e){e.classList.remove("active")});var t=document.querySelector('[data-color="'.concat(e,'"]'));t&&t.classList.add("active");var n=document.getElementById("colorMenu");n&&(n.classList.add("hidden"),n.classList.remove("show")),ye()}function ye(){var e={front:{white:"./images/white-front.png",black:"./images/black-front.png"},back:{white:"./images/white-back.png",black:"./images/black-back.png"}},t=D.querySelector("img");e[b]&&e[b][w]&&t&&(t.src=e[b][w])}function be(){document.getElementById("fileInput").click()}function we(e){var t=e.target.files;if(t&&0!==t.length){for(var n=0;n<t.length;n++){var r=t[n];if(r.type.startsWith("image/")){var a=new FileReader;a.onload=function(e){ke(e.target.result)},a.readAsDataURL(r)}else alert("请选择图片文件！")}e.target.value=""}}function ke(e){var t=document.createElement("img");t.className="uploaded-image",t.src=e,t.onload=function(){var e=.6*R.offsetWidth,n=.6*R.offsetHeight,r=Math.min(e/this.naturalWidth,n/this.naturalHeight),a=this.naturalWidth*r,i=this.naturalHeight*r;t.style.width=a+"px",t.style.height=i+"px",t.style.left=(R.offsetWidth-a)/2+"px",t.style.top=(R.offsetHeight-i)/2+"px",t.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,R.appendChild(t),k.push(t),Ee(t)}}function Ee(e){e.draggable=!1,e.style.touchAction="none",e.addEventListener("click",function(t){t.stopPropagation(),xe(e)}),Ce()?e.addEventListener("touchstart",function(t){t.preventDefault(),t.stopPropagation(),xe(e)},{passive:!1}):(e.addEventListener("touchstart",function(t){if(t.preventDefault(),t.stopPropagation(),xe(e),1===t.touches.length){var n=t.touches[0],r=e.getBoundingClientRect(),a=R.getBoundingClientRect();L=!0,I=n.clientX-(r.left-a.left),C=n.clientY-(r.top-a.top),e.classList.add("dragging")}},{passive:!1}),e.addEventListener("mousedown",function(t){t.target.classList.contains("resize-handle")||(L=!0,I=t.clientX-e.offsetLeft,C=t.clientY-e.offsetTop,e.classList.add("dragging"),t.preventDefault())}))}function Le(){Ce()?(document.addEventListener("touchmove",function(e){e.target.classList.contains("resize-handle")&&e.preventDefault()},{passive:!1}),document.addEventListener("touchend",function(e){(L||S)&&(e.preventDefault(),L=!1,S=!1,x=null,E&&E.classList.remove("dragging"))},{passive:!1})):(document.addEventListener("touchmove",function(e){if(L&&E&&1===e.touches.length){e.preventDefault();var t=e.touches[0],n=R.getBoundingClientRect(),r=t.clientX-n.left-I,a=t.clientY-n.top-C,i=n.width-E.offsetWidth,o=n.height-E.offsetHeight;E.style.left=Math.max(0,Math.min(r,i))+"px",E.style.top=Math.max(0,Math.min(a,o))+"px",Te()}else S&&E&&1===e.touches.length&&(e.preventDefault(),function(e){if(!S||!E)return;var t=e.clientX-I,n=(e.clientY,T),r=B,a=A,i=M;switch(x){case"se":r=(n=Math.max(30,T+t))/O;break;case"sw":r=(n=Math.max(30,T-t))/O,a=A+(T-n);break;case"ne":n=Math.max(30,T+t),i=M+(B-(r=n/O));break;case"nw":n=Math.max(30,T-t),a=A+(T-n),i=M+(B-(r=n/O))}E.style.width=n+"px",E.style.height=r+"px",E.style.left=a+"px",E.style.top=i+"px",Te()}(e.touches[0]))},{passive:!1}),document.addEventListener("touchend",function(e){(L||S)&&(e.preventDefault(),L=!1,S=!1,x=null,E&&E.classList.remove("dragging"))},{passive:!1}))}function Se(){var e;(e=document.createElement("style")).textContent='\n            .uploaded-image {\n                touch-action: none;\n                -webkit-user-select: none;\n                user-select: none;\n                -webkit-touch-callout: none;\n            }\n            \n            .resize-handle {\n                touch-action: none;\n                -webkit-user-select: none;\n                user-select: none;\n            }\n            \n            /* Mobile-specific handle styles */\n            @media (max-width: 899px) {\n                .resize-handle {\n                    width: 30px !important;\n                    height: 30px !important;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    font-size: 23px;\n                    \n                    color: black;\n                    transform-origin: center center !important;\n                }\n                \n                /* Corner handles - resize controls */\n                .resize-handle[data-direction="nw"],\n                .resize-handle[data-direction="ne"] {\n                   \n                    border: 2px solid black;\n                }\n                \n                .resize-handle[data-direction="sw"],\n                .resize-handle[data-direction="se"] {\n                  \n                    border: 2px solid black;\n                }\n                \n                /* Side handles - movement controls */\n                .resize-handle[data-direction="n"],\n                .resize-handle[data-direction="s"],\n                .resize-handle[data-direction="e"],\n                .resize-handle[data-direction="w"] {\n\n                    border: 2px solid black;\n                }\n                \n              \n            }\n            \n           \n        ',document.head.appendChild(e),Le()}function xe(e){E&&E.classList.remove("selected"),(E=e).classList.add("selected"),P.classList.remove("hidden"),Te(),Ae()}function Ie(){E&&E.classList.remove("selected"),E=null,P.classList.add("hidden")}function Ce(){return window.innerWidth<=899||"ontouchstart"in window}function Te(){if(E){E.offsetHeight;var e=E.getBoundingClientRect(),t=R.getBoundingClientRect(),n=e.left-t.left,r=e.top-t.top,a=e.width,i=e.height;P.style.transform="translate(".concat(n,"px, ").concat(r,"px)"),P.style.width=a+"px",P.style.height=i+"px",P.style.position||(P.style.position="absolute",P.style.left="0",P.style.top="0"),Ce()&&requestAnimationFrame(function(){Be()})}}function Be(){P.querySelectorAll(".resize-handle").forEach(function(e){switch(e.dataset.direction){case"nw":case"ne":e.innerHTML="+",e.title="Tap to enlarge";break;case"sw":case"se":e.innerHTML="−",e.title="Tap to shrink";break;case"n":e.innerHTML="↑",e.title="Move up";break;case"s":e.innerHTML="↓",e.title="Move down";break;case"e":e.innerHTML="→",e.title="Move right";break;case"w":e.innerHTML="←",e.title="Move left"}})}function Ae(){P.querySelectorAll(".resize-handle").forEach(function(e){e.replaceWith(e.cloneNode(!0))}),P.querySelectorAll(".resize-handle").forEach(function(e){Ce()?(e.addEventListener("touchstart",Me,{passive:!1}),e.addEventListener("touchend",Oe,{passive:!1}),e.addEventListener("touchmove",function(e){return e.preventDefault()},{passive:!1})):e.addEventListener("mousedown",function(e){e.stopPropagation(),E&&(S=!0,x=this.dataset.direction,I=e.clientX,C=e.clientY,T=E.offsetWidth,B=E.offsetHeight,A=E.offsetLeft,M=E.offsetTop,O=parseFloat(E.dataset.aspectRatio)||1,e.preventDefault())})}),Ce()&&Be()}function Me(e){(e.preventDefault(),e.stopPropagation(),E)&&(e.currentTarget.style.transformOrigin="center center")}function Oe(e){(e.preventDefault(),e.stopPropagation(),E)&&function(e){if(!E)return;var t=E.offsetWidth,n=E.offsetHeight,r=E.offsetLeft,a=E.offsetTop,i=parseFloat(E.dataset.aspectRatio)||1,o=R.offsetWidth,c=R.offsetHeight;switch(e){case"nw":case"ne":var s=Math.min(1.1*t,.9*o),l=s/i;if(l<=.9*c){E.style.width=s+"px",E.style.height=l+"px";var u=Math.max(0,Math.min(r+(t-s)/2,o-s)),d=Math.max(0,Math.min(a+(n-l)/2,c-l));E.style.left=u+"px",E.style.top=d+"px"}break;case"sw":case"se":var f=Math.max(.9*t,30),p=f/i;E.style.width=f+"px",E.style.height=p+"px";var m=Math.max(0,Math.min(r+(t-f)/2,o-f)),h=Math.max(0,Math.min(a+(n-p)/2,c-p));E.style.left=m+"px",E.style.top=h+"px";break;case"n":var v=Math.max(0,a-10);E.style.top=v+"px";break;case"s":var g=Math.min(c-n,a+10);E.style.top=g+"px";break;case"w":var y=Math.max(0,r-10);E.style.left=y+"px";break;case"e":var b=Math.min(o-t,r+10);E.style.left=b+"px"}requestAnimationFrame(function(){Te()})}(e.currentTarget.dataset.direction)}function Re(){if(E){if(E.parentNode&&E.parentNode.removeChild(E),void 0!==k&&Array.isArray(k)){var e=k.indexOf(E);e>-1&&k.splice(e,1)}Ie()}}function De(){var e=document.getElementById("frontBtn");e&&e.addEventListener("click",function(e){e.preventDefault(),ve("front")});var t=document.getElementById("backBtn");t&&t.addEventListener("click",function(e){e.preventDefault(),ve("back")});var n=document.getElementById("colorBtn");n&&n.addEventListener("click",function(e){var t;e.preventDefault(),(t=document.getElementById("colorMenu"))&&(t.classList.contains("hidden")?(t.classList.remove("hidden"),t.classList.add("show")):(t.classList.add("hidden"),t.classList.remove("show")))})}document.addEventListener("DOMContentLoaded",function(){Le(),setTimeout(function(){"function"==typeof window.displayUserProfile&&window.displayUserProfile().catch(function(e){})},1e3)}),"undefined"!=typeof supabase&&supabase.auth.onAuthStateChange(function(e,t){"SIGNED_IN"===e?setTimeout(function(){"function"==typeof window.displayUserProfile&&window.displayUserProfile()},500):"SIGNED_OUT"===e&&_&&V()}),window.addEventListener("resize",function(){setTimeout(function(){E&&(Ae(),Te())},100)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Se):Se(),document.addEventListener("mousemove",function(e){if(L&&E){var t=e.clientX-I,n=e.clientY-C;E.style.left=t+"px",E.style.top=n+"px",Te()}else S&&function(e){if(S&&E){var t=e.clientX-I,n=e.clientY-C,r=T,a=B,i=A,o=M;switch(x){case"nw":i=A+t,o=M+(B-(a=(r=T-t)/O));break;case"n":i=A-((r=(a=B-n)*O)-T)/2,o=M+n;break;case"ne":o=M+(B-(a=(r=T+t)/O));break;case"e":o=M-((a=(r=T+t)/O)-B)/2;break;case"se":a=(r=T+t)/O;break;case"s":i=A-((r=(a=B+n)*O)-T)/2;break;case"sw":a=(r=T-t)/O,i=A+t;break;case"w":i=A+t,o=M-((a=(r=T-t)/O)-B)/2}r<20||a<20||(E.style.width=r+"px",E.style.height=a+"px",E.style.left=i+"px",E.style.top=o+"px",Te())}}(e)}),document.addEventListener("mouseup",function(){L=!1,S=!1,x=null,E&&E.classList.remove("dragging")}),R.addEventListener("click",function(e){e.target.classList.contains("uploaded-image")||Ie()}),document.addEventListener("dragstart",function(e){e.preventDefault()}),document.addEventListener("dragover",function(e){e.preventDefault()}),document.addEventListener("keydown",function(e){"Delete"===e.key&&E?Re():"Escape"===e.key&&Ie()}),window.addEventListener("resize",function(){E&&Te()}),document.addEventListener("click",function(e){e.target.closest(".color-option")&&ge(e.target.closest(".color-option").dataset.color);if(!e.target.closest("#colorBtn")&&!e.target.closest(".color-menu")){var t=document.getElementById("colorMenu");t&&t.classList.contains("show")&&(t.classList.add("hidden"),t.classList.remove("show"))}});var Pe=document.getElementById("saveModal");if(Pe){Pe.addEventListener("click",function(e){e.target===Pe&&Z()});var Ue=document.getElementById("memberCodeBtn");Ue&&Ue.addEventListener("click",function(){return Y.apply(this,arguments)})}function _e(){["tshirtContainer","tshirtBackground","resizeHandles","frontBtn","backBtn","colorBtn"].every(function(e){return document.getElementById(e)})?setTimeout(function(){!function(){void 0===k&&(window.uploadedImages=[]),void 0===E&&(window.selectedImage=null);var e=document.getElementById("tshirtContainer");e&&void 0===R&&(window.container=e),document.getElementById("tshirtBackground"),document.getElementById("resizeHandles")}(),De(),R?(ve("front"),ge("white"),z(),function(){var e=document.getElementById("fileBtn");e&&e.addEventListener("click",be);var t=document.getElementById("deleteBtn");t&&t.addEventListener("click",Re);var n=document.getElementById("saveDesignBtn");n&&n.addEventListener("click",Q);var r=document.getElementById("saveToDraftBtn");r&&r.addEventListener("click",y(h().m(function e(){return h().w(function(e){for(;;)switch(e.n){case 0:return this.textContent="SAVING...",this.disabled=!0,e.n=1,oe();case 1:this.textContent="SAVE TO DRAFT",this.disabled=!1;case 2:return e.a(2)}},e,this)})));var a=document.getElementById("addToCartBtn");a&&(a.replaceWith(a.cloneNode(!0)),document.getElementById("addToCartBtn").addEventListener("click",Qe));var i=document.getElementById("backToEditBtn");i&&i.addEventListener("click",Z);var o=document.getElementById("fileInput");o&&o.addEventListener("change",we)}(),function(){ze.apply(this,arguments)}(),setTimeout(function(){var e=document.querySelector('[data-color="white"]');e&&e.classList.add("active")},100)):setTimeout(_e,1e3)},500):setTimeout(_e,500)}function je(){var e=document.querySelectorAll(".size-option"),t={};return e.forEach(function(e){var n=e.querySelector("label"),r=e.querySelector(".quantity-input");if(n&&r){var a=n.textContent.trim(),i=parseInt(r.value)||0;i>0&&(t[a]=i)}}),t}function qe(){var e=U.front&&U.front.length>0,t=U.back&&U.back.length>0;return e||t}function ze(){return(ze=y(h().m(function e(){var t,n,r;return h().w(function(e){for(;;)switch(e.n){case 0:if(t=new URLSearchParams(window.location.search),!(n=t.get("loadTshirtDraft"))){e.n=3;break}return e.n=1,Ne();case 1:return e.n=2,He(n);case 2:r=window.location.pathname,window.history.replaceState({},document.title,r);case 3:return e.a(2)}},e)}))).apply(this,arguments)}function Ne(){return new Promise(function(e){var t=function(){var n=document.getElementById("tshirtContainer"),r=document.getElementById("frontBtn"),a=document.getElementById("backBtn");n&&r&&a?e():setTimeout(t,100)};t()})}function He(e){return Ge.apply(this,arguments)}function Ge(){return(Ge=y(h().m(function e(t){var n,r,a;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,document.getElementById("tshirtContainer")){e.n=1;break}return e.n=1,new Promise(function(e){return setTimeout(e,1e3)});case 1:return e.n=2,supabase.from("drafts").select("*").eq("id",t).single();case 2:if(n=e.v,r=n.data,!n.error&&r&&"tshirt"===r.type){e.n=3;break}return alert("无法加载T恤设计"),e.a(2);case 3:if(a=r.data){e.n=4;break}return alert("草稿数据损坏"),e.a(2);case 4:return a.color&&ge(a.color),We(),ve("front"),e.n=5,Xe("front",a.frontImages);case 5:return ve("back"),e.n=6,Xe("back",a.backImages);case 6:a.sizeQuantities&&Ye(a.sizeQuantities),a.currentView?ve(a.currentView):ve("front"),ln("The design has been loaded!","success"),e.n=8;break;case 7:e.p=7,e.v,alert("恢复失败，请重试");case 8:return e.a(2)}},e,null,[[0,7]])}))).apply(this,arguments)}function We(){U.front=[],U.back=[];var e=document.getElementById("tshirtContainer");e&&e.querySelectorAll(".uploaded-image").forEach(function(e){return e.remove()});_.front=!1,_.back=!1,j.front=null,j.back=null,k=[],Ie()}function Xe(e,t){return Fe.apply(this,arguments)}function Fe(){return(Fe=y(h().m(function e(t,n){var r,a,i,o,c;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n&&Array.isArray(n)){e.n=1;break}return e.a(2);case 1:if(document.getElementById("tshirtContainer")){e.n=2;break}return e.a(2);case 2:r=f(n),e.p=3,r.s();case 4:if((a=r.n()).done){e.n=10;break}if(i=a.value,e.p=5,o=null,i.storageFile&&i.storageFile.publicUrl?o=i.storageFile.publicUrl:i.src&&(o=i.src),o){e.n=6;break}return e.a(3,9);case 6:return e.n=7,Ve(o,i,t);case 7:e.n=9;break;case 8:e.p=8,e.v;case 9:e.n=4;break;case 10:e.n=12;break;case 11:e.p=11,c=e.v,r.e(c);case 12:return e.p=12,r.f(),e.f(12);case 13:q();case 14:return e.a(2)}},e,null,[[5,8],[3,11,12,13]])}))).apply(this,arguments)}function Ve(e,t,n){return new Promise(function(r,a){var i=new Image;i.onload=function(){var a=document.createElement("img");a.src=e,a.className=t.className||"uploaded-image",t.style&&(a.style.width=t.style.width,a.style.height=t.style.height,a.style.left=t.style.left,a.style.top=t.style.top),t.dataset&&t.dataset.aspectRatio?a.dataset.aspectRatio=t.dataset.aspectRatio:a.dataset.aspectRatio=this.naturalWidth/this.naturalHeight,document.getElementById("tshirtContainer").appendChild(a),Ee(a),k.push(a),(t.isMemberCode||a.classList.contains("member-code-image"))&&(j[n]=a,_[n]=!0,z()),r(a)},i.onerror=function(){a(new Error("图片加载失败"))},i.src=e})}function Ye(e){e&&Object.keys(e).forEach(function(t){var n=document.querySelector('.quantity-input[data-size="'.concat(t,'"]'));if(!n){var r,a=f(document.querySelectorAll(".size-option"));try{for(a.s();!(r=a.n()).done;){var i=r.value,o=i.querySelector("label");if(o&&o.textContent.trim()===t){n=i.querySelector(".quantity-input");break}}}catch(e){a.e(e)}finally{a.f()}}n&&(n.value=e[t]||0)})}function Qe(){return $e.apply(this,arguments)}function $e(){return($e=y(h().m(function e(){var t,n,r,a,i,c,s,l,u,d,f,p,m,v,g,y;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,checkUserLogin();case 1:if(t=e.v){e.n=2;break}return e.a(2);case 2:if(n=je(),0!==(r=Object.values(n).reduce(function(e,t){return e+t},0))){e.n=3;break}return alert("请至少选择一个尺码"),e.a(2);case 3:if(!(a=document.getElementById("addToCartBtn"))){e.n=10;break}if(i=a.textContent,a.textContent="PROCESSING...",a.disabled=!0,e.p=4,q(),c=U.front&&U.front.length>0,s=U.back&&U.back.length>0,l="",u="",d=0,f="",p=null,c||s?c&&s?(l="double-sided",u="double-sided-".concat(w),f="Double-sided Custom T-shirt",d=TSHIRT_PRICING["double-sided"][w]||TSHIRT_PRICING["double-sided"].white):(l="single-sided",u="single-sided-".concat(w),f="Single-sided Custom T-shirt",d=TSHIRT_PRICING["single-sided"][w]||TSHIRT_PRICING["single-sided"].white):(l="blank",u="blank-tshirt-".concat(w),f="Blank T-shirt (".concat(w,")"),d=TSHIRT_PRICING.blank[w]||TSHIRT_PRICING.blank.white),!c&&!s){e.n=6;break}return e.n=5,Ke(!0);case 5:if(p=e.v){e.n=6;break}throw new Error("保存设计失败");case 6:return e.n=7,window.CartManager.addOrUpdateCartItem({draftId:p,itemData:{type:u,designType:l,color:w,title:f,unitPrice:d},sizes:n,userId:t.id});case 7:if(!(m=e.v).success){e.n=8;break}Z(),v=d*r,g=Object.entries(n).map(function(e){var t=o(e,2),n=t[0],r=t[1];return"".concat(n,": ").concat(r)}).join(", "),confirm("Successfully added to cart!\n\n"+"Item: ".concat(f,"\n")+"Type: ".concat(l,"\n")+"Color: ".concat(w,"\n")+"Sizes: ".concat(g,"\n")+"Unit Price: $".concat(d.toFixed(2),"\n")+"Total Quantity: ".concat(r,"\n")+"Total Price: $".concat(v.toFixed(2),"\n\n")),e.n=9;break;case 8:throw new Error(m.error||"添加到购物车失败");case 9:return e.p=9,a.textContent=i,a.disabled=!1,e.f(9);case 10:e.n=12;break;case 11:e.p=11,y=e.v,alert("添加失败: "+y.message);case 12:return e.a(2)}},e,null,[[4,,9,10],[0,11]])}))).apply(this,arguments)}function Je(){return new Promise(function(e){var t=setInterval(function(){window.CartManager&&"function"==typeof window.CartManager.addOrUpdateCartItem&&(clearInterval(t),e())},100);setTimeout(function(){clearInterval(t),e()},5e3)})}function Ke(){return Ze.apply(this,arguments)}function Ze(){return Ze=y(h().m(function e(){var t,n,r,i,o,c,s,u,d,f,p,m,v,g,y,k,E,L,S=arguments;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=1,e.n=2,checkUserLogin();case 2:if(t=e.v){e.n=3;break}return e.a(2,null);case 3:if(qe()){e.n=4;break}return e.a(2,null);case 4:if(q(),n=document.getElementById("frontPreview"),r=document.getElementById("backPreview"),n&&r){e.n=5;break}return e.a(2,null);case 5:return e.n=6,se(n);case 6:return e.n=7,se(r);case 7:return i={backgroundColor:"#ffffff",useCORS:!0,allowTaint:!1,removeContainer:!0,scale:1,logging:!1,foreignObjectRendering:!1,imageTimeout:15e3,width:n.offsetWidth,height:n.offsetHeight,onclone:function(e){e.querySelectorAll("img").forEach(function(e){e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.transform="none"})}},e.p=8,e.n=9,a()(n,i);case 9:o=e.v,e.n=12;break;case 10:return e.p=10,e.v,e.n=11,fe(n);case 11:o=e.v;case 12:return e.p=12,e.n=13,a()(r,i);case 13:c=e.v,e.n=16;break;case 14:return e.p=14,e.v,e.n=15,fe(r);case 15:c=e.v;case 16:return s=ue(o),u=ue(c),e.n=17,me(U.front,t.id,"front");case 17:return d=e.v,e.n=18,me(U.back,t.id,"back");case 18:return f=e.v,p=Date.now(),m=null,v=null,e.p=19,e.n=20,$(s,t.id,"".concat(p,"_cart_preview_front.jpg"));case 20:m=e.v,e.n=22;break;case 21:e.p=21,e.v;case 22:return e.p=22,e.n=23,$(u,t.id,"".concat(p,"_cart_preview_back.jpg"));case 23:v=e.v,e.n=25;break;case 24:e.p=24,e.v;case 25:return g=je(),y={frontImages:U.front.map(function(e,t){return l(l({},e),{},{storageFile:d[t]||null})}),backImages:U.back.map(function(e,t){return l(l({},e),{},{storageFile:f[t]||null})}),color:w,currentView:b,timestamp:(new Date).toISOString(),sizeQuantities:g,frontPreviewFile:m||null,backPreviewFile:v||null},k={user_id:t.id,title:"T恤设计 ".concat((new Date).toLocaleString()),type:"tshirt",data:y,front_preview_image:m&&m.publicUrl?m.publicUrl:s,back_preview_image:v&&v.publicUrl?v.publicUrl:u,sizes:g},e.n=26,supabase.from("drafts").insert(k).select().single();case 26:if(E=e.v,L=E.data,!E.error){e.n=27;break}return e.a(2,null);case 27:return e.a(2,L.id);case 28:return e.p=28,e.v,e.a(2,null)}},e,null,[[22,24],[19,21],[12,14],[8,10],[1,28]])})),Ze.apply(this,arguments)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",_e):_e(),document.querySelectorAll(".quantity-control").forEach(function(e){var t=e.querySelector(".quantity-input");t.addEventListener("change",function(){var e=parseInt(t.value);isNaN(e)||e<0?t.value=0:e>99&&(t.value=99)})}),document.addEventListener("DOMContentLoaded",y(h().m(function e(){return h().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,Je();case 1:if(!window.CartManager||"function"!=typeof window.CartManager.initCartIcon){e.n=2;break}return e.n=2,window.CartManager.initCartIcon();case 2:document.querySelectorAll(".quantity-input").forEach(function(e){e.addEventListener("change",function(){var e=parseInt(this.value)||0;e<0&&(this.value=0),e>99&&(this.value=99)}),e.addEventListener("input",function(){this.value=this.value.replace(/[^0-9]/g,"")})});case 3:return e.a(2)}},e)})));var et,tt,nt,rt,at,it=!1,ot=null,ct=[],st=-1,lt="pencil",ut=2,dt=1,ft=3,pt=!1,mt=0,ht=0;function vt(){var e=document.querySelector(".pencil-menu");e&&e.classList.remove("show")}function gt(){(nt=document.getElementById("mySVG"))&&(yt(),function(){var e=document.getElementById("pencil");e&&e.addEventListener("click",function(){xt("pencil"),It(ft),St(ft),vt()});var t=document.querySelector(".pencil-menu-trigger");t&&t.addEventListener("click",function(e){var t;e.stopPropagation(),(t=document.querySelector(".pencil-menu"))&&t.classList.toggle("show")});document.addEventListener("click",function(e){var t=document.getElementById("pencil");t&&!t.contains(e.target)&&vt()});var n=document.getElementById("eraser");n&&n.addEventListener("click",function(){xt("eraser")});var r=document.getElementById("zoom-in");r&&r.addEventListener("click",function(){dt<3&&(dt=Math.min(1.25*dt,3),bt())});var a=document.getElementById("zoom-out");a&&a.addEventListener("click",function(){dt>.5&&((dt=Math.max(dt/1.25,.5))<=1&&(dt=1,mt=0,ht=0),bt())});var i=document.getElementById("drag");i&&i.addEventListener("click",function(){xt("drag")});document.querySelectorAll(".pencil-menu [data-width]").forEach(function(e){e.addEventListener("click",function(){var e=parseInt(this.getAttribute("data-width"));It(e),ft=e,St(e),vt()})}),It(2),St(2)}(),function(){if(!nt)return;function e(e){var t,n;if(e.preventDefault(),"touchstart"===e.type){var r=e.touches[0];t=r.clientX,n=r.clientY}else t=e.clientX,n=e.clientY;var a=Ct(t,n);"drag"===lt?(pt=!0,rt=t,at=n,nt.style.cursor="grabbing"):(it=!0,et=a.x,tt=a.y,Tt(a.x,a.y))}function t(e){var t,n;if(e.preventDefault(),"touchmove"===e.type){var r=e.touches[0];t=r.clientX,n=r.clientY}else t=e.clientX,n=e.clientY;var a=Ct(t,n);if(pt){var i=t-rt,o=n-at;rt=t,at=n,mt+=i,ht+=o,bt()}else it&&(Bt(et,tt,a.x,a.y),et=a.x,tt=a.y)}function n(e){e.preventDefault(),pt?(pt=!1,nt.style.cursor="drag"===lt?"grab":"default"):it&&(it=!1,At(),Ot())}nt.addEventListener("mousedown",function(e){e.preventDefault();var t=Ct(e.clientX,e.clientY);"drag"===lt?(pt=!0,rt=e.clientX,at=e.clientY,nt.style.cursor="grabbing"):(it=!0,et=t.x,tt=t.y,Tt(t.x,t.y))}),nt.addEventListener("mousemove",function(e){e.preventDefault();var t=Ct(e.clientX,e.clientY);if(pt){var n=e.clientX-rt,r=e.clientY-at;rt=e.clientX,at=e.clientY,mt+=n,ht+=r,bt()}else it&&(Bt(et,tt,t.x,t.y),et=t.x,tt=t.y)}),nt.addEventListener("mouseup",function(e){pt?(pt=!1,nt.style.cursor="grab"):it&&(it=!1,At(),Ot())}),nt.addEventListener("mousedown",e),nt.addEventListener("mousemove",t),nt.addEventListener("mouseup",n),nt.addEventListener("touchstart",kt),nt.addEventListener("touchmove",Et),nt.addEventListener("touchend",Lt),nt.addEventListener("touchcancel",n,{passive:!1}),nt.addEventListener("touchstart",function(e){e.touches.length>1&&e.preventDefault()},{passive:!1})}(),xt("pencil"),Ot())}function yt(){if(nt){var e=nt.parentElement;if(e){var t=e.getBoundingClientRect(),n=Math.max(t.width,100),r=Math.max(t.height-60,100);nt.setAttribute("width",n),nt.setAttribute("height",r),nt.setAttribute("viewBox","0 0 ".concat(n," ").concat(r))}}}function bt(){if(nt){var e="".concat(-mt/dt," ").concat(-ht/dt," ").concat(nt.clientWidth/dt," ").concat(nt.clientHeight/dt);nt.setAttribute("viewBox",e)}}function wt(){setTimeout(function(){gt(),function(){var e=document.getElementById("undoBtn");e&&e.addEventListener("click",Rt);var t=document.getElementById("saveBtn");t&&t.addEventListener("click",Pt);var n=document.getElementById("clearBtn");n&&n.addEventListener("click",Dt);var r=document.getElementById("nextBtn");r&&r.addEventListener("click",Jt)}(),function(){en.apply(this,arguments)}(),function(){cn.apply(this,arguments)}();var e=setInterval(function(){document.getElementById("tshirtContainer")&&clearInterval(e)},500);setTimeout(function(){return clearInterval(e)},1e4)},100)}function kt(e){e.preventDefault();var t=e.touches[0],n=Ct(t.clientX,t.clientY);"drag"===lt?(pt=!0,rt=t.clientX,at=t.clientY):(it=!0,et=n.x,tt=n.y,Tt(n.x,n.y))}function Et(e){e.preventDefault();var t=e.touches[0],n=Ct(t.clientX,t.clientY);if(pt){var r=t.clientX-rt,a=t.clientY-at;rt=t.clientX,at=t.clientY,mt+=r,ht+=a,bt()}else it&&(Bt(et,tt,n.x,n.y),et=n.x,tt=n.y)}function Lt(e){e.preventDefault(),pt?pt=!1:it&&(it=!1,At(),Ot())}function St(e){document.querySelectorAll(".pencil-menu [data-width]").forEach(function(t){t.classList.remove("active"),parseInt(t.getAttribute("data-width"))===e&&t.classList.add("active")})}function xt(e){lt=e,document.querySelectorAll(".tools > div").forEach(function(e){e.classList.remove("active")});var t=document.getElementById(e);t&&t.classList.add("active"),nt&&("pencil"===e?nt.classList.add("pencil-cursor"):(nt.classList.remove("pencil-cursor"),nt.style.cursor="eraser"===e?"crosshair":"drag"===e?"grab":"default"))}function It(e){ut=e}function Ct(e,t){if(!nt)return{x:0,y:0};var n=nt.getBoundingClientRect(),r=window.pageXOffset||document.documentElement.scrollLeft||0,a=window.pageYOffset||document.documentElement.scrollTop||0,i=e-n.left-r,o=t-n.top-a;return{x:(i-mt)/dt,y:(o-ht)/dt}}function Tt(e,t){if("pencil"===lt){ot=document.createElementNS("http://www.w3.org/2000/svg","path");var n=Math.round(100*e)/100,r=Math.round(100*t)/100;ot.setAttribute("d","M ".concat(n," ").concat(r)),ot.setAttribute("stroke","black"),ot.setAttribute("stroke-width",ut),ot.setAttribute("fill","none"),ot.setAttribute("stroke-linecap","square"),ot.setAttribute("stroke-linejoin","square"),nt.appendChild(ot)}else"eraser"===lt&&Mt(e,t)}function Bt(e,t,n,r){if("pencil"===lt&&ot){var a=Math.round(100*n)/100,i=Math.round(100*r)/100,o=ot.getAttribute("d");ot.setAttribute("d",o+" L ".concat(a," ").concat(i))}else"eraser"===lt&&Mt(n,r)}function At(){ot=null}function Mt(e,t){if(nt){var n=nt.querySelectorAll("path"),r=2*ut;n.forEach(function(n){try{var a=n.getBBox();e>=a.x-r&&e<=a.x+a.width+r&&t>=a.y-r&&t<=a.y+a.height+r&&nt.removeChild(n)}catch(e){}})}}function Ot(){if(nt){++st<ct.length&&(ct.length=st),ct.push(nt.innerHTML);ct.length>20&&(ct.shift(),st--)}}function Rt(){!nt||st<=0||(st--,nt.innerHTML=ct[st])}function Dt(){nt&&(nt.innerHTML="",Ot())}function Pt(){var e=document.getElementById("saveSvgModal");if(!e){var t=(new XMLSerializer).serializeToString(nt),n=new Blob([t],{type:"image/svg+xml"}),r=URL.createObjectURL(n),a='\n            <div id="saveSvgModal" class="modal">\n                <div class="modal-content-svg">\n                    <div class="preview-container-svg">\n                        <div class="preview-item-svg">\n                            <span>PREVIEW</span>\n                            <div class="preview-svg" style="background-image: url(\''.concat(r,'\')"></div>\n                        </div>\n                    </div>\n                    <div class="modal-buttons">\n                        <button id="confirmSaveSvgBtn">SAVE TO DRAFT</button>\n                        <button id="uploadAvatarBtn">UPLOAD AVATAR</button>\n                        <button id="addToGalleryBtn">ADD TO GALLERY</button>\n                    </div>\n                </div>\n            </div>\n        ');document.body.insertAdjacentHTML("beforeend",a),e=document.getElementById("saveSvgModal");var i=document.getElementById("confirmSaveSvgBtn");i&&i.addEventListener("click",function(){var e=y(h().m(function e(t){return h().w(function(e){for(;;)switch(e.n){case 0:return t.stopPropagation(),this.textContent="SAVING...",this.disabled=!0,e.n=1,Gt();case 1:this.textContent="SAVE TO DRAFT",this.disabled=!1;case 2:return e.a(2)}},e,this)}));return function(t){return e.apply(this,arguments)}}());var o=document.getElementById("uploadAvatarBtn");o&&o.addEventListener("click",function(){var e=y(h().m(function e(t){return h().w(function(e){for(;;)switch(e.n){case 0:return t.stopPropagation(),this.textContent="UPLOADING...",this.disabled=!0,e.n=1,Ut();case 1:this.textContent="UPLOAD AVATAR",this.disabled=!1;case 2:return e.a(2)}},e,this)}));return function(t){return e.apply(this,arguments)}}());var c=document.getElementById("addToGalleryBtn");c&&c.addEventListener("click",function(){var e=y(h().m(function e(t){return h().w(function(e){for(;;)switch(e.n){case 0:return t.stopPropagation(),this.textContent="PROCESSING...",this.disabled=!0,e.n=1,Yt();case 1:this.textContent="ADD TO GALLERY",this.disabled=!1;case 2:return e.a(2)}},e,this)}));return function(t){return e.apply(this,arguments)}}())}e.classList.remove("hidden")}function Ut(){return _t.apply(this,arguments)}function _t(){return(_t=y(h().m(function e(){var t,n,r,a,i,o,c,s;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,checkUserLogin();case 1:if(t=e.v){e.n=2;break}return Xt(),e.a(2);case 2:if(nt&&0!==nt.children.length){e.n=3;break}return alert("请先绘制一些内容！"),e.a(2);case 3:return e.n=4,supabase.from("profiles").select("id, email").eq("user_id",t.id).single();case 4:if(n=e.v,r=n.data,!n.error){e.n=13;break}if(!t.email){e.n=11;break}return e.n=5,supabase.from("profiles").select("id, email").eq("email",t.email).single();case 5:if(a=e.v,i=a.data,!a.error){e.n=9;break}return e.n=6,supabase.from("profiles").insert({user_id:t.id,email:t.email,created_at:(new Date).toISOString()}).select().single();case 6:if(o=e.v,c=o.data,!o.error){e.n=7;break}return alert("无法创建用户资料，请联系管理员"),e.a(2);case 7:return e.n=8,jt(t,c.id);case 8:e.n=10;break;case 9:return e.n=10,jt(t,i.id);case 10:e.n=12;break;case 11:return alert("用户没有email信息，无法更新头像"),e.a(2);case 12:e.n=14;break;case 13:return e.n=14,jt(t,r.id);case 14:e.n=16;break;case 15:e.p=15,s=e.v,alert("上传失败，请重试: "+s.message);case 16:return e.a(2)}},e,null,[[0,15]])}))).apply(this,arguments)}function jt(e,t){return qt.apply(this,arguments)}function qt(){return(qt=y(h().m(function e(t,n){var r,a,i,o,c,s,l,u,d,f,p,m,v,g,y;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,(r=nt.cloneNode(!0)).setAttribute("width","300"),r.setAttribute("height","300"),r.setAttribute("xmlns","http://www.w3.org/2000/svg"),r.querySelectorAll("path").forEach(function(e){e.getAttribute("stroke")||e.setAttribute("stroke","black"),e.getAttribute("stroke-width")||e.setAttribute("stroke-width","2"),e.getAttribute("fill")||e.setAttribute("fill","none")}),e.n=1,Nt(r,300,300);case 1:if(a=e.v){e.n=2;break}throw new Error("生成头像图片失败");case 2:return i=ee(a),o="avatars/".concat(n,".png"),e.p=3,e.n=4,supabase.storage.from("design-files").list("avatars/",{search:"".concat(n)});case 4:if(c=e.v,s=c.data,!(!c.error&&s&&s.length>0)){e.n=6;break}return l=s.map(function(e){return"avatars/".concat(e.name)}),e.n=5,supabase.storage.from("design-files").remove(l);case 5:u=e.v,u.error;case 6:e.n=8;break;case 7:e.p=7,e.v;case 8:return e.n=9,supabase.storage.from("design-files").upload(o,i,{contentType:"image/png",cacheControl:"3600",upsert:!0});case 9:if(d=e.v,d.data,!(f=d.error)){e.n=10;break}throw new Error("上传失败: "+f.message);case 10:return p=supabase.storage.from("design-files").getPublicUrl(o),m=p.data.publicUrl,e.n=11,supabase.from("profiles").update({avatar_url:m,avatar_updated_at:(new Date).toISOString()}).eq("id",n).select();case 11:if(v=e.v,v.data,!v.error){e.n=14;break}return e.n=12,supabase.from("profiles").update({avatar_url:m,avatar_updated_at:(new Date).toISOString()}).eq("user_id",t.id).select();case 12:if(g=e.v,g.data,!(y=g.error)){e.n=13;break}throw new Error("更新数据库失败: "+y.message);case 13:e.n=15;break;case 14:case 15:Xt(),ln("Avatar updated!","success"),zt(m),e.n=17;break;case 16:throw e.p=16,e.v;case 17:return e.a(2)}},e,null,[[3,7],[0,16]])}))).apply(this,arguments)}function zt(e){var t=e+"?t="+Date.now(),n=document.querySelectorAll(".avatar");if(0===n.length){[".header__logo img","header img",".user-avatar",".profile-avatar","[data-avatar]"].forEach(function(e){document.querySelectorAll(e).forEach(function(e){"IMG"===e.tagName&&(e.src=t)})})}else n.forEach(function(e,n){"IMG"===e.tagName?(e.src=t,e.alt="User Avatar"):(e.style.backgroundImage="url('".concat(t,"')"),e.style.backgroundSize="cover",e.style.backgroundPosition="center")});try{localStorage.setItem("user_avatar_url",t)}catch(e){}}function Nt(e){return Ht.apply(this,arguments)}function Ht(){return Ht=y(h().m(function e(t){var n,r,a=arguments;return h().w(function(e){for(;;)if(0===e.n)return n=a.length>1&&void 0!==a[1]?a[1]:300,r=a.length>2&&void 0!==a[2]?a[2]:300,e.a(2,new Promise(function(e){var a=document.createElement("canvas"),i=a.getContext("2d");a.width=n,a.height=r;var o=(new XMLSerializer).serializeToString(t),c=new Blob([o],{type:"image/svg+xml"}),s=URL.createObjectURL(c),l=new Image;l.onload=function(){try{i.clearRect(0,0,n,r),i.fillStyle="#ffffff",i.fillRect(0,0,n,r);var o=t.getAttribute("width")||t.viewBox.baseVal.width||n,c=t.getAttribute("height")||t.viewBox.baseVal.height||r,u=1*Math.min(n/o,r/c),d=o*u,f=c*u,p=(n-d)/2,m=(r-f)/2;i.drawImage(l,p,m,d,f);var h=a.toDataURL("image/png",.9);URL.revokeObjectURL(s),e(h)}catch(t){e(null)}},l.onerror=function(){URL.revokeObjectURL(s),e(null)},l.src=s}))},e)})),Ht.apply(this,arguments)}function Gt(){return Wt.apply(this,arguments)}function Wt(){return(Wt=y(h().m(function e(){var t,n,r,a,i,o,c,s,l,u;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,checkUserLogin();case 1:if(t=e.v){e.n=2;break}return Xt(),e.a(2);case 2:return n=(new XMLSerializer).serializeToString(nt),r=new Blob([n],{type:"image/svg+xml"}),a=Date.now(),i="".concat(t.id,"/svg/").concat(a,"_drawing.svg"),e.n=3,supabase.storage.from("design-files").upload(i,r,{contentType:"image/svg+xml",cacheControl:"3600",upsert:!0});case 3:if(o=e.v,o.data,!o.error){e.n=4;break}return alert("上传失败，请重试"),e.a(2);case 4:return c=supabase.storage.from("design-files").getPublicUrl(i),s=c.data.publicUrl,e.n=5,Ft(n);case 5:return l=e.v,e.n=6,supabase.from("drafts").insert({user_id:t.id,title:"SVG绘图 ".concat((new Date).toLocaleString()),type:"svg",data:{storageUrl:s,fileName:i,fileSize:r.size,uploadTime:(new Date).toISOString()},front_preview_image:l});case 6:u=e.v,u.data,u.error?alert("保存失败，请重试"):(Xt(),alert("Design saved to drafts. Review it in your profile.")),e.n=8;break;case 7:e.p=7,e.v,alert("保存失败，请重试");case 8:return e.a(2)}},e,null,[[0,7]])}))).apply(this,arguments)}function Xt(){document.querySelectorAll("#saveSvgModal").forEach(function(e){var t;null===(t=e.parentNode)||void 0===t||t.removeChild(e)})}function Ft(e){return Vt.apply(this,arguments)}function Vt(){return Vt=y(h().m(function e(t){var n,r,a=arguments;return h().w(function(e){for(;;)if(0===e.n)return n=a.length>1&&void 0!==a[1]?a[1]:400,r=a.length>2&&void 0!==a[2]?a[2]:400,e.a(2,new Promise(function(e){var a=document.createElement("canvas"),i=a.getContext("2d"),o=new Image;a.width=n,a.height=r,i.fillStyle="#ffffff",i.fillRect(0,0,n,r),o.onload=function(){var t=.9*Math.min(n/this.width,r/this.height),c=this.width*t,s=this.height*t,l=(n-c)/2,u=(r-s)/2;i.drawImage(o,l,u,c,s),e(a.toDataURL("image/png",.9))},o.onerror=function(){i.fillStyle="#f0f0f0",i.fillRect(50,50,n-100,r-100),i.fillStyle="#666",i.font="20px Arial",i.textAlign="center",i.fillText("SVG预览",n/2,r/2),e(a.toDataURL("image/png",.9))};var c=new Blob([t],{type:"image/svg+xml"});o.src=URL.createObjectURL(c)}))},e)})),Vt.apply(this,arguments)}function Yt(){return Qt.apply(this,arguments)}function Qt(){return(Qt=y(h().m(function e(){var t,n,r,a,i,o,c,s,l,u,d,f,p;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,checkUserLogin();case 1:if(t=e.v){e.n=2;break}return e.a(2);case 2:if(nt&&0!==nt.children.length){e.n=3;break}return alert("请先绘制一些内容！"),e.a(2);case 3:return n=(new XMLSerializer).serializeToString(nt),e.n=4,Ft(n);case 4:return r=e.v,a=null,e.p=5,i=new Blob([n],{type:"image/svg+xml"}),o=Date.now(),c="".concat(t.id,"/gallery/").concat(o,"_artwork.svg"),e.n=6,supabase.storage.from("design-files").upload(c,i,{contentType:"image/svg+xml",cacheControl:"3600",upsert:!0});case 6:s=e.v,s.data,s.error||(l=supabase.storage.from("design-files").getPublicUrl(c),u=l.data.publicUrl,a=u),e.n=8;break;case 7:e.p=7,e.v;case 8:return d={user_id:t.id,title:prompt("Give your artwork a title:","My Doodle")||"Untitled",description:prompt("Add a description (optional):","")||"",preview_image:r,svg_url:a,svg_data:n},e.n=9,supabase.from("gallery").insert(d).select();case 9:f=e.v,f.data,(p=f.error)?alert("添加失败："+p.message):(alert("Successfully added to gallery!"),Xt(),confirm("View in gallery now?")&&("function"==typeof loadPage?loadPage("gallery"):window.location.href="/gallery")),e.n=11;break;case 10:e.p=10,e.v,alert("添加失败，请重试");case 11:return e.a(2)}},e,null,[[5,7],[0,10]])}))).apply(this,arguments)}window.__svgModalHandlerBound||(window.__svgModalHandlerBound=!0,document.addEventListener("mousedown",function(e){"saveSvgModal"===e.target.id&&(e.preventDefault(),Xt())},!0),document.addEventListener("click",function(e){"saveSvgModal"===e.target.id&&(e.preventDefault(),e.stopPropagation(),Xt())},!0));var $t=!1;function Jt(){return Kt.apply(this,arguments)}function Kt(){return(Kt=y(h().m(function e(){var t,n,r,a,i,o,c,s,l,u,d,f,p;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!$t){e.n=1;break}return e.a(2);case 1:if(nt&&0!==nt.children.length){e.n=2;break}return ln("Draw something first！","error"),e.a(2);case 2:if($t=!0,e.p=3,t=nt.cloneNode(!0),0!==(n=t.querySelectorAll("path")).length){e.n=4;break}return ln("没有找到绘图内容！","error"),e.a(2);case 4:if(r=1/0,a=1/0,i=-1/0,o=-1/0,c=!1,n.forEach(function(e){var t=e.getAttribute("d");if(t&&""!==t.trim()){var n=Zt(t);n.length>0&&(n.forEach(function(e){r=Math.min(r,e.x),a=Math.min(a,e.y),i=Math.max(i,e.x),o=Math.max(o,e.y)}),c=!0)}}),c&&r!==1/0){e.n=5;break}return ln("没有找到有效的绘图内容！","error"),e.a(2);case 5:if(s=i-r,l=o-a,u=Math.max(.1*Math.max(s,l),20),t.setAttribute("viewBox","".concat(r-u," ").concat(a-u," ").concat(s+2*u," ").concat(l+2*u)),t.setAttribute("width","300"),t.setAttribute("height","300"),t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.querySelectorAll("path").forEach(function(e){e.getAttribute("stroke")||e.setAttribute("stroke","black"),e.getAttribute("stroke-width")||e.setAttribute("stroke-width","2"),e.getAttribute("fill")||e.setAttribute("fill","none")}),!Ce()){e.n=10;break}return e.p=6,e.n=7,ne(t,1200,"transparent");case 7:d=e.v,e.n=9;break;case 8:e.p=8,e.v,f=(new XMLSerializer).serializeToString(t),d="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(f)));case 9:e.n=11;break;case 10:p=(new XMLSerializer).serializeToString(t),d="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(p)));case 11:if(d&&!(d.length<50)){e.n=12;break}throw new Error("Generated data URL is invalid or too short");case 12:return e.n=13,un(d);case 13:e.n=15;break;case 14:e.p=14,ln("传输失败："+e.v.message,"error");case 15:return e.p=15,setTimeout(function(){$t=!1},500),e.f(15);case 16:return e.a(2)}},e,null,[[6,8],[3,14,15,16]])}))).apply(this,arguments)}function Zt(e){var t=[],n=e.match(/-?\d+(?:\.\d+)?/g);if(n&&n.length>=2)for(var r=0;r<n.length-1;r+=2){var a=parseFloat(n[r]),i=parseFloat(n[r+1]);isNaN(a)||isNaN(i)||t.push({x:a,y:i})}return t}function en(){return(en=y(h().m(function e(){var t,n,r;return h().w(function(e){for(;;)switch(e.n){case 0:if(t=new URLSearchParams(window.location.search),!(n=t.get("loadSvgDraft"))){e.n=3;break}return e.n=1,tn();case 1:return e.n=2,nn(n);case 2:r=window.location.pathname,window.history.replaceState({},document.title,r);case 3:return e.a(2)}},e)}))).apply(this,arguments)}function tn(){return new Promise(function(e){var t=function(){void 0!==nt&&nt?e():setTimeout(t,100)};t()})}function nn(e){return rn.apply(this,arguments)}function rn(){return(rn=y(h().m(function e(t){var n,r,a,i,o,c,s;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("drafts").select("*").eq("id",t).single();case 1:if(a=e.v,i=a.data,!a.error&&i){e.n=2;break}return alert("获取草稿失败"),e.a(2);case 2:if(o=null,null===(n=i.data)||void 0===n||!n.storageUrl){e.n=4;break}return e.n=3,an(i.data.storageUrl);case 3:o=e.v,e.n=5;break;case 4:null!==(r=i.data)&&void 0!==r&&r.svgContent&&(o=i.data.svgContent);case 5:if(o){e.n=6;break}return alert("无法恢复SVG文件"),e.a(2);case 6:nt&&(nt.innerHTML="",c=new DOMParser,s=c.parseFromString(o,"image/svg+xml"),s.querySelectorAll("path").forEach(function(e){var t=e.cloneNode(!0);nt.appendChild(t)}),Ot(),ln("The draft has been loaded!","success")),e.n=8;break;case 7:e.p=7,e.v,alert("恢复失败，请重试");case 8:return e.a(2)}},e,null,[[0,7]])}))).apply(this,arguments)}function an(e){return on.apply(this,arguments)}function on(){return(on=y(h().m(function e(t){var n,r;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,fetch(t);case 1:if((n=e.v).ok){e.n=2;break}throw new Error("获取SVG失败");case 2:return e.n=3,n.text();case 3:return r=e.v,e.a(2,r);case 4:return e.p=4,e.v,e.a(2,null)}},e,null,[[0,4]])}))).apply(this,arguments)}function cn(){return(cn=y(h().m(function e(){var t,n,r,a,i,o,c,s;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t=new URLSearchParams(window.location.search),n=t.get("loadSvgDraft"),r="true"===t.get("fromGallery"),!n||!r){e.n=1;break}return e.a(2);case 1:if(!(a=t.get("loadSvgUrl"))){e.n=8;break}return e.p=2,e.n=3,tn();case 3:return e.n=4,fetch(decodeURIComponent(a));case 4:if((i=e.v).ok){e.n=5;break}throw new Error("无法获取SVG文件");case 5:return e.n=6,i.text();case 6:sn(e.v),ln("Remix loaded! Start editing!","success"),o=window.location.pathname,window.history.replaceState({},document.title,o),e.n=8;break;case 7:e.p=7,e.v,alert("无法加载Remix内容");case 8:if("true"!==t.get("loadRemixData")){e.n=10;break}if(!(c=sessionStorage.getItem("remixSvgData"))){e.n=10;break}return e.n=9,tn();case 9:sn(c),sessionStorage.removeItem("remixSvgData"),ln("Remix loaded! Start editing!","success"),s=window.location.pathname,window.history.replaceState({},document.title,s);case 10:return e.a(2)}},e,null,[[2,7]])}))).apply(this,arguments)}function sn(e){if(nt){nt.innerHTML="";try{var t=(new DOMParser).parseFromString(e,"image/svg+xml");if(t.querySelector("parsererror"))return void alert("SVG文件格式错误");var n=t.querySelectorAll("path");if(0===n.length)t.querySelectorAll("circle, rect, line, polyline, polygon, ellipse, path, text, g").forEach(function(e){var t=e.cloneNode(!0);nt.appendChild(t)});else n.forEach(function(e){var t=e.cloneNode(!0);nt.appendChild(t)});Ot()}catch(e){alert("加载失败："+e.message)}}}function ln(e){var t=document.createElement("div");t.textContent=e;t.style.cssText="\n        position: fixed;\n        top: 0px;\n        right: 0px;\n        background: black;\n        color: white;\n        z-index: 9999;\n        font-size: 20px;\n        animation: slideIn 0.3s ease-out;\n    ";var n=document.createElement("style");n.textContent="\n        @keyframes slideIn {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n        }\n    ",document.head.querySelector("style[data-notification]")||(n.setAttribute("data-notification","true"),document.head.appendChild(n)),document.body.appendChild(t),setTimeout(function(){document.body.contains(t)&&(t.style.animation="slideIn 0.3s ease-out reverse",setTimeout(function(){document.body.contains(t)&&document.body.removeChild(t)},300))},3e3)}function un(e){return new Promise(function(t,n){try{if(!e||!e.startsWith("data:image/svg")&&!e.startsWith("data:image/png"))throw new Error("Invalid image data URL");var r=null;if((r=document.getElementById("tshirtContainer"))||(r=document.getElementById("uploadedImagesContainer")),r||void 0===R||(r=R),!r)throw new Error("T恤设计区域未找到，请确保右侧面板已加载");var a=document.createElement("img");a.className="uploaded-image svg-drawing";var i=setTimeout(function(){a.onload=null,a.onerror=null,n(new Error("Image load timeout"))},1e4);a.onload=function(){try{if(clearTimeout(i),0===this.naturalWidth||0===this.naturalHeight)throw new Error("Image loaded but has no dimensions");var e=.4*r.offsetWidth,o=(r.offsetHeight,this.naturalWidth/this.naturalHeight);a.style.width=e+"px",a.style.height=e/o+"px",a.style.left=(r.offsetWidth-e)/2+"px",a.style.top="80px",a.style.position="absolute",a.style.cursor="move",a.style.userSelect="none",a.dataset.aspectRatio=o,r.appendChild(a),void 0!==k&&Array.isArray(k)||(window.uploadedImages=[]),k.push(a),Ee(a),setTimeout(function(){try{if(xe(a),q(),void 0!==U&&void 0!==b){var e=Array.from(r.querySelectorAll(".uploaded-image"));U[b]=e.map(function(e){return{src:e.src,className:e.className,style:{width:e.style.width,height:e.style.height,left:e.style.left,top:e.style.top},dataset:{aspectRatio:e.dataset.aspectRatio},isMemberCode:e.classList.contains("member-code-image")}})}t(a)}catch(e){t(a)}},150)}catch(e){clearTimeout(i),a.parentNode&&a.parentNode.removeChild(a),n(e)}},a.onerror=function(e){clearTimeout(i),n(new Error("图片加载失败，请重试"))},a.src=e}catch(e){n(e)}})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",wt):wt(),window.addEventListener("resize",function(){nt&&yt()})}},a={};function i(e){var t=a[e];if(void 0!==t)return t.exports;var n=a[e]={exports:{}};return r[e].call(n.exports,n,n.exports,i),n.exports}i.m=r,e=[],i.O=(t,n,r,a)=>{if(!n){var o=1/0;for(u=0;u<e.length;u++){for(var[n,r,a]=e[u],c=!0,s=0;s<n.length;s++)(!1&a||o>=a)&&Object.keys(i.O).every(e=>i.O[e](n[s]))?n.splice(s--,1):(c=!1,a<o&&(o=a));if(c){e.splice(u--,1);var l=r();void 0!==l&&(t=l)}}return t}a=a||0;for(var u=e.length;u>0&&e[u-1][2]>a;u--)e[u]=e[u-1];e[u]=[n,r,a]},i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},n=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,i.t=function(e,r){if(1&r&&(e=this(e)),8&r)return e;if("object"==typeof e&&e){if(4&r&&e.__esModule)return e;if(16&r&&"function"==typeof e.then)return e}var a=Object.create(null);i.r(a);var o={};t=t||[null,n({}),n([]),n(n)];for(var c=2&r&&e;("object"==typeof c||"function"==typeof c)&&!~t.indexOf(c);c=n(c))Object.getOwnPropertyNames(c).forEach(t=>o[t]=()=>e[t]);return o.default=()=>e,i.d(a,o),a},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.j=390,(()=>{var e={390:0};i.O.j=t=>0===e[t];var t=(t,n)=>{var r,a,[o,c,s]=n,l=0;if(o.some(t=>0!==e[t])){for(r in c)i.o(c,r)&&(i.m[r]=c[r]);if(s)var u=s(i)}for(t&&t(n);l<o.length;l++)a=o[l],i.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return i.O(u)},n=self.webpackChunk=self.webpackChunk||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var o=i.O(void 0,[96],()=>i(5828));o=i.O(o)})();