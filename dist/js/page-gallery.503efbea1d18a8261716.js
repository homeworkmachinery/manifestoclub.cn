/*! For license information please see page-gallery.503efbea1d18a8261716.js.LICENSE.txt */
(()=>{function e(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return r(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function t(){var e,r,a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",o=a.toStringTag||"@@toStringTag";function l(t,a,i,o){var l=a&&a.prototype instanceof s?a:s,u=Object.create(l.prototype);return n(u,"_invoke",function(t,n,a){var i,o,l,s=0,u=a||[],d=!1,f={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(r,t){return i=r,o=0,l=e,f.n=t,c}};function p(t,n){for(o=t,l=n,r=0;!d&&s&&!a&&r<u.length;r++){var a,i=u[r],p=f.p,y=i[2];t>3?(a=y===n)&&(l=i[(o=i[4])?5:(o=3,3)],i[4]=i[5]=e):i[0]<=p&&((a=t<2&&p<i[1])?(o=0,f.v=n,f.n=i[1]):p<y&&(a=t<3||i[0]>n||n>y)&&(i[4]=t,i[5]=n,f.n=y,o=0))}if(a||t>1)return c;throw d=!0,n}return function(a,u,y){if(s>1)throw TypeError("Generator is already running");for(d&&1===u&&p(u,y),o=u,l=y;(r=o<2?e:l)||!d;){i||(o?o<3?(o>1&&(f.n=-1),p(o,l)):f.n=l:f.v=l);try{if(s=2,i){if(o||(a="next"),r=i[a]){if(!(r=r.call(i,l)))throw TypeError("iterator result is not an object");if(!r.done)return r;l=r.value,o<2&&(o=0)}else 1===o&&(r=i.return)&&r.call(i),o<2&&(l=TypeError("The iterator does not provide a '"+a+"' method"),o=1);i=e}else if((r=(d=f.n<0)?l:t.call(n,f))!==c)break}catch(r){i=e,o=1,l=r}finally{s=1}}return{value:r,done:d}}}(t,i,o),!0),u}var c={};function s(){}function u(){}function d(){}r=Object.getPrototypeOf;var f=[][i]?r(r([][i]())):(n(r={},i,function(){return this}),r),p=d.prototype=s.prototype=Object.create(f);function y(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,n(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return u.prototype=d,n(p,"constructor",d),n(d,"constructor",u),u.displayName="GeneratorFunction",n(d,o,"GeneratorFunction"),n(p),n(p,o,"Generator"),n(p,i,function(){return this}),n(p,"toString",function(){return"[object Generator]"}),(t=function(){return{w:l,m:y}})()}function n(e,r,t,a){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}n=function(e,r,t,a){if(r)i?i(e,r,{value:t,enumerable:!a,configurable:!a,writable:!a}):e[r]=t;else{var o=function(r,t){n(e,r,function(e){return this._invoke(r,t,e)})};o("next",0),o("throw",1),o("return",2)}},n(e,r,t,a)}function a(e,r,t,n,a,i,o){try{var l=e[i](o),c=l.value}catch(e){return void t(e)}l.done?r(c):Promise.resolve(c).then(n,a)}function i(e){return function(){var r=this,t=arguments;return new Promise(function(n,i){var o=e.apply(r,t);function l(e){a(o,n,i,l,c,"next",e)}function c(e){a(o,n,i,l,c,"throw",e)}l(void 0)})}}function o(){return l.apply(this,arguments)}function l(){return(l=i(t().m(function e(){var r;return t().w(function(e){for(;;)switch(e.n){case 0:if(document.getElementById("galleryGrid")){e.n=1;break}return e.a(2);case 1:return(r=document.querySelectorAll(".filter-btn")).forEach(function(e){e.addEventListener("click",function(){r.forEach(function(e){return e.classList.remove("active")}),this.classList.add("active"),c(this.dataset.filter)})}),e.n=2,c("all");case 2:return e.a(2)}},e)}))).apply(this,arguments)}function c(){return s.apply(this,arguments)}function s(){return s=i(t().m(function r(){var n,a,i,o,l,c,s,u,d,f,p,y,m,g,v,b,h,k,w,_=arguments;return t().w(function(r){for(;;)switch(r.p=r.n){case 0:if(n=_.length>0&&void 0!==_[0]?_[0]:"all",a=document.getElementById("galleryGrid")){r.n=1;break}return r.a(2);case 1:return a.innerHTML='<div class="loading">Loading gallery...</div>',r.p=2,i=null,r.n=3,supabase.auth.getUser();case 3:return o=r.v,(l=o.data.user)&&(i=l.id),c=supabase.from("gallery").select("*"),c="mine"===n&&i?c.eq("user_id",i):"popular"===n?c.order("likes",{ascending:!1}).limit(20):"curated"===n?c.gte("likes",5).order("likes",{ascending:!1}):c.order("created_at",{ascending:!1}),r.n=4,c;case 4:if(s=r.v,u=s.data,!s.error){r.n=5;break}return a.innerHTML='<div class="empty-gallery"><h2>加载失败</h2><p>请稍后重试</p></div>',r.a(2);case 5:if(u&&0!==u.length){r.n=6;break}return a.innerHTML='\n            <div class="empty-gallery">\n                <h2>No artworks yet</h2>\n                <p>Be the first to add your creation to the gallery!</p>\n            </div>\n        ',r.a(2);case 6:return d=e(new Set(u.map(function(e){return e.user_id}))),r.n=7,supabase.from("profiles").select("user_id, manifesto").in("user_id",d);case 7:if(f=r.v,p=f.data,y={},p&&p.forEach(function(e){y[e.user_id]=e.manifesto}),m=new Set,g=new Set,!i){r.n=10;break}return v=u.map(function(e){return e.id}),r.n=8,supabase.from("gallery_likes").select("gallery_id").eq("user_id",i).in("gallery_id",v);case 8:return b=r.v,(h=b.data)&&h.forEach(function(e){return m.add(e.gallery_id)}),r.n=9,supabase.from("gallery_remixes").select("gallery_id").eq("user_id",i).in("gallery_id",v);case 9:k=r.v,(w=k.data)&&w.forEach(function(e){return g.add(e.gallery_id)});case 10:a.innerHTML=u.map(function(e){var r=y[e.user_id]||"Anonymous",t=new Date(e.created_at).toLocaleDateString(),n=i===e.user_id,a=m.has(e.id),o=g.has(e.id);return'\n            <div class="gallery-item" data-id="'.concat(e.id,'">\n                <img src="').concat(e.preview_image,'" alt="').concat(e.title,'" onclick="viewGalleryItem(\'').concat(e.id,'\')">\n                <div class="gallery-item-info">\n                    <div class="gallery-item-title">').concat(e.title||"Untitled",'</div>\n                    <div class="gallery-item-author">by ').concat(r,'</div>\n                    <div class="gallery-item-date">').concat(t,'</div>\n                    <div class="gallery-item-actions">\n                        <button class="action-btn ').concat(a?"liked":"",'" \n                                onclick="toggleLike(\'').concat(e.id,"')\"\n                                ").concat(i?"":'disabled title="请先登录"',">\n                            LIKE ").concat(e.likes||0,'\n                        </button>\n                        <button class="action-btn ').concat(o?"remixed":"",'" \n                                onclick="remixGalleryItem(\'').concat(e.id,"')\"\n                                ").concat(i?"":'disabled title="请先登录"',">\n                            REMIX ").concat(e.remix_count||0,"\n                        </button>\n                        ").concat(n?'<button class="action-btn" onclick="deleteGalleryItem(\''.concat(e.id,"')\">DELETE</button>"):"","\n                    </div>\n                </div>\n            </div>\n        ")}).join(""),r.n=12;break;case 11:r.p=11,r.v,a.innerHTML='<div class="empty-gallery"><h2>出错了</h2><p>请刷新页面重试</p></div>';case 12:return r.a(2)}},r,null,[[2,11]])})),s.apply(this,arguments)}function u(){return(u=i(t().m(function e(r){var n,a,i,o,l,c,s,u,f,p,y,m,g,v,b;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,checkUserLogin();case 1:if(n=e.v){e.n=2;break}return e.a(2);case 2:if(a=document.querySelector("[onclick=\"toggleLike('".concat(r,"')\"]"))){e.n=3;break}return e.a(2);case 3:return a.disabled=!0,a.textContent,e.n=4,supabase.from("gallery_likes").select("id").eq("user_id",n.id).eq("gallery_id",r).single();case 4:if(i=e.v,!(o=i.data)){e.n=9;break}return e.n=5,supabase.from("gallery_likes").delete().eq("id",o.id);case 5:if(s=e.v,!(u=s.error)){e.n=6;break}throw u;case 6:return e.n=7,supabase.from("gallery").select("likes").eq("id",r).single();case 7:return f=e.v,p=f.data,l=Math.max(0,((null==p?void 0:p.likes)||0)-1),c=!1,e.n=8,supabase.from("gallery").update({likes:l}).eq("id",r);case 8:e.n=13;break;case 9:return e.n=10,supabase.from("gallery_likes").insert([{user_id:n.id,gallery_id:r}]);case 10:if(y=e.v,!(m=y.error)){e.n=11;break}throw m;case 11:return e.n=12,supabase.from("gallery").select("likes").eq("id",r).single();case 12:return g=e.v,v=g.data,l=((null==v?void 0:v.likes)||0)+1,c=!0,e.n=13,supabase.from("gallery").update({likes:l}).eq("id",r);case 13:d(a,l,c),e.n=15;break;case 14:e.p=14,e.v,alert("操作失败，请重试"),(b=document.querySelector("[onclick=\"toggleLike('".concat(r,"')\"]")))&&(b.disabled=!1);case 15:return e.a(2)}},e,null,[[0,14]])}))).apply(this,arguments)}function d(e,r,t){e.textContent="LIKE ".concat(r),t?e.classList.add("liked"):e.classList.remove("liked"),e.disabled=!1}function f(){return(f=i(t().m(function e(r){var n,a,i,o,l,c,s,u;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,checkUserLogin();case 1:if(n=e.v){e.n=2;break}return e.a(2);case 2:return e.n=3,supabase.from("gallery").select("*").eq("id",r).single();case 3:if(a=e.v,i=a.data,!a.error&&i){e.n=4;break}return alert("无法获取作品信息"),e.a(2);case 4:return e.n=5,supabase.from("gallery_remixes").select("id").eq("user_id",n.id).eq("gallery_id",r).maybeSingle();case 5:if(o=e.v,l=o.data,l){e.n=9;break}return e.n=6,supabase.from("gallery_remixes").insert([{user_id:n.id,gallery_id:r}]);case 6:if(c=e.v,s=c.error){e.n=8;break}return u=(i.remix_count||0)+1,e.n=7,supabase.from("gallery").update({remix_count:u}).eq("id",r);case 7:e.n=9;break;case 8:s.code;case 9:if(confirm("Do you really want to remix this artwork?")){e.n=10;break}return e.a(2);case 10:i.draft_id?window.location.href="/?loadSvgDraft=".concat(i.draft_id,"&fromGallery=true"):i.svg_url?window.location.href="/?loadSvgUrl=".concat(encodeURIComponent(i.svg_url)):i.svg_data?(sessionStorage.setItem("remixSvgData",i.svg_data),window.location.href="/?loadRemixData=true"):alert("该作品没有可用的源文件"),e.n=12;break;case 11:e.p=11,e.v,alert("Remix失败，请重试");case 12:return e.a(2)}},e,null,[[0,11]])}))).apply(this,arguments)}function p(e){return y.apply(this,arguments)}function y(){return(y=i(t().m(function e(r){var n,a,i,o,l;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("gallery").select("*").eq("id",r).single();case 1:n=e.v,a=n.data,!n.error&&a&&(i=document.getElementById("galleryModal"),o=document.getElementById("modalImage"),l=document.getElementById("modalInfo"),o.src=a.svg_url||a.preview_image,l.innerHTML="\n                    <h3>".concat(a.title||"Untitled","</h3>\n                    <p>").concat(a.description||"",'</p>\n                    <p style="margin-top: 10px; color: #666;">Created: ').concat(new Date(a.created_at).toLocaleString(),"</p>\n                "),i.classList.add("show")),e.n=3;break;case 2:e.p=2,e.v;case 3:return e.a(2)}},e,null,[[0,2]])}))).apply(this,arguments)}function m(){document.getElementById("galleryModal").classList.remove("show")}function g(e){return v.apply(this,arguments)}function v(){return(v=i(t().m(function e(r){var n,a,i,o;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,supabase.from("gallery").select("likes").eq("id",r).single();case 1:return n=e.v,a=n.data,i=((null==a?void 0:a.likes)||0)+1,e.n=2,supabase.from("gallery").update({likes:i}).eq("id",r);case 2:o=e.v,o.error||c(document.querySelector(".filter-btn.active").dataset.filter),e.n=4;break;case 3:e.p=3,e.v;case 4:return e.a(2)}},e,null,[[0,3]])}))).apply(this,arguments)}function b(){return(b=i(t().m(function r(n){var a,i,o,l,s,u,d,f,p,y,m,g,v,b;return t().w(function(r){for(;;)switch(r.p=r.n){case 0:if(confirm("确定要从Gallery中删除这个作品吗？")){r.n=1;break}return r.a(2);case 1:return r.p=1,r.n=2,supabase.from("gallery").select("*").eq("id",n).single();case 2:if(a=r.v,i=a.data,!a.error&&i){r.n=3;break}return alert("删除失败"),r.a(2);case 3:if(o=[],l=function(e){if(!e||"string"!=typeof e)return null;var r=e.match(/\/storage\/v1\/object\/public\/design-files\/(.+)/);return r?r[1]:null},i.svg_url&&(s=l(i.svg_url))&&o.push(s),i.preview_image&&(u=l(i.preview_image))&&o.push(u),!i.draft_id){r.n=5;break}return r.n=4,supabase.from("drafts").select("*").eq("id",i.draft_id).single();case 4:d=r.v,(f=d.data)&&f.data&&(f.data.storageUrl&&(p=l(f.data.storageUrl))&&!o.includes(p)&&o.push(p),f.data.fileName&&!o.includes(f.data.fileName)&&o.push(f.data.fileName));case 5:if(!((y=e(new Set(o))).length>0)){r.n=7;break}return r.n=6,supabase.storage.from("design-files").remove(y);case 6:m=r.v,m.data,m.error;case 7:return r.n=8,supabase.from("gallery_likes").delete().eq("gallery_id",n);case 8:return g=r.v,g.error,r.n=9,supabase.from("gallery_remixes").delete().eq("gallery_id",n);case 9:return v=r.v,v.error,r.n=10,supabase.from("gallery").delete().eq("id",n);case 10:b=r.v,b.error?alert("删除失败"):(alert("作品已从Gallery中删除"),c(document.querySelector(".filter-btn.active").dataset.filter)),r.n=12;break;case 11:r.p=11,r.v,alert("删除失败");case 12:return r.a(2)}},r,null,[[1,11]])}))).apply(this,arguments)}setTimeout(function(){if("undefined"!=typeof supabase)o();else var e=setInterval(function(){"undefined"!=typeof supabase&&(clearInterval(e),o())},100)},100),window.viewGalleryItem=p,window.closeGalleryModal=m,window.likeGalleryItem=g,window.viewGalleryItem=p,window.closeGalleryModal=m,window.likeGalleryItem=g,window.toggleLike=function(e){return u.apply(this,arguments)},window.remixGalleryItem=function(e){return f.apply(this,arguments)},window.deleteGalleryItem=function(e){return b.apply(this,arguments)}})();